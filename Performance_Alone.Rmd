---
title: "Fitness In Alone treatment"
author: "Richard Honor"
date: "04/05/2020"
output: html_document
---

#Read in and prep data
```{r}
library(ggplot2)
library(dplyr)
library(lmerTest)
library(car)
library("glmmTMB")


#read in data
rm(list=ls())
dat<-read.csv("DataSynthesis.csv")

#Assign family column
prefamily<-gsub("*.\\|","",dat$Tag)
dat$Family<-gsub("\\-.*","",prefamily)

#remove those with fertilizer treatment, and extra genotypes that are only in the alone treatment. 
dat<-dat[!grepl("i",dat$Sample,fixed=T),]


#Function to weigh pathogen damage by leaf area. 
Weigh<-function(x){
  x/(dat$GM_Leaf_Len*dat$GM_Leaf_Wid)
}
#Function to standardize variables. 
Standardize<-function(x){
  standard<-(x-mean(x,na.rm=T))/sd(x,na.rm=T)
}

#Weighing pathogen damage
dat$BlackPathDamW<-Weigh(dat$BlackPathDam)
dat$ThripsDamW<-Weigh(dat$ThripsDam)


#Logging pathogen damage data, fern data, and secondary compound and chlorophyll data as they are all skewed. 
dat$BlackPathDamW<-log(dat$BlackPathDamW+abs(min(dat$BlackPathDamW,na.rm=T)+1))
dat$ThripsDamW<-log(dat$ThripsDamW+abs(min(dat$ThripsDamW,na.rm=T)+1))

dat$Fern<-log(dat$Fern+1)
dat$gluc_Conc<-log(dat$gluc_Conc)
dat$flav_Conc<-log(dat$flav_Conc)
dat$ChlorA<-log(dat$ChlorA)
dat$ThripsDam<-log(dat$ThripsDam+1)
dat$BlackPathDam<-log(dat$BlackPathDam+1)

#Creating leaf area vector 
dat$GM_Leaf_Area<-dat$GM_Leaf_Len*dat$GM_Leaf_Wid



#Average Duplicates. 
dat2<-dat %>% select(-X) %>% group_by(Tag) %>%  summarize(gh_col=first(gh_col),gh_bench=first(gh_bench),treatment=first(treatment),GA3=first(GA3),Family=first(Family),Maple_StemHeight_End=mean(Maple_StemHeight_End),Maple_LeafNum_End=mean(Maple_LeafNum_End),maple_leaf_length_0=mean(maple_leaf_length_0),maple_leaves_0=mean(maple_leaves_0),Maple_TotalLeafArea_End=mean(Maple_TotalLeafArea_End),MapleDamage=mean(Maple_Damage_End),Fern=first(Fern),gluc_Conc=mean(gluc_Conc),flav_Conc=mean(flav_Conc),maple_height_0=mean(maple_height_0),ChlorA=mean(ChlorA), GM_TotalLeaf_Area=first(GM_TotalLeaf_Area),ThripsDam=mean(ThripsDam),BlackPathDam=mean(BlackPathDam),WhiteFungDam=mean(WhiteFungDam),BlackPathDamW=mean(BlackPathDamW),ThripsDamW=mean(ThripsDamW),GM_Leaf_Area=mean(GM_Leaf_Area))


#Converting white fungal damage to logistic. 
dat2$WhiteFungLogis<-NA
dat2$WhiteFungLogis[dat2$WhiteFungDam>0]<-"Yes"
dat2$WhiteFungLogis[dat2$WhiteFungDam==0]<-"No"


dat2<-dat2[!grepl("maple",dat2$Tag,fixed = T),]

length(unique(dat2$Family))


dat2<-dat2[dat2$treatment=="a",]

```


#Gmatrix model 
```{r}
library(tidyr)
library(rms)


datG<-dat2 %>% select(Tag,Family,gluc_Conc,ChlorA,flav_Conc,gh_bench) %>%  pivot_longer(c(gluc_Conc,ChlorA,flav_Conc))

fit0<-Gls(value ~ name,correlation = (1|Family),data=datG)


fit<-glmmTMB(value~name+(1|Family),data=datG)
summary(fit)



fit1<-lmer(value ~ 1 + name +(1 + name|Family),data=datG)
summary(fit1)
```







#What predicts garlic mustard performance in the alone treatment? (Non- weighted) (not enough samples to estimate family values. )
```{r}
#Weighted pathogen damage data are no on too small of a scale. These will be standardized. 
#Modelling random effects 
library(glmmTMB)
dat2$GM_Leaf_Area<-Standardize(dat2$GM_Leaf_Area)



fit<-glmmTMB(GM_TotalLeaf_Area~Fern+ThripsDam*BlackPathDam*WhiteFungLogis+GM_Leaf_Area+(1|Family)+(1|gh_bench/gh_col),data=dat2)

fit2<-glmmTMB(GM_TotalLeaf_Area~Fern+ThripsDam*BlackPathDam*WhiteFungLogis+GM_Leaf_Area+(1|Family)+(1|gh_bench),data=dat2)

fit3<-glmmTMB(GM_TotalLeaf_Area~Fern+ThripsDam*BlackPathDam*WhiteFungLogis+GM_Leaf_Area+(1|gh_bench/gh_col),data=dat2)

fit4<-glmmTMB(GM_TotalLeaf_Area~Fern+ThripsDam*BlackPathDam*WhiteFungLogis+GM_Leaf_Area+(1|Family),data=dat2)

fit5<-glmmTMB(GM_TotalLeaf_Area~Fern+ThripsDam*BlackPathDam*WhiteFungLogis+GM_Leaf_Area+(1|gh_bench),data=dat2)


fit5<-glmmTMB(GM_TotalLeaf_Area~1+(1|Family),data=dat2)
fit6<-glmmTMB(GM_TotalLeaf_Area~1,data=dat2)

summary(fit5)
dat2
#Is collumn important?
anova(fit,fit2) #no it is not.

#Is family important? 
anova(fit2,fit5) #nNot at all. 

#Is gh_bench important? 
anova(fit2,fit4) #yes it is



#Modeling fixed effects: 

fit<-lmer(GM_TotalLeaf_Area~Fern+ThripsDam*BlackPathDam*WhiteFungLogis+GM_Leaf_Area+(1|gh_bench),data=dat2)

fit2<-update(fit,~.-ThripsDam:BlackPathDam:WhiteFungLogis)
anova(fit,fit2) #Not a significant three way interaction.

fit3<-update(fit2,~.-BlackPathDam:WhiteFungLogis)
anova(fit3,fit2) #There is not a significant two way interaction, 

fit4<-update(fit3,~.-BlackPathDam:ThripsDam)
anova(fit4,fit3)
#There is not a significant interaction between black path dam and thrips dam. 

fit5<-update(fit4,~.-WhiteFungLogis:ThripsDam)
anova(fit5,fit4) #There is not a significant whitefung dam and thrips dam interaction. 

summary(fit5)#Fern is not significant
fit6<-lmer(GM_TotalLeaf_Area~ThripsDam+BlackPathDam+WhiteFungLogis+GM_Leaf_Area+(1|gh_bench),data=dat2)
summary(fit6)#thrips damage is not significant. 

fit7<-lmer(GM_TotalLeaf_Area~BlackPathDam+WhiteFungLogis+GM_Leaf_Area+(1|gh_bench),data=dat2)
summary(fit7)#White fungal damage and black pathogen damage are significant. 



#These coeficients make much more sense, all in the negatives. Weighing was the appropriate thing to do. This should be done in models that predict pathogen response to glucosinolates and flavonoids. - Chlorophyll concentration should be used in those models as well. 
summary(fit7)
hist(residuals(fit7))
plot(residuals(fit7))
plot(fit7)
```










#Is there a cost to glucosinolate production?
```{r}
#Must control for leaf size here. ...
dat2
fit8<-lmer(GM_TotalLeaf_Area~BlackPathDam++Standardize(GM_Leaf_Area)+WhiteFungLogis+gluc_Conc+(1|gh_bench),data=dat2)
summary(fit8)
#only black pathogen damage predicts performance in the alone treatment. #No it is not, although... there is a negative slope....

fit8<-lmer(GM_TotalLeaf_Area~log(BlackPathDam+1)+WhiteFungLogis+Standardize(GM_Leaf_Area)+flav_Conc+(1|gh_bench),data=dat2)
summary(fit8) #no although this is now negative as well. This is interesting as it is the opposite of what was observed in the maple treatment. 


```



#Using all individuals from the experiment, *including* those not replicated across treatment. 
```{r}
#read in data
rm(list=ls())
dat<-read.csv("DataSynthesis.csv")


#Assign family column
prefamily<-gsub("*.\\|","",dat$Tag)
dat$Family<-gsub("\\-.*","",prefamily)

#remove those with fertilizer treatment only
dat<-dat[!grepl("SMITH1-3-80|MSMID1-2-0|KVEDG1-8-60",dat$Tag),]


#Function to weigh pathogen damage by leaf area. 
Weigh<-function(x){
  x/(dat$GM_Leaf_Len*dat$GM_Leaf_Wid)
}
#Function to standardize variables. 
Standardize<-function(x){
  standard<-(x-mean(x,na.rm=T))/sd(x,na.rm=T)
}

#Weighing pathogen damage
dat$BlackPathDamW<-Weigh(dat$BlackPathDam)
dat$ThripsDamW<-Weigh(dat$ThripsDam)


#Logging Data
dat$BlackPathDamW<-log(dat$BlackPathDamW+abs(min(dat$BlackPathDamW,na.rm=T)+1))
dat$ThripsDamW<-log(dat$ThripsDamW+abs(min(dat$ThripsDamW,na.rm=T)+1))

dat$Fern<-log(dat$Fern+1)
dat$gluc_Conc<-log(dat$gluc_Conc)
dat$flav_Conc<-log(dat$flav_Conc)
dat$ChlorA<-log(dat$ChlorA)
dat$ThripsDam<-log(dat$ThripsDam+1)
dat$BlackPathDam<-log(dat$BlackPathDam+1)

#Generating leaf area
dat$GM_Leaf_Area<-dat$GM_Leaf_Len*dat$GM_Leaf_Wid

#Average Duplicates. 
dat2<-dat %>% select(-X) %>% group_by(Tag) %>%  summarize(gh_col=first(gh_col),gh_bench=first(gh_bench),treatment=first(treatment),GA3=first(GA3),Family=first(Family),Maple_StemHeight_End=mean(Maple_StemHeight_End),Maple_LeafNum_End=mean(Maple_LeafNum_End),maple_leaf_length_0=mean(maple_leaf_length_0),maple_leaves_0=mean(maple_leaves_0),Maple_TotalLeafArea_End=mean(Maple_TotalLeafArea_End),MapleDamage=mean(Maple_Damage_End),Fern=first(Fern),gluc_Conc=mean(gluc_Conc),flav_Conc=mean(flav_Conc),maple_height_0=mean(maple_height_0),ChlorA=mean(ChlorA), GM_TotalLeaf_Area=first(GM_TotalLeaf_Area),ThripsDam=mean(ThripsDam),BlackPathDam=mean(BlackPathDam),WhiteFungDam=mean(WhiteFungDam),BlackPathDamW=mean(BlackPathDamW),ThripsDamW=mean(ThripsDamW),GM_Leaf_Area=mean(GM_Leaf_Area))


#Converting white fungal damage to logistic. 
dat2$WhiteFungLogis<-NA
dat2$WhiteFungLogis[dat2$WhiteFungDam>0]<-"Yes"
dat2$WhiteFungLogis[dat2$WhiteFungDam==0]<-"No"
```

#What predicts garlic mustard performance in the alone treatment? (Non- weighted)
```{r}
#Weighted pathogen damage data are no on too small of a scale. These will be standardized. 
#Modelling random effects 
library(glmmTMB)
dat2$GM_Leaf_Area<-Standardize(dat2$GM_Leaf_Area)



fit<-glmmTMB(GM_TotalLeaf_Area~Fern+ThripsDam*BlackPathDam*WhiteFungLogis+GM_Leaf_Area+(1|Family)+(1|gh_bench/gh_col),data=dat2)

fit2<-glmmTMB(GM_TotalLeaf_Area~Fern+ThripsDam*BlackPathDam*WhiteFungLogis+GM_Leaf_Area+(1|Family)+(1|gh_bench),data=dat2)

fit3<-glmmTMB(GM_TotalLeaf_Area~Fern+ThripsDam*BlackPathDam*WhiteFungLogis+GM_Leaf_Area+(1|gh_bench/gh_col),data=dat2)

fit4<-glmmTMB(GM_TotalLeaf_Area~Fern+ThripsDam*BlackPathDam*WhiteFungLogis+GM_Leaf_Area+(1|Family),data=dat2)

fit5<-glmmTMB(GM_TotalLeaf_Area~Fern+ThripsDam*BlackPathDam*WhiteFungLogis+GM_Leaf_Area+(1|gh_bench),data=dat2)


#Is collumn important?
anova(fit,fit2) #no it is not.

#Is family important? 
anova(fit2,fit5) #Yes.... Very. 

#Is gh_bench important? 
anova(fit2,fit4) #yes it is



#Modeling fixed effects: 

fit<-lmer(GM_TotalLeaf_Area~Fern+ThripsDam*BlackPathDam*WhiteFungLogis+GM_Leaf_Area+(1|gh_bench)+(1|Family),data=dat2)

fit2<-update(fit,~.-ThripsDam:BlackPathDam:WhiteFungLogis)
anova(fit,fit2) #Not a significant three way interaction.

fit3<-update(fit2,~.-BlackPathDam:WhiteFungLogis)
anova(fit3,fit2) #There is not a significant two way interaction, 

fit4<-update(fit3,~.-BlackPathDam:ThripsDam)
anova(fit4,fit3)
#There is not a significant interaction between black path dam and thrips dam. 

fit5<-update(fit4,~.-WhiteFungLogis:ThripsDam)
anova(fit5,fit4) #There is not a significant whitefung dam and thrips dam interaction. 

summary(fit5)#Fern is not significant
fit6<-lmer(GM_TotalLeaf_Area~ThripsDam+BlackPathDam+WhiteFungLogis+GM_Leaf_Area+(1|gh_bench)+(1|Family),data=dat2)
summary(fit6)#All else is significant. 


summary(fit7)
hist(residuals(fit7))
plot(residuals(fit7))
plot(fit7)
```





#Is there a cost to glucosinolate production?
```{r}
#Must control for leaf size here. ...
dat2
fit8<-lmer(GM_TotalLeaf_Area~BlackPathDam+ThripsDam+GM_Leaf_Area+WhiteFungLogis+gluc_Conc+(1|gh_bench)+(1|Family),data=dat2)
summary(fit8)
#only black pathogen damage predicts performance in the alone treatment. #No it is not, although... there is a negative slope....

fit8<-lmer(GM_TotalLeaf_Area~BlackPathDam+ThripsDam+WhiteFungLogis+GM_Leaf_Area+flav_Conc+(1|gh_bench)+(1|Family),data=dat2)
summary(fit8) #no although this is now negative as well. This is interesting as it is the opposite of what was observed in the maple treatment. 


```
#Significantly positive. 
