---
title: "Publication_Analysis_2"
output: html_document
---

#Read in and prep data
```{r}
library(ggplot2)
library(glmmTMB)
library(cowplot)
library(grid)
library(gridExtra)
library(dplyr)
source("GGPlot_Themes.R")

#read in data
rm(list=ls())
dat<-read.csv("DataSynthesis.csv")

#remove those with fertilizer treatment, and extra genotypes that are only in the alone treatment. 
dat<-dat[!grepl("i",dat$ID,fixed=T),]


#Initializing columns to avoid constant error messages. 
dat$WhiteFungLogis<-NA
dat$BlackFungLogis<-NA

#Function to standardize variables. 
Standardize<-function(x,meanSTD=F,SupplyDatStat=NULL){
  
  if(is.null(SupplyDatStat)){

      if(meanSTD==T){
            standard<-(x/mean(x,na.rm=T))
      }
      else{  standard<-(x-mean(x,na.rm=T))/sd(x,na.rm=T) }
  }
  
  
  else{ #SupplyDatStat allows the statistic from the entire population to be used as weighing measure to express values relative to the entire population and not just in a treatment. 
    
      if(meanSTD==T){
            standard<-(x/mean(SupplyDatStat,na.rm=T))
      }
      else{  standard<-(x-mean(x,na.rm=T))/sd(SupplyDatStat,na.rm=T) }
  }
    


  return(standard)
}




```


#Generating data frames with summarized leaf data (dat2) and summarized genotype data (dat3)
```{r}

 #Logging data
dat$Fern<-log(dat$Fern+1)
dat$gluc_Conc<-log(dat$gluc_Conc)
dat$flav_Conc<-log(dat$flav_Conc)
dat$ChlorA<-log(dat$ChlorA)
dat$ThripsDam<-log(dat$ThripsDam+1)
dat$BlackPathDam<-log(dat$BlackPathDam+1)

#Creating leaf area vector 
dat$GM_Leaf_Area<-dat$GM_Leaf_Len*dat$GM_Leaf_Wid

#clarifying names 
dat$GM_Leaf_Len_SampledLeaf<-dat$GM_Leaf_Len
dat$GM_Leaf_WidSampledLeaf<-dat$GM_Leaf_Wid

dat$GM_Leaf_Number_EndRosette<-dat$GM_Leaf_Number

#Summarizing: Taking the mean value of leaves. This tibble contains data at the level of the plant means. 

dat2<-dat %>% group_by(Tag) %>% summarize(ChlorA=mean(ChlorA),ChlorB=mean(ChlorB),gluc_Conc=mean(gluc_Conc),flav_Conc=mean(flav_Conc),Family=first(Family),treatment=first(treatment),gh_row=first(gh_row),gh_bench=first(gh_bench),GM_TotalLeaf_Area=first(GM_TotalLeaf_Area),comp_number=first(comp_number),ThripsDam=mean(ThripsDam),WhiteFungDam=mean(WhiteFungDam),BlackPathDam=mean(BlackPathDam),Fern=mean(Fern),gh_col=first(gh_col),GM_Leaf_Area=mean(GM_Leaf_Area),Latitude=first(Latitude),Longitude=first(Longitude),Altitude=first(Altitude),
RosDens=first(RosDens),
AdultDens=first(AdultDens),
TotalSizeS0=first(TotalSizeS0),
HerbivoryS0=first(HerbivoryS0),
GM_StemHeight_Bolt=first(GM_StemHeight_Bolt),
GM_Leaf_Number_Bolt=first(GM_Leaf_Number_Bolt),
Larg_Leaf_Len_Bolt=first(Larg_Leaf_Len_Bolt),
Larg_Leaf_Wid_Bolt=first(Larg_Leaf_Wid_Bolt),
Row_Field=first(Row_Field),
Col_Field=first(Col_Field),
Maple_Died=first(Maple_Died),
Maple_TotalLeafArea_End=first(Maple_TotalLeafArea_End),
GM_Fecundity=first(GM_Fecundity),
MapleFinalMass=first(MapleFinalMass),
RGR1=first(RGR1),
NumberOfSamples=n(),
maple_height_0=first(maple_height_0),
maple_leaf_length_0=first(maple_leaf_length_0),
maple_leaves_0=first(maple_leaves_0),
Maple_StemHeight_End=first(Maple_StemHeight_End),
Maple_LeafNum_End=first(Maple_LeafNum_End),
Maple_TotalLeafArea_End=first(Maple_TotalLeafArea_End),
MapleDamage=mean(Maple_Damage_End),
GM_Leaf_Len_Initial=mean(GM_Leaf_Len_Initial),
GM_NumberOfLeaves_Initial=mean(GM_NumberOfLeaves_Initial)

)


#All of these genotypes died (15 Genotypes).(We are simply missing a final measurement for e|JBCHY1-1-50|Q|240) That is only 3% Mortality. 
dead<-dat2[is.na(dat2$GM_TotalLeaf_Area),]

deadID<-dead %>% filter(treatment!="mcnt",Tag!="e|JBCHY1-1-50|Q|240") #Here there are 12 putative dead competitors because  ("e|JBCHY1-1-50|Q|240") did not die. 



#Creating a collumn for those that survived (1) or died (2) in the greenhouse
dat2$GreenhouseSurvival<-c()
dat2$GreenhouseSurvival[dat2$Tag %in% deadID$Tag]<-0
dat2$GreenhouseSurvival[is.na(dat2$GreenhouseSurvival)]<-1


#Creating a column to model white pathogen presence (1= present on leaf)
dat2$WhiteFungLogis<-NA
dat2$WhiteFungLogis[dat2$WhiteFungDam==0]<-0
dat2$WhiteFungLogis[dat2$WhiteFungDam>0]<-1
dat2$WhiteFungLogis<-as.factor(dat2$WhiteFungLogis)


#Creating column to indivate whether bolts survived in the field or not (1 = survived, 0 = died).
dat2$Bolt_Survival<-c()
dat2$Bolt_Survival[dat2$GM_StemHeight_Bolt=="Dead"]<-0
dat2$Bolt_Survival[dat2$GM_StemHeight_Bolt!="Dead"]<-1
dat2$Bolt_Survival[is.na(dat2$GM_StemHeight_Bolt)]<-0 # I am going to be consistent and call those without a value dead because i missed these ones. 
dat2$Bolt_Survival[dat2$GM_Fecundity>0]<-1 #Those with fecundity data are also alive... 
dat2$Bolt_Survival[dat2$treatment=="mcnt"]<-NA #those that dies in year 1 are NA
dat2$Bolt_Survival[dat2$treatment=="mcnt"]<-NA #Maple controls are NA


#Creating a column to indicate wheter maples survived in year 2 or not.
dat2$Maple_SurvivalY2<-c()
dat2$Maple_SurvivalY2[is.na(dat2$MapleFinalMass)]<-0 #Converting all those without a final measurement to dead.
dat2$Maple_SurvivalY2[!is.na(dat2$MapleFinalMass)]<-1 #Anything that is not NA (i.e. has a final measurment, is alive)
dat2$Maple_SurvivalY2[dat2$Maple_TotalLeafArea_End==0]<-NA #anything that died in the first year is overwritten as NA 
dat2$Maple_SurvivalY2[!dat2$treatment %in% c("mcnt","m")]<-NA


#Creating a column to indicate whether maples survived in year 1 or not.
dat2$Maple_SurvivalY1<-c()
dat2$Maple_SurvivalY1[dat2$Maple_TotalLeafArea_End==0]<-0 #anything with a value of 0 is dead
dat2$Maple_SurvivalY1[is.na(dat2$Maple_TotalLeafArea_End)]<-NA #anything with NA is unknown
dat2$Maple_SurvivalY1[dat2$Maple_SurvivalY2==1]<-1 #Those with an NA will be overwritten if i have a record of their size in year two. 
dat2$Maple_SurvivalY1[dat2$Maple_TotalLeafArea_End>0]<-1 #anything with a value greater than zero is alive

#This Genotype was NA for maple total leaf area, but we know that it is dead. 
dat2$Maple_SurvivalY1[dat2$Tag=="e|CBMCK1-1-0|N|49"]<-0

#Shifting GM_Fecudity values to bring all values above zero 
dat2$GM_Fecundity<-dat2$GM_Fecundity+0.05

#Creating a new fecundity collumn that has zeros for dead individuals 
dat2$GM_Fecundity2<-dat2$GM_Fecundity

#assigning those that didnt survive to zero.
dat2$GM_Fecundity2[dat2$Bolt_Survival==0]<-0

#Mean standardized fecundity.
dat2$GM_FecundityMS<-Standardize(dat2$GM_Fecundity,meanSTD = T)


```
#year 1 mortality calculations
```{r}
#Percent mortality A.p greenhouse: 
dat2 %>% filter(treatment!="mcnt") %>% nrow()
12/524*100

#Percent mortality maple year 1
dat2 %>% filter(Maple_SurvivalY1==1) %>% nrow()
dat2 %>% filter(Maple_SurvivalY1==0) %>% nrow()
3/196*100
```

#Removing dead individuals and dead competitors (year 1) from the analysis. 
```{r}

#Removing those with dead competitors from the garlic mustard treatment. ("e|JBCHY1-1-50|Q|240") did not die, we are simply missing the final measurement for it.
dead_competitors<-dead %>% filter(treatment=="gm",Tag!="e|JBCHY1-1-50|Q|240") %>% select(comp_number)

#Removing those with dead competitors from the analysis. 
dat2<-dat2 %>% filter(!comp_number %in% dead_competitors$comp_number)
dat<-dat %>% filter(!comp_number %in% dead_competitors$comp_number)

#Removing dead individuals from the analysis. 
dat2<-dat2[dat2$GreenhouseSurvival==1,]

#Removing those with dead maples from the analysis
dat2<-dat2[dat2$Maple_SurvivalY1==1 | is.na(dat2$Maple_SurvivalY1),]

```

#Mortality year 2
```{r}
#Percent A. petiolata that perished (mortality)
dat2 %>% filter(Bolt_Survival==0) %>% nrow()
dat2 %>% filter(Bolt_Survival==1) %>% nrow()
349/(349+157)

# Percent A saccharum that perished
dat2 %>% filter(Maple_SurvivalY2==0) %>% nrow()
dat2 %>% filter(Maple_SurvivalY2==1) %>% nrow()
12/192*100


```


#Checking out number of leaf samples
```{r}

dat2[is.na(dat2$gluc_Conc) & dat2$treatment !="mcnt",]
506-141 #Plants with samples. 

plantsWSamples<-dat[dat$treatment !="mcnt"& !is.na(dat$gluc_Conc),] %>% group_by(Tag) %>% summarize(number=n())

plantsWSamples %>% filter(number==2)
plantsWSamples %>% filter(number==1)


dat2[dat2$treatment !="mcnt",]
```

#Generating PCA for Glucosinolate and Chlorophyll
```{r}

pcaGlucCor<-prcomp(~Standardize(ChlorA)+Standardize(gluc_Conc),data=dat2,na.action=na.omit)
biplot(pcaGlucCor)
pcaGlucCor
summary(pcaGlucCor)

#Loading to data frame.
prediction<-as.data.frame(predict(pcaGlucCor))

#addings PCs to the data frame. 
df2<-tibble::rownames_to_column(prediction, "rownumber")
dat2[df2$rownumber,"PCCG_1"]<-df2$PC1
dat2[df2$rownumber,"PCCG_2"]<-df2$PC2

hist(dat2$PCCG_1)

#Testing correlation
summary(lm(Standardize(ChlorA)~Standardize(gluc_Conc),data=dat2,na.action=na.omit))
summary(lm(Standardize(gluc_Conc)~Standardize(ChlorA),data=dat2,na.action=na.omit))
```

#PCA of GM SIZE in the second year. 
```{r}
#Changing dead individuals to zero. 
dat2$GM_StemHeight_Bolt[which(dat2$GM_StemHeight_Bolt=="Dead")]<-NA
dat2$GM_Leaf_Number_Bolt[which(dat2$GM_Leaf_Number_Bolt=="Dead")]<-NA
dat2$Larg_Leaf_Len_Bolt[which(dat2$Larg_Leaf_Len_Bolt=="Dead")]<-NA
dat2$Larg_Leaf_Wid_Bolt[which(dat2$Larg_Leaf_Wid_Bolt=="Dead")]<-NA

#Making data numeric
dat2$GM_StemHeight_Bolt<-as.numeric(dat2$GM_StemHeight_Bolt)
dat2$GM_Leaf_Number_Bolt<-as.numeric(dat2$GM_Leaf_Number_Bolt)
dat2$Larg_Leaf_Len_Bolt<-as.numeric(dat2$Larg_Leaf_Len_Bolt)
dat2$Larg_Leaf_Wid_Bolt<-as.numeric(dat2$Larg_Leaf_Wid_Bolt)

#Performing principal component analysis
pca<-prcomp(~GM_StemHeight_Bolt+GM_Leaf_Number_Bolt+Larg_Leaf_Len_Bolt+Larg_Leaf_Wid_Bolt,data=dat2,scale.=T,na.action=na.omit)
summary(pca)

x<-as.data.frame(pca[1:4])
x<-x %>% select(-sdev,-center,-scale)
x<-apply(x,2,round,digits=2)
write.csv(x,"boltSizePCA.csv")
x
#Assignign PCA bolt size data to the main data frame from analysis
prediction<-as.data.frame(predict(pca))
df<-tibble::rownames_to_column(prediction, "rownumber")
dat2[df$rownumber,"PC1BoltSize"]<-df$PC1
```

#PCA of A.petiolata transplant size
```{r}
#Selecting variables to use in the PCA (All initial and final maple measurements which could indicate performance)
PCAInit<-dat2 %>% filter(treatment != "mcnt") %>% select(GM_Leaf_Len_Initial,GM_NumberOfLeaves_Initial)

#Standardizing all variables.
PCAInit<-data.frame(apply(PCAInit,2,Standardize))
#PCAInit<-data.frame(apply(PCAInit,2,function(x){x*-1}))

#Performing PCA model of initial maple size
pcaInit<-prcomp(PCAInit)
summary(pcaInit)
#Explains 74% of initial variation.

#All variables are correlated with the PC1 loading. 
plot(predict(pcaInit)[,1]~PCAInit$GM_NumberOfLeaves_Initial)
plot(predict(pcaInit)[,1]~PCAInit$GM_Leaf_Len_Initial)

pcaInit
#Adding pca for initial size into data frame.
dat2$Transplant_Size_GM[dat2$treatment!="mcnt"]<-predict(pcaInit)[,1]*-1


plot(dat2$Transplant_Size_GM~dat2$GM_NumberOfLeaves_Initial)
plot(dat2$Transplant_Size_GM~dat2$GM_Leaf_Len_Initial)


```


#PCA of  maple Transplant size
```{r}
#Creating a maple data frame
Maple<-dat2[dat2$treatment=="m"|dat2$treatment=="mcnt",]

#b|EFCC2-4-80|Q|144 and f|JBCHY1-1-50|Q|247,e|CBMCK1-1-0|N|49, e|JWBOY-2-80|Q|264 are simply not in the datafile. Nothing to do there - they will be deleted from the analysis. These genotypes are either dead, or we missed them when conducting the sampling.
Maple<-Maple[!is.na(Maple$Maple_StemHeight_End),]
Maple$treatment<-factor(Maple$treatment,levels = c("m","mcnt"))

#Selecting variables to use in the PCA (All initial and final maple measurements which could indicate performance)
PCAMaple<-Maple %>% select(maple_height_0,maple_leaf_length_0,maple_leaves_0,Maple_StemHeight_End,Maple_LeafNum_End,Maple_TotalLeafArea_End)

#Standardizing all variables.
PCAMaple<-data.frame(apply(PCAMaple,2,Standardize))

#Performing PCA model of initial maple size
pcaModelTotal<-prcomp(PCAMaple)
summary(pcaModelTotal)
pcaModelTotal

#All variables are correlated with the PC1 loading. 
plot(predict(pcaModelTotal)[,1]~PCAMaple$Maple_TotalLeafArea_End)
plot(predict(pcaModelTotal)[,1]~PCAMaple$maple_height_0)
plot(predict(pcaModelTotal)[,1]~PCAMaple$maple_leaf_length_0)
plot(predict(pcaModelTotal)[,1]~PCAMaple$maple_leaves_0)

#Adding in PC1 values of initial maple size to main maple data frame.
Maple$PC1Tot<-predict(pcaModelTotal)[,1]

#Creating a new data frame without maple controls (to be used in models that do not include maple treatment as a variable.) 
MapleModel<-Maple %>% filter(treatment=="m")

#write.csv(dat2,"CleanData.csv")
```


#Measuring response to selection for each fitness treatt
```{r}

##### TLA
#Removing Na's and making new dataframe with NAs excluded
datPlot<-dat2 %>% filter(!is.na(Transplant_Size_GM),!is.na(gh_bench),!is.na(GM_TotalLeaf_Area))

#For PCCG_1, Leaf Quality, obtaining the values of PCCG_1 after controlling for leaf area. 
fit<-glmmTMB(GM_TotalLeaf_Area~Transplant_Size_GM+gh_bench,data=datPlot)
fitResi<-residuals(fit)
datPlot$GM_TotalLeaf_AreaRes<-as.single(fitResi)

#TLA
datPlot %>% mutate(TLA = GM_TotalLeaf_AreaRes) %>% group_by(treatment) %>%  summarize(Var=sd(Standardize(TLA,meanSTD = T))^2)



#####
#Survival...idk how to do ... doing for mortality?? 

dat2 <- dat2 %>%  mutate(BoltMortality=1-Bolt_Survival)

#Removing Na's and making new dataframe with NAs excluded
datPlot<-dat2 %>% filter(!is.na(Transplant_Size_GM),!is.na(gh_bench),!is.na(BoltMortality))


#For PCCG_1, Leaf Quality, obtaining the values of PCCG_1 after controlling for leaf area. 
fit<-glmmTMB(Standardize(BoltMortality,meanSTD = T)~Transplant_Size_GM+gh_bench,data=datPlot)
fitResi<-residuals(fit)
datPlot$BoltMortality<-as.single(fitResi)

datPlot %>% group_by(treatment) %>%  summarize(Var=sd(Standardize(BoltMortality,meanSTD = T))^2)



#looking at survival means in treatment
dat2 %>% group_by(treatment) %>%  summarize(mean(BoltMortality))

dat2 %>% select(Bolt_Survival,BoltMortality)

##### Fecundity
#Removing Na's and making new dataframe with NAs excluded
datPlot<-dat2 %>% filter(!is.na(Transplant_Size_GM),!is.na(gh_bench),!is.na(GM_Fecundity))

#For PCCG_1, Leaf Quality, obtaining the values of PCCG_1 after controlling for leaf area. 
fit<-glmmTMB(GM_Fecundity~Transplant_Size_GM+gh_bench,data=datPlot)
fitResi<-residuals(fit)
datPlot$Fecundity<-as.single(fitResi)

#TLA
datPlot %>%  group_by(treatment) %>%  summarize(Var=sd(Standardize(GM_Fecundity,meanSTD = T))^2)



##### Total fitness
#Removing Na's and making new dataframe with NAs excluded
datPlot<-dat2 %>% filter(!is.na(Transplant_Size_GM),!is.na(gh_bench),!is.na(GM_Fecundity2))

#For PCCG_1, Leaf Quality, obtaining the values of PCCG_1 after controlling for leaf area. 
fit<-glmmTMB(GM_Fecundity2~Transplant_Size_GM+gh_bench,data=datPlot)
fitResi<-residuals(fit)
datPlot$Fecundity<-as.single(fitResi)

#TLA
datPlot %>%  group_by(treatment) %>%  summarize(Var=sd(Standardize(GM_Fecundity2,meanSTD = T))^2)



#simulation for understanding
p = seq(0,1,0.0001)
q = 1-p

ggplot()+
  geom_point(aes(x=p,y=100*p*q))

```



# Garlic Mustard Models

#### Performance analysis 
```{r}
#Making fungal damage a factor for analyses
dat2$WhiteFungLogis<-as.factor(dat2$WhiteFungLogis)

#Modelling random effects.
fitfull<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PCCG_1+treatment*PCCG_2+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(Fern)+RGR1+Transplant_Size_GM+(1|Family)+(1|gh_bench), data=dat2)

fitfull1<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PCCG_1+treatment*PCCG_2+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(Fern)+RGR1+Transplant_Size_GM+(1|gh_bench), data=dat2)

fitfull2<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PCCG_1+treatment*PCCG_2+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(Fern)+RGR1+Transplant_Size_GM+(1|Family), data=dat2)

summary(fitfull)
#Is family important? 
anova(fitfull,fitfull1) #No
#Is gh bench important? 
anova(fitfull,fitfull2) #Yes, gh_bench predicts performance. 


#Modelling fixed effects. 

#Is transplant size important?
  fitfull1<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PCCG_1+treatment*PCCG_2+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(Fern)+RGR1+Transplant_Size_GM+(1|gh_bench), data=dat2)
  fit2<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PCCG_1+treatment*PCCG_2+BlackPathDam*WhiteFungLogis*ThripsDam+RGR1+Standardize(Fern)+(1|gh_bench), data=dat2)
  anova(fitfull1,fit2) #yes... extremely

#IS fern important? 
  fitfull1<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PCCG_1+treatment*PCCG_2+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(Fern)+RGR1+Transplant_Size_GM+(1|gh_bench), data=dat2)
  fit2<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PCCG_1+treatment*PCCG_2+BlackPathDam*WhiteFungLogis*ThripsDam+RGR1+Transplant_Size_GM+(1|gh_bench), data=dat2)
  anova(fitfull1,fit2) #yes

fit2<-update(fitfull1,~.-ThripsDam:BlackPathDam:WhiteFungLogis)
anova(fitfull1,fit2) #Not a significant three way interaction.

fit3<-update(fit2,~.-BlackPathDam:WhiteFungLogis)
anova(fit3,fit2) #There is not a significant two way interaction, 

fit4<-update(fit3,~.-BlackPathDam:ThripsDam)
anova(fit4,fit3)
#There is not a significant interaction between black path dam and thrips dam. 

fit5<-update(fit4,~.-WhiteFungLogis:ThripsDam)
anova(fit5,fit4) #There is not a significant whitefung dam and thrips dam interaction. 
summary(fit5)

#IS thrips dam significant?
fit11<-glmmTMB(Standardize(GM_TotalLeaf_Area) ~ treatment*PCCG_1+treatment*PCCG_2 + BlackPathDam +  WhiteFungLogis + ThripsDam  + RGR1 +Fern+(1 | gh_bench)+Transplant_Size_GM,data=dat2[!is.na(dat2$ThripsDam),])
fit12<-glmmTMB(Standardize(GM_TotalLeaf_Area) ~ treatment*PCCG_1+treatment*PCCG_2 + BlackPathDam +  WhiteFungLogis + RGR1+Fern+ (1 | gh_bench)+Transplant_Size_GM ,data=dat2[!is.na(dat2$ThripsDam),])
anova(fit11,fit12) #No.

#Is  White Path dam significant
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PCCG_1+treatment*PCCG_2+BlackPathDam+WhiteFungLogis+RGR1+Fern+(1|gh_bench)+Transplant_Size_GM, data=dat2[!is.na(dat2$WhiteFungLogis),])
fit8<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PCCG_1+treatment*PCCG_2+BlackPathDam+RGR1+Fern+(1|gh_bench)+Transplant_Size_GM, data=dat2[!is.na(dat2$WhiteFungLogis),])
anova(fit6,fit8) #No

#Is  Black Path dam significant
fit5<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PCCG_1+treatment*PCCG_2+BlackPathDam+WhiteFungLogis+RGR1+Fern+(1|gh_bench)+Transplant_Size_GM, data=dat2[!is.na(dat2$BlackPathDam),])
fit7<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PCCG_1+treatment*PCCG_2+WhiteFungLogis+RGR1+Fern+(1|gh_bench)+Transplant_Size_GM, data=dat2[!is.na(dat2$BlackPathDam),])
anova(fit5,fit7) #Yes

#IS RGR1 significant?

fit4<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PCCG_1+treatment*PCCG_2+BlackPathDam+RGR1+Fern+(1|gh_bench)+Transplant_Size_GM, data=dat2[!is.na(dat2$RGR1),])
fit5<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PCCG_1+treatment*PCCG_2+BlackPathDam+Fern+(1|gh_bench)+Transplant_Size_GM, data=dat2[!is.na(dat2$RGR1),])
anova(fit5,fit4) # No

#IS the interaction between treatment and PCCG_2 significant?
fit6<-update(fit5,~.-treatment:PCCG_2)
anova(fit6,fit5) #No. 


#IS the interaction between treatment and PCCG_1 significant?
fit7<-update(fit6,~.-treatment:PCCG_1)
anova(fit7,fit6) #Yes p= 0.0025

#IS PCCG_2 significant? 
fit8<-update(fit7,~.-PCCG_2)
anova(fit8,fit7) #No. 



#Best Model is (With performance gradients): 
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area,meanSTD = T)~treatment*Standardize(PCCG_1)+Standardize(Fern)+Standardize(BlackPathDam)+Standardize(Transplant_Size_GM)+(1|gh_bench),  data=dat2)
summary(fit6)



#Transplant size is very important, no longer have significant PC1 slopes in the alone and maple treatment.
plot(residuals(fit6)~fitted(fit6))
hist(residuals(fit6),breaks=20)


```


#### Reassessing perfromance analysis with leaf size residuals
```{r}
#Best model
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(PCCG_1)+Standardize(Fern)+Standardize(BlackPathDam)+(1|gh_bench)+Transplant_Size_GM,  data=dat2) 

#Obtaining clean data frame
#Removing Na's and making new dataframe with NAs excluded
datPlot<-dat2[!is.na(dat2$PCCG_1)&!is.na(dat2$BlackPathDam)&!is.na(dat2$gh_bench)&!is.na(dat2$Fern)&!is.na(dat2$GM_Leaf_Area),]



#For PCCG_1, Leaf Quality, obtaining the values of PCCG_1 after controlling for leaf area. 
fit<-glmmTMB(Standardize(PCCG_1)~Standardize(GM_Leaf_Area),data=datPlot)
fitResi<-residuals(fit)
datPlot$CGFResi<-as.single(fitResi)

#Assessing significance of interaction. 
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(CGFResi)+Standardize(Fern)+Standardize(BlackPathDam)+(1|gh_bench)+Transplant_Size_GM,  data=datPlot)

fit7<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment+Standardize(CGFResi)+Standardize(Fern)+Standardize(BlackPathDam)+(1|gh_bench)+Transplant_Size_GM,  data=datPlot)
anova(fit6,fit7) #Interaction is highly significant. p = 0.001

#Therefore, the  analysis without controlling for leaf area is similar to that with it controlled for.
summary(fit6)

#Performing permutation test on the interaction to obtain p values for each treatment. 
source("/Users/richardhonor/Documents/PermutateR/R/permTest_LR.R")
source("/Users/richardhonor/Documents/PermutateR/R/permTest_LR_int.R")
source("/Users/richardhonor/Documents/PermutateR/R/permTest_Contrast.R")

source("/Users/richardhonor/Documents/PermutateR/R/model_extract.R")
source("/Users/richardhonor/Documents/PermutateR/R/new_data.R")

fit6<-lme4::lmer(GM_TotalLeaf_Area~treatment*PCCG_1+Fern+BlackPathDam+(1|gh_bench), data=dat2) 
summary(fit6)

fit6<-glmmTMB(GM_TotalLeaf_Area~treatment*PCCG_1+Fern+BlackPathDam+(1|gh_bench), data=dat2) 
summary(fit6)

library(PermutateR)
permTest_Contrast(fit6,c("treatmentm:PCCG_1","treatmentgm:PCCG_1","PCCG_1"),Randomize_Variables = "PCCG_1","z value",3,OutputData = F)

output
#The p values for this model are very accurate: maple treatment was simulated at 0.001, GM at 0.042 and alone treatment at 0.048


#initial measurements
dat2 %>%  summarize(min(maple_height_0,na.rm=T),max(maple_height_0,na.rm=T),sd(maple_height_0,na.rm=T))
dat2 %>%  summarize(min(GM_Leaf_Len_Initial,na.rm=T),max(GM_Leaf_Len_Initial,na.rm=T),sd(GM_Leaf_Len_Initial,na.rm=T))
dat2 %>%  summarize(min(GM_NumberOfLeaves_Initial,na.rm=T),max(GM_NumberOfLeaves_Initial,na.rm=T),sd(GM_NumberOfLeaves_Initial,na.rm=T))

dat2 %>% group_by(treatment) %>%  summarize(min(PCCG_1,na.rm=T),max(PCCG_1,na.rm=T),sd(PCCG_1,na.rm=T))
dat2 %>% group_by(treatment) %>%  summarize(min(GM_TotalLeaf_Area,na.rm=T),max(GM_TotalLeaf_Area,na.rm=T),sd(GM_TotalLeaf_Area,na.rm=T))

```



#### Fecundity analysis 
Bolt size is not included.
```{r}
#Maximum model ... 
fit<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+(1|Col_Field)+Transplant_Size_GM,data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

fit2<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+(1|Row_Field)+Transplant_Size_GM,data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

fit3<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+(1|gh_bench)+Transplant_Size_GM,data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

fit4<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+Transplant_Size_GM,data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

fit5<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Row_Field)+Transplant_Size_GM,data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

fit6<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Transplant_Size_GM,data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

#IS column in field significant?
anova(fit,fit4) # No

#IS row in field significant?
anova(fit2,fit4) #No

#IS gh_bench  significant?
anova(fit3,fit4) #No.

#IS family  significant?
anova(fit5,fit2) #No

###Modelling fixed effects 

#Is transplant size important?
fit1<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Transplant_Size_GM,data=dat2[!is.na(dat2$BlackPathDam),])
fit2<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+BlackPathDam,data=dat2[!is.na(dat2$BlackPathDam),])
anova(fit1,fit2) #Yes...

#IS Black Path  dam significant?
fit1<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Transplant_Size_GM,data=dat2[!is.na(dat2$BlackPathDam),])
fit2<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Transplant_Size_GM,data=dat2[!is.na(dat2$BlackPathDam),])
anova(fit1,fit2) #No


#IS Fern significant?
fit2<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Transplant_Size_GM,data=dat2[!is.na(dat2$Fern),])
fit3<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Transplant_Size_GM,data=dat2[!is.na(dat2$Fern),])
anova(fit2,fit3) #No


###
# Testing life history data now
###

#Is RGR significant?
fit3<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Transplant_Size_GM,data=dat2[!is.na(dat2$RGR1),])
fit4<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(GM_TotalLeaf_Area)+Transplant_Size_GM,data=dat2[!is.na(dat2$RGR1),])
anova(fit3,fit4) # No 


#Is Total leaf area (year 1) significant?
fit3<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(GM_TotalLeaf_Area)+Transplant_Size_GM,data=dat2[!is.na(dat2$GM_TotalLeaf_Area),])
fit4<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Transplant_Size_GM,data=dat2[!is.na(dat2$GM_TotalLeaf_Area),])
anova(fit3,fit4) #No



###
# Testing leaf treats now
###
fit5<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Transplant_Size_GM,data=dat2)


#IS the interaction between treatment and PCCG_2 significant?
fit6<-update(fit5,~.-treatment:PCCG_2)
anova(fit6,fit5) #No. 

#IS PCCG_2 significant? 
fit7<-update(fit6,~.-PCCG_2)
anova(fit7,fit6) #No 

#IS the interaction between treatment and PCCG_1 significant?
fit8<-update(fit7,~.-treatment:PCCG_1)
anova(fit8,fit7) #No. 

#IS PCCG_1 significant at all?
 fit10<-glmmTMB(log(GM_Fecundity) ~ treatment + PCCG_1 + Transplant_Size_GM ,data=dat2[!is.na(dat2$PCCG_1),])
  fit11<-glmmTMB(log(GM_Fecundity) ~ treatment  + Transplant_Size_GM ,data=dat2[!is.na(dat2$PCCG_1),])
anova(fit11,fit10) #Yes. Simply correlated with fitness: p=0.027. 


#IS treatment significant at all?
 fit10<-glmmTMB(log(GM_Fecundity) ~ treatment +  Transplant_Size_GM +  
    Standardize(PC1BoltSize),data=dat2)
  fit11<-glmmTMB(log(GM_Fecundity) ~   + Transplant_Size_GM+  
    Standardize(PC1BoltSize),data=dat2)
anova(fit11,fit10) #Yes. treatment is significant 


#Best model (log data)
fit12<-glmmTMB(log(GM_Fecundity)~treatment+Transplant_Size_GM+PCCG_1,data=dat2)

#Selection differential
fit12<-glmmTMB(GM_FecundityMS~treatment+Standardize(Transplant_Size_GM)+Standardize(PCCG_1),data=dat2)


summary(fit12)
min(dat2$GM_FecundityMS,na.rm=T)
#Selection differential bolt size
fit12<-glmmTMB(GM_FecundityMS~Standardize(PC1BoltSize),data=dat2)
summary(fit12)
```

#Reasessing fecundity analysis with leaf size controlled for.
```{r}
#Removing Na's and making new dataframe with NAs excluded
datPlot<-dat2[!is.na(dat2$Transplant_Size_GM)&!is.na(dat2$PCCG_1)&!is.na(dat2$GM_Fecundity)&!is.na(dat2$GM_Leaf_Area),]

#For PCCG_1, Leaf Quality, obtaining the values of PCCG_1 after controlling for leaf area. 
fit<-glmmTMB(Standardize(PCCG_1)~Standardize(GM_Leaf_Area),data=datPlot)
fitResi<-residuals(fit)
datPlot$CGResi<-as.single(fitResi)

#Assessing significance of pc1 residuals 

fit1<-glmmTMB(log(GM_Fecundity)~treatment+Transplant_Size_GM+CGResi,data=datPlot)

fit2<-glmmTMB(log(GM_Fecundity)~treatment+Transplant_Size_GM,data=datPlot)

anova(fit1,fit2) #This is still significant. 

summary(fit1)
```


#### Permutation test using relative fitness of gm fecundity. 
```{r}
dat2$GM_FecundityMS<-Standardize(dat2$GM_Fecundity,meanSTD = T)
fit12<-lm(GM_FecundityMS~treatment,data=dat2)

summary(fit12)

source("/Users/richardhonor/Documents/PermutateR/R/permTest_LR.R")
source("/Users/richardhonor/Documents/PermutateR/R/permTest_LR_int.R")
source("/Users/richardhonor/Documents/PermutateR/R/permTest_Contrast.R")

source("/Users/richardhonor/Documents/PermutateR/R/model_extract.R")
source("/Users/richardhonor/Documents/PermutateR/R/new_data.R")

#Perm test for treatment
Fec_Treat_Perm<-permTest_Contrast(fit12,c("(Intercept)","treatmentgm" ,"treatmentm"),c("treatment"),"t value",10000)
Fec_Treat_Perm

#Perm test leaf traits. 
fit<-lm(GM_FecundityMS~treatment+PCCG_1,data=dat2)
fit<-lm(GM_FecundityMS~treatment+PCCG_2,data=dat2)

#Perm test for PCCG_1
Fec_Treat_Perm<-permTest_LR(fit,"PCCG_1","F",10000)
Fec_Treat_Perm #Not even close now. 

Fec_Treat_Perm<-permTest_LR(fit,"PCCG_2","F",10000)
Fec_Treat_Perm #Not even close now. 


```




#Survival analysis
```{r}
#Maximum model ... is interaction significant?
fit<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Transplant_Size_GM+(1|Family)+(1|Col_Field),data=dat2[!is.na(dat2$Col_Field),],family="binomial")

fit2<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Transplant_Size_GM+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$Col_Field),],family="binomial")

fit3<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Transplant_Size_GM+(1|Family)+(1|gh_bench),data=dat2[!is.na(dat2$Col_Field),],family="binomial")

fit4<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Transplant_Size_GM+(1|Family),data=dat2[!is.na(dat2$Col_Field),],family="binomial")

fit5<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Transplant_Size_GM+(1|Row_Field),data=dat2[!is.na(dat2$Col_Field),],family="binomial")

#IS column in field significant?
anova(fit,fit4) # No

#IS row in field significant?
anova(fit2,fit4) #Yes it is. 

#IS gh_bench  significant?
anova(fit3,fit4) #No.

#IS family  significant?
anova(fit5,fit2) #Yes

###Modeling fixed effects 

#Is transplant size significant? 
fit0.1<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Transplant_Size_GM+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$BlackPathDam),],family="binomial")
fit1<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+Standardize(RGR1)+(1|Family)+(1|Row_Field)+Standardize(GM_TotalLeaf_Area)+BlackPathDam,data=dat2[!is.na(dat2$BlackPathDam),],family="binomial")
anova(fit0.1,fit1)# no.

#IS Black path dam significant? 
fit0.1<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$BlackPathDam),],family="binomial")
fit1<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+Standardize(RGR1)+(1|Family)+(1|Row_Field)+Standardize(GM_TotalLeaf_Area),data=dat2[!is.na(dat2$BlackPathDam),],family="binomial")
anova(fit0.1,fit1)# no.

#IS fern significant? 
fit0.1<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$Fern),],family="binomial")
fit1<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(RGR1)+(1|Family)+(1|Row_Field)+Standardize(GM_TotalLeaf_Area),data=dat2[!is.na(dat2$Fern),],family="binomial")
anova(fit0.1,fit1)# Yes

#IS Total Leaf area (first year) significant? 
fit0.1<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$GM_TotalLeaf_Area),],family="binomial")
fit1<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+Standardize(RGR1)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$GM_TotalLeaf_Area),],family="binomial")
anova(fit0.1,fit1)# no.

#IS RGR significant? 
fit0.1<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+Standardize(RGR1)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$RGR1),],family="binomial")
fit1<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$RGR1),],family="binomial")
anova(fit0.1,fit1)# no.

#IS the interaction between treatment and PCCG_2 significant?
fit2<-update(fit1,~.-treatment:PCCG_2)
anova(fit2,fit1) #No. 


#IS PCCG_2 significant? 
fit3<-update(fit2,~.-PCCG_2)
anova(fit2,fit3) #No. 


#IS the interaction between treatment and PCCG_1 significant?
fit4<-update(fit3,~.-treatment:PCCG_1)
anova(fit4,fit3) #yes, it is. 

#Best model
fit<- glmmTMB(Bolt_Survival ~ treatment*Standardize(PCCG_1) + Standardize(Fern) +  
    (1 | Family) + (1 | Row_Field) ,data=dat2, family="binomial")
summary(fit)

#Best model standardized
fit<- glmmTMB(Standardize(Bolt_Survival,meanSTD=T) ~ treatment*Standardize(PCCG_1) + Standardize(Fern) +  
    (1 | Family) + (1 | Row_Field) ,data=dat2)
summary(fit)


#New best model as leaf size rendered pccg_1 insignificant. 
fit<- glmmTMB(Bolt_Survival ~ treatment + Standardize(Fern) +  
    (1 | Family) + (1 | Row_Field) ,data=dat2, family="binomial")
summary(fit)

#New model with relative survival. 
fit<- glmmTMB(Standardize(Bolt_Survival,meanSTD=T) ~ treatment + Standardize(Fern) +  
    (1 | Family) + (1 | Row_Field) ,data=dat2)

summary(fit)




```


#reassessing PCCG_2 when family is not included. 
```{r}

#reassessing PCCG_2:treatment interaction when family is not included. 
fit<- glmmTMB(Bolt_Survival ~ treatment*Standardize(PCCG_2) + Standardize(Fern) +  
      (1 | Row_Field) ,data=dat2, family="binomial")
fit1<- glmmTMB(Bolt_Survival ~ treatment+Standardize(PCCG_2) + Standardize(Fern) +  
      (1 | Row_Field) ,data=dat2, family="binomial")
anova(fit,fit1) # interaction not significant

#Testing PCCG_2 without family
fit<- glmmTMB(Bolt_Survival ~ treatment+Standardize(PCCG_2) + Standardize(Fern)  
     +(1 | Row_Field),data=dat2[!is.na(dat2$PCCG_2),], family="binomial")
fit1<- glmmTMB(Bolt_Survival ~ treatment + Standardize(Fern)   
       +(1 | Row_Field),data=dat2[!is.na(dat2$PCCG_2),], family="binomial")
anova(fit,fit1) #This is actually close to significant. (p = 0.058)

summary(fit)

#reassessing PCCG_1 treatment interaction when family is not included. 
fit<- glmmTMB(Bolt_Survival ~ treatment*Standardize(PCCG_1) + Standardize(Fern) +  
      (1 | Row_Field) ,data=dat2, family="binomial")
fit1<- glmmTMB(Bolt_Survival ~ treatment+Standardize(PCCG_1) + Standardize(Fern) +  
      (1 | Row_Field) ,data=dat2, family="binomial")
anova(fit,fit1) # Almost significant
summary(fit)
#This is actually close to significant. (p = 0.058)

#testing PCCG_1 without family
fit<- glmmTMB(Bolt_Survival ~ treatment+Standardize(PCCG_1) + Standardize(Fern)  
     +(1 | Row_Field),data=dat2[!is.na(dat2$PCCG_2),], family="binomial")
fit1<- glmmTMB(Bolt_Survival ~ treatment + Standardize(Fern)   
       +(1 | Row_Field),data=dat2[!is.na(dat2$PCCG_2),], family="binomial")
anova(fit,fit1)  #Almost significant again...

#
#Reassessing treatment by removing the GM treatment
datrmGM<-dat2 %>% mutate(treatment=replace(treatment,treatment=="gm","a")) %>% filter(!is.na(PCCG_2))

fit<- glmmTMB(Bolt_Survival ~ treatment + Standardize(Fern)  
     +(1 | Row_Field),data=datrmGM, family="binomial")
fit1<- glmmTMB(Bolt_Survival ~   Standardize(Fern)   
       +(1 | Row_Field),data=datrmGM, family="binomial")
anova(fit,fit1)  #Wow significant again...
#Now treatment is significant !!! why didnt i do this before. This is what to report. 
summary(fit)

#Reassessing if PCCG_2 : treatment interaction is significant with new treatment categories 
fit<- glmmTMB(Bolt_Survival ~ treatment * Standardize(PCCG_2)+Standardize(Fern)  
     +(1 | Row_Field),data=datrmGM, family="binomial")
fit1<- glmmTMB(Bolt_Survival ~  treatment +Standardize(PCCG_2)+Standardize(Fern)   
       +(1 | Row_Field),data=datrmGM, family="binomial")
anova(fit,fit1)  #not significant

#reassessing if PCCG_2 is significant
fit<- glmmTMB(Bolt_Survival ~ treatment + Standardize(PCCG_2)+Standardize(Fern)  
     +(1 | Row_Field),data=datrmGM, family="binomial")
fit1<- glmmTMB(Bolt_Survival ~  treatment +Standardize(Fern)   
       +(1 | Row_Field),data=datrmGM, family="binomial")
anova(fit,fit1)  #still not significant p == 0.059

summary(fit)

#New model with relative survival. 
fit<- glmmTMB(Standardize(Bolt_Survival,meanSTD=T) ~ treatment + Standardize(Fern) +  
    (1 | Family) + (1 | Row_Field) ,data=datrmGM)


summary(fit)
Link=function(x){
  a=exp(x)/(1+exp(x))
  return(a)
}


```

#Reasessing survival analysis with leaf size controlled for.
```{r}
#Removing Na's and making new dataframe with NAs excluded
datPlot<-dat2[!is.na(dat2$GM_Leaf_Area)&!is.na(dat2$PCCG_1)&!is.na(dat2$Fern)&!is.na(dat2$Row_Field)&!is.na(dat2$Bolt_Survival),]

#For PCCG_1, Leaf Quality, obtaining the values of PCCG_1 after controlling for leaf area. 
fit<-glmmTMB(Standardize(PCCG_1)~Standardize(GM_Leaf_Area),data=datPlot)
fitResi<-residuals(fit)
datPlot$CGResi<-as.single(fitResi)

#Assessing significance of interaction. 

fit1<- glmmTMB(Bolt_Survival ~ treatment*Standardize(CGResi) + Standardize(Fern) +  
    (1 | Family) + (1 | Row_Field) ,data=datPlot, family="binomial")
fit2<- glmmTMB(Bolt_Survival ~ treatment+Standardize(CGResi) + Standardize(Fern) +  
    (1 | Family) + (1 | Row_Field) ,data=datPlot, family="binomial")

anova(fit1,fit2) #Interaction is close to significance after controlling for leaf area of sampled leaf. ... but not significant. Therefore, i should neglect it? 

#assessing significance of variable at all. 
fit1<- glmmTMB(Bolt_Survival ~ treatment+Standardize(CGResi) + Standardize(Fern) +  
    (1 | Family) + (1 | Row_Field) ,data=datPlot, family="binomial")
fit2<- glmmTMB(Bolt_Survival ~ treatment + Standardize(Fern) +  
    (1 | Family) + (1 | Row_Field) ,data=datPlot, family="binomial")

anova(fit1,fit2) #The term is not significant at all. 

summary(fit1)
```

#Permutation test on survival analysis 
```{r}
#Permutation test
#library(PermutateR)


fit<- glmmTMB(Bolt_Survival ~ treatment*PCCG_1 + Fern +  
    (1 | Family) + (1 | Row_Field) ,data=dat2, family="binomial")
summary(fit)

output<-permTest_LR_int(fit, "treatment:PCCG_1","PCCG_1","Chisq",3000,OutputData=T)

#The simulated p value is 0.035 on 3000 iterations, which is significant, but not when leaf size is accounted for.  


```

#Change in mean (manual calculations)
```{r}
##### PC1
dat2$PCCG_1S<-Standardize(dat2$PCCG_1)
dat2$PCCG_2S<-Standardize(dat2$PCCG_2)

#Alone treatment ... -0.03
dat2 %>% filter(treatment=="a",Bolt_Survival==1) %>% summarize(mean(PCCG_1S,na.rm=T)) -
dat2 %>% filter(treatment=="a") %>% summarize(mean(PCCG_1S,na.rm=T)) 

#Maple treatment...0.099
dat2 %>% filter(treatment=="m",Bolt_Survival==1) %>% summarize(mean(PCCG_1S,na.rm=T)) -
dat2 %>% filter(treatment=="m") %>% summarize(mean(PCCG_1S,na.rm=T)) 

#GM treatment...0.433
dat2 %>% filter(treatment=="gm",Bolt_Survival==1) %>% summarize(mean(PCCG_1S,na.rm=T)) -
dat2 %>% filter(treatment=="gm") %>% summarize(mean(PCCG_1S,na.rm=T)) 


##### PC2
#Alone treatment ... 0.0089
dat2 %>% filter(treatment=="a",Bolt_Survival==1) %>% summarize(mean(PCCG_2S,na.rm=T)) -
dat2 %>% filter(treatment=="a") %>% summarize(mean(PCCG_2S,na.rm=T)) 

#Maple treatment...-0.221
dat2 %>% filter(treatment=="m",Bolt_Survival==1) %>% summarize(mean(PCCG_2S,na.rm=T)) -
dat2 %>% filter(treatment=="m") %>% summarize(mean(PCCG_2S,na.rm=T)) 

#GM treatment...-0.321
dat2 %>% filter(treatment=="gm",Bolt_Survival==1) %>% summarize(mean(PCCG_2S,na.rm=T)) -
dat2 %>% filter(treatment=="gm") %>% summarize(mean(PCCG_2S,na.rm=T)) 

#All treatment...-0.16
dat2 %>% filter(Bolt_Survival==1) %>% summarize(mean(PCCG_2S,na.rm=T)) -
dat2 %>%  summarize(mean(PCCG_2S,na.rm=T)) 

summarize(mean(PCCG_2S,na.rm=T)) -
dat2 %>%  summarize(mean(PCCG_2S,na.rm=T)) 



```




#Total fitness analysis -- testing fit of model objects
```{r}
####
#Testing model fit
####

datPlot<-dat2[!is.na(dat2$GM_Fecundity2)&!is.na(dat2$PCCG_1)&!is.na(dat2$Fern)&!is.na(dat2$BlackPathDam)&!is.na(dat2$RGR1)&!is.na(dat2$PC1BoltSize),]

fit<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2)
hist(residuals(fit),breaks=20)
plot(residuals(fit)~fitted(fit))
plot(fitted(fit),log(datPlot$GM_Fecundity2+1))+abline(a=0,b=1) #This is actually a pretty good model. 
shapiro.test(residuals(fit)) #The fit is not that bad. 

#
fit<-glmmTMB(GM_Fecundity2~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2,family=nbinom2)
hist(residuals(fit),breaks=20)
plot(residuals(fit)~fitted(fit))
plot(fitted(fit),log(datPlot$GM_Fecundity2+1))+abline(a=0,b=1) #This is not a great fit. 
shapiro.test(residuals(fit)) #The fit is not that bad. 


fit<-glmmTMB(GM_Fecundity2~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2,family=tweedie)
hist(residuals(fit),breaks=20)
plot(residuals(fit)~fitted(fit))
plot(fitted(fit),log(datPlot$GM_Fecundity2+1))+abline(a=0,b=1) #This is also not great.


fit<-glm(GM_Fecundity2~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2,family=tweedie(link.power = 0, var.power = 2))
hist(residuals(fit),breaks=20)
plot(residuals(fit)~fitted(fit))
plot(fitted(fit),log(datPlot$GM_Fecundity2+1))+abline(a=0,b=1) #This is also not great.

library(statmod)
library(tweedie)

tweedie.profile( GM_Fecundity2~1, p.vec=seq(1.1, 5, length=30),data=dat2)



fit<-glm(GM_Fecundity2~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2,family=tweedie(link.power = 0, var.power = 2))

fit<-glm(GM_Fecundity2~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2,family=tweedie(link.power = 0, var.power = 1.906897))
hist(residuals(fit),breaks=20)
plot(residuals(fit)~fitted(fit))
plot(fitted(fit),log(datPlot$GM_Fecundity2+1))+abline(a=0,b=1) #This is also not a great model. 

CI95<-function(x){
  x<-x[!is.na(x)]
  error <- qnorm(0.975)*sd(x)/sqrt(length(x))
  upper<-round(mean(x)+error,2)
  lower<-round(mean(x)-error,2)
  return(paste(round(error,2)))

}

dat2 %>% filter(!is.na(GM_Fecundity2)) %>% group_by(treatment) %>% summarize(mean=mean( GM_Fecundity2,na.rm=T),CI=CI95(GM_Fecundity2))
```

#Total fitness analysis --modelling without bolt size included. 
Random effects that were not significant  are now significant. 
```{r}
####
#Modelling
####

#Maximum model ... 
fit<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+(1|Col_Field)+Transplant_Size_GM,data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

fit2<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Transplant_Size_GM+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

fit3<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Transplant_Size_GM+(1|Family)+(1|gh_bench),data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

fit4<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Transplant_Size_GM+(1|Family),data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

fit5<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Transplant_Size_GM+(1|Row_Field),data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

fit6<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Transplant_Size_GM,data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

#IS column in field significant?
anova(fit,fit4) # No

#IS row in field significant?
anova(fit2,fit4) #Yes - this is now highly significant with bolt size excluded.

#IS gh_bench  significant?
anova(fit3,fit4) #No.

#IS family  significant?
anova(fit5,fit2) #Yes, family is now highly significant. 

###Modelling fixed effects 

#IS Transplant size significant?
fit1<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Transplant_Size_GM+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$BlackPathDam),])
fit2<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+BlackPathDam+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$BlackPathDam),])
anova(fit1,fit2) #No

#IS Black Path  dam significant?
fit1<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$BlackPathDam),])
fit2<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$BlackPathDam),])
anova(fit1,fit2) #No


#IS Fern significant?
fit2<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$Fern),])
fit3<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$Fern),])
anova(fit2,fit3) #No but close p = 0.09


###
# Testing life history data now
###

#Is RGR significant?
fit3<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$RGR1),])
fit4<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(GM_TotalLeaf_Area)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$RGR1),])
anova(fit3,fit4) # no


#Is Total leaf area (year 1) significant?
fit3<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(GM_TotalLeaf_Area)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$GM_TotalLeaf_Area),])
fit4<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$GM_TotalLeaf_Area),])
anova(fit3,fit4) #No



###
# Testing leaf treats now
###
fit5<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+(1|Family)+(1|Row_Field),data=dat2)


#IS the interaction between treatment and PCCG_2 significant?
fit6<-update(fit5,~.-treatment:PCCG_2)
anova(fit6,fit5) #No. 

#IS the interaction between treatment and PCCG_1 significant?

fit7<-update(fit6,~.-treatment:PCCG_1)
anova(fit7,fit6) #No 

#IS PCCG_2 significant? 
fit8<-update(fit7,~.-PCCG_2)
anova(fit8,fit7) #No

#Is pccg_1 significant?
fit12<-glmmTMB(log(GM_Fecundity2+1)~treatment+PCCG_1+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$PCCG_1),])
fit13<-glmmTMB(log(GM_Fecundity2+1)~treatment +(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$PCCG_1),])
anova(fit12,fit13)# No.


#Is treatment significant?
fit12<-glmmTMB(log(GM_Fecundity2+1)~treatment+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$PCCG_1),])
fit13<-glmmTMB(log(GM_Fecundity2+1)~1 +(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$PCCG_1),])
anova(fit12,fit13)# Yes, treatment is highly significant and that is all. 

summary(fit12) # Competition with maple and GM affecting total fitness relatively equally. 


#Reassessing PCCG_2 without random effect of family
fit12<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_2+(1|Row_Field),data=dat2[!is.na(dat2$PCCG_1),])
fit13<-glmmTMB(log(GM_Fecundity2+1)~treatment+PCCG_2+(1|Row_Field),data=dat2[!is.na(dat2$PCCG_1),])
anova(fit12,fit13) # interaction not significant. 

fit12<-glmmTMB(log(GM_Fecundity2+1)~treatment+PCCG_2+(1|Row_Field),data=dat2[!is.na(dat2$PCCG_1),])
fit13<-glmmTMB(log(GM_Fecundity2+1)~treatment+(1|Row_Field),data=dat2[!is.na(dat2$PCCG_1),])
anova(fit12,fit13) # Variable not significant.

#Best model: 

fit12<-glmmTMB(log(GM_Fecundity2+1)~treatment+(1|Family)+(1|Row_Field),data=dat2)

#Reassessing PCCG_2 without the effect of family. 

fit12<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_2+(1|Row_Field),data=dat2[!is.na(dat2$PCCG_2),])
fit13<-glmmTMB(log(GM_Fecundity2+1)~treatment+PCCG_2+(1|Row_Field),data=dat2[!is.na(dat2$PCCG_2),])
anova(fit12,fit13) # not significant. 


fit12<-glmmTMB(log(GM_Fecundity2+1)~treatment+(1|Row_Field),data=dat2[!is.na(dat2$PCCG_2),])
fit13<-glmmTMB(log(GM_Fecundity2+1)~treatment+PCCG_2+(1|Row_Field),data=dat2[!is.na(dat2$PCCG_2),])
anova(fit12,fit13) # Not significant. 


#Extracting data object from model fit.

Lifetime<-model.frame(glmmTMB(GM_Fecundity2~treatment+(1|Family)+(1|Row_Field),data=dat2))
#Calculating relative fitness
Lifetime$GM_Fecundity2MS<-Standardize(Lifetime$GM_Fecundity2,meanSTD = T)

fit12<-glmmTMB(GM_Fecundity2MS~treatment+(1|Family)+(1|Row_Field),data=Lifetime)
summary(fit12) #The coefficients are still reaching beyond zero. A result of a poor model fit? ...

plot(fitted(fit12)~Lifetime$GM_Fecundity2MS)

min(Lifetime$GM_Fecundity2MS) 
model.frame(fit12) #A result of a poor model fit. 

```

#Permutation test on total fitness  
```{r}
#Permutation test
#library(PermutateR)

#Tests on treatment.
fit<-lme4::glmer(GM_Fecundity2MS~treatment+(1|Family)+(1|Row_Field),data=dat2)

summary(fit)
TreamentTotPerm<-permTest_Contrast(fit,
                Test_Parameter = c("treatmentgm","treatmentm"),
                Randomize_Variables = "treatment",
                Test_Statistic = "t value",
                Replication=10000
                ,OutputData=T)

TreamentTotPerm

#Tests on leaf traits. 
fit<-lm(GM_Fecundity2 ~ treatment * PCCG_2  ,data=dat2[!is.na(dat2$PCCG_1),])


output<-permTest_LR(fit, "PCCG_2","F",1000,OutputData=T)

permTest_LR_int(fit,
                Test_Parameter = "treatment:PCCG_2",
                Randomize_Variables = "PCCG_2",
                Test_Statistic = "F",
                Replication=1000
                ,OutputData=T)

output #The p values are very accurate for this model it seems. Neither interaction nor p value are significant. 



#Now assessing on PCCG_1
fit<-lm(GM_Fecundity2 ~ treatment * PCCG_1  ,data=dat2[!is.na(dat2$PCCG_1),])

fit2<-lm(GM_Fecundity2 ~ treatment + PCCG_1  ,data=dat2[!is.na(dat2$PCCG_1),])


#Interaction
output<-permTest_LR_int(fit,
                Test_Parameter = "treatment:PCCG_1",
                Randomize_Variables = "PCCG_1",
                Test_Statistic = "F",
                Replication=10000
                ,OutputData=T)

output #The interaction is close to significance at p = 0.072
#effect
output2<-permTest_LR(fit2, "PCCG_1","F",10000,OutputData=T) #Alone it is very much not significant. 


output2 

```






# Maple Models

#### GM effect on Maple performance year 1? (within treatment)
```{r}
#Is bench important? 
fit<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+PCCG_1+PCCG_2+(1|gh_bench), data=MapleModel)
fit2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+PCCG_1+PCCG_2, data=MapleModel)
anova(fit,fit2) #No it is not.

#Modelling fixed effects. 
#Is RGR significant?
fit0<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+PCCG_1+PCCG_2+MapleDamage+Family+GM_TotalLeaf_Area+Fern+RGR1, data=MapleModel[!is.na(MapleModel$RGR1),])
fit<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+PCCG_1+PCCG_2+MapleDamage+Family+GM_TotalLeaf_Area+Fern, data=MapleModel[!is.na(MapleModel$RGR1),])
anova(fit,fit0) # no

#Is family significant?
fit<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+PCCG_1+PCCG_2+MapleDamage+Family+GM_TotalLeaf_Area+Fern, data=MapleModel)
fit2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+PCCG_1+PCCG_2+MapleDamage+GM_TotalLeaf_Area+Fern, data=MapleModel)
anova(fit,fit2) #Family not significant. 
summary(fit2)

#Is TLA significant?
fit<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+PCCG_1+PCCG_2+MapleDamage+GM_TotalLeaf_Area+Fern, data=MapleModel)
fit2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+PCCG_1+PCCG_2+MapleDamage+Fern, data=MapleModel)
anova(fit,fit2) #TLA is not significant. 

#IS PCCG_2 significant?
fit3<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+PCCG_1+PCCG_2+MapleDamage+Fern, data=MapleModel)
fit5<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+MapleDamage+Fern+PCCG_1, data=MapleModel)
anova(fit3,fit5) #Yes it is.... Very interesting. This is the glucosinolate ratio!!

#IS PCCG_1 significant?
fit5<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+MapleDamage+Fern+PCCG_1+PCCG_2, data=MapleModel)

fit6<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+MapleDamage+Fern+PCCG_2, data=MapleModel)
anova(fit6,fit5) #Yes, this is also significant, which was the variable with a treatment interaction in the first place. 

#IS damage significant?
fit7<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+PCCG_1+PCCG_2+Fern, data=MapleModel)
anova(fit7,fit5) #Yes it is. 

#IS Fern significant?
fit8<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+PCCG_1+PCCG_2+MapleDamage, data=MapleModel)
anova(fit5,fit8) #No it is not. 

#IS initial size significant?
fit9<-glmmTMB(Maple_TotalLeafArea_End~PCCG_1+PCCG_2+MapleDamage+Fern, data=MapleModel)
anova(fit9,fit8) #Yes it is. Very much so. 


#The best model is:
fit3<-glmmTMB(Standardize(Maple_TotalLeafArea_End,meanSTD = T)~Standardize(PC1Tot)+Standardize(PCCG_1)+Standardize(PCCG_2)+Standardize(MapleDamage), data=MapleModel)
summary(fit3)





plot(residuals(fit3,type="pearson"),fitted(fit3))

plot(residuals(fit3,type="pearson"))
qqnorm(residuals(fit3,type="pearson"))
```

#### GM effect on Maple  performance year 2? (within treatment)
```{r}
MapleModel$Bolt_Survival<-as.factor(MapleModel$Bolt_Survival)

#Is bench important? 
fit<-glmmTMB(log(MapleFinalMass)~PC1Tot+PCCG_1+PCCG_2+(1|gh_bench), data=MapleModel)
fit2<-glmmTMB(log(MapleFinalMass)~PC1Tot+PCCG_1+PCCG_2, data=MapleModel)
anova(fit,fit2) #No it is not.

#Is col field important? 
fit<-glmmTMB(log(MapleFinalMass)~PC1Tot+PCCG_1+PCCG_2+(1|Col_Field), data=MapleModel[!is.na(MapleModel$Col_Field),])
fit2<-glmmTMB(log(MapleFinalMass)~PC1Tot+PCCG_1+PCCG_2, data=MapleModel[!is.na(MapleModel$Col_Field),])
anova(fit,fit2) #No it is not.

#Is row field important? 
fit<-glmmTMB(log(MapleFinalMass)~PC1Tot+PCCG_1+PCCG_2+(1|Row_Field), data=MapleModel[!is.na(MapleModel$Row_Field),])
fit2<-glmmTMB(log(MapleFinalMass)~PC1Tot+PCCG_1+PCCG_2, data=MapleModel[!is.na(MapleModel$Row_Field),])
anova(fit,fit2) #Yes it is, p=0.019


#Modelling fixed effects. 

#Is RGR significant?
fit<-glmmTMB(log(MapleFinalMass)~PC1Tot+PCCG_1+PCCG_2+MapleDamage+Family+GM_TotalLeaf_Area+Fern+Bolt_Survival+RGR1+(1|Row_Field), data=MapleModel[!is.na(MapleModel$RGR1),])
fit2<-glmmTMB(log(MapleFinalMass)~PC1Tot+PCCG_1+PCCG_2+MapleDamage+Family+GM_TotalLeaf_Area+Fern+Bolt_Survival+(1|Row_Field), data=MapleModel[!is.na(MapleModel$RGR1),])
anova(fit,fit2) # no

fit<-glmmTMB(log(MapleFinalMass)~PC1Tot+PCCG_1+PCCG_2+MapleDamage+Family+GM_TotalLeaf_Area+Fern+Bolt_Survival+(1|Row_Field), data=MapleModel)

fit2<-glmmTMB(log(MapleFinalMass)~PC1Tot+PCCG_1+PCCG_2+MapleDamage+GM_TotalLeaf_Area+Fern+Bolt_Survival+(1|Row_Field), data=MapleModel)
anova(fit,fit2) #Family not significant. 
summary(fit2)

fit3<-update(fit2,~.-GM_TotalLeaf_Area)
anova(fit2,fit3) #Total leaf area is  significant. 

#Is PCCG_2 significant?
fit4<-update(fit2,~.- PCCG_2)
anova(fit2,fit4) #No


#Is Bolt_Survival significant?
fit5<-glmmTMB(log(MapleFinalMass) ~ PC1Tot + PCCG_1 + MapleDamage +  
    GM_TotalLeaf_Area + Fern + Bolt_Survival+(1|Row_Field),data=MapleModel[!is.na(MapleModel$Bolt_Survival),])
fit6<-update(fit5,~.- Bolt_Survival)
anova(fit5,fit6) #No

#IS maple damage significant? 
fit6<-glmmTMB(log(MapleFinalMass) ~ PC1Tot + PCCG_1 + MapleDamage +  
    GM_TotalLeaf_Area + Fern+(1|Row_Field) ,data=MapleModel)
fit7<-glmmTMB(log(MapleFinalMass) ~ PC1Tot + PCCG_1  +  
    GM_TotalLeaf_Area + Fern+(1|Row_Field) ,data=MapleModel)
anova(fit6,fit7)#No.

#IS PCCG_1?
fit7<-glmmTMB(log(MapleFinalMass) ~ PC1Tot + PCCG_1  +  
    GM_TotalLeaf_Area + Fern+(1|Row_Field) ,data=MapleModel[!is.na(MapleModel$PCCG_1),])
fit8<-update(fit7,~.-PCCG_1)
anova(fit7,fit8) #no

#Is Fern
fit9<-glmmTMB(log(MapleFinalMass) ~ PC1Tot   +  
    GM_TotalLeaf_Area + Fern+(1|Row_Field) ,data=MapleModel[!is.na(MapleModel$Fern),])
fit10<-update(fit9,~.-Fern)
anova(fit9,fit10) #no Fern did not have effects on maple at all. 


#Is GM size in second year important? 
fit9<-glmmTMB(log(MapleFinalMass) ~ PC1Tot   +  
    GM_TotalLeaf_Area +PC1BoltSize+(1|Row_Field) ,data=MapleModel[!is.na(MapleModel$PC1BoltSize),])
fit10<-update(fit9,~.-PC1BoltSize)
anova(fit9,fit10) #GM Size in second year is very close to significant at p=0.054, but not significant.. 


#Is maple initial size significant?
fit9<-glmmTMB(log(MapleFinalMass) ~ Standardize(PC1Tot)  +
   Standardize( GM_TotalLeaf_Area )+(1|Row_Field) ,data=MapleModel[!is.na(MapleModel$PC1Tot),])
fit10<-update(fit9, ~.-Standardize( PC1Tot ))
anova(fit9,fit10) #Yes.

#Best model is
fit9<-glmmTMB(log(MapleFinalMass) ~ Standardize(PC1Tot)  +
   Standardize( GM_TotalLeaf_Area ) +(1|Row_Field),data=MapleModel)
summary(fit9)

#Best model STD
fit9<-glmmTMB(Standardize(MapleFinalMass,meanSTD=T) ~ Standardize(PC1Tot)  +
   Standardize( GM_TotalLeaf_Area ) +(1|Row_Field),data=MapleModel)
summary(fit9)




plot(residuals(fit9,type="pearson"),fitted(fit9))

plot(residuals(fit9,type="pearson"))
qqnorm(residuals(fit9,type="pearson"))

#PErmutation test on this 

MapleModel$MapleFinalMassMS<-Standardize(MapleModel$MapleFinalMass,meanSTD = T)
MapleModel$PC1TotS<-Standardize(MapleModel$PC1Tot)
MapleModel$GM_TotalLeaf_AreaS<-Standardize(MapleModel$GM_TotalLeaf_Area)

fit10<-lme4::lmer(MapleFinalMassMS ~ PC1TotS  +
    GM_TotalLeaf_AreaS + (1|Row_Field),data=MapleModel)
summary(fit10)

Maple2PermInit<-permTest_Contrast(fit10,"PC1TotS","PC1TotS","t value",10000)
Maple2PermInit #Both p are , <0.001


Maple2PermGM<-permTest_Contrast(fit10,"GM_TotalLeaf_AreaS","GM_TotalLeaf_AreaS","t value",10000)

Maple2PermGM#Both p are , <0.001

```

#Treatment effect maple year 1 (among treatment)
```{r}
Maple$treatment<-relevel(Maple$treatment,ref="mcnt")

#Is Bench significant?
fit1<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+treatment+Fern+MapleDamage+(1|gh_bench),data=Maple)
fit2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+treatment+Fern+MapleDamage,data=Maple)
anova(fit1,fit2) #NO

#Is Damage significant?
fit1<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+treatment+Fern+MapleDamage,data=Maple)
fit2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+treatment+Fern,data=Maple)
anova(fit1,fit2) #Yes

#Is Fern significant?
fit1<-glmmTMB(Standardize(Maple_TotalLeafArea_End)~Standardize(PC1Tot)+treatment+Standardize(Fern)+Standardize(MapleDamage),data=Maple)
fit2<-glmmTMB(Standardize(Maple_TotalLeafArea_End)~Standardize(PC1Tot)+treatment+Standardize(MapleDamage),data=Maple)
anova(fit1,fit2) #Yes
summary(fit1)
summary(fit2)



#Is treatment significant?
fit1<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+Fern+MapleDamage,data=Maple)
fit2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+treatment+Fern+MapleDamage,data=Maple)
anova(fit1,fit2) #Yes

#Best model is: 
fit1<-glmmTMB(Standardize(Maple_TotalLeafArea_End,meanSTD=T)~Standardize(PC1Tot)+treatment+Standardize(Fern)+Standardize(MapleDamage),data=Maple)
summary(fit1)

```

#Treatment effect maple year 2 (among treatment)
```{r}
#Feild row and collumn could not be assessed here because the maple controls are missing those data. 

#Is Bench significant?
fit1<-glmmTMB(log(MapleFinalMass)~PC1Tot+treatment+Fern+MapleDamage+(1|gh_bench),data=Maple)
fit2<-glmmTMB(log(MapleFinalMass)~PC1Tot+treatment+Fern+MapleDamage,data=Maple)
anova(fit1,fit2) #NO

#Is Damage significant?
fit1<-glmmTMB(log(MapleFinalMass)~PC1Tot+treatment+Fern+MapleDamage,data=Maple)
fit2<-glmmTMB(log(MapleFinalMass)~PC1Tot+treatment+Fern,data=Maple)
anova(fit1,fit2) #No

#Is Fern significant?
fit1<-glmmTMB(log(MapleFinalMass)~PC1Tot+treatment+Fern+MapleDamage,data=Maple)
fit2<-glmmTMB(log(MapleFinalMass)~PC1Tot+treatment+MapleDamage,data=Maple)
anova(fit1,fit2) #No
#no

#Is treatment significant?
fit1<-glmmTMB(log(MapleFinalMass)~PC1Tot,data=Maple)
fit2<-glmmTMB(log(MapleFinalMass)~PC1Tot+treatment,data=Maple)
anova(fit1,fit2) #Yes

#Is PC1Tot significant?
fit1<-glmmTMB(log(MapleFinalMass)~treatment+PC1Tot,data=Maple)
fit2<-glmmTMB(log(MapleFinalMass)~treatment,data=Maple)
anova(fit1,fit2) #Yes

#The best model is (with mean std: 
fit<-glmmTMB(Standardize(MapleFinalMass,meanSTD = T)~treatment+PC1Tot,data=Maple)
summary(fit)
```



# Path analysis

#Anova on greenhouse bench for use in the path analyses 
Nominal variables not accepted. Determining where the real differences lie with method of crawley from the R book. 

I think that i should still log fecundity and total fitness because they were logged before. 
```{r}
#Indirect effect of leaf traits on performance
fitBench<-lm(GM_TotalLeaf_Area~as.factor(gh_bench),data=dat2)
summary(fitBench)
f<-aov(fitBench)
TukeyHSD(f)
#With maple model, they were all different than 1. 

#lets try with merging groups 2-5 and seeing if this changes anything
dat2$gh_bench2<-dat2$gh_bench

dat2$gh_bench2[dat2$gh_bench2 %in% c("2","3","4","5")]<-"0"


#with only two levels
fitBench2<-lm(GM_TotalLeaf_Area~as.factor(gh_bench2),data=dat2)

#with 5 levels 
fitBench1<-lm(GM_TotalLeaf_Area~as.factor(gh_bench),data=dat2)

anova(fitBench2,fitBench1) #There is information lost, but the following is performed only on
#individuals in the maple model, therefore i will test this. 

MapleModel2<-dat2[dat2$treatment=="m",]
#with only two levels
fitBench2<-lm(GM_TotalLeaf_Area~as.factor(gh_bench2),data=MapleModel2)
summary(fitBench2)
#with 5 levels 
fitBench1<-lm(GM_TotalLeaf_Area~as.factor(gh_bench),data=MapleModel2)

anova(fitBench2,fitBench1) #This difference is not significant, therefore i can just include
#one variable for greenhouse bench classifying as either bench 1 or bench 2. 

#
fitBench1<-lm(GM_TotalLeaf_Area~as.factor(gh_bench),data=MapleModel2)
fitBench<-lm(GM_TotalLeaf_Area~1,data=MapleModel2)
anova(fitBench1,fitBench)



#Testing the same thing for survival. 


fitRow<-glmmTMB(Bolt_Survival~as.factor(Row_Field),family="binomial",data=MapleModel[!is.na(MapleModel$Row_Field),])
fitRow2<-glmmTMB(Bolt_Survival~1,family="binomial",data=MapleModel[!is.na(MapleModel$Row_Field),])
anova(fitRow,fitRow2) #Row is not significant considering only the maples. 

#Can i take out the insignificant levels?
summary(fitRow)
anova(fitBench2,fitBench1) #There is information lost, but the following is performed only on
#individuals in the maple model, therefore i will test this. 



```

#### Modifying variables for path analysis
```{r}
library(lavaan)


#Standardizing variables by the entire population parameters to be consistent and reflect more relevant data. 

#Mean standardizing GM total leaf area from whole population. 
MapleModel$GM_TotalLeaf_AreaMS<-Standardize(MapleModel$GM_TotalLeaf_Area,SupplyDatStat = dat2$GM_TotalLeaf_Area,meanSTD = T)

#Standardizing maple total leaf area by SD in whole population. 
MapleModel$Maple_TotalLeafArea_EndS<-Standardize(MapleModel$Maple_TotalLeafArea_End,SupplyDatStat = dat2$Maple_TotalLeafArea_End )

MapleModel$Maple_TotalLeafArea_EndS2<-Standardize(MapleModel$Maple_TotalLeafArea_End)

#This one can be standardized by whole population.
MapleModel$BlackPathDamS<-Standardize(MapleModel$BlackPathDam,SupplyDatStat = dat2$BlackPathDam)

#Standardizing bolt survival by the mean of the entire population.
MapleModel$Bolt_SurvivalMS<-Standardize(MapleModel$Bolt_Survival,SupplyDatStat = dat2$Bolt_Survival,meanSTD = T)

#Standardizing fern survival by the mean of the entire population.
MapleModel$FernS<-Standardize(MapleModel$Fern,SupplyDatStat = dat2$Fern)

#Standardizing PCCG_1 by entire population
MapleModel$PCCG_1S<-Standardize(MapleModel$PCCG_1,SupplyDatStat = dat2$PCCG_1)

#Standardizing PCCG_2 by entire population
MapleModel$PCCG_2S<-Standardize(MapleModel$PCCG_2,SupplyDatStat = dat2$PCCG_2)

#Standardizing bolt size by population sd
MapleModel$PC1BoltSizeS<-Standardize(MapleModel$PC1BoltSize,SupplyDatStat = dat2$PC1BoltSize)

#Mean standardizing gm fecundity by entire data mean
MapleModel$GM_FecundityMS<-Standardize(MapleModel$GM_Fecundity,SupplyDatStat = dat2$GM_Fecundity,meanSTD = T)

MapleModel$GM_FecundityLMS<-Standardize(log(MapleModel$GM_Fecundity),SupplyDatStat = log(dat2$GM_Fecundity),meanSTD = T)


#Mean standardizing gm fecundity2 (Total fitness) by entire data mean
MapleModel$GM_Fecundity2MS<-Standardize(MapleModel$GM_Fecundity2,SupplyDatStat = dat2$GM_Fecundity2,meanSTD = T)

#Logging and standardizing total fitness. 
MapleModel$GM_Fecundity2LMS<-Standardize(log(MapleModel$GM_Fecundity2+1),SupplyDatStat = log(dat2$GM_Fecundity2+1),meanSTD = T)

#Transplant size
MapleModel$Transplant_Size_GMS<-Standardize(MapleModel$Transplant_Size_GM,SupplyDatStat = dat2$Transplant_Size_GM,meanSTD = F)

Transplant_Size_GM

###----
#Standardizing PCCG_1 by entire population by mean 

#Transfering the mean so that it is not zero. 
dat2$PCCG_1_T<-dat2$PCCG_1+min(dat2$PCCG_1,na.rm=T)
MapleModel$PCCG_1_T<-MapleModel$PCCG_1+abs(min(MapleModel$PCCG_1,na.rm=T))

#Standardizing
MapleModel$PCCG_1MS<-Standardize(MapleModel$PCCG_1_T,SupplyDatStat = dat2$PCCG_1_T,meanSTD = T)

###----
#Standardizing PCCG_2 by entire population by mean

#Transfering the mean so that it is not zero. 
dat2$PCCG_2_T<-dat2$PCCG_2+abs(min(dat2$PCCG_2,na.rm=T))
MapleModel$PCCG_2_T<-MapleModel$PCCG_2+abs(min(MapleModel$PCCG_2,na.rm=T))

MapleModel$PCCG_2MS<-Standardize(MapleModel$PCCG_2_T,SupplyDatStat = dat2$PCCG_2_T,meanSTD = T)


#Modifying the gh_bench variable
MapleModel$gh_bench<-as.numeric(MapleModel$gh_bench)

MapleModel$gh_bench2<-MapleModel$gh_bench

MapleModel$gh_bench2[MapleModel$gh_bench2 %in% c(2,3,4,5)]<-0

MapleModel$gh_bench2


```

#### Path analysis GM performance
```{r}

#Indirect effect of leaf traits on performance

# MapleFormula_1_1 <- '
# Maple_TotalLeafArea_EndS2 ~ PC1Tot+B1*PCCG_1S + MapleDamage + B2*PCCG_2S
# 
# GM_TotalLeaf_AreaMS ~ B3*Maple_TotalLeafArea_EndS2 + BlackPathDamS +FernS + PCCG_1S+PCCG_2S+ gh_bench2+Transplant_Size_GMS
# 
# indirect_PCCG_1 := B1 * B3
# indirect_PCCG_2 := B2 * B3
# '

#testing without greenhouse bench
MapleFormula_1_1 <- '
Maple_TotalLeafArea_EndS2 ~ PC1Tot+B1*PCCG_1S + MapleDamage + B2*PCCG_2S

GM_TotalLeaf_AreaMS ~ B3*Maple_TotalLeafArea_EndS2 + BlackPathDamS +FernS + PCCG_1S+PCCG_2S+Transplant_Size_GMS

indirect_PCCG_1 := B1 * B3
indirect_PCCG_2 := B2 * B3
'


fit<-sem(MapleFormula_1_1,data=MapleModel)
summary(fit)

source("/Users/richardhonor/Documents/PermutateR/R/permTest_LR.R")
source("/Users/richardhonor/Documents/PermutateR/R/permTest_LR_int.R")
source("/Users/richardhonor/Documents/PermutateR/R/permTest_Contrast.R")

source("/Users/richardhonor/Documents/PermutateR/R/model_extract.R")
source("/Users/richardhonor/Documents/PermutateR/R/new_data.R")


#Permutation tests.
OutIndirPerfPC2<- permTest_Contrast(fit,c("indirect_PCCG_2"),"PCCG_2S","z",10000,Data_Supplement = MapleModel,OutputData = T) #Will work now. 

OutIndirPerfPC2
# [1] "The simulated p-value value for test parameter indirect_PCCG_2 is: 0.0101"

OutIndirPerfPC1<-permTest_Contrast(fit,c("indirect_PCCG_1"),"PCCG_1S","z",10000,Data_Supplement = MapleModel,OutputData = T) 
# [1] "The simulated p-value value for test parameter indirect_PCCG_1 is: 0.0086"

OutIndirPerfPC1

OutdirPerfMapl<-permTest_Contrast(fit,c("Maple_TotalLeafArea_EndS2"),"Maple_TotalLeafArea_EndS2","z",10000,Data_Supplement = MapleModel,OutputData = T,Dependent_Variable =c("GM_TotalLeaf_AreaMS"))
OutdirPerfMapl

# [1] "The simulated p-value value for test parameter Maple_TotalLeafArea_EndS2 is: 0.0195"

#Direct PC1
OutdirPerfPC1<-permTest_Contrast(fit,c("PCCG_1S"),"PCCG_1S","z",10000,Data_Supplement = MapleModel,OutputData = T,Dependent_Variable =c("GM_TotalLeaf_AreaMS"))
OutdirPerfPC1
# [1] "The simulated p-value value for test parameter PCCG_1S is: 0.0748"

#Direct PC2
OutdirPerfPC2<-permTest_Contrast(fit,c("PCCG_2S"),"PCCG_2S","z",10000,Data_Supplement = MapleModel,OutputData = T,Dependent_Variable =c("GM_TotalLeaf_AreaMS"))

OutdirPerfPC2 
# [1] "The simulated p-value value for test parameter PCCG_2S is: 0.1487"



```

#### Path analysis survival
```{r}

#Selection gradient of survival
MapleFormula_1_1 <- '
Maple_TotalLeafArea_EndS ~ PC1Tot+ B1*PCCG_1S + MapleDamage + B2*PCCG_2S

Bolt_SurvivalMS ~   FernS + B3*Maple_TotalLeafArea_EndS + PCCG_2S+PCCG_1S
    
indirect_PCCG_1 := B1 * B3
indirect_PCCG_2 := B2 * B3
'


fit<-sem(MapleFormula_1_1,data=MapleModel)
summary(fit)

plot(MapleModel$Maple_TotalLeafArea_EndS2~MapleModel$Maple_TotalLeafArea_EndS)
MapleModel$Maple_TotalLeafArea_EndS
#Very interesting, there is direct selection for relative investment both through maple performance and directly on the plant. This may reflect benefits for competition and benefits through some other mechanism other than maple increasing survival. Adding up these effects results in the total direct selection, which matches up very closesly to the selection gradient i calculated manually at 20%. Very nice result. I must also do the perm test on the direct effect of PCG2 on survival now. 



#Permutation test on this
library("PermutateR")

source("/Users/richardhonor/Documents/PermutateR/R/permTest_LR.R")
source("/Users/richardhonor/Documents/PermutateR/R/permTest_LR_int.R")
source("/Users/richardhonor/Documents/PermutateR/R/permTest_Contrast.R")

source("/Users/richardhonor/Documents/PermutateR/R/model_extract.R")
source("/Users/richardhonor/Documents/PermutateR/R/new_data.R")


OutdirSurvPC2<-permTest_Contrast(fit,c("PCCG_2S"),"PCCG_2S","z",10,Data_Supplement = MapleModel,OutputData = T,Dependent_Variable =c("Bolt_SurvivalMS"))
OutdirSurvPC2
#[1] "The simulated p-value value for test parameter PCCG_2S is: 0.3032"

OutdirSurvPC1<-permTest_Contrast(fit,c("PCCG_1S"),"PCCG_1S","z",10000,Data_Supplement = MapleModel,OutputData = T,Dependent_Variable =c("Bolt_SurvivalMS"))
OutdirSurvPC1
#[1] "The simulated p-value value for test parameter PCCG_1S is: 0.83"



OutIndirSurvPC2<-permTest_Contrast(fit,c("indirect_PCCG_2"),"PCCG_2S","z",10000,Data_Supplement = MapleModel,OutputData = T)
#"The simulated p-value value for test parameter indirect_PCCG_2 is: 0.0166"
OutIndirSurvPC2


OutIndirSurvPC1<-permTest_Contrast(fit,c("indirect_PCCG_1"),"PCCG_1S","z",10000,Data_Supplement = MapleModel,OutputData = T)
#[1] "The simulated p-value value for test parameter indirect_PCCG_1 is: 0.0016"
OutIndirSurvPC1


OutdirSurvMapl<-permTest_Contrast(fit,c("Maple_TotalLeafArea_EndS"),"Maple_TotalLeafArea_EndS","z",10000,Data_Supplement = MapleModel,OutputData = T,Dependent_Variable =c("Bolt_SurvivalMS"))
#"The simulated p-value value for test parameter Maple_TotalLeafArea_EndS is: 0.0122"
OutdirSurvMapl

```

#### Path analysis Fecundity
```{r}

#Fecundity data 

MapleFormula_1_1 <- '
Maple_TotalLeafArea_EndS ~ PC1Tot+B1*PCCG_1S + MapleDamage + B2*PCCG_2S

GM_FecundityMS~B3*Maple_TotalLeafArea_EndS +PCCG_2S+PCCG_1S + Transplant_Size_GMS

indirect_PCCG_1 := B1 * B3
indirect_PCCG_2 := B2 * B3

'

fit<-sem(MapleFormula_1_1,data=MapleModel)
summary(fit)

#Permutations 
OutIndirFecPC1<-permTest_Contrast(fit,c("indirect_PCCG_1"),"PCCG_1S","z",10000,Data_Supplement = MapleModel,OutputData = T)
OutIndirFecPC1

#[1] "The simulated p-value value for test parameter indirect_PCCG_1 is: 0.8697"

out<-c()
for(i in 1:20){
OutIndirFecPC2<-permTest_Contrast(fit,c("indirect_PCCG_2"),"PCCG_2S","z",100,Data_Supplement = MapleModel,OutputData = T)
out<-append(out,OutIndirFecPC2[[3]])
}
length(out[abs(out)>0.10946374396042])/length(out)
#The simulated p value is 0.7816.

#Finding the effect of maple 
OutdirFecMapl<-permTest_Contrast(fit,c("Maple_TotalLeafArea_EndS"),"Maple_TotalLeafArea_EndS","z",10000,Data_Supplement = MapleModel,OutputData = T,Dependent_Variable =c("GM_FecundityMS"))
OutdirFecMapl
#"The simulated p-value value for test parameter Maple_TotalLeafArea_EndS is: 0.9218"

out<-c()
for(i in 1:1000){
OutdirFecPC1<-permTest_Contrast(fit,c("PCCG_1S"),"PCCG_1S","z",10,Data_Supplement = MapleModel,OutputData = T,Dependent_Variable =c("GM_FecundityMS"))
out<-append(out,OutdirFecPC1[[3]])
}
out
length(out[abs(out)>2.04705760607548])/length(out) 
#[1] "The simulated p-value value for test parameter PCCG_1S is: 0.1137809"


#Direct PC2
out<-c()
for(i in 1:100){
OutdirFecPC2<-permTest_Contrast(fit,c("PCCG_2S"),"PCCG_2S","z",100,Data_Supplement = MapleModel,OutputData = T,Dependent_Variable =c("GM_FecundityMS"))
out<-append(out,OutdirFecPC2[[3]])
}
out
length(out[abs(out)>1.43111769100453])/length(out) 

#[1] "The simulated p-value value for test parameter PCCG_2S is: 0.250354"


```

#### Path analysis lifetime fitness
```{r}
MapleFormula_1_1 <- '
 Maple_TotalLeafArea_EndS ~ PC1Tot+ B1*PCCG_1S + MapleDamage + B2*PCCG_2S


GM_Fecundity2MS~ B3*Maple_TotalLeafArea_EndS +PCCG_1S +PCCG_2S


indirect_PCCG_1 := B1 * B3
indirect_PCCG_2 := B2 * B3

'
fit<-sem(MapleFormula_1_1,data=MapleModel)
summary(fit)



#Permutation test on this
library(PermutateR)

source("/Users/richardhonor/Documents/PermutateR/R/permTest_LR.R")
source("/Users/richardhonor/Documents/PermutateR/R/permTest_LR_int.R")
source("/Users/richardhonor/Documents/PermutateR/R/permTest_Contrast.R")

source("/Users/richardhonor/Documents/PermutateR/R/model_extract.R")
source("/Users/richardhonor/Documents/PermutateR/R/new_data.R")


#OutdirTotPC2<-permTest_Contrast(fit,c("PCCG_2S"),"PCCG_2S","z",10000,Data_Supplement = MapleModel,OutputData = T,Dependent_Variable =c("GM_Fecundity2MS"))
OutdirTotPC2
#[1] "The simulated p-value value for test parameter PCCG_2S is: 0.0487"

#OutdirTotPC1<-permTest_Contrast(fit,c("PCCG_1S"),"PCCG_1S","z",10000,Data_Supplement = MapleModel,OutputData = T,Dependent_Variable =c("GM_Fecundity2MS"))
OutdirTotPC1
#[1] "The simulated p-value value for test parameter PCCG_1S is: 0.0838"



#OutIndirTotPC2<-permTest_Contrast(fit,c("indirect_PCCG_2"),"PCCG_2S","z",10000,Data_Supplement = MapleModel,OutputData = T)
OutIndirTotPC2
#[1] "The simulated p-value value for test parameter indirect_PCCG_2 is: 0.1521"

#OutIndirTotPC1<-permTest_Contrast(fit,c("indirect_PCCG_1"),"PCCG_1S","z",10000,Data_Supplement = MapleModel,OutputData = T)
OutIndirTotPC1
#[1] "The simulated p-value value for test parameter indirect_PCCG_1 is: 0.1782"


#OutdirTotMapl<-permTest_Contrast(fit,c("Maple_TotalLeafArea_EndS"),"Maple_TotalLeafArea_EndS","z",10000,Data_Supplement = MapleModel,OutputData = T,Dependent_Variable =c("GM_Fecundity2MS"))
OutdirTotMapl

#[1] "The simulated p-value value for test parameter Maple_TotalLeafArea_EndS is: 0.2805"

#Interestingly maple is not significant when the effect of PC1 and PC2 are included. This might mean that they share alot of the same variance and so it is eliminating the singificance of maple. I now dont think i should include them as main effects. ...


#[1] "The simulated p-value value for test parameter PCCG_2S is: 0.0487"
#[1] "The simulated p-value value for test parameter PCCG_1S is: 0.0838"
#[1] "The simulated p-value value for test parameter indirect_PCCG_2 is: 0.1521"
#[1] "The simulated p-value value for test parameter indirect_PCCG_1 is: 0.1782"
#[1] "The simulated p-value value for test parameter Maple_TotalLeafArea_EndS is: 0.2805"


```

#Trying different lifetime fecudnity models
```{r}
#Assessing with a log fecundity
MapleFormula_Log <- '
Maple_TotalLeafArea_EndS ~ PC1Tot+ B1*PCCG_1S + MapleDamage + B2*PCCG_2S
GM_Fecundity2LMS~ B3*Maple_TotalLeafArea_EndS +PCCG_1S +PCCG_2S
indirect_PCCG_1 := B1 * B3
indirect_PCCG_2 := B2 * B3
'
fit<-sem(MapleFormula_Log,data=MapleModel)
summary(fit)
AIC(fit)

MapleFormula_Log <- '
Maple_TotalLeafArea_EndS ~ PC1Tot+ B1*PCCG_1S + MapleDamage + B2*PCCG_2S
GM_Fecundity2MS~ B3*Maple_TotalLeafArea_EndS +PCCG_1S +PCCG_2S
indirect_PCCG_1 := B1 * B3
indirect_PCCG_2 := B2 * B3
'
fit<-sem(MapleFormula_Log,data=MapleModel)
summary(fit)
AIC(fit) #This AIC is much higher.. It is otherwise the exact same data so i think the other model explains the data much better.


MapleFormula_1_1 <- '
Maple_TotalLeafArea_EndS ~ PC1Tot+B1*PCCG_1S + MapleDamage + B2*PCCG_2S

GM_FecundityLMS~B3*Maple_TotalLeafArea_EndS +PCCG_2S+PCCG_1S

indirect_PCCG_1 := B1 * B3
indirect_PCCG_2 := B2 * B3

'

fit<-sem(MapleFormula_1_1,data=MapleModel)
summary(fit)

AIC(fit) #Can compare AICs
library(piecewiseSEM)

# Construct SEM... This glm with a poisson estimated very good estimations... i should do this with logged data maybe
glmsem <- psem(
  lm( Maple_TotalLeafArea_EndS ~ PC1Tot+ PCCG_1S + MapleDamage + PCCG_2S, MapleModel),
  glm(GM_Fecundity2MS~ Maple_TotalLeafArea_EndS +PCCG_1S +PCCG_2S
, "poisson", MapleModel)
)

summary(glmsem)


#Testing residuals of GM_Fecundity logged vs not logged. 
 fit<- lm(GM_Fecundity2MS~ Maple_TotalLeafArea_EndS +PCCG_1S +PCCG_2S, MapleModel)
hist(residuals(fit),breaks=20)
plot(residuals(fit)~fitted(fit))
shapiro.test(residuals(fit))
summary(fit)
 fit<- lm(GM_Fecundity2LMS~ Maple_TotalLeafArea_EndS +PCCG_1S +PCCG_2S, MapleModel)
hist(residuals(fit),breaks=20)
plot(residuals(fit)~fitted(fit))
shapiro.test(residuals(fit)) 
summary(fit)

#Both are bad. 
 fit<- glm(GM_Fecundity2LMS~ Maple_TotalLeafArea_EndS +PCCG_1S +PCCG_2S,"poisson", MapleModel)
hist(residuals(fit),breaks=20)
plot(residuals(fit)~fitted(fit))
shapiro.test(residuals(fit)) 

hist(MapleModel$GM_Fecundity2LMS)
 hist(MapleModel$GM_Fecundity2MS)
 
 #Both are bad. 
 fit<- glmmTMB(GM_Fecundity2LMS~ Maple_TotalLeafArea_EndS +PCCG_1S +PCCG_2S,family="nbinom2", data=MapleModel)
 summary(fit)
hist(residuals(fit),breaks=20)
plot(residuals(fit)~fitted(fit))
shapiro.test(residuals(fit)) 



```

#Manual selection gradients for survival and leaf traits. 
```{r}
#model with relative fitness of bolt survival to get selection gradient. 

#Mean change in PCCG 2...: 
mean(dat2$PCCG_2[dat2$Bolt_Survival==1&dat2$treatment!="m"],na.rm=T)-mean(dat2$PCCG_2[dat2$treatment!="m"],na.rm=T)
#Mean PCCG 2 was reduced by -0.089 SD i in other treatments 

mean(MapleModel$PCCG_2S[MapleModel$Bolt_Survival==1],na.rm=T)-mean(MapleModel$PCCG_2S,na.rm=T)
#Mean PCCG_2 was reduced by -0.218 in the maple treatment. 

mean(dat2$PCCG_2[dat2$Bolt_Survival==1&dat2$treatment=="gm"],na.rm=T)-mean(dat2$PCCG_2[dat2$treatment=="gm"],na.rm=T)
#Mean PCCG 2 was reduced by -0.1843 SD i in gm treatments 

mean(dat2$PCCG_2[dat2$Bolt_Survival==1&dat2$treatment=="a"],na.rm=T)-mean(dat2$PCCG_2[dat2$treatment=="a"],na.rm=T)
#Mean PCCG 2 was reduced by -0.1843 SD i in gm treatments 

mean(dat2$PCCG_2[dat2$Bolt_Survival==1],na.rm=T)-mean(dat2$PCCG_2,na.rm=T)
#Mean PCCG 2 was reduced by -0.094 SD in all treatments 


#Mean change in PCCG 1...: 
mean(dat2$PCCG_1[dat2$Bolt_Survival==1&dat2$treatment!="m"],na.rm=T)-mean(dat2$PCCG_1[dat2$treatment!="m"],na.rm=T)
#Mean PCCG 2 was increased by 0.249 in other treatments 

mean(MapleModel$PCCG_1S[MapleModel$Bolt_Survival==1],na.rm=T)-mean(MapleModel$PCCG_1S,na.rm=T)
#Mean PCCG_1 only increased by 0.10 in the maple treatment. 



mean(MapleModel$Bolt_Survival,na.rm=T)-0.05*mean(MapleModel$Bolt_Survival,na.rm=T) # This is pretty close - the sd standardized selection gradient measures the proportion of individuals that re not selected for reproduction



```



#Variance partition analysis

####  Variance partition analysis -- Fitness and bolt size 
```{r}

#Function to extract random effect heritabilities from a glmmTMB model. 
Xtract<-function(x,Resi){
  temp<-VarCorr(x)
GXE=temp$cond$`Family:treatment`[[1]]
E=temp$cond$treatment[[1]]
G=temp$cond$Family[[1]]

G_by_E<-GXE/(GXE+E+G+Resi)
Envir<-E/(GXE+E+G+Resi)
Genet<-G/(GXE+E+G+Resi)
data.frame(Type=c("GXE","E","G"),Value=c(G_by_E,Envir,Genet)*100)
}


#Fecundity with  log 
fit<-glmmTMB(log(GM_Fecundity)~(1|treatment/Family)+(1|Family),data=dat2)
summary(fit)
#Is there an effect of GXE? 
fit2<-glmmTMB(log(GM_Fecundity)~(1|treatment)+(1|Family),data=dat2)
anova(fit,fit2)#No.

#Is there an effect of family? 
fit3<-glmmTMB(log(GM_Fecundity)~(1|treatment),data=dat2)
anova(fit2,fit3)#No. 

#Is there an effect of treatment? 
fit4<-glmmTMB(log(GM_Fecundity)~(1|Family),data=dat2)
anova(fit2,fit4)#Yes. 

summary(fit)
Xtract(fit,1.239e+00) #Large effect of treatment on the values fecundity. 


#Survival 
#some genotypes that were recorded as dead actually grew again from the root to produce a bolt and seeds. I am replacing these with a 1 to designate that they are alive. 


#Conducting analysis on Survival
fit<-glmmTMB(Bolt_Survival~as.factor(Row_Field)+(1|treatment/Family)+(1|Family),data=dat2,family="binomial")
summary(fit)
#Is there an effect of GXE? 
fit2<-glmmTMB(Bolt_Survival~as.factor(Row_Field)+(1|treatment)+(1|Family),data=dat2,family="binomial")
anova(fit,fit2)#No.

#Is there an effect of family? 
fit3<-glmmTMB(Bolt_Survival~as.factor(Row_Field)+(1|treatment),data=dat2,family="binomial")
anova(fit2,fit3)#Yes, very strong effect. 

#Is there an effect of treatment? 
fit4<-glmmTMB(Bolt_Survival~as.factor(Row_Field)+(1|Family),data=dat2,family="binomial")
anova(fit2,fit4)#No, Not at all. 

summary(fit)
Xtract(fit,pi^2/3) #Large effect of treatment on the values fecundity. 
df.residual(fit)
pi^2/3


#Bolt Size

#Is there an effect of row? 
fit0.1<-glmmTMB(PC1BoltSize~1+(1|treatment/Family)+(1|Family),data=dat2)
summary(fit)
fit<-glmmTMB(PC1BoltSize~as.factor(Row_Field)+(1|treatment/Family)+(1|Family),data=dat2)
anova(fit,fit0.1) #Yes there is

#Is there an effect of GXE? 
fit2<-glmmTMB(PC1BoltSize~as.factor(Row_Field)+(1|treatment)+(1|Family),data=dat2)
anova(fit,fit2)#No.

#Is there an effect of family? 
fit3<-glmmTMB(PC1BoltSize~as.factor(Row_Field)+(1|treatment),data=dat2)
anova(fit2,fit3)#no

#Is there an effect of treatment? 
fit4<-glmmTMB(PC1BoltSize~as.factor(Row_Field)+(1|Family),data=dat2)
anova(fit2,fit4)#Yes. 

summary(fit)
Xtract(fit,2.451e+00 ) 

#Lifetime fitness 
#Is there an effect of row? 
fit0.1<-glmmTMB(log(GM_Fecundity2+1)~1+(1|treatment/Family)+(1|Family),data=dat2[!is.na(dat2$Row_Field),])
summary(fit)
fit<-glmmTMB(log(GM_Fecundity2+1)~as.factor(Row_Field)+(1|treatment/Family)+(1|Family),data=dat2[!is.na(dat2$Row_Field),])
anova(fit,fit0.1) #Yes there is

#Is there an effect of GXE? 

fit<-glmmTMB(log(GM_Fecundity2+1)~as.factor(Row_Field)+(1|treatment/Family)+(1|Family),data=dat2)

fit2<-glmmTMB(log(GM_Fecundity2+1)~as.factor(Row_Field)+(1|treatment)+(1|Family),data=dat2)
anova(fit,fit2)#No.

#Is there an effect of family? 
fit3<-glmmTMB(log(GM_Fecundity2+1)~as.factor(Row_Field)+(1|treatment),data=dat2)
anova(fit2,fit3)#Yes

#Is there an effect of treatment? 
fit4<-glmmTMB(log(GM_Fecundity2+1)~as.factor(Row_Field)+(1|Family),data=dat2)
anova(fit2,fit4)#Yes. 

summary(fit)
Xtract(fit,2.332e-01 ) 



```

#### Variance partition analysis - TLA, transplant size, RGR, Chlorophyll A and Glucosinoalte
```{r}
#looking at effect with and without black path dam
#Total leaf area. 
fit<-glmmTMB(Standardize(GM_TotalLeaf_Area)~as.factor(gh_bench)+(1|treatment/Family)+(1|Family),data=dat2)
summary(fit)

#Is there an effect of GXE? 
fit2<-glmmTMB(Standardize(GM_TotalLeaf_Area)~as.factor(gh_bench)+(1|treatment)+(1|Family),data=dat2)
anova(fit,fit2)#No.

#Is there an effect of family? 
fit3<-glmmTMB(Standardize(GM_TotalLeaf_Area)~as.factor(gh_bench)+(1|treatment),data=dat2)
anova(fit2,fit3)#No. 

#Is there an effect of treatment? 
fit4<-glmmTMB(Standardize(GM_TotalLeaf_Area)~as.factor(gh_bench)+(1|Family),data=dat2)
anova(fit2,fit4)#Yes. 

summary(fit)
Xtract(fit,0.59131)



#Looking at effect with black path dam.


##Relative growth rate. 
fit<-glmmTMB(Standardize(RGR1)~as.factor(gh_bench)+(1|treatment/Family)+(1|Family),data=dat2)
summary(fit)
#Is there an effect of GXE? 
fit2<-glmmTMB(Standardize(RGR1)~as.factor(gh_bench)+(1|treatment)+(1|Family),data=dat2)
anova(fit,fit2)#No.

#Is there an effect of family? 
fit3<-glmmTMB(Standardize(RGR1)~as.factor(gh_bench)+(1|treatment),data=dat2)
anova(fit2,fit3)#No. (just) 

#Is there an effect of treatment? 
fit4<-glmmTMB(Standardize(RGR1)~as.factor(gh_bench)+(1|Family),data=dat2)
anova(fit2,fit4)#Yes. 

summary(fit)
Xtract(fit,0.80131)



##Chlor A
fit<-glmmTMB(Standardize(ChlorA)~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment/Family)+(1|Family),data=dat2)
summary(fit)
#Is there an effect of GXE? 
fit2<-glmmTMB(Standardize(ChlorA)~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment)+(1|Family),data=dat2)
anova(fit,fit2)#No.

#Is there an effect of family? 
fit3<-glmmTMB(Standardize(ChlorA)~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment),data=dat2)
anova(fit2,fit3)#No. 

#Is there an effect of treatment? 
fit4<-glmmTMB(Standardize(ChlorA)~GM_Leaf_Area+as.factor(gh_bench)+(1|Family),data=dat2)
anova(fit2,fit4)#Yes. 

summary(fit)
Xtract(fit,8.592e-01)

#Glucosinolate
fit<-glmmTMB(gluc_Conc~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment/Family)+(1|Family),data=dat2)
summary(fit)
#Is there an effect of GXE? 
fit2<-glmmTMB(gluc_Conc~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment)+(1|Family),data=dat2)
anova(fit,fit2)#No.

#Is there an effect of family? 
fit3<-glmmTMB(gluc_Conc~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment),data=dat2)
anova(fit2,fit3)#Yes. 

#Is there an effect of treatment? 
fit4<-glmmTMB(gluc_Conc~GM_Leaf_Area+as.factor(gh_bench)+(1|Family),data=dat2)
anova(fit2,fit4)#Yes. 

summary(fit)
Xtract(fit,0.067131)


# Transplant size
fit<-glmmTMB(Standardize(Transplant_Size_GM)~(1|treatment/Family)+(1|Family),data=dat2)
summary(fit)

#Is there an effect of GXE? 
fit2<-glmmTMB(Standardize(Transplant_Size_GM)~(1|treatment)+(1|Family),data=dat2)
anova(fit,fit2)#No.

#Is there an effect of family? 
fit3<-glmmTMB(Standardize(Transplant_Size_GM)~(1|treatment),data=dat2)
anova(fit2,fit3)# Yes, there is a major effect of family on transplant size. 

#Is there an effect of treatment? 
fit4<-glmmTMB(Standardize(Transplant_Size_GM)~(1|Family),data=dat2)
anova(fit2,fit4)#No 

summary(fit)
Xtract(fit,0.708636)
#28.6% of the variation in transplant size is attributable to family. This is very large. 
#Because of this i am not accounting for transplant size in any of these models. 

```

#### Variance partition analysis -  PCCG_1, PCCG_2
```{r}
#########
#PC1
#########
fit<-glmmTMB(PCCG_1~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment/Family)+(1|Family),data=dat2)
summary(fit)
#Is there an effect of GXE? 
fit2<-glmmTMB(PCCG_1~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment)+(1|Family),data=dat2)
anova(fit,fit2) #No.

#Is there an effect of family? 
fit3<-glmmTMB(PCCG_1~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment),data=dat2)
anova(fit2,fit3)#No... not when assessing in this model. 

#Is there an effect of treatment? 
fit4<-glmmTMB(PCCG_1~GM_Leaf_Area+as.factor(gh_bench)+(1|Family),data=dat2)
anova(fit2,fit4)#Yes, very strong. 

summary(fit)
Xtract(fit,1.37268) #Extremely high environmental effect fot PC1


#########
#PC2 glucosinolate off diagonal. 
#########
fit<-glmmTMB(PCCG_2~as.factor(gh_bench)+(1|treatment/Family)+(1|Family),data=dat2)
summary(fit)
#Is there an effect of GXE? 
fit2<-glmmTMB(PCCG_2~as.factor(gh_bench)+(1|treatment)+(1|Family),data=dat2)
anova(fit,fit2)#No.

#Is there an effect of family? 
fit3<-glmmTMB(PCCG_2~as.factor(gh_bench)+(1|treatment),data=dat2)
anova(fit2,fit3)#Yes. Still highly significant effect of family. 

#Is there an effect of treatment? 
fit4<-glmmTMB(PCCG_2~as.factor(gh_bench)+(1|Family),data=dat2)
anova(fit2,fit4)# No, no effect of treatment at all. 

summary(fit)
Xtract(fit,2.681e-01) #Extremely high Genetic effect for PC2
#Very interesting. 

#What if i dont include greenhouse bench? 
fit<-glmmTMB(PCCG_2~+(1|treatment/Family)+(1|Family),data=dat2)
summary(fit)

Xtract(fit,2.682e-01) #Slight increase in genetic variation -- only by 1 % though. 


```

#### Variance partition analysis -  RGR Fecundity and TLA with transplant size as covariate
```{r}
#looking at effect with and without black path dam
#Total leaf area. 
fit<-glmmTMB(Standardize(GM_TotalLeaf_Area)~as.factor(gh_bench)+Transplant_Size_GM+(1|treatment/Family)+(1|Family),data=dat2)
summary(fit)

#Is there an effect of GXE? 
fit2<-glmmTMB(Standardize(GM_TotalLeaf_Area)~as.factor(gh_bench)+Transplant_Size_GM+(1|treatment)+(1|Family),data=dat2)
anova(fit,fit2)#No.

#Is there an effect of family? 
fit3<-glmmTMB(Standardize(GM_TotalLeaf_Area)~as.factor(gh_bench)+Transplant_Size_GM+(1|treatment),data=dat2)
anova(fit2,fit3)#No. 

#Is there an effect of treatment? 
fit4<-glmmTMB(Standardize(GM_TotalLeaf_Area)~as.factor(gh_bench)+Transplant_Size_GM+(1|Family),data=dat2)
anova(fit2,fit4)#Yes. 

summary(fit)
Xtract(fit,5.757e-01)



#Looking at effect with black path dam.


##Relative growth rate. 
fit<-glmmTMB(Standardize(RGR1)~as.factor(gh_bench)+Transplant_Size_GM+(1|treatment/Family)+(1|Family),data=dat2)
summary(fit)
#Is there an effect of GXE? 
fit2<-glmmTMB(Standardize(RGR1)~as.factor(gh_bench)+Transplant_Size_GM+(1|treatment)+(1|Family),data=dat2)
anova(fit,fit2)#No.

#Is there an effect of family? 
fit3<-glmmTMB(Standardize(RGR1)~as.factor(gh_bench)+Transplant_Size_GM+(1|treatment),data=dat2)
anova(fit2,fit3)#No. (just) 

#Is there an effect of treatment? 
fit4<-glmmTMB(Standardize(RGR1)~as.factor(gh_bench)+Transplant_Size_GM+(1|Family),data=dat2)
anova(fit2,fit4)#Yes. 

summary(fit)
Xtract(fit,0.579540)



#Fecundity with  log 
fit<-glmmTMB(log(GM_Fecundity)~Transplant_Size_GM+(1|treatment/Family)+(1|Family),data=dat2)
summary(fit)
#Is there an effect of GXE? 
fit2<-glmmTMB(log(GM_Fecundity)~Transplant_Size_GM+(1|treatment)+(1|Family),data=dat2)
anova(fit,fit2)#No.

#Is there an effect of family? 
fit3<-glmmTMB(log(GM_Fecundity)~Transplant_Size_GM+(1|treatment),data=dat2)
anova(fit2,fit3)#No. 

#Is there an effect of treatment? 
fit4<-glmmTMB(log(GM_Fecundity)~Transplant_Size_GM+(1|Family),data=dat2)
anova(fit2,fit4)#Yes. 

summary(fit)
Xtract(fit,1.14607) #Large effect of treatment on the values fecundity. 



```



# Figures

#Export image to Excel
```{r}

library(officer)
library(rvg)

ExportX<-function(plot,plot2=NULL, outfile){
  
  outputPPT<-read_pptx() 

   if(!is.null(plot2)){
   my_vec_graph2 <- dml(ggobj = plot2)
   }
  
  #Converting plots to output objects
my_vec_graph <- dml(ggobj = plot)
 outputPPT<-add_slide(outputPPT,layout = "Title and Content",master="Office Theme")
  outputPPT<-ph_with(outputPPT,my_vec_graph,location=ph_location_fullsize())
  outputPPT<-add_slide(outputPPT,layout = "Title Slide",master="Office Theme")
   outputPPT<-ph_with(outputPPT,my_vec_graph2,location=ph_location_fullsize())




 print(outputPPT,target=outfile)
}


```




#### PCA figure
```{r}

summary(lm(gluc_Conc~ChlorA,data=dat2))
#intercept -1.14841
#Slope 0.45434 

CGSlope<-function(x){
    y=(0.45434 )*x-1.14841 
  return(y)
}


minC<-min(dat2$ChlorA,na.rm=T)
minG<-min(dat2$gluc_Conc,na.rm=T)

maxC<-max(dat2$ChlorA,na.rm=T)
maxG<-max(dat2$gluc_Conc,na.rm=T)




source("ggplot_themes.r")
a<-ggplot(dat2,aes(y=gluc_Conc,x=ChlorA))+
  geom_point(size=2)+
   # geom_smooth(method = lm,se=F,colour="black")+
    scale_x_continuous(breaks = seq(-2.75,0.25,0.5))+
    scale_y_continuous(breaks = seq(-2.5,-0.75,0.25),limits=c(-2.4,-0.70))+
 # +xlimits=c(-2.75,-0.25)
 # +ylimits=c(-2.6,-0.70)

 theme_simple_vertScientific()+
     ylab(bquote(bold("Glucosinolate, ln" (mg/ml))))+
   xlab(bquote(bold("Chlorophyll A, ln" (μg/ml))))+
  scale_colour_gradient(
  low = "#660000",
  high = "#FFF300",name="PC1")+
 theme( plot.margin = unit(c(1, 1, 0, 0), "cm"),
          legend.position = c(0.12,0.8))
  # geom_segment(x=minC,xend=maxC,y=CGSlope(minC),yend=CGSlope(maxC),colour="black",size=1,arrow = arrow(length = unit(0.5, "cm")))
  

tiff("Other_Figures/GCInvestementSimple.tiff", units="in", width=8, height=6, res=300)
a
dev.off()
```
inkscape as svg

#### Performance visualization with residuals
```{r}
source("GGPlot_Themes.R")

###
#Fitting a residual model
###

#The mean standardized selection gradient. 
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area,meanSTD = T)~treatment*Standardize(PCCG_1)+Standardize(Fern)+Standardize(BlackPathDam)+Standardize(Transplant_Size_GM)+(1|gh_bench),  data=dat2)
summary(fit6)

#Removing Na's and making new dataframe with NAs excluded
datPlot<-dat2[!is.na(dat2$PCCG_1)&!is.na(dat2$BlackPathDam)&!is.na(dat2$gh_bench)&!is.na(dat2$Fern),]


#Obtaining residuals from a model without the treatment*leafquality interaction
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area,meanSTD = T)~Standardize(Fern)+Standardize(BlackPathDam)+Standardize(Transplant_Size_GM)+(1|gh_bench),  data=datPlot)
summary(fit6)

#adding in residuals to the dataframe. 
fitResi<-residuals(fit6)
datPlot$GMSizeResi<-as.single(fitResi)

#Modelling the residuals against the interaction
fit7<-glmmTMB(GMSizeResi~treatment*Standardize(PCCG_1), data=datPlot)
summary(fit7) #The significance is still there. 

fit7
###
#Setting plotting parameters
###

aloneSlope<-function(x){
  #y= 0.07142*x+ 0.34161
    y=( 0)*x+ 0.22261
  return(y)
}
mapleSlope<-function(x){
  y=( -0.06481   +0.16756  )*x +0.22356   -0.15063 
  return(y)
}

mustardSlope<-function(x){
  #y=( 0.07142+0.03584)*x+0.34161-0.61888#Non significant slope
    y=(0)*x+ 0.22356   -0.48271  #Non significant slope
  return(y)
}

#Standardizing variables.
datPlot$PCCG_1S<-Standardize(datPlot$PCCG_1)

#Obtaining minimum and maximum values of leaf quality in each treatment.
minM<-min(datPlot$PCCG_1S[datPlot$treatment=="m"],na.rm = T)
maxM<-max(datPlot$PCCG_1S[datPlot$treatment=="m"],na.rm = T)

minA<-min(datPlot$PCCG_1S[datPlot$treatment=="a"],na.rm = T)
maxA<-max(datPlot$PCCG_1S[datPlot$treatment=="a"],na.rm = T)

minG<-min(datPlot$PCCG_1S[datPlot$treatment=="gm"],na.rm = T)
maxG<-max(datPlot$PCCG_1S[datPlot$treatment=="gm"],na.rm = T)

#Removing maple control
datPlot<-datPlot[datPlot$treatment!="mcnt",]


###
#Plotting
###
source("GGPlot_Themes.R")

TLATiff<-ggplot(datPlot)+
  geom_point(aes(y=GMSizeResi,x=PCCG_1S,fill=treatment,shape=treatment),size=3, alpha=0.5)+
  geom_segment(x=minA,xend=maxA,y=aloneSlope(minA),yend=aloneSlope(maxA),colour="#009E73",size=1.5)+
  geom_segment(x=minM,xend=maxM,y=mapleSlope(minM),yend=mapleSlope(maxM),colour="#E69F00",size=1.5)+
  geom_segment(x=minG,xend=maxG,y=mustardSlope(minG),yend=mustardSlope(maxG),colour="#56B4E9",size=1.5)+
  theme_simple_2()+
  ylab(bquote(bold("Rosette Size Residuals")))+xlab(bquote(bold("Standardized General Investment (PC1)")))+
  scale_y_continuous(breaks=seq(-2,3,by=0.5))+
  scale_x_continuous(breaks=seq(-5,5,by=1))+
  scale_shape_manual(values=c(21,22,24))+
  scale_fill_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Intraspecific","Interspecific"))

tiff("Selection_Figures/GCInvestement_VS_RosetteSizeResiduals.tiff", units="in", width=8, height=6, res=300)
TLATiff
dev.off()

#Plot for combo plot
TLATiffCombo<-ggplot(datPlot)+
  geom_point(aes(y=GMSizeResi,x=PCCG_1S,fill=treatment,shape=treatment),size=3, alpha=0.5)+
  geom_segment(x=minA,xend=maxA,y=aloneSlope(minA),yend=aloneSlope(maxA),colour="#009E73",size=1.5)+
  geom_segment(x=minM,xend=maxM,y=mapleSlope(minM),yend=mapleSlope(maxM),colour="#E69F00",size=1.5)+
  geom_segment(x=minG,xend=maxG,y=mustardSlope(minG),yend=mustardSlope(maxG),colour="#56B4E9",size=1.5)+
  theme_simple_2()+
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank()
  )+
  # ylab(bquote(bold("Rosette Size Residuals")))+xlab(bquote(bold("Standardized General Investment (PC1)")))+
  scale_y_continuous(breaks=seq(-2,3,by=0.5))+
  scale_x_continuous(breaks=seq(-5,5,by=1))+
  scale_shape_manual(values=c(21,22,24))+
  scale_fill_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Intraspecific","Interspecific"))




```



#### Fecundity gradients visualization
```{r}
source("GGPlot_Themes.R")

###
#Fitting a residual model
###

#Obtaining residuals without Standardize(PCCG_1)
fit12<-glmmTMB(Standardize(GM_FecundityMS)~Standardize(Transplant_Size_GM),data=dat2)
Fec_Resi<-residuals(fit12)

#Fitting model with the residuals
datPlot<-dat2[!is.na(dat2$GM_FecundityMS)&!is.na(dat2$Transplant_Size_GM),]
datPlot<-datPlot %>% mutate(Fec_Resi=Fec_Resi)

#Refitting model with residuals 
fit12<-glmmTMB(Fec_Resi~treatment+Standardize(PCCG_1),data=datPlot)
summary(fit12)

###
#Setting plotting parameters
###

aloneSlope<-function(x){
    y=( 0.09242 )*x+ 0.44742 
  return(y)
}
mapleSlope<-function(x){
  y=( 0.09242  )*x +0.44742    -0.40731   
  return(y)
}

mustardSlope<-function(x){
    y=(0.09242 )*x+ 0.44742    -0.97081  
  return(y)
}

#Standardizing variables.
datPlot$PCCG_1S<-Standardize(datPlot$PCCG_1)

#Obtaining minimum and maximum values of leaf quality in each treatment.
minM<-min(datPlot$PCCG_1S[datPlot$treatment=="m"],na.rm = T)
maxM<-max(datPlot$PCCG_1S[datPlot$treatment=="m"],na.rm = T)

minA<-min(datPlot$PCCG_1S[datPlot$treatment=="a"],na.rm = T)
maxA<-max(datPlot$PCCG_1S[datPlot$treatment=="a"],na.rm = T)

minG<-min(datPlot$PCCG_1S[datPlot$treatment=="gm"],na.rm = T)
maxG<-max(datPlot$PCCG_1S[datPlot$treatment=="gm"],na.rm = T)

#Removing maple control
datPlot<-datPlot[datPlot$treatment!="mcnt",]


###
#Plotting
###
source("GGPlot_Themes.R")

FecTiff<-ggplot(datPlot)+
  geom_point(aes(y=Fec_Resi,x=PCCG_1S,fill=treatment,shape=treatment),size=3, alpha=0.5)+
  geom_segment(x=minA,xend=maxA,y=aloneSlope(minA),yend=aloneSlope(maxA),colour="#009E73",size=1.5)+
  geom_segment(x=minM,xend=maxM,y=mapleSlope(minM),yend=mapleSlope(maxM),colour="#E69F00",size=1.5)+
  geom_segment(x=minG,xend=maxG,y=mustardSlope(minG),yend=mustardSlope(maxG),colour="#56B4E9",size=1.5)+
  theme_simple_2()+
  theme(
    axis.title.y=element_blank(),
    axis.title.x = element_blank()
  )+
  # ylab(bquote(bold("Rosette Size Residuals")))+xlab(bquote(bold("Standardized General Investment (PC1)")))+
  scale_y_continuous(breaks=seq(-3,5,by=0.5),limits=c(-1.5,4.2))+
  scale_x_continuous(breaks=seq(-5,5,by=1))+
  scale_shape_manual(values=c(21,22,24))+
  scale_fill_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Intraspecific","Interspecific"))

tiff("Selection_Figures/PC1_VS_FecundityResiduals.tiff", units="in", width=8, height=6, res=300)
FecTiff
dev.off()


tiff("Selection_Figures/PC1_TLAGM_Fecundity_Combo.tiff", units="in", width=14, height=6, res=300)
plot_grid(TLATiffCombo,FecTiff,ncol=2,rel_widths=c(1,1),rel_heights = c(1,1),label_fontfamily = "Arial",label_size = 18)
dev.off()


```


# Maple figure
```{r}

###
#Fitting a residual model
###

#Obtaining residuals without Standardize(PCCG_1) (For PC1)

fit3<-glmmTMB(Standardize(Maple_TotalLeafArea_End,meanSTD = T)~Standardize(PC1Tot)+Standardize(PCCG_2)+Standardize(MapleDamage), data=MapleModel)
Maple_PC1_Resi<-residuals(fit3)

#Creating dataframe without NA
datPlot<-MapleModel[!is.na(MapleModel$Maple_TotalLeafArea_End)&!is.na(MapleModel$PCCG_2)&!is.na(MapleModel$MapleDamage)&!is.na(MapleModel$PC1Tot),]

#Adding in residuals to dataframe
datPlot<-datPlot %>% mutate(Maple_PC1_Resi=Maple_PC1_Resi)

#Refitting model with residuals 
fit12<-glmmTMB(Maple_PC1_Resi~Standardize(PCCG_1),data=datPlot)
summary(fit12)



###
#Setting plotting parameters
###
PC1Slope<-function(x){
  y=( -1.036e-01  )*x +1.045e-06
  return(y)
}



#Standardizing variables.
datPlot$PCCG_1S<-Standardize(datPlot$PCCG_1)


#Obtaining minimum and maximum values of leaf quality in each treatment.
minM<-min(datPlot$PCCG_1S,na.rm = T)
maxM<-max(datPlot$PCCG_1S,na.rm = T)



#Removing maple control
datPlot<-datPlot[datPlot$treatment!="mcnt",]


###
#Plotting
###
source("GGPlot_Themes.R")

PC1Maple<-ggplot(datPlot)+
  geom_point(aes(y=Maple_PC1_Resi,x=PCCG_1S,fill=treatment,shape=treatment),size=3, alpha=0.5)+
  geom_segment(x=minM,xend=maxM,y=PC1Slope(minM),yend=PC1Slope(maxM),colour="#E69F00",size=1.5)+
  theme_simple_2()+
  theme(
    axis.title.y = element_blank(),
    axis.title.x = element_blank()

  )+
  # ylab(bquote(bold("Acer saccharum TLA")))+xlab(bquote(bold("Standardized General Investment (PC1)")))+
  scale_y_continuous(breaks=seq(-3,3,by=0.5),limits=c(-1,2))+
  scale_x_continuous(breaks=seq(-5,5,by=1))+
  scale_shape_manual(values=c(21,22,24))+
  scale_fill_manual(values=c("#E69F00"))


#----------------—————————————————————————----------- 
###
#Obtaining residuals without Standardize(PCCG_1) (For PC2)
###

fit3<-glmmTMB(Standardize(Maple_TotalLeafArea_End,meanSTD = T)~Standardize(PC1Tot)+Standardize(PCCG_1)+Standardize(MapleDamage), data=MapleModel)
Maple_PC2_Resi<-residuals(fit3)

#Creating dataframe without NA
datPlot<-MapleModel[!is.na(MapleModel$Maple_TotalLeafArea_End)&!is.na(MapleModel$PCCG_1)&!is.na(MapleModel$MapleDamage)&!is.na(MapleModel$PC1Tot),]

#Adding in residuals to dataframe
datPlot<-datPlot %>% mutate(Maple_PC2_Resi=Maple_PC2_Resi)

#Refitting model with residuals 
fit12<-glmmTMB(Maple_PC2_Resi~Standardize(PCCG_2),data=datPlot)
summary(fit12)

datPlot$PCCG_2S<-Standardize(datPlot$PCCG_2)

#Obtaining minimum and maximum values of leaf quality in each treatment.
minM<-min(datPlot$PCCG_2S,na.rm = T)
maxM<-max(datPlot$PCCG_2S,na.rm = T)


PC2Slope<-function(x){
  y=( 7.454e-02 )*x +3.027e-08
  return(y)
}



PC2Maple<-ggplot(datPlot)+
  geom_point(aes(y=Maple_PC2_Resi,x=PCCG_2S,fill=treatment,shape=treatment),size=3, alpha=0.5)+
  geom_segment(x=minM,xend=maxM,y=PC2Slope(minM),yend=PC2Slope(maxM),colour="#E69F00",size=1.5)+
  theme_simple_2()+
  # ylab(bquote(bold("Acer saccharum TLA")))+
  xlab(bquote(bold("Relative Investment (PC2)")))+
  scale_y_continuous(breaks=seq(-3,3,by=0.5),limits=c(-1,2))+
  scale_x_continuous(breaks=seq(-5,5,by=1))+
  scale_shape_manual(values=c(21,22,24))+
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_blank()
    

  )+
  scale_fill_manual(values=c("#E69F00"))


tiff("Maple_Figures/PC1_PC2_MapleTLA.tiff", units="in", width=14, height=6, res=300)
plot_grid(PC1Maple,PC2Maple,ncol=2,rel_widths=c(1,1),rel_heights = c(1,1),label_fontfamily = "Arial",label_size = 18)
dev.off()
```


#Figure for change in mean pc1 and pc2
```{r}

##### PC1
dat2$PCCG_1S<-Standardize(dat2$PCCG_1)
dat2$PCCG_2S<-Standardize(dat2$PCCG_2)

#Alone treatment ... -0.03
A_Change_PC1<-dat2 %>% filter(treatment=="a",Bolt_Survival==1) %>% summarize(mean(PCCG_1S,na.rm=T))%>% pull() -
dat2 %>% filter(treatment=="a") %>% summarize(mean(PCCG_1S,na.rm=T)) %>% pull()

#Maple treatment...0.099
M_Change_PC1<-dat2 %>% filter(treatment=="m",Bolt_Survival==1) %>% summarize(mean(PCCG_1S,na.rm=T))%>% pull() -
dat2 %>% filter(treatment=="m") %>% summarize(mean(PCCG_1S,na.rm=T)) %>% pull()


#GM treatment...0.433
GM_Change_PC1<-dat2 %>% filter(treatment=="gm",Bolt_Survival==1) %>% summarize(mean(PCCG_1S,na.rm=T)) %>% pull()-
dat2 %>% filter(treatment=="gm") %>% summarize(mean(PCCG_1S,na.rm=T)) %>% pull()



##### PC2
#Alone treatment ... 0.0089
A_Change_PC2<-dat2 %>% filter(treatment=="a",Bolt_Survival==1) %>% summarize(mean(PCCG_2S,na.rm=T))%>% pull() -
dat2 %>% filter(treatment=="a") %>% summarize(mean(PCCG_2S,na.rm=T)) %>% pull()


#Maple treatment...-0.221
M_Change_PC2<-dat2 %>% filter(treatment=="m",Bolt_Survival==1) %>% summarize(mean(PCCG_2S,na.rm=T))%>% pull() -
dat2 %>% filter(treatment=="m") %>% summarize(mean(PCCG_2S,na.rm=T)) %>% pull()


#GM treatment...-0.321
GM_Change_PC2<-dat2 %>% filter(treatment=="gm",Bolt_Survival==1) %>% summarize(mean(PCCG_2S,na.rm=T))%>% pull() -
dat2 %>% filter(treatment=="gm") %>% summarize(mean(PCCG_2S,na.rm=T)) %>% pull()

d1<-dat2 %>% filter(treatment=="m",Bolt_Survival==1) %>% select(PCCG_2S)  %>%  pull() 
d2<-dat2 %>% filter(treatment=="m") %>% select(PCCG_2S) %>% pull()

Trait=c("PC1","PC1","PC1","PC2","PC2","PC2")
Value=c(A_Change_PC1,M_Change_PC1,GM_Change_PC1,A_Change_PC2,M_Change_PC2,GM_Change_PC2)
Treatment=c("Alone","Interspecific","Intraspecific","Alone","Interspecific","Intraspecific")

changeVis<-data.frame(Trait,Value,Treatment)


ggplot(changeVis)+
  geom_col(aes(y=Value,x=Trait,fill=Treatment),position = "dodge",colour="black")+
  theme_simple_2()+
  ylab(bquote(bold("Trait value (σ)")))+
  xlab(bquote(bold("Standardized General Investment (PC1)")))+
  # scale_y_continuous(breaks=seq(-2,3,by=0.5))+
  # scale_x_continuous(breaks=seq(-5,5,by=1))+
  # 
  theme(
    axis.title.x=element_blank()
  )+
    # scale_shape_manual(values=c(21,22,24))+
 scale_fill_manual(values=c("#009E73","#E69F00","#56B4E9"),labels=c("Alone","Intraspecific","Interspecific"))

  


```






#### Performance Path analysis Visualization 
```{r}
library(ggraph)
library(igraph)

library(lavaan) 

#------
#Performing path analysis and obtaining data to visualize
#-----
MapleFormula_1_1 <- '
Maple_TotalLeafArea_EndS ~ PC1Tot+B1*PCCG_1S + MapleDamage + B2*PCCG_2S

GM_TotalLeaf_AreaMS ~ B3*Maple_TotalLeafArea_EndS + BlackPathDamS +FernS +PCCG_2S+ PCCG_1S+ gh_bench2 + Transplant_Size_GMS

indirect_PCCG_1 := B1 * B3
indirect_PCCG_2 := B2 * B3

'

fit<-sem(MapleFormula_1_1,data=MapleModel)

#Constructing data frame of paths
b<-summary(fit)[[1]]
b<-b %>% filter(exo==0) %>% select(from=rhs,to=lhs,est,pvalue)

#Altering the p values in the model to reflect permutation tests.

#[1] "The simulated p-value value for test parameter indirect_PCCG_2 is: 0.0095"
#[1] "The simulated p-value value for test parameter indirect_PCCG_1 is: 0.0051"
#[1] "The simulated p-value value for test parameter Maple_TotalLeafArea_EndS is: 0.0111"
#[1] "The simulated p-value value for test parameter PCCG_1S is: 0.0773"
#[1] "The simulated p-value value for test parameter PCCG_2S is: 0.1922"

 b$pvalue[b$from=="B1*B3"]<-0.0051 #indirect pc1
 b$pvalue[b$from=="B2*B3"]<-0.0095 #indirect Pc2
 b$pvalue[b$from=="Maple_TotalLeafArea_EndS"]<-0.0111
 b$pvalue[b$from=="PCCG_2S"&b$to=="GM_TotalLeaf_AreaMS"]<- 0.1922 #direct Pc2
 b$pvalue[b$from=="PCCG_1S"&b$to=="GM_TotalLeaf_AreaMS"]<- 0.0773 #direct Pc1

#Adding significance to b values. 
 b$estL<-b$est
  b$estL[b$pvalue>=0.05]<- round(b$est[b$pvalue>=0.05],2)
 b$estL[b$pvalue<0.05]<-paste(round(b$est[b$pvalue<0.05],2),"*")
  b$estL[b$pvalue<0.01]<-paste(round(b$est[b$pvalue<0.01],2),"**")
  b$estL[b$pvalue<0.001]<-paste(round(b$est[b$pvalue<0.001],2),"***")



#Defining the whether the relationship is positive or negative.
defineColour<-function(x){
x[x<0]<-"Negative"
x[!grepl("Negative",x)]<-"Positive"
  return(x)
}
b$PosNeg<-defineColour(b$est)

#Adding Custom gradient values ranging from 1-6 for the size of the effect. 

#Function to scale data linearly between 1 and 6
Scale<-function(m,Type="Width"){
  if(Type=="Alpha"){
  m <- (m-0)/(1-0)*(1-0)+0
  }
  else{
    m <- (m-0)/(1-0)*(6-1)+1
  }
  return(m)
}
#Creating unique identifier column for each edge. 
b$Unique<-letters[1:nrow(b)]


b$Thickness<-Scale(abs(b$est))
names(b$Thickness)<-b$Unique
ThicknessNames<-b$Thickness
names(ThicknessNames)<-b$Unique
ThicknessNames

b$Alpha<-Scale(abs(1-b$pvalue),Type = "Alpha")
AlphaNames<-b$Alpha
names(AlphaNames)<-b$Unique
AlphaNames


# Keeping only the indirect effects in c data frame
c<-b %>% filter(to %in% c("indirect_PCCG_1","indirect_PCCG_2"))

# Removing the indirect effects in b data frame
b<-b %>% filter(!to %in% c("indirect_PCCG_1","indirect_PCCG_2"))

#Display the indirect effects in C 

 c$from[c$from=="B1*B3"]<-"PCCG_1S"
 c$to[c$to=="indirect_PCCG_1"]<-"GM_TotalLeaf_AreaMS"
 
 c$from[c$from=="B2*B3"]<-"PCCG_2S"
 c$to[c$to=="indirect_PCCG_2"]<-"GM_TotalLeaf_AreaMS"

 
 
#---------
#Converting data frame into a ggraph object
#---------

#Creating names for the path diagram b
Vert<-data.frame(name=append(unique(b$to),unique(b$from)))
Vert<-Vert[!duplicated(Vert$name),]

#Creating names for the path diagram c
Vert2<-data.frame(name=append(unique(c$to),unique(c$from)))
Vert2<-Vert2[!duplicated(Vert2$name),]

#Converting to a graph-able object, b
SGg<-graph_from_data_frame(b,directed=T)

#Converting to a graph-able object, c
SGg_C<-graph_from_data_frame(c,directed=T)




#-------
#Adding in Custom layout defined in external excel files. 
#-------

#Creating a dummy layout list to work with, b
lay = create_layout(SGg, layout ="fr" )

#Creating a dummy layout list to work with, c
lay2 = create_layout(SGg_C, layout ="fr" )
lay
lay2

#Importing the x and y data point i want
Lay<-read.csv("CustomLayout.csv")
Lay2<-read.csv("CustomLayoutPerf_Curv.csv")


#Replacing the data point in lay with the ones i want in Lay (b)
lay$x<-Lay$x
lay$y<-Lay$y
lay$name<-Lay$name2

#Replacing the data point in lay with the ones i want in Lay2 (c)
lay2$x<-Lay2$x
lay2$y<-Lay2$y
lay2$name<-Lay2$name2



#------------
#Graphing plot b
#------------

PathPerf<-ggraph(lay)  +

 geom_edge_link(
   aes(start_cap = label_rect(node1.name,padding =margin(3,3,3,3,"mm") ), end_cap = label_rect(node2.name,padding =margin(5,3,3,3,"mm")),color=PosNeg,label=estL,width=Unique,alpha=Unique),
   
   fontface="bold",
   show.legend = F,
  label_colour = 'black',
  fill='white',
  
      arrow = arrow(type = "closed", length = unit(5, 'mm'))
  ) + 
  
    geom_node_label(aes(label =name))+
  set_graph_style(plot_margin = margin(10,10,10,10))+
  scale_x_continuous(limits=c(8,10))+
  scale_edge_colour_manual(values=c("#CC6666","#66CC99"))+
  scale_edge_width_manual(values=ThicknessNames)+
  scale_edge_alpha_manual(values=AlphaNames)



PathPerf


#----
#Graphing plot c
#-----
PathPerfC<-ggraph(lay2,circular=F)  +

 geom_edge_arc(
   aes(start_cap = label_rect(node1.name,padding =margin(3,3,3,3,"mm") ), end_cap = label_rect(node2.name,padding =margin(5,3,3,3,"mm")),color=PosNeg,label=estL,width=Unique,alpha=Unique),

   #width=6,
   curvature = c(-0.1,0.1),
   fontface="bold",
   show.legend = F,
  label_colour = 'black',
  fill='white',
      arrow = arrow(type = "closed", length = unit(5, 'mm'))
  
  ) +
  
    geom_node_label(aes(label =name))+
  set_graph_style(plot_margin = margin(10,10,10,10))+
  scale_x_continuous(limits=c(8,10))+
      scale_edge_colour_manual(values=c("#CC6666","#66CC99"))+
  scale_edge_width_manual(values=ThicknessNames)+
  scale_edge_alpha_manual(values=AlphaNames)


#tiff("Selection_Figures/PathAnalysisPerf.tiff", units="in", width=8, height=6, res=300)
PathPerfC
#dev.off()
Lay2

ExportX(PathPerf,PathPerfC,"Selection_Figures/PathPerfNew2.pptx")


```


#### Survival Path analysis Visualization 
```{r}
library(ggraph)
library(igraph)
library(lavaan)

#------
#Performing path analysis and obtaining data to visualize
#-----
MapleFormula_1_1 <- '
 Maple_TotalLeafArea_EndS ~ PC1Tot+ B1*PCCG_1S + MapleDamage + B2*PCCG_2S

  
Bolt_SurvivalMS ~   FernS + B3*Maple_TotalLeafArea_EndS+PCCG_2S+PCCG_1S
    
  

indirect_PCCG_1 := B1 * B3
indirect_PCCG_2 := B2 * B3

'


fit<-sem(MapleFormula_1_1,data=MapleModel)


#Constructing data frame of paths
b<-summary(fit)[[1]]
b<-b %>% filter(exo==0) %>% select(from=rhs,to=lhs,est,pvalue)

#Altering the p values in the model to reflect permutation tests.
b$pvalue[b$from=="Maple_TotalLeafArea_EndS"]<-0.0122
 b$pvalue[b$from=="B1*B3"]<-0.0016 #indirect pc1
 b$pvalue[b$from=="B2*B3"]<- 0.0166 #indirect Pc2

 
#Adding significance to b values. 
b$estL<-b$est
b$estL[b$pvalue>=0.05]<-round(b$est[b$pvalue>=0.05],2)
b$estL[b$pvalue<0.05]<-paste(round(b$est[b$pvalue<0.05],2),"*")
b$estL[b$pvalue<0.01]<-paste(round(b$est[b$pvalue<0.01],2),"**")
b$estL[b$pvalue<0.001]<-paste(round(b$est[b$pvalue<0.001],2),"***")


#Defining the whether the relationship is positive or negative.
defineColour<-function(x){
x[x<0]<-"Negative"
x[!grepl("Negative",x)]<-"Positive"
  return(x)
}
b$PosNeg<-defineColour(b$est)

#Adding Custom gradient values ranging from 1-6 for the size of the effect. 

#Function to scale data linearly between 1 and 6
Scale<-function(m,Type="Width"){
  if(Type=="Alpha"){
  m <- (m-0)/(1-0)*(1-0)+0
  }
  else{
    m <- (m-0)/(1-0)*(6-1)+1
  }
  return(m)
}
#Creating unique identifier column for each edge. 
b$Unique<-letters[1:nrow(b)]


b$Thickness<-Scale(abs(b$est))
names(b$Thickness)<-b$Unique
ThicknessNames<-b$Thickness
names(ThicknessNames)<-b$Unique
ThicknessNames

b$Alpha<-Scale(abs(1-b$pvalue),Type = "Alpha")
AlphaNames<-b$Alpha
names(AlphaNames)<-b$Unique
AlphaNames


# Keeping only the indirect effects in c data frame
c<-b %>% filter(to %in% c("indirect_PCCG_1","indirect_PCCG_2"))

# Removing the indirect effects in b data frame
b<-b %>% filter(!to %in% c("indirect_PCCG_1","indirect_PCCG_2"))

#Display the indirect effects in C 

 c$from[c$from=="B1*B3"]<-"PCCG_1S"
 c$to[c$to=="indirect_PCCG_1"]<-"Bolt_SurvivalMS"
 
 c$from[c$from=="B2*B3"]<-"PCCG_2S"
 c$to[c$to=="indirect_PCCG_2"]<-"Bolt_SurvivalMS"

 
 
#---------
#Converting data frame into a ggraph object
#---------

#Creating names for the path diagram b
Vert<-data.frame(name=append(unique(b$to),unique(b$from)))
Vert<-Vert[!duplicated(Vert$name),]

#Creating names for the path diagram c
Vert2<-data.frame(name=append(unique(c$to),unique(c$from)))
Vert2<-Vert2[!duplicated(Vert2$name),]

#Converting to a graph-able object, b
SGg<-graph_from_data_frame(b,directed=T)

#Converting to a graph-able object, c
SGg_C<-graph_from_data_frame(c,directed=T)




#-------
#Adding in Custom layout defined in external excel files. 
#-------

#Creating a dummy layout list to work with, b
lay = create_layout(SGg, layout ="fr" )

#Creating a dummy layout list to work with, c
lay2 = create_layout(SGg_C, layout ="fr" )


#Importing the x and y data point i want
Lay<-read.csv("CustomLayoutSurvival.csv")
Lay2<-read.csv("CustomLayoutSurv_Curv.csv")


#Replacing the data point in lay with the ones i want in Lay (b)
lay$x<-Lay$x
lay$y<-Lay$y
lay$name<-Lay$name2

#Replacing the data point in lay with the ones i want in Lay2 (c)
lay2$x<-Lay2$x
lay2$y<-Lay2$y
lay2$name<-Lay2$name2



#------------
#Graphing plot b
#------------

PathPerf<-ggraph(lay)  +

 geom_edge_link(
   aes(start_cap = label_rect(node1.name,padding =margin(3,3,3,3,"mm") ), end_cap = label_rect(node2.name,padding =margin(5,3,3,3,"mm")),color=PosNeg,label=estL,width=Unique,alpha=Unique),
   
   fontface="bold",
   show.legend = F,
  label_colour = 'black',
  fill='white',
  
      arrow = arrow(type = "closed", length = unit(5, 'mm'))
  ) + 
  
    geom_node_label(aes(label =name))+
  set_graph_style(plot_margin = margin(10,10,10,10))+
  scale_x_continuous(limits=c(8,10))+
  scale_edge_colour_manual(values=c("#CC6666","#66CC99"))+
  scale_edge_width_manual(values=ThicknessNames)+
  scale_edge_alpha_manual(values=AlphaNames)



PathPerf


#----
#Graphing plot c
#-----
PathPerfC<-ggraph(lay2,circular=F)  +

 geom_edge_arc(
   aes(start_cap = label_rect(node1.name,padding =margin(3,3,3,3,"mm") ), end_cap = label_rect(node2.name,padding =margin(5,3,3,3,"mm")),color=PosNeg,label=estL,width=Unique,alpha=Unique),
#linetype="dashed",
   #width=6,
   curvature = c(-0.1,0.1),
   fontface="bold",
   show.legend = F,
  label_colour = 'black',
  fill='white',
      arrow = arrow(type = "closed", length = unit(5, 'mm'))
  
  ) +
  
    geom_node_label(aes(label =name))+
  set_graph_style(plot_margin = margin(10,10,10,10))+
  scale_x_continuous(limits=c(8,10))+
      scale_edge_colour_manual(values=c("#CC6666","#66CC99"))+
  scale_edge_width_manual(values=ThicknessNames)+
  scale_edge_alpha_manual(values=AlphaNames)


#tiff("Selection_Figures/PathAnalysisPerf.tiff", units="in", width=8, height=6, res=300)
PathPerfC
#dev.off()


ExportX(PathPerf,PathPerfC,"Selection_Figures/PathSurvNew2.pptx")


```


#### Fecundity path analysis Visualization 
```{r}
library(ggraph)
library(igraph)

MapleFormula_1_1 <- '
Maple_TotalLeafArea_EndS ~ PC1Tot+B1*PCCG_1S + MapleDamage + B2*PCCG_2S

GM_FecundityMS~B3*Maple_TotalLeafArea_EndS +PCCG_2S+PCCG_1S+Transplant_Size_GMS

indirect_PCCG_1 := B1 * B3
indirect_PCCG_2 := B2 * B3

'


fit<-sem(MapleFormula_1_1,data=MapleModel)

summary(fit)

#Constructing data frame of paths
b<-summary(fit)[[1]]
b<-b %>% filter(exo==0) %>% select(from=rhs,to=lhs,est,pvalue)

#Altering the p values in the model to reflect permutation tests.

#[1] "The simulated p-value value for test parameter indirect_PCCG_1 is: 0.8697"
#The simulated p value for test parameter indirect_ PCCG_2s is 0.7816
#"The simulated p-value value for test parameter Maple_TotalLeafArea_EndS is: 0.9218"
#[1] "The simulated p-value value for test parameter PCCG_1S is: 0.1137809"
#[1] "The simulated p-value value for test parameter PCCG_2S is: 0.250354"


 b$pvalue[b$from=="B1*B3"]<-0.8697 #indirect pc1
 b$pvalue[b$from=="B2*B3"]<-0.7816 #indirect Pc2
 b$pvalue[b$from=="Maple_TotalLeafArea_EndS"]<-0.9218
 b$pvalue[b$from=="PCCG_2S"&b$to=="GM_FecundityMS"]<- 0.250354 #direct Pc2
 b$pvalue[b$from=="PCCG_1S"&b$to=="GM_FecundityMS"]<- 0.1137809 #direct Pc1

#Adding significance to b values. 
 b$estL<-b$est
  b$estL[b$pvalue>=0.05]<- round(b$est[b$pvalue>=0.05],2)
 b$estL[b$pvalue<0.05]<-paste(round(b$est[b$pvalue<0.05],2),"*")
  b$estL[b$pvalue<0.01]<-paste(round(b$est[b$pvalue<0.01],2),"**")
  b$estL[b$pvalue<0.001]<-paste(round(b$est[b$pvalue<0.001],2),"***")



#Defining the whether the relationship is positive or negative.
defineColour<-function(x){
x[x<0]<-"Negative"
x[!grepl("Negative",x)]<-"Positive"
  return(x)
}
b$PosNeg<-defineColour(b$est)

#Adding Custom gradient values ranging from 1-6 for the size of the effect. 

#Function to scale data linearly between 1 and 6
Scale<-function(m,Type="Width"){
  if(Type=="Alpha"){
  m <- (m-0)/(1-0)*(1-0)+0
  }
  else{
    m <- (m-0)/(1-0)*(6-1)+1
  }
  return(m)
}
#Creating unique identifier column for each edge. 
b$Unique<-letters[1:nrow(b)]


b$Thickness<-Scale(abs(b$est))
names(b$Thickness)<-b$Unique
ThicknessNames<-b$Thickness
names(ThicknessNames)<-b$Unique
ThicknessNames

b$Alpha<-Scale(abs(1-b$pvalue),Type = "Alpha")
AlphaNames<-b$Alpha
names(AlphaNames)<-b$Unique
AlphaNames


# Keeping only the indirect effects in c data frame
c<-b %>% filter(to %in% c("indirect_PCCG_1","indirect_PCCG_2"))

# Removing the indirect effects in b data frame
b<-b %>% filter(!to %in% c("indirect_PCCG_1","indirect_PCCG_2"))

#Display the indirect effects in C 

 c$from[c$from=="B1*B3"]<-"PCCG_1S"
 c$to[c$to=="indirect_PCCG_1"]<-"GM_FecundityMS"
 
 c$from[c$from=="B2*B3"]<-"PCCG_2S"
 c$to[c$to=="indirect_PCCG_2"]<-"GM_FecundityMS"

 
 
#---------
#Converting data frame into a ggraph object
#---------

#Creating names for the path diagram b
Vert<-data.frame(name=append(unique(b$to),unique(b$from)))
Vert<-Vert[!duplicated(Vert$name),]

#Creating names for the path diagram c
Vert2<-data.frame(name=append(unique(c$to),unique(c$from)))
Vert2<-Vert2[!duplicated(Vert2$name),]

#Converting to a graph-able object, b
SGg<-graph_from_data_frame(b,directed=T)

#Converting to a graph-able object, c
SGg_C<-graph_from_data_frame(c,directed=T)




#-------
#Adding in Custom layout defined in external excel files. 
#-------

#Creating a dummy layout list to work with, b
lay = create_layout(SGg, layout ="fr" )

#Creating a dummy layout list to work with, c
lay2 = create_layout(SGg_C, layout ="fr" )
lay
lay2

#Importing the x and y data point i want
Lay<-read.csv("CustomLayoutFecundity.csv")
Lay2<-read.csv("CustomLayoutFec_Curv.csv")


#Replacing the data point in lay with the ones i want in Lay (b)
lay$x<-Lay$x
lay$y<-Lay$y
lay$name<-Lay$name2

#Replacing the data point in lay with the ones i want in Lay2 (c)
lay2$x<-Lay2$x
lay2$y<-Lay2$y
lay2$name<-Lay2$name2



#------------
#Graphing plot b
#------------

PathPerf<-ggraph(lay)  +

 geom_edge_link(
   aes(start_cap = label_rect(node1.name,padding =margin(3,3,3,3,"mm") ), end_cap = label_rect(node2.name,padding =margin(5,3,3,3,"mm")),color=PosNeg,label=estL,width=Unique,alpha=Unique),
   
   fontface="bold",
   show.legend = F,
  label_colour = 'black',
  fill='white',
  
      arrow = arrow(type = "closed", length = unit(5, 'mm'))
  ) + 
  
    geom_node_label(aes(label =name))+
  set_graph_style(plot_margin = margin(10,10,10,10))+
  scale_x_continuous(limits=c(8,10))+
  scale_edge_colour_manual(values=c("#CC6666","#66CC99"))+
  scale_edge_width_manual(values=ThicknessNames)+
  scale_edge_alpha_manual(values=AlphaNames)



PathPerf


#----
#Graphing plot c
#-----
PathPerfC<-ggraph(lay2,circular=F)  +

 geom_edge_arc(
   aes(start_cap = label_rect(node1.name,padding =margin(3,3,3,3,"mm") ), end_cap = label_rect(node2.name,padding =margin(5,3,3,3,"mm")),color=PosNeg,label=estL,width=Unique,alpha=Unique),

   #width=6,
   curvature = c(-0.1,0.1),
   fontface="bold",
   show.legend = F,
  label_colour = 'black',
  fill='white',
      arrow = arrow(type = "closed", length = unit(5, 'mm'))
  
  ) +
  
    geom_node_label(aes(label =name))+
  set_graph_style(plot_margin = margin(10,10,10,10))+
  scale_x_continuous(limits=c(8,10))+
      scale_edge_colour_manual(values=c("#CC6666","#66CC99"))+
  scale_edge_width_manual(values=ThicknessNames)+
  scale_edge_alpha_manual(values=AlphaNames)


#tiff("Selection_Figures/PathAnalysisPerf.tiff", units="in", width=8, height=6, res=300)
PathPerfC
#dev.off()
Lay2

ExportX(PathPerf,PathPerfC,"Selection_Figures/PathFecNew2.pptx")



```


#### Lifetime fitness Path analysis Visualization Update
```{r}
library(ggraph)
library(igraph)
library(lavaan)

#------
#Performing path analysis and obtaining data to visualize
#-----
MapleFormula_1_1 <- '
 Maple_TotalLeafArea_EndS ~ PC1Tot+ B1*PCCG_1S + MapleDamage + B2*PCCG_2S


GM_Fecundity2MS~ B3*Maple_TotalLeafArea_EndS +PCCG_1S +PCCG_2S


indirect_PCCG_1 := B1 * B3
indirect_PCCG_2 := B2 * B3

'

fit<-sem(MapleFormula_1_1,data=MapleModel)


#Constructing data frame of paths
b<-summary(fit)[[1]]
b<-b %>% filter(exo==0) %>% select(from=rhs,to=lhs,est,pvalue)
b
#Altering the p values in the model to reflect permutation tests.
b$pvalue[b$from=="Maple_TotalLeafArea_EndS"]<-0.2805
 b$pvalue[b$from=="B1*B3"]<- 0.1782#indirect pc1
 b$pvalue[b$from=="B2*B3"]<- 0.1521 #indirect Pc2
 
  b$pvalue[b$from=="PCCG_1S"&b$to=="GM_Fecundity2MS"]<- 0.0838#direct pc1
 b$pvalue[b$from=="PCCG_2S"&b$to=="GM_Fecundity2MS"]<- 0.0487 #direct Pc2
 
 #[1] "The simulated p-value value for test parameter PCCG_2S is: 0.0487"
#[1] "The simulated p-value value for test parameter PCCG_1S is: 0.0838"
#[1] "The simulated p-value value for test parameter indirect_PCCG_2 is: 0.1521"
#[1] "The simulated p-value value for test parameter indirect_PCCG_1 is: 0.1782"
#[1] "The simulated p-value value for test parameter Maple_TotalLeafArea_EndS is: 0.2805"

 
 
#Adding significance symbols to regression coefficients. 
b$estL<-b$est
b$estL[b$pvalue>=0.05]<-round(b$est[b$pvalue>=0.05],2)
b$estL[b$pvalue<0.05]<-paste(round(b$est[b$pvalue<0.05],2),"*")
b$estL[b$pvalue<0.01]<-paste(round(b$est[b$pvalue<0.01],2),"**")
b$estL[b$pvalue<0.001]<-paste(round(b$est[b$pvalue<0.001],2),"***")


#Defining the whether the relationship is positive or negative.
defineColour<-function(x){
x[x<0]<-"Negative"
x[!grepl("Negative",x)]<-"Positive"
  return(x)
}
b$PosNeg<-defineColour(b$est)

#Adding Custom gradient values ranging from 1-6 for the size of the effect. 

#Function to scale data linearly between 1 and 6
Scale<-function(m,Type="Width"){
  if(Type=="Alpha"){
  m <- (m-0)/(1-0)*(1-0)+0
  }
  else{
    m <- (m-0)/(1-0)*(6-1)+1
  }
  return(m)
}
#Creating unique identifier column for each edge. 
b$Unique<-letters[1:nrow(b)]


b$Thickness<-Scale(abs(b$est))
names(b$Thickness)<-b$Unique
ThicknessNames<-b$Thickness
names(ThicknessNames)<-b$Unique
ThicknessNames

b$Alpha<-Scale(abs(1-b$pvalue),Type = "Alpha")
AlphaNames<-b$Alpha
names(AlphaNames)<-b$Unique
AlphaNames


# Keeping only the indirect effects in c data frame
c<-b %>% filter(to %in% c("indirect_PCCG_1","indirect_PCCG_2"))

# Removing the indirect effects in b data frame
b<-b %>% filter(!to %in% c("indirect_PCCG_1","indirect_PCCG_2"))

#Display the indirect effects in C 

 c$from[c$from=="B1*B3"]<-"PCCG_1S"
 c$to[c$to=="indirect_PCCG_1"]<-"GM_Fecundity2MS"
 
 c$from[c$from=="B2*B3"]<-"PCCG_2S"
 c$to[c$to=="indirect_PCCG_2"]<-"GM_Fecundity2MS"

 
 
#---------
#Converting data frame into a ggraph object
#---------

#Creating names for the path diagram b
Vert<-data.frame(name=append(unique(b$to),unique(b$from)))
Vert<-Vert[!duplicated(Vert$name),]

#Creating names for the path diagram c
Vert2<-data.frame(name=append(unique(c$to),unique(c$from)))
Vert2<-Vert2[!duplicated(Vert2$name),]

#Converting to a graph-able object, b
SGg<-graph_from_data_frame(b,directed=T)

#Converting to a graph-able object, c
SGg_C<-graph_from_data_frame(c,directed=T)




#-------
#Adding in Custom layout defined in external excel files. 
#-------

#Creating a dummy layout list to work with, b
lay = create_layout(SGg, layout ="fr" )

#Creating a dummy layout list to work with, c
lay2 = create_layout(SGg_C, layout ="fr" )


#Importing the x and y data point i want
Lay<-read.csv("CustomLayoutTotalFit.csv")
Lay2<-read.csv("CustomLayoutTot_Curv.csv")


#Replacing the data point in lay with the ones i want in Lay (b)
lay$x<-Lay$x
lay$y<-Lay$y
lay$name<-Lay$name2

#Replacing the data point in lay with the ones i want in Lay2 (c)
lay2$x<-Lay2$x
lay2$y<-Lay2$y
lay2$name<-Lay2$name2



#------------
#Graphing plot b
#------------

PathPerf<-ggraph(lay)  +

 geom_edge_link(
   aes(start_cap = label_rect(node1.name,padding =margin(3,3,3,3,"mm") ), end_cap = label_rect(node2.name,padding =margin(5,3,3,3,"mm")),color=PosNeg,label=estL,width=Unique,alpha=Unique),
   
   fontface="bold",
   show.legend = F,
  label_colour = 'black',
  fill='white',
  
      arrow = arrow(type = "closed", length = unit(5, 'mm'))
  ) + 
  
    geom_node_label(aes(label =name))+
  set_graph_style(plot_margin = margin(10,10,10,10))+
  scale_x_continuous(limits=c(8,10))+
  scale_edge_colour_manual(values=c("#CC6666","#66CC99"))+
  scale_edge_width_manual(values=ThicknessNames)+
  scale_edge_alpha_manual(values=AlphaNames)



PathPerf


#----
#Graphing plot c
#-----
PathPerfC<-ggraph(lay2,circular=F)  +

 geom_edge_arc(
   aes(start_cap = label_rect(node1.name,padding =margin(3,3,3,3,"mm") ), end_cap = label_rect(node2.name,padding =margin(5,3,3,3,"mm")),color=PosNeg,label=estL,width=Unique,alpha=Unique),
#linetype="dashed",
   #width=6,
   curvature = c(-0.1,0.1),
   fontface="bold",
   show.legend = F,
  label_colour = 'black',
  fill='white',
      arrow = arrow(type = "closed", length = unit(5, 'mm'))
  
  ) +
  
    geom_node_label(aes(label =name))+
  set_graph_style(plot_margin = margin(10,10,10,10))+
  scale_x_continuous(limits=c(8,10))+
      scale_edge_colour_manual(values=c("#CC6666","#66CC99"))+
  scale_edge_width_manual(values=ThicknessNames)+
  scale_edge_alpha_manual(values=AlphaNames)


#tiff("Selection_Figures/PathAnalysisPerf.tiff", units="in", width=8, height=6, res=300)
PathPerfC
#dev.off()


ExportX(PathPerf,PathPerfC,"Selection_Figures/PathTotalNew2.pptx")

#Didnt simulate direct effect on maple.... probably irrelevant thoough. 

```




# Simulations for understanding

#Looking at the effect of pc2 on pathogen damage
```{r}
#PCCG_1 is associated with more black pathogen damage. Interesting.... maybe they got more water resulting in higher performance, but it was too much water and they got the pathogen damage? 

#do models like this 
fit3<-glmmTMB(Standardize(BlackPathDam)~PCCG_1+GM_Leaf_Area+treatment+Standardize(Fern)+(1|gh_bench), data=dat2)
summary(fit3)

#do models like this 
fit3<-glmmTMB(Standardize(BlackPathDam)~PCCG_2+GM_Leaf_Area+treatment+Standardize(Fern)+(1|gh_bench), data=dat2)
summary(fit3)


#Check if glucosinolate and chlorophyll are diluted in bigger leaves and if this has an effect. 


#There is no significant effect of the predictors on white fungal damage
fitfull<-glmmTMB(WhiteFungLogis~PCCG_1+PCCG_2+treatment+Standardize(Fern)+RGR1+Transplant_Size_GM+(1|gh_bench), data=dat2)
summary(fitfull)




#there is a significant effect of PCCG_2


#Testing with family 

fit4<-glmmTMB(Standardize(ThripsDam)~PCCG_2+GM_Leaf_Area+treatment+(1|gh_bench)+(1|Family), data=dat2)
summary(fit4) 

#I think that pathogen damage needs to go into the path analysis... --- if it is a significant predictor. 




#Leaf damage from adult populations 
dat$
```

# Testing whether PC2 is significantly correated with adult traits. 
```{r}
#Creating total density
dat2<-dat2 %>% mutate(TotalDens=RosDens+AdultDens)

#Summarizing to family level
dat3 <-
  dat2 %>% 
  group_by(Family) %>% 
  summarize(
    TotalDens = first(TotalDens),
    RosDens = first(RosDens),
    AdultDens = first(AdultDens),
    GM_Leaf_Area = mean(GM_Leaf_Area, na.rm = T),
    PCCG_2 = mean(PCCG_2, na.rm = T),
    TotalSizeS0 = first(TotalSizeS0),
    HerbivoryS0 = first(HerbivoryS0)
  )

dat2 %>% filter(is.na(TotalSizeS0))
  
  dat2$total
#Testing whether density is associated with PC1 or PC2
fit3<-glmmTMB(Standardize(TotalDens)~PCCG_2, data=dat3)
summary(fit3)
fit3<-glmmTMB(Standardize(RosDens)~PCCG_2, data=dat3)
summary(fit3)

#PC2 is still significant after taking the family mean on adult density --- interesting. 
fit3<-glmmTMB(Standardize(AdultDens)~PCCG_2, data=dat3)
summary(fit3)
#There is a positive correlated between pccg_2 and adult density in the original field experiement

#testing whether total GM size is significantly correlated with PC2
fit3<-glmmTMB(Standardize(TotalSizeS0)~PCCG_2, data=dat3)
summary(fit3) #Very close to significance! p = 0.0532


#testing whether the bolt:rosette density ratio is significantly correlated with PC2. This would demosntrate that something about the phase of the two year cycle is important
fit3<-glmmTMB(Standardize(RosDens/AdultDens)~PCCG_2, data=dat3)
summary(fit3) #Not significant.




###
#Testing whether PC2 is significantl correalted with adult herbivore damage in the populations
###
fit3<-glmmTMB(Standardize(HerbivoryS0)~PCCG_2, data=dat3)
summary(fit3) #Not significant. 

#Glucosinolate concentration is significantly higher in populations with higher adult density. 
dat2$GM_Leaf_Area
dat2$lat

ggplot(dat2 %>% filter(!is.na(PCCG_2)))+
  geom_jitter(aes(x=Longitude, y= Latitude, colour=PCCG_2),width = 1.5, height = 1.5)
```



#Testing selection differential of survival.
```{r}

Chlorophyll<-c()
Survival<-c()
for(i in 1:1000){
  
  Chlorophyll<-append(Chlorophyll,seq(0,1,0.1)) #More chlorophyll more survival.
  Survival<-append(Survival,rbinom(11,1,seq(0,1,0.1)))
}

SurvDat<-data.frame(Chlorophyll,Survival)

#Calculating selection differential. 

#Standardizing relative survival.
SurvDat$RelSurvival<-SurvDat$Survival/mean(SurvDat$Survival)

#Standardizing chlorophyll
SurvDat$ChlorSTD<-Standardize(SurvDat$Chlorophyll)




#selection differential
summary(lm(RelSurvival~ChlorSTD,data=SurvDat))


#The selection differential is +2.005646 or 0.634270 if standardized 

#Is this also the mean change in the trait after survival?

mean(SurvDat$ChlorSTD[SurvDat$Survival==1])-mean(SurvDat$ChlorSTD)
 
#Yes it does. a trait shift of +0.63 standard deviations.




#Yes. it is in fact the exact same, but it is the difference between those that survived and the entire population. 
#Mean(Survivors) - mean(total population) Right - the change in mean of the trait due to selection.


#Is it also the proportion of individuals that are not selected for reproduction?

#No it does not...
mean(SurvDat$Survival[SurvDat$Survival==1])

length(SurvDat$Survival)*0.634212 #Proportion not selected.

#6976.332 individuals
length(SurvDat$Survival[SurvDat$Survival==0])
#In reality 5509 individuals did not survive but it is close. 


#actual proportion not selected 
length(SurvDat$Survival[SurvDat$Survival==0])/length(SurvDat$Survival)
0.5008182 #is. 





```

#Testing selection differential with indirect and direct effects. 
```{r}
#Path analysis estimating only a simple indirect effect 
Glucosinolate<-c()
Maple<-c()
Fitness<-c()

  #Wide glucosinolate investment. 
  Glucosinolate<-rnorm(10000,mean=0, sd=3) 
  
  #Maple decreases with increasing glucosinolate investment
  Maple<-Glucosinolate*(-2)+rnorm(10000,sd=3)

plot(Maple~Glucosinolate)

  #Fitness decreases with increasing maple performance. 
  Fitness<-Maple*(-1)+rnorm(10000,sd=3)

PathDat<-data.frame(Fitness,Glucosinolate,Maple)

#Performing path analysis without indirect effect and looking at the estimate. 

TestFormula <- '
Maple ~ b*Glucosinolate

Fitness ~ b2*Maple

indirect_ := b * b2

'

fit<-sem(TestFormula,data=PathDat)
summary(fit)

#With a direct influence paramter...

TestFormula <- '
Maple ~ b*Glucosinolate

Fitness ~ b2*Maple + Glucosinolate

indirect_ := b * b2

'

fit<-sem(TestFormula,data=PathDat)
summary(fit) #It performed very well actually even though i allowed for the direct parameter to be estimated. 

#What happens if i add direct influence into the data? 

  #Wide glucosinolate investment. 
  Glucosinolate<-rnorm(1000,mean=0, sd=3) 
  
  #Maple decreases with increasing glucosinolate investment
  Maple<-Glucosinolate*(-2)+rnorm(1000,sd=3)

  #Fitness decreases with increasing maple performance. 
  Fitness<-Maple*(-1)+rnorm(1000,sd=3)+Glucosinolate*(1)+rnorm(1000, sd=3) 
PathDat<-data.frame(Fitness,Glucosinolate,Maple)

  
TestFormula <- '
Maple ~ b*Glucosinolate

Fitness ~ b2*Maple + Glucosinolate

indirect_ := b * b2

'

fit<-sem(TestFormula,data=PathDat)
summary(fit) #It performed very well actually even though i allowed for the direct parameter to be estimated. 



TestFormula <- '
Maple ~ b*Glucosinolate

Fitness ~ b2*Maple 

indirect_ := b * b2

'

fit<-sem(TestFormula,data=PathDat)
summary(fit) 

#The indirect effects are always inflated by the correlation with the variable . It is therefore likely better to include it in the model. 



#Reducing the SD between glucosinolate and maple relationship. 

  #Wide glucosinolate investment. 
  Glucosinolate<-rnorm(1000,mean=0, sd=3) 
  
  #Maple decreases with increasing glucosinolate investment
  Maple<-Glucosinolate*(-2)+rnorm(1000,sd=1)

  #Fitness decreases with increasing maple performance. 
  Fitness<-Maple*(-1)+rnorm(1000,sd=3)+Glucosinolate*(1)+rnorm(1000, sd=3) 
PathDat<-data.frame(Fitness,Glucosinolate,Maple)

  
  
TestFormula <- '
Maple ~ b*Glucosinolate

Fitness ~ b2*Maple + Glucosinolate

indirect_ := b * b2

'

fit<-sem(TestFormula,data=PathDat)
summary(fit) #It performed very well actually even though i allowed for the direct parameter to be estimated. 



TestFormula <- '
Maple ~ b*Glucosinolate

Fitness ~ b2*Maple 

indirect_ := b * b2

'

fit<-sem(TestFormula,data=PathDat)
summary(fit) 
```

#Testing how to describe selection differential in terms of %
```{r}

#Standardized glucosinolate values. 
Glucosinolates<-rnorm(1000,0,1)

#Population fitness
Slope<-c()
Theta<-c()
Slope2<-c()
Theta2<-c()
for(i in seq(1,200,25)){
  
    Fitness<-Glucosinolates*125*(-1) +rnorm(1000,0,1)+1000
    RFitness<-Fitness/mean(Fitness)
    
    #Lms
    out<-coef(lm(RFitness~Glucosinolates))[2]
    Slope<-append(Slope,out)
    Theta<-append(Theta,sd(RFitness))
    
    #------
   # If  SD standardized...
    
        RFitness<-(Fitness-mean(Fitness))/sd(Fitness)
    
    #Lms
    out<-coef(lm(RFitness~Glucosinolates))[2]
    Slope2<-append(Slope2,out)
    Theta2<-append(Theta2,sd(RFitness))
    
}
Slope
Theta
Slope2
Theta2


# A 1 SD increase in Glucosinolates results in a ?
mean(RFitness)+mean(RFitness)*0.0019119

#A 1sd increase in glucosinolates results in a relative fitness of 2. 
sd(RFitness)

summary(lm(RFitness~Glucosinolates))

plot(RFitness~Glucosinolates)

min(Fitness)
```



#Table Creation


# Functions for automatic table creation 
```{r}

library(tidyr)


#Function to create a data frame without the NA's in it
NewData<-function(x,var){
  
  #When there is an interaction
  if(grepl(":",var,fixed=T)){
   before<- gsub(".*\\:","",var)
   after<- gsub("\\:.*","",var)
   datFoc<-x %>% drop_na(before,after)
  }
  
  #When there is a random effect.
  else if(grepl("|",var,fixed=T)){
    a<-gsub(".* \\| ","",var)
    b<-gsub(")","",a)
    datFoc<-x %>% drop_na(b)
  }
  
  #Simple removing Nas when not an interaction and not a random effect 
   else datFoc<-x %>% drop_na(var)
   
   return(datFoc)
}



#This works on non-significant variables when you want to add an effect. 
NonSigExtract<-function(Data,bestmodel,NonSigVar){
 #Extracting test statistic of every non significant variable: 
    
  #Model data with NAs of additional variable removed. 
    datFoc<-NewData(Data,NonSigVar)
    
  #Creating a new formula with a nonsigvar included
    
    #If there is an interaction add in all lower order terms before testing it.: 
      if(grepl(":",NonSigVar,fixed=T)){
   before<- gsub(".*\\:","",NonSigVar)
   after<- gsub("\\:.*","",NonSigVar)
  
    oldFormula<-as.character(formula(bestmodel))
  #Making one string
  oldFormula<- paste(oldFormula[2],oldFormula[1],oldFormula[3],sep="")
  #old formula with lower order terms added
  oldFormula<-paste(oldFormula,before,after,sep="+")
  #New model with interaction added 
  newFormula<-paste(oldFormula,NonSigVar,sep="+")
  }
  
    else{
  oldFormula<-as.character(formula(bestmodel))
  #Making one string
  oldFormula<- paste(oldFormula[2],oldFormula[1],oldFormula[3],sep="")
  #New model for anova
  newFormula<-paste(oldFormula,NonSigVar,sep="+")
    }
  #Creating models with althered formula and data without Na's for the excluded variable
  oldMod<-glmmTMB(formula=as.formula(oldFormula),data=datFoc)
  newMod<-glmmTMB(formula=as.formula(newFormula),data=datFoc)
    
  #Return anova output
out<-anova(oldMod,newMod)


return(out)
}

#This works on significant variables when you want to remove an effect. 
SigExtract<-function(Data,bestmodel,SigVar){
 #Extracting test statistic of every non significant variable: 
    
  #Model data with NAs of additional variable removed. 
    datFoc<-NewData(Data,SigVar)

  oldFormula<-as.character(formula(bestmodel))
  #Making one string
  oldFormula<- paste(oldFormula[2],oldFormula[1],oldFormula[3],sep="")
  
  #Creating new formula without the effect 
  #Removing term
  newFormula<-sub(SigVar,"",oldFormula,fixed = T)
  #Removing spaces
  newFormula<-gsub(" ","",newFormula,fixed = T)
  #Removing any double + from formula after removing variable.
  newFormula<-gsub("++","+",newFormula,fixed = T)
  #Removing any trailing "+"
  newFormula<-sub("\\+$","",newFormula)


  oldMod<-glmmTMB(formula=as.formula(oldFormula),data=datFoc)

    newMod<-glmmTMB(formula=as.formula(newFormula),data=datFoc)
    
out<-anova(oldMod,newMod)

return(out)
}




```

#Wrapping chisq and p extraction into one function. 
```{r}

ChiExtracter<-function(Data,fit,SignificantVar,NonSignificantVar){

#Non-significant vars
Variable_Glob<-c()
Chi_Glob<-c()
p_Glob<-c()

for(i in 1:length(NonSignificantVar)){
  out<-NonSigExtract(Data,fit,NonSigVar=NonSignificantVar[i])

  Chi<-out[2,"Chisq"]

p<-out[2,"Pr(>Chisq)"]

if(out[2,"Chi Df"]<1){
  stop("Error on DF")
}

Variable_Glob<-append(Variable_Glob,NonSignificantVar[i])
Chi_Glob<-append(Chi_Glob,Chi)
p_Glob<-append(p_Glob,p)

print(paste("NonSigVar:",i))
}

dataA<-data.frame(Variable_Glob,Chi_Glob,p_Glob)
print("NonSigVar done")



#Significant vars. 
Variable_Glob<-c()
Chi_Glob<-c()
p_Glob<-c()

for(i in 1:length(SignificantVar)){
  out<-SigExtract(Data,fit,SigVar=SignificantVar[i])

  Chi<-out[2,"Chisq"]

p<-out[2,"Pr(>Chisq)"]

if(out[2,"Chi Df"]<1){
  stop("Error on DF")
}

Variable_Glob<-append(Variable_Glob,SignificantVar[i])
Chi_Glob<-append(Chi_Glob,Chi)
p_Glob<-append(p_Glob,p)


print(paste("SigVar:",i))

}

dataB<-data.frame(Variable_Glob,Chi_Glob,p_Glob)


print("SigVar done")

return(rbind(dataA,dataB))

}




```


# Creating a table of chisq and p values for paper. 

Must explicitely state model (i.e. no "*")

Must also have a space between random effect in model (1 | term) not (1|term)
```{r}
dat2$GM_FecundityL<-log(dat2$GM_Fecundity)
dat2$WhiteFungLogis<-as.factor(dat2$WhiteFungLogis)
dat2$GM_Fecundity2L<-log(dat2$GM_Fecundity2+1)
dat2$GM_TotalLeaf_AreaS<-Standardize(dat2$GM_TotalLeaf_Area)

#PERFORMANCE

#Best model 
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment+PCCG_1+PCCG_1+treatment:PCCG_1+Fern+BlackPathDam+Transplant_Size_GM+(1 | gh_bench),  data=dat2)

SignificantVar<-c("treatment:PCCG_1","Fern","BlackPathDam","Transplant_Size_GM","(1 | gh_bench)")
NonSignificantVar<-c("PCCG_2","WhiteFungLogis","ThripsDam","RGR1","(1 | Family)", "treatment:PCCG_2")

perfTable<-ChiExtracter(Data=dat2,fit=fit6,SignificantVar=SignificantVar,NonSignificantVar=NonSignificantVar)



#FECUNDITY

#Best model
fit12<-glmmTMB(GM_FecundityL~treatment+Transplant_Size_GM+PCCG_1,data=dat2)

SignificantVar<-c("treatment","Transplant_Size_GM","PCCG_1")
NonSignificantVar<-c("PCCG_2","ThripsDam","RGR1","(1 | Family)", "treatment:PCCG_2","treatment:PCCG_1","BlackPathDam","Fern","WhiteFungLogis","(1 | Col_Field)","(1 | Row_Field)","GM_TotalLeaf_AreaS", "(1 | gh_bench)")

FecTable<-ChiExtracter(Data=dat2,fit=fit12,SignificantVar=SignificantVar,NonSignificantVar=NonSignificantVar)


#SURVIVAL

#Best model
fits<- glmmTMB(Bolt_Survival ~ treatment+PCCG_1 +treatment:PCCG_1  + Fern +  
    (1 | Family) + (1 | Row_Field) ,data=dat2, family="binomial")

SignificantVar<-c("treatment:PCCG_1" , "Fern" ,  
   "(1 | Family)" , "(1 | Row_Field)")

dat2$GM_TotalLeaf_AreaS<-Standardize(dat2$GM_TotalLeaf_Area)

NonSignificantVar<-c("PCCG_2","WhiteFungLogis","RGR1", "treatment:PCCG_2","BlackPathDam","ThripsDam","(1 | Col_Field)","GM_TotalLeaf_AreaS","Transplant_Size_GM","(1 | gh_bench)")

SurvTable<-ChiExtracter(Data=dat2,fit=fits,SignificantVar=SignificantVar,NonSignificantVar=NonSignificantVar)




#LIFETIME FITNESS


#Best model
fit2<-glmmTMB(GM_Fecundity2L~treatment+(1|Family)+(1|Row_Field),data=dat2)


SignificantVar<-c("treatment" ,  
   "(1 | Family)" , "(1 | Row_Field)")

NonSignificantVar<-c("PCCG_2","WhiteFungLogis","RGR1", "treatment:PCCG_2","treatment:PCCG_1","PCCG_1","BlackPathDam","ThripsDam","(1 | Col_Field)","GM_TotalLeaf_AreaS", "Fern","Transplant_Size_GM", "(1 | gh_bench)")

LifetimeTable<-ChiExtracter(Data=dat2,fit=fit2,SignificantVar=SignificantVar,NonSignificantVar=NonSignificantVar)


```

#organizing table
```{r}

#Organizing table 

#Rounding p values and chi values
perfTable<-perfTable %>% mutate(Chi=round(Chi_Glob,1),p=round(p_Glob,2))

#Changing significance values to to symbols: < 0.04

     perfTable$p[perfTable$p_Glob<0.05]<-"< 0.05"
    perfTable$p[perfTable$p_Glob<0.01]<-"< 0.01"
    perfTable$p[perfTable$p_Glob<0.001]<-"< 0.001"
    
#Combining chi and p into the structure i want:
    
perfTable$Performance<-paste("(",perfTable$Chi,", ",perfTable$p,")",sep="")


#Fecundity

#Rounding p values and chi values
FecTable<-FecTable %>% mutate(Chi=round(Chi_Glob,1),p=round(p_Glob,2))

#Changing significance values to to symbols: < 0.04

     FecTable$p[FecTable$p_Glob<0.05]<-"< 0.05"
    FecTable$p[FecTable$p_Glob<0.01]<-"< 0.01"
    FecTable$p[FecTable$p_Glob<0.001]<-"< 0.001"
    
#Combining chi and p into the structure i want:
    
FecTable$Fecundity<-paste("(",FecTable$Chi,", ",FecTable$p,")",sep="")


#Survival

#Rounding p values and chi values
SurvTable<-SurvTable %>% mutate(Chi=round(Chi_Glob,1),p=round(p_Glob,2))

#Changing significance values to to symbols: < 0.04

     SurvTable$p[SurvTable$p_Glob<0.05]<-"< 0.05"
    SurvTable$p[SurvTable$p_Glob<0.01]<-"< 0.01"
    SurvTable$p[SurvTable$p_Glob<0.001]<-"< 0.001"
    
#Combining chi and p into the structure i want:
    
SurvTable$Survival<-paste("(",SurvTable$Chi,", ",SurvTable$p,")",sep="")



# LifetimeTable
#Rounding p values and chi values
LifetimeTable<-LifetimeTable %>% mutate(Chi=round(Chi_Glob,1),p=round(p_Glob,2))

#Changing significance values to to symbols: < 0.04

     LifetimeTable$p[LifetimeTable$p_Glob<0.05]<-"< 0.05"
    LifetimeTable$p[LifetimeTable$p_Glob<0.01]<-"< 0.01"
    LifetimeTable$p[LifetimeTable$p_Glob<0.001]<-"< 0.001"
    
#Combining chi and p into the structure i want:
    
LifetimeTable$Lifetime<-paste("(",LifetimeTable$Chi,", ",LifetimeTable$p,")",sep="")

LifetimeTable

#Adding all tabes together. 
a<-perfTable %>% select(Variable_Glob,Performance)
b<-SurvTable %>% select(Variable_Glob,Survival)
c<-FecTable %>% select(Variable_Glob,Fecundity)
d<-LifetimeTable %>% select(Variable_Glob,Lifetime)



#Setting organization data frame

Org=data.frame("Variable_Glob"=c(
"treatment:PCCG_1",
"treatment:PCCG_2",
'treatment',
'PCCG_1',
'PCCG_2',
'Transplant_Size_GM',
'RGR1',
'GM_TotalLeaf_AreaS',
'Boltsize',
'Fern',
'ThripsDam',
'BlackPathDam',
'WhiteFungLogis',
'(1 | gh_bench)',
'(1 | Col_Field)',
'(1 | Row_Field)',
'(1 | Family)'
),
"ind"=1:17)

#Organizing
output<-a %>% full_join(b,by="Variable_Glob") %>% full_join(c,by="Variable_Glob") %>% full_join(d,by="Variable_Glob") %>% full_join(Org,by="Variable_Glob")

output[order(output$ind),]

write.csv(output[order(output$ind),],"AnovaResultsTable.csv")


```

#Treatment effects on A.saccarum
```{r}

#FIRST YEAR 
Maple$Maple_TotalLeafArea_EndS<-Standardize(Maple$Maple_TotalLeafArea_End,meanSTD=T)

Maple$MapleFinalMassL<-log(Maple$MapleFinalMass)

MapleModel$GM_TotalLeaf_AreaS<-Standardize( MapleModel$GM_TotalLeaf_Area )
MapleModel$Maple_TotalLeafArea_EndS<-Standardize(MapleModel$Maple_TotalLeafArea_End,meanSTD=T)
MapleModel$MapleFinalMassL<-log(MapleModel$MapleFinalMass)


fit1<-glmmTMB(Maple_TotalLeafArea_EndS~PC1Tot+treatment+Fern+MapleDamage,data=Maple)

SignificantVar<-c("PC1Tot","treatment","Fern","MapleDamage")
NonSignificantVar<-c("(1 | gh_bench)")

M1<-ChiExtracter(Data=Maple,fit=fit1,SignificantVar=SignificantVar,NonSignificantVar=NonSignificantVar)


#FIRST YEAR WITHIN TREATMENT
fit3<-glmmTMB(Maple_TotalLeafArea_EndS~PC1Tot+PCCG_1+PCCG_2+MapleDamage, data=MapleModel)

SignificantVar<-c("PC1Tot","PCCG_1","PCCG_2","MapleDamage")
NonSignificantVar<-c("(1 | gh_bench)","Fern","GM_TotalLeaf_AreaS","RGR1","Family")

M1Within<-ChiExtracter(Data=MapleModel,fit=fit3,SignificantVar=SignificantVar,NonSignificantVar=NonSignificantVar)



#SECOND YEAR
fit<-glmmTMB(MapleFinalMassL~treatment+PC1Tot,data=Maple)


SignificantVar<-c("PC1Tot","treatment")
NonSignificantVar<-c("(1 | gh_bench)","Fern","MapleDamage")

M2<-ChiExtracter(Data=Maple,fit=fit,SignificantVar=SignificantVar,NonSignificantVar=NonSignificantVar)

M2


#SECOND YEAR WITHIN TREATMENT
fit9<-glmmTMB(MapleFinalMassL ~ PC1Tot  +
    GM_TotalLeaf_AreaS  +(1 | Row_Field),data=MapleModel)


# omit repeats.. ?
SignificantVar<-c("PC1Tot","GM_TotalLeaf_AreaS","(1 | Row_Field)")
NonSignificantVar<-c("(1 | gh_bench)","(1 | Col_Field)","Fern","RGR1","Family","PCCG_2","PCCG_1","MapleDamage")

M2Within<-ChiExtracter(Data=MapleModel,fit=fit9,SignificantVar=SignificantVar,NonSignificantVar=NonSignificantVar)

                                                                                    
M2Within
```

#Organizing maple tables
```{r}

#Rounding p values and chi values
M1<-M1 %>% mutate(Chi=round(Chi_Glob,1),p=round(p_Glob,2))

#Changing significance values to to symbols: < 0.04

     M1$p[M1$p_Glob<0.05]<-"< 0.05"
    M1$p[M1$p_Glob<0.01]<-"< 0.01"
    M1$p[M1$p_Glob<0.001]<-"< 0.001"
    
#Combining chi and p into the structure i want:
    
M1$Year1<-paste("(",M1$Chi,", ",M1$p,")",sep="")



#M2

#Rounding p values and chi values
M2<-M2 %>% mutate(Chi=round(Chi_Glob,1),p=round(p_Glob,2))

#Changing significance values to to symbols: < 0.04

     M2$p[M2$p_Glob<0.05]<-"< 0.05"
    M2$p[M2$p_Glob<0.01]<-"< 0.01"
    M2$p[M2$p_Glob<0.001]<-"< 0.001"
    
#Combining chi and p into the structure i want:
    
M2$Year2<-paste("(",M2$Chi,", ",M2$p,")",sep="")

#M1Within 
M1Within<-M1Within %>% mutate(Chi=round(Chi_Glob,1),p=round(p_Glob,2))

#Changing significance values to to symbols: < 0.04

     M1Within$p[M1Within$p_Glob<0.05]<-"< 0.05"
    M1Within$p[M1Within$p_Glob<0.01]<-"< 0.01"
    M1Within$p[M1Within$p_Glob<0.001]<-"< 0.001"
    
#Combining chi and p into the structure i want:
    
M1Within$Year1<-paste("(",M1Within$Chi,", ",M1Within$p,")",sep="")


#M2Within 
M2Within<-M2Within %>% mutate(Chi=round(Chi_Glob,1),p=round(p_Glob,2))

#Changing significance values to to symbols: < 0.04

     M2Within$p[M2Within$p_Glob<0.05]<-"< 0.05"
    M2Within$p[M2Within$p_Glob<0.01]<-"< 0.01"
    M2Within$p[M2Within$p_Glob<0.001]<-"< 0.001"
    
#Combining chi and p into the structure i want:
    
M2Within$Year2<-paste("(",M2Within$Chi,", ",M2Within$p,")",sep="")


#Adding all tabes together. 
a<-M1 %>% select(Variable_Glob,Year1)
b<-M2 %>% select(Variable_Glob,Year2)
c<-M1Within %>% select(Variable_Glob,Year1)
d<-M2Within %>% select(Variable_Glob,Year2)



#Setting organization data frame
output1
Org1=data.frame("Variable_Glob"=c(
'treatment',
'PC1Tot',
'MapleDamage',
'Fern',
'(1 | gh_bench)'
),
"ind"=1:5)

Org2=data.frame("Variable_Glob"=c(
'PCCG_1',
'PCCG_2',
'RGR1',
'GM_TotalLeaf_AreaS',
'Family',
'PC1Tot',
'MapleDamage',
'Fern',
'(1 | gh_bench)',
'(1 | Col_Field)',
'(1 | Row_Field)'
),
"ind"=1:11)


#Organizing
output1<-a %>% full_join(b,by="Variable_Glob")%>% full_join(Org1,by="Variable_Glob")

output2<-c %>% full_join(d,by="Variable_Glob") %>% full_join(Org2,by="Variable_Glob")


#Pasting data frames together

output<-rbind(
output1[order(output1$ind),],
output2[order(output2$ind),]
)

write.csv(output,"MapleResultsTable.csv")


```




#Generating table of genotype location and sample size. 
```{r}
table(dat$Family,dat$Longitude,dat$Latitude,dat$Altitude)

GenotypeLocation<-dat %>% group_by(Family) %>% summarize(Longitude=first(Longitude),Latitude=first(Latitude),Altitude=first(Altitude))




######
#Generating table demonstrating sample size before Sample Loss. 
#####

#Creating column for full family name
dat2$FamilyLong<-gsub("\\|[[:digit:]]+$","",dat2$Tag)

dat2$FamilyLong<-gsub("^[[:alpha:]]{1}\\|","",dat2$FamilyLong)

dat2$FamilyLong<-gsub("\\|[[:graph:]]+$","",dat2$FamilyLong)


#creating the tale in long format
repTable<-dat2 %>% filter(treatment != "mcnt") %>% group_by(FamilyLong,treatment) %>% summarize(SampleSize=n())


#Making the table into a wide format
repTableWide<-repTable %>% pivot_wider(names_from = treatment,values_from = SampleSize)

##Adding a column for total sample size per genotype
repTableWide$Total<-repTableWide$a+repTableWide$gm+repTableWide$m

##Ordering the data set.  
repTableWide<-repTableWide[order(repTableWide$Total,decreasing = T),]
repTableWide

apply(repTableWide[,2:5],2,sum)

##Printing table. 
write.csv(repTableWide,"SampleSizeUpdate.csv")
#write.csv(GenotypeLocation,"GenotypeLocation.csv")







######
#Generating table demonstrating sample size with loss of glcosinolate samples. 
#####

# After Sample Loss. 
repTable<-dat2 %>% filter(treatment != "mcnt") %>% drop_na(gluc_Conc) %>% group_by(FamilyLong,treatment) %>% summarize(SampleSize=n())


#Making the table into a wide format
repTableWide<-repTable %>% pivot_wider(names_from = treatment,values_from = SampleSize)

##Adding a column for total sample size per genotype
repTableWide$Total<-repTableWide$a+repTableWide$gm+repTableWide$m

##Ordering the data set.  
repTableWide<-repTableWide[order(repTableWide$Total,decreasing = T),]
repTableWide

#writing to csv
write.csv(repTableWide,"SampleSizeNoGlucConc.csv")

#generating column totals
apply(repTableWide[,2:5],2,sum)




####
#Generating table with latitude and longitude and altitude added in.

# After Sample Loss. 
repTable<-dat2 %>% filter(treatment != "mcnt") %>% drop_na(gluc_Conc) %>% group_by(FamilyLong,treatment) %>% summarize(SampleSize=n(),Latitude=first(round(Latitude,2)),Longitude=first(round(Longitude,2)),Altitude=first(Altitude))


#Making the table into a wide format
repTableWide<-repTable %>% pivot_wider(names_from = treatment,values_from = SampleSize)

##Adding a column for total sample size per genotype
repTableWide$Total<-repTableWide$a+repTableWide$gm+repTableWide$m

##Ordering the data set.  
repTableWide<-repTableWide[order(repTableWide$Total,decreasing = T),]
repTableWide


write.csv(repTableWide,"Long_Family_Table.csv")

apply(repTableWide[,2:5],2,sum)



#hmmmmm.... this is very interesting. There is a strong significance between PCCG_2 and adult density. 
summary(glmmTMB(AdultDens~PCCG_2+(1|Family),data=dat2))
####


#We are seeing that glucosinolate investment is higher in higher adult densities???
dat2$


```
