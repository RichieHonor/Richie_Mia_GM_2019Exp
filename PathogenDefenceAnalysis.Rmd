---
title: "PathogenDefenseAnalysis"
author: "Richard Honor"
date: "03/05/2020"
output: html_document
---

#Read in and prep data
```{r}
library(ggplot2)
library(dplyr)
library("glmmTMB")


#read in data
rm(list=ls())
dat<-read.csv("DataSynthesis.csv")

#Assign family column
prefamily<-gsub("*.\\|","",dat$Tag)
dat$Family<-gsub("\\-.*","",prefamily)

#remove those with fertilizer treatment, and extra genotypes that are only in the alone treatment. 
dat<-dat[!grepl("i",dat$Sample,fixed=T),]


#Function to weigh pathogen damage by leaf area. 
Weigh<-function(x){
  x/(dat$GM_Leaf_Len*dat$GM_Leaf_Wid)
}

Standardize<-function(x){
  standard<-(x-mean(x,na.rm=T))/sd(x,na.rm=T)
}


dat$BlackPathDamW<-Weigh(dat$BlackPathDam)
dat$ThripsDamW<-Weigh(dat$ThripsDam)
dat$WhiteFungDamW<-Weigh(dat$WhiteFungDam)


#Average Duplicates. 
dat2<-dat %>% select(-X) %>% group_by(Tag) %>%  summarize(gh_col=first(gh_col),gh_bench=first(gh_bench),treatment=first(treatment),GA3=first(GA3),Family=first(Family),Maple_StemHeight_End=mean(Maple_StemHeight_End),Maple_LeafNum_End=mean(Maple_LeafNum_End),maple_leaf_length_0=mean(maple_leaf_length_0),maple_leaves_0=mean(maple_leaves_0),Maple_TotalLeafArea_End=mean(Maple_TotalLeafArea_End),MapleDamage=mean(Maple_Damage_End),Fern=first(Fern),gluc_Conc=mean(gluc_Conc),flav_Conc=mean(flav_Conc),maple_height_0=mean(maple_height_0),ChlorA=mean(ChlorA), GM_TotalLeaf_Area=first(GM_TotalLeaf_Area),ThripsDam=mean(ThripsDam),BlackPathDam=mean(BlackPathDam),WhiteFungDam=mean(WhiteFungDam),BlackPathDamW=mean(BlackPathDamW),ThripsDamW=mean(ThripsDamW),WhiteFungDamW=mean(WhiteFungDamW))

#Converting white fungal damage to logistic. 
dat2$WhiteFungLogis<-NA
dat2$WhiteFungLogis[dat2$WhiteFungDam>0]<-"Yes"
dat2$WhiteFungLogis[dat2$WhiteFungDam==0]<-"No"

dat$GM_Leaf_Area<-dat$GM_Leaf_Wid*dat$GM_Leaf_Len

```



#Modelling : Negative binomial on Thrips Damage. 
```{r}
#Because there is no such model that is negative binomial and continuous, i will have to controll for leave size and leaf health in the model. Leaf size must be contorlled for because more pathogens can appear on leaves with larger surface area. 

#Modelling Random Effects
#standardizing Leaf area. 
dat$GM_Leaf_Area<-Standardize(dat$GM_Leaf_Area)

fit_full<-glmmTMB(ThripsDam~treatment+gluc_Conc+flav_Conc+GM_Leaf_Area+ChlorA+(1|Family/Tag)+(1|gh_bench),family=nbinom2,data=dat)
summary(fit_full)

fit_full2<-glmmTMB(ThripsDam~treatment+gluc_Conc+flav_Conc+GM_Leaf_Area+ChlorA+(1|Family)+(1|gh_bench),family=nbinom2,data=dat)

fit_full3<-glmmTMB(ThripsDam~treatment+gluc_Conc+flav_Conc+GM_Leaf_Area+ChlorA+(1|Family/Tag),family=nbinom2,data=dat)

fit_full4<-glmmTMB(ThripsDam~treatment+gluc_Conc+flav_Conc+GM_Leaf_Area+ChlorA+(1|gh_bench),family=nbinom2,data=dat)

fit_full5<-glmmTMB(ThripsDam~treatment+gluc_Conc+flav_Conc+GM_Leaf_Area+ChlorA+(1|Tag)+(1|gh_bench),family=nbinom2,data=dat)


#Is Tag important? 
anova(fit_full,fit_full2) #Yes, 

#Is Family important? 
anova(fit_full,fit_full5) #No, Family is not significant, but Tag is.  
#Is GH_Bench important?

anova(fit_full,fit_full3) #No greenhouse bench is not important. 
#Therefore, Tag is the only random effect i need to include. 


#Modelling fixed effects 
fit_full<-glmmTMB(ThripsDam~treatment+gluc_Conc+flav_Conc+GM_Leaf_Area+ChlorA+(1|Tag),family=nbinom2,data=dat)


summary(fit_full) #Including leaf size almost completely eliminates the effect here. However, controlling for chlorophyll brings the significance right back for both. This is interesting. It means that after you controll for the overall health of the plant, glucosinolates and flavonoids significantly reduce thrips abundance.

fit_1<-update(fit_full,~.-treatment)
anova(fit_full,fit_1) #treatment is important. This is radicaly different than the results i got earlier. There are much more thrips in the garlic mustard treatment, which makes sense. 

#Could there be a synergistic effect of producing high glucosinolates and flavonoids? 
fit_1<-update(fit_full,~.+ gluc_Conc:flav_Conc)
anova(fit_full,fit_1) #No there isnt. 

summary(fit_full)
plot(resid(fit_full))
plot(resid(fit_full)^2)
#The model appears to be a good fit. 

```





#Modelling: Negative Binomial -- BlackPathDam 
```{r}

#Modelling random effects 

fit_full<-glmmTMB(BlackPathDam~treatment+gluc_Conc+flav_Conc+GM_Leaf_Area+ChlorA+(1|Family/Tag)+(1|gh_bench),family=nbinom2,data=dat)

fit_full2<-glmmTMB(BlackPathDam~treatment+gluc_Conc+flav_Conc+GM_Leaf_Area+ChlorA+(1|Family)+(1|gh_bench),family=nbinom2,data=dat)

fit_full3<-glmmTMB(BlackPathDam~treatment+gluc_Conc+flav_Conc+GM_Leaf_Area+ChlorA+(1|Family/Tag),family=nbinom2,data=dat)

fit_full4<-glmmTMB(BlackPathDam~treatment+gluc_Conc+flav_Conc+GM_Leaf_Area+ChlorA+(1|Tag)+(1|gh_bench),family=nbinom2,data=dat)

#Is Tag imporatant? 
anova(fit_full,fit_full2) #Yes it is. 

#Is gh_Bench imporatant? 
anova(fit_full,fit_full3) #No it is not.

#Is Family Important. 
anova(fit_full,fit_full4) #Yes it is 

#Modelling fixed effects 
fit_full<-glmmTMB(BlackPathDam~treatment+gluc_Conc+flav_Conc+GM_Leaf_Area+ChlorA+(1|Family/Tag),family=nbinom2,data=dat)

fit1<-update(fit_full,~.-treatment)
anova(fit_full,fit1) #treatment is important


summary(fit_full)# Gluc_Conc is not important. 
#Therefore, the best model is one with flavonoids and treatment. 

fit1<-update(fit_full,~.-gluc_Conc)
summary(fit1)
plot(residuals(fit1))

#All else are significant (except for leaf size) Therefore, flavonoids alone reduces black pathogen abundance -- even after contorlling for leaf allocation. There is likely also less blackpathogen damage in the maple treatment than in the garlic mustard treatment. 

```


#Modelling negative binomial White Fungal damage. 


#WhitePathDam -- logistic regression 
```{r}
#Because of how zero inflated white pathogen damage is, i will use a logistic regression to model it.
dat$WhiteFungLogis<-NA
dat$WhiteFungLogis[dat$WhiteFungDam==0]<-0
dat$WhiteFungLogis[dat$WhiteFungDam>0]<-1

#Modelling Random Effects
fit_full<-glmmTMB(WhiteFungLogis~treatment+gluc_Conc+flav_Conc+GM_Leaf_Area+ChlorA+(1|Family/Tag)+(1|gh_bench),family=binomial,data=dat)

fit_full2<-glmmTMB(WhiteFungLogis~treatment+gluc_Conc+flav_Conc+GM_Leaf_Area+ChlorA+(1|Family)+(1|gh_bench),family=binomial,data=dat)

fit_full3<-glmmTMB(WhiteFungLogis~treatment+gluc_Conc+flav_Conc+GM_Leaf_Area+ChlorA+(1|Family),family=binomial,data=dat)

fit_full4<-glmmTMB(WhiteFungLogis~treatment+gluc_Conc+flav_Conc+GM_Leaf_Area+ChlorA+(1|gh_bench),family=binomial,data=dat)

#Is Tag important? 
anova(fit_full,fit_full2) #no, the individual is not important. 

#Is Family important? 
anova(fit_full2,fit_full4) #Yes, family is important for predicting pathogen abundance. 

#Is gh_bench important? 
anova(fit_full2,fit_full3) #No, greenhouse bench is not important. 


#Modelling fixed effects. 
fit_full<-glmmTMB(WhiteFungLogis~treatment+gluc_Conc+flav_Conc+GM_Leaf_Area+ChlorA+(1|Family),family=binomial,data=dat)

fit1<-update(fit_full,~.-treatment)
anova(fit_full,fit1) #Treatment is important

summary(fit_full)#glucosinolate concentration is not. 
fit1<-glmmTMB(WhiteFungLogis~treatment+flav_Conc+GM_Leaf_Area+ChlorA+(1|Family),family=binomial,data=dat)

summary(fit1) #ChlorA is not 


fit1<-glmmTMB(WhiteFungLogis~treatment+flav_Conc+GM_Leaf_Area+(1|Family),family=binomial,data=dat)

summary(fit1)#flavonoids is not


fit1<-glmmTMB(WhiteFungLogis~treatment+GM_Leaf_Area+(1|Family),family=binomial,data=dat)
summary(fit1)
#treatment and leaf area all predict whehter or not garlic mustard will be affected by powdery mildue. This suggests that garlic mustard is very poorly defended against such a predator. 

```











