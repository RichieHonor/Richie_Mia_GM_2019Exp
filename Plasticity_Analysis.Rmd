---
title: "Plasticity Analysis"
author: "Richard Honor"
date: "28/04/2020"
output: html_document
---

#Read in data. 
```{r}
library(ggplot2)
library(dplyr)
library(lmerTest)

#read in data
rm(list=ls())
dat<-read.csv("DataSynthesis.csv")

#Assign family column
prefamily<-gsub("*.\\|","",dat$Tag)
dat$Family<-gsub("\\-.*","",prefamily)

#remove those with fertilizer treatment, and extra genotypes that are only in the alone treatment. 
dat<-dat[!grepl("i",dat$Sample,fixed=T),]


#Creating leaf area vector 
dat$GM_Leaf_Area<-dat$GM_Leaf_Len*dat$GM_Leaf_Wid

sd(dat$GM_Leaf_Area,na.rm=T) # certain variables can affect the linear regression simply because of how large they are. I will standardize GM_Leaf_Area, which is clearly way too large. 

Standardize<-function(x){
  standard<-(x-mean(x,na.rm=T))/sd(x,na.rm=T)
}
dat$GM_Leaf_Area<-Standardize(dat$GM_Leaf_Area)


#Making WhiteFungalDamage Boolean 
dat$WhiteFungLogis<-NA
dat$WhiteFungLogis[dat$WhiteFungDam>0]<-"Yes"
dat$WhiteFungLogis[dat$WhiteFungDam==0]<-"No"


```

#Standardizing pathogen damage
Previous analysis have indicated that leaf size is a significant predictor of pathogen abudnance. This is because the larger the leaf, the more pathogens can be on the leaf. For this reason, I am weighing the Thrips damage and black pathogen damage by the leaf area, and then standardizing the variable. 
```{r}
Weigh<-function(x){
  x/(dat$GM_Leaf_Len*dat$GM_Leaf_Wid)
}

Standardize<-function(x){
  standard<-(x-mean(x,na.rm=T))/sd(x,na.rm=T)
}

#Weighing measurements by leaf area
dat$ThripsDamW<-Weigh(dat$ThripsDam)
dat$BlackPathDamW<-Weigh(dat$BlackPathDam)

#Standardizing measurements
dat$ThripsDamW<-Standardize(dat$ThripsDamW)
dat$BlackPathDamW<-Standardize(dat$BlackPathDamW)

```


#What predicts glucosinolate concentration? (Apparent Plasticity)
```{r}
hist(dat$gluc_Conc) 
#The distribution looks faily normal, so i am going to use a linear mixed model. # My maximum model is one with possible interactions between pathogens, but no other interactions

#------------------
#Modelling Random Effects 

#Maximum model
fit<-lmer(gluc_Conc~treatment+WhiteFungLogis*BlackPathDamW*ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+(1|Family/Tag)+(1|gh_bench),data=dat)

#Is Tag important?
fit2<-lmer(gluc_Conc~treatment+WhiteFungLogis*BlackPathDamW*ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+(1|Family)+(1|gh_bench),data=dat)
anova(fit,fit2)#The model with Tag is much better. 

#Is greenhouse bench important?
fit3<-lmer(gluc_Conc~treatment+WhiteFungLogis*BlackPathDamW*ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+(1|Family/Tag),data=dat)
anova(fit,fit3) #gh_Bench is significant (p=0.04948). 

#Is family important? (Genotype effects)
fit4<-lmer(gluc_Conc~treatment+WhiteFungLogis*BlackPathDamW*ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+(1|Tag)+(1|gh_bench),data=dat)
anova(fit,fit4) #Family is very important.

#Is there a GXE interaction? 
fit5<-lmer(gluc_Conc~treatment+WhiteFungLogis*BlackPathDamW*ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+(1|Family:treatment)+(1|gh_bench),data=dat)
anova(fit2,fit5) #There is no GXE interaction


#------------------
#Modelling fixed effects. 

#Maximum model:
fit<-lmer(gluc_Conc~treatment+WhiteFungLogis*ThripsDamW*BlackPathDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+(1|Family/Tag)+(1|gh_bench),data=dat)

fit2<-update(fit,~.-WhiteFungLogis:ThripsDamW:BlackPathDamW)
anova(fit,fit2)

fit3<-update(fit2,~.-WhiteFungLogis:ThripsDamW)
anova(fit2,fit3)

fit4<-update(fit3,~.-ThripsDamW:BlackPathDamW)
anova(fit3,fit4)

fit5<-update(fit4,~.-WhiteFungLogis:BlackPathDamW)
anova(fit5,fit4)#There are no significant interactions. 


fit4<-lmer(gluc_Conc~treatment+BlackPathDamW+WhiteFungLogis+ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+(1|Family/Tag)+(1|gh_bench),data=dat)
summary(fit4) #White Fungi not important

#Removing WhiteFungLogis
fit4<-lmer(gluc_Conc~treatment+BlackPathDamW+ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+(1|Family/Tag)+(1|gh_bench),data=dat)
summary(fit4)#ThripsDam is not important

#Removing Thrips Dam
fit5<-lmer(gluc_Conc~treatment+BlackPathDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+(1|Family/Tag)+(1|gh_bench),data=dat)
summary(fit5)##Fern is not important

#Removing Fern
fit6<-lmer(gluc_Conc~treatment+BlackPathDamW+GM_Leaf_Area+I(GM_Leaf_Area^2)+(1|Family/Tag)+(1|gh_bench),data=dat[!is.na(dat$BlackPathDamW),])
summary(fit6)

#Black path dam is no longer significant: This is the best model. 
fit7<-lmer(gluc_Conc~treatment+GM_Leaf_Area+I(GM_Leaf_Area^2)+(1|Family/Tag)+(1|gh_bench),data=dat)

summary(fit7)#This is the best model. 
plot(fit7)#There still appears to be a pattern in the residuals, probably due to the skew in the data. 
qqnorm(residuals(fit7))
plot(residuals(fit7))


```


#What predicts glucosinolate concentration after controlling for resource allocation? (True Plasticity). 
```{r}
#Modelling Random Effects 

#Maximum model
fit<-lmer(gluc_Conc~treatment+WhiteFungLogis*BlackPathDamW*ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+ChlorA+treatment:ChlorA+(1|Family/Tag)+(1|gh_bench),data=dat)

#Is Tag important?
fit2<-lmer(gluc_Conc~treatment+WhiteFungLogis*BlackPathDamW*ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+ChlorA+treatment:ChlorA+(1|Family)+(1|gh_bench),data=dat)
anova(fit,fit2)#The model with Tag is better. 

#Is greenhouse bench important?
fit3<-lmer(gluc_Conc~treatment+WhiteFungLogis*BlackPathDamW*ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+ChlorA+treatment:ChlorA+(1|Family/Tag),data=dat)
anova(fit,fit3) #greenhouse bench is not significant. I will remove it from the analysis. 

#Is family important? (Genotype effects)
fit4<-lmer(gluc_Conc~treatment+WhiteFungLogis*BlackPathDamW*ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+ChlorA+treatment:ChlorA+(1|Tag)+(1|gh_bench),data=dat)
anova(fit,fit4) #Family is very important.

#Is there a GXE interaction? 
fit5<-lmer(gluc_Conc~treatment+WhiteFungLogis*BlackPathDamW*ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+ChlorA+treatment:ChlorA+(1|Family:treatment)+(1|gh_bench),data=dat)
anova(fit2,fit5) #There is no GXE interaction


#Modelling Fixed Effects. 

#Maximum model
fit<-lmer(gluc_Conc~treatment+WhiteFungLogis*BlackPathDamW*ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+ChlorA+treatment:ChlorA+(1|Family/Tag),data=dat)

fit1<-update(fit,~.- WhiteFungLogis:BlackPathDamW:ThripsDamW)
anova(fit,fit1) #No three way interaction

fit2<-update(fit1,~.- WhiteFungLogis:BlackPathDamW)
anova(fit2,fit1)#There is a significant interaction between White fungi presence and black pathogen damage. 

fit3<-update(fit1,~.- WhiteFungLogis:ThripsDamW)
anova(fit3,fit1) #No interaction

fit4<-update(fit3,~.- BlackPathDamW:ThripsDamW)
anova(fit4,fit3) #No interaction

summary(fit4) #Polynomial of leaf size isn't significant. 

fit5<-lmer(gluc_Conc~treatment+WhiteFungLogis+BlackPathDamW+ThripsDamW+Fern+GM_Leaf_Area+ChlorA+treatment:ChlorA+WhiteFungLogis:BlackPathDamW+(1|Family/Tag),data=dat)
summary(fit5) #Fern not significant. (Although it is close p=0.08)

fit6<-lmer(gluc_Conc~treatment+WhiteFungLogis+BlackPathDamW+ThripsDamW+GM_Leaf_Area+ChlorA+treatment:ChlorA+WhiteFungLogis:BlackPathDamW+(1|Family/Tag),data=dat)
summary(fit6) #BlackPathDamW not significant

fit7<-lmer(gluc_Conc~treatment+WhiteFungLogis+ThripsDamW+GM_Leaf_Area+ChlorA+treatment:ChlorA+WhiteFungLogis:BlackPathDamW+(1|Family/Tag),data=dat)
summary(fit7) #White Fung Dam not significant

fit8<-lmer(gluc_Conc~treatment+ThripsDamW+GM_Leaf_Area+ChlorA+treatment:ChlorA+WhiteFungLogis:BlackPathDamW+(1|Family/Tag),data=dat)
summary(fit8) #Everything else is significant. 

#Is the interaction between ChlorA and treatment significant? 
fit9<-lmer(gluc_Conc~treatment+ThripsDamW+GM_Leaf_Area+ChlorA+WhiteFungLogis:BlackPathDamW+(1|Family/Tag),data=dat)
anova(fit9,fit8) #Yes
summary(fit8)

#Interstingly there is significant interaction between chlorophyll a and treatment with glucosinolate concentration. What this means exacly is unclear, but the relationship between chlorophyll a and glucosinolate concentration is higher in the maple and garlic mustard treatment. 

#In terms of the fixed effects, the amount of glucosinolates still decreases in the maple and garlic mustard treatment, suggesting that the plasticity we see is actually true plasticity, and is not just occuring because the plants perform worse and so make less glucosinolates, but are actively producing less glucosinolates. This could also just represent a steeper decrease in glucosinolates than in chlorophyll. It would make sense for individuals to reduce the amount of glucosinolate they are producing before they reduce the amount of chlorophyll. This is in line with what is found for thrips damage, for some reason, glucosinolate concentration is reduced with increasing thrips damage after controlling for performance. This does not change, whether thrips damage is weighed by leaf size or not -- the effect is still negative. 

plot(fit8)
qqnorm(residuals(fit8))
plot(residuals(fit8))

```
Thrips damage, and treatment predict glucosinolate concentration after controlling for chlorophyll A, however, the lack of resources likely resulted in reduced production of glucosinolates before the reduced production of chlorophyll A - in other words, i think we are still observing apparent plasticity. Even the interaction between black pathogen damage and white fungal abundance is negative. 


#What predicts flavonoid concentration? (Apparent Plasticity)
```{r}
hist(dat$flav_Conc) 
#The distribution looks faily normal, so i am going to use a linear mixed model. # My maximum model is one with possible interactions between pathogens, but no other interactions

#------------------
#Modelling Random Effects 

#Maximum model
fit<-lmer(flav_Conc~treatment+WhiteFungLogis*BlackPathDamW*ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+(1|Family/Tag)+(1|gh_bench),data=dat)

#Is Tag important?
fit2<-lmer(flav_Conc~treatment+WhiteFungLogis*BlackPathDamW*ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+(1|Family)+(1|gh_bench),data=dat)
anova(fit,fit2)#The model with Tag is not significant, this means there is no evidence for genetic variation at the individual level (leaves are approximately the same)

#Is greenhouse bench important?
fit3<-lmer(flav_Conc~treatment+WhiteFungLogis*BlackPathDamW*ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+(1|Family/Tag),data=dat)
anova(fit,fit3) #gh_Bench is very significant. Keeping this in the analysis 

#Is family important? (Genotype effects)
fit4<-lmer(flav_Conc~treatment+WhiteFungLogis*BlackPathDamW*ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+(1|Tag)+(1|gh_bench),data=dat)
anova(fit,fit4) #Family is not important. 

#Is there a GXE interaction? 
fit5<-lmer(flav_Conc~treatment+WhiteFungLogis*BlackPathDamW*ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+(1|Family:treatment)+(1|gh_bench),data=dat)
anova(fit2,fit5) #There is no GXE interaction

#Double check family is not important because there was no significant effect of Tag. 
fit6<-lmer(flav_Conc~treatment+WhiteFungLogis*BlackPathDamW*ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+(1|gh_bench),data=dat)
anova(fit2,fit6) #Family is not important. 

#There is no significant family within family genetic variation for flavonoid concentration. 

#------------------
#Modelling fixed effects. 

#Maximum model:
fit<-lmer(flav_Conc~treatment+WhiteFungLogis*ThripsDamW*BlackPathDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+(1|gh_bench),data=dat)

fit2<-update(fit,~.-WhiteFungLogis:ThripsDamW:BlackPathDamW)
anova(fit,fit2)

fit3<-update(fit2,~.-WhiteFungLogis:ThripsDamW)
anova(fit2,fit3) # There is a significant interaction between white fungi presense and thripsdamage. 

fit4<-update(fit2,~.-ThripsDamW:BlackPathDamW)
anova(fit2,fit4) #no relationship here. 

fit5<-update(fit4,~.-WhiteFungLogis:BlackPathDamW)
anova(fit5,fit4)#There are no significant interactions. 


fit4<-lmer(flav_Conc~treatment+BlackPathDamW+WhiteFungLogis+ThripsDamW+Fern+GM_Leaf_Area+WhiteFungLogis:ThripsDamW+I(GM_Leaf_Area^2)+(1|gh_bench),data=dat)
summary(fit4)
#Removing WhiteFungLogis

fit4<-lmer(flav_Conc~treatment+BlackPathDamW+ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+WhiteFungLogis:ThripsDamW+(1|gh_bench),data=dat)
summary(fit4)#BlackPathDamW is also not important

#Removing BlackPathDamW
fit5<-lmer(flav_Conc~treatment+ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+WhiteFungLogis:ThripsDamW+(1|gh_bench),data=dat)
summary(fit5)#ThripsDamW is not imporant, although it is very very close to significant ( p= 0.056)

#Removing ThripsDamW
fit6<-lmer(flav_Conc~treatment+Fern+GM_Leaf_Area+WhiteFungLogis:ThripsDamW+I(GM_Leaf_Area^2)+(1|gh_bench),data=dat)
summary(fit6)#Fern is not important although it is very close to significant ( p=0.0546)

#Best Model
fit7<-lmer(flav_Conc~treatment+GM_Leaf_Area+WhiteFungLogis:ThripsDamW+I(GM_Leaf_Area^2)+(1|gh_bench),data=dat)
summary(fit7)#This is the best model. 
plot(fit7)
qqnorm(residuals(fit7))
plot(residuals(fit7))

#Treatment (Maple and garlic mustard) and an interaction between whitefungal abundance and thripsdamage reduced flavonoid concentration (apparent plasticity)


```


#What predicts flavonoid concentration after controlling for performance? (True Plasticity). 
```{r}
#Modelling Random Effects 

#Maximum model
fit<-lmer(flav_Conc~treatment+WhiteFungLogis*BlackPathDamW*ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+ChlorA+treatment:ChlorA+(1|Family/Tag)+(1|gh_bench),data=dat)

#Is Tag important?
fit2<-lmer(flav_Conc~treatment+WhiteFungLogis*BlackPathDamW*ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+ChlorA+treatment:ChlorA+(1|Family)+(1|gh_bench),data=dat)
anova(fit,fit2)#Tag is unimportant (i.e. there is no significant genetic variation within an individual.. leaves are very different) 

#Is greenhouse bench important?
fit3<-lmer(flav_Conc~treatment+WhiteFungLogis*BlackPathDamW*ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+ChlorA+treatment:ChlorA+(1|Family/Tag),data=dat)
anova(fit,fit3) #greenhouse bench is very significant. I will keep this.

#Is family important? (Genotype effects)
fit4<-lmer(flav_Conc~treatment+WhiteFungLogis*BlackPathDamW*ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+ChlorA+treatment:ChlorA+(1|Tag)+(1|gh_bench),data=dat)
anova(fit,fit4) #Family is not important.

#Is there a GXE interaction? 
fit5<-lmer(flav_Conc~treatment+WhiteFungLogis*BlackPathDamW*ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+ChlorA+treatment:ChlorA+(1|Family:treatment)+(1|gh_bench),data=dat)
anova(fit2,fit5) #There is no GXE interaction

#Double check that family isnt important because Tag was not significant.
fit6<-lmer(flav_Conc~treatment+WhiteFungLogis*BlackPathDamW*ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+ChlorA+treatment:ChlorA+(1|gh_bench),data=dat)
anova(fit6,fit2) #Family is not important, although it was close to significant (p=0.068)

#Modelling Fixed Effects. 

#Maximum model
fit<-lmer(flav_Conc~treatment+WhiteFungLogis*BlackPathDamW*ThripsDamW+Fern+GM_Leaf_Area+I(GM_Leaf_Area^2)+ChlorA+treatment:ChlorA+(1|gh_bench),data=dat)

fit1<-update(fit,~.- WhiteFungLogis:BlackPathDamW:ThripsDamW)
anova(fit,fit1) #No three way interaction

fit2<-update(fit1,~.- WhiteFungLogis:BlackPathDamW)
anova(fit2,fit1)#No interaction

fit3<-update(fit2,~.- WhiteFungLogis:ThripsDamW)
anova(fit3,fit2) #No interaction

fit4<-update(fit3,~.- BlackPathDamW:ThripsDamW)
anova(fit4,fit3) #No interaction

summary(fit4) #Polynomial of leaf size isn't significant. 

fit4<-lmer(flav_Conc~treatment+WhiteFungLogis+BlackPathDamW+ThripsDamW+Fern+GM_Leaf_Area+ChlorA+treatment:ChlorA+(1|gh_bench),data=dat)

fit5<-update(fit4,~.- ChlorA:treatment)
anova(fit5,fit4) #the chlorophyll A interaction is not important. 

fit5<-lmer(flav_Conc~treatment+WhiteFungLogis+BlackPathDamW+ThripsDamW+Fern+GM_Leaf_Area+ChlorA+(1|gh_bench),data=dat)
summary(fit5) #Fern not significant... but just barely (p=0.055)

fit6<-lmer(flav_Conc~treatment+WhiteFungLogis+BlackPathDamW+ThripsDamW+GM_Leaf_Area+ChlorA+(1|gh_bench),data=dat)
summary(fit6) #WhiteFung Dam is not significant


fit7<-lmer(flav_Conc~treatment+BlackPathDamW+ThripsDamW+GM_Leaf_Area+ChlorA+(1|gh_bench),data=dat)
summary(fit7)#Black Path Dam sint significant. 

fit7<-lmer(flav_Conc~treatment+ThripsDamW+GM_Leaf_Area+ChlorA+(1|gh_bench),data=dat)

#is treatment significant? 
fit8<-update(fit7,~.-treatment)
anova(fit7,fit8) #Treatment is highly significant. 

#Therefore, the best model is fit7, with predictors of thrips damage, black pathogen damage, treatment and leaf area all affecting the true plasticity of flavonoid compounds in this experiement. 

#However, the surprising result is that the amount of flavonoids actually decreases with increasing thrips and blackpathogen damage, even after chlorophyll is accounted for. This suggests that when the plant is suffering some sort of fitness consequence, it reduces the amount of glucosinolates and flavonoids before it reduces the amount of chlorophyll, which makes sense. 

plot(fit7)
qqnorm(residuals(fit7))
plot(residuals(fit7))


```
Even after controlling for performance, the parameter for thips damagage is negative, suggesting that thrips reduce perforncance and allow for less resources to be allocated to flavonoids, even after controlling for the amount of thrips in the experiemnt. 
