---
title: "Publication Analysis"
output: html_document
---

This analysis will exclude flavonoids.  

#Read in and prep data
```{r}
library(ggplot2)
library(glmmTMB)
library(cowplot)
library(grid)
library(gridExtra)
library(dplyr)
source("GGPlot_Themes.R")

#read in data
rm(list=ls())
dat<-read.csv("DataSynthesis.csv")


#remove those with fertilizer treatment, and extra genotypes that are only in the alone treatment. 
dat<-dat[!grepl("i",dat$ID,fixed=T),]


#Initializing columns to avoid constant error messages. 
dat$WhiteFungLogis<-NA
dat$BlackFungLogis<-NA

#Function to standardize variables. 
Standardize<-function(x){
  standard<-(x-mean(x,na.rm=T))/sd(x,na.rm=T)
}

```


#Generating data frames with summarized leaf data (dat2) and summarized genotype data (dat3)
```{r}

 #Logging data
  dat$Fern<-log(dat$Fern+1)
  dat$gluc_Conc<-log(dat$gluc_Conc)
  dat$flav_Conc<-log(dat$flav_Conc)
  dat$ChlorA<-log(dat$ChlorA)
 dat$ThripsDam<-log(dat$ThripsDam+1)
dat$BlackPathDam<-log(dat$BlackPathDam+1)

#Creating leaf area vector 
dat$GM_Leaf_Area<-dat$GM_Leaf_Len*dat$GM_Leaf_Wid

#Summarizing: Taking the mean value of leaves. This tibble contains data at the level of the plant means. 
dat2<-dat %>% group_by(Tag) %>% summarize(ChlorA=mean(ChlorA),ChlorB=mean(ChlorB),gluc_Conc=mean(gluc_Conc),flav_Conc=mean(flav_Conc),Family=first(Family),treatment=first(treatment),gh_row=first(gh_row),gh_bench=first(gh_bench),GM_TotalLeaf_Area=first(GM_TotalLeaf_Area),comp_number=first(comp_number),ThripsDam=mean(ThripsDam),WhiteFungDam=mean(WhiteFungDam),BlackPathDam=mean(BlackPathDam),Fern=mean(Fern),gh_col=first(gh_col),GM_Leaf_Area=mean(GM_Leaf_Area),Latitude=first(Latitude),Longitude=first(Longitude),Altitude=first(Altitude),
GM_StemHeight_Bolt=first(GM_StemHeight_Bolt),
GM_Leaf_Number_Bolt=first(GM_Leaf_Number_Bolt),
Larg_Leaf_Len_Bolt=first(Larg_Leaf_Len_Bolt),
Larg_Leaf_Wid_Bolt=first(Larg_Leaf_Wid_Bolt),
Row_Field=first(Row_Field),
Col_Field=first(Col_Field),
Maple_Died=first(Maple_Died),
Maple_TotalLeafArea_End=first(Maple_TotalLeafArea_End),
GM_Fecundity=first(GM_Fecundity),
MapleFinalMass=first(MapleFinalMass),
RGR1=first(RGR1),
NumberOfSamples=n(),
maple_height_0=first(maple_height_0),
maple_leaf_length_0=first(maple_leaf_length_0),
maple_leaves_0=first(maple_leaves_0),
Maple_StemHeight_End=first(Maple_StemHeight_End),
Maple_LeafNum_End=first(Maple_LeafNum_End),
Maple_TotalLeafArea_End=first(Maple_TotalLeafArea_End),
MapleDamage=mean(Maple_Damage_End)
)

#All of these genotypes died (15 Genotypes).(We are simply missing a final measurement for e|JBCHY1-1-50|Q|240) That is only 3% Mortality. 
dead<-dat2[is.na(dat2$GM_TotalLeaf_Area),]

deadID<-dead %>% filter(treatment!="mcnt",Tag!="e|JBCHY1-1-50|Q|240") #Here there are 12 putative dead competitors because  ("e|JBCHY1-1-50|Q|240") did not die. 

#Creating a collumn for those that survived (1) or died (2) in the greenhouse
dat2$GreenhouseSurvival<-c()
dat2$GreenhouseSurvival[dat2$Tag %in% deadID$Tag]<-0
dat2$GreenhouseSurvival[is.na(dat2$GreenhouseSurvival)]<-1


#Creating a column to model white pathogen presence (1= present on leaf)
dat2$WhiteFungLogis<-NA
dat2$WhiteFungLogis[dat2$WhiteFungDam==0]<-0
dat2$WhiteFungLogis[dat2$WhiteFungDam>0]<-1
dat2$WhiteFungLogis<-as.factor(dat2$WhiteFungLogis)


#Creating column to indivate whether bolts survived in the field or not (1 = survived, 0 = died).
dat2$Bolt_Survival<-c()
dat2$Bolt_Survival[dat2$GM_StemHeight_Bolt=="Dead"]<-0
dat2$Bolt_Survival[dat2$GM_StemHeight_Bolt!="Dead"]<-1
dat2$Bolt_Survival[is.na(dat2$GM_StemHeight_Bolt)]<-0 # I am going to be consistent and call those without a value dead because i missed these ones. 
dat2$Bolt_Survival[dat2$GM_Fecundity>0]<-1 #Those with fecundity data are also alive... 
dat2$Bolt_Survival[dat2$treatment=="mcnt"]<-NA #those that dies in year 1 are NA
dat2$Bolt_Survival[dat2$treatment=="mcnt"]<-NA #Maple controls are NA


#Creating a column to indicate wheter maples survived in year 2 or not.
dat2$Maple_SurvivalY2<-c()
dat2$Maple_SurvivalY2[is.na(dat2$MapleFinalMass)]<-0 #Converting all those without a final measurement to dead.
dat2$Maple_SurvivalY2[!is.na(dat2$MapleFinalMass)]<-1 #Anything that is not NA (i.e. has a final measurment, is alive)
dat2$Maple_SurvivalY2[dat2$Maple_TotalLeafArea_End==0]<-NA #anything that died in the first year is overwritten as NA 
dat2$Maple_SurvivalY2[!dat2$treatment %in% c("mcnt","m")]<-NA


#Creating a column to indicate whether maples survived in year 1 or not.
dat2$Maple_SurvivalY1<-c()
dat2$Maple_SurvivalY1[dat2$Maple_TotalLeafArea_End==0]<-0 #anything with a value of 0 is dead
dat2$Maple_SurvivalY1[is.na(dat2$Maple_TotalLeafArea_End)]<-NA #anything with NA is unknown
dat2$Maple_SurvivalY1[dat2$Maple_SurvivalY2==1]<-1 #Those with an NA will be overwritten if i have a record of their size in year two. 
dat2$Maple_SurvivalY1[dat2$Maple_TotalLeafArea_End>0]<-1 #anything with a value greater than zero is alive

#This Genotype was NA for maple total leaf area, but we know that it is dead. 
dat2$Maple_SurvivalY1[dat2$Tag=="e|CBMCK1-1-0|N|49"]<-0

#Creating a new fecundity collumn that has zeros for dead individuals 
dat2$GM_Fecundity2<-dat2$GM_Fecundity+0.05

#assigning those that didnt survive to zero.
dat2$GM_Fecundity2[dat2$Bolt_Survival==0]<-0

```


#Removing dead individuals and dead competitors from the analysis. 
```{r}

#Removing those with dead competitors from the garlic mustard treatment. ("e|JBCHY1-1-50|Q|240") did not die, we are simply missing the final measurement for it.
dead_competitors<-dead %>% filter(treatment=="gm",Tag!="e|JBCHY1-1-50|Q|240") %>% select(comp_number)

#Removing those with dead competitors from the analysis. 
dat2<-dat2 %>% filter(!comp_number %in% dead_competitors$comp_number)
dat<-dat %>% filter(!comp_number %in% dead_competitors$comp_number)

#Removing dead individuals from the analysis. 
dat2<-dat2[dat2$GreenhouseSurvival==1,]

#Removing those with dead maples from the analysis
dat2<-dat2[dat2$Maple_SurvivalY1==1 | is.na(dat2$Maple_SurvivalY1),]

```


#Generating PCA for Glucosinolate and Chlorophyll
```{r}
#######
#Trying a pca with all two variables, glucosinolate and chlorophyll.
#########
pcaGlucCor<-prcomp(~Standardize(ChlorA)+Standardize(gluc_Conc),data=dat2,na.action=na.omit)
biplot(pcaGlucCor)
pcaGlucCor
summary(pcaGlucCor)

#Loading to data frame.
prediction<-as.data.frame(predict(pcaGlucCor))

#addings PCs to the data frame. 
df2<-tibble::rownames_to_column(prediction, "rownumber")
dat2[df2$rownumber,"PCCG_1"]<-df2$PC1
dat2[df2$rownumber,"PCCG_2"]<-df2$PC2

hist(dat2$PCCG_1)
```

#PCA of GM SIZE in the second year. 
```{r}
#Changing dead individuals to zero. 
dat2$GM_StemHeight_Bolt[which(dat2$GM_StemHeight_Bolt=="Dead")]<-NA
dat2$GM_Leaf_Number_Bolt[which(dat2$GM_Leaf_Number_Bolt=="Dead")]<-NA
dat2$Larg_Leaf_Len_Bolt[which(dat2$Larg_Leaf_Len_Bolt=="Dead")]<-NA
dat2$Larg_Leaf_Wid_Bolt[which(dat2$Larg_Leaf_Wid_Bolt=="Dead")]<-NA

#Making data numeric
dat2$GM_StemHeight_Bolt<-as.numeric(dat2$GM_StemHeight_Bolt)
dat2$GM_Leaf_Number_Bolt<-as.numeric(dat2$GM_Leaf_Number_Bolt)
dat2$Larg_Leaf_Len_Bolt<-as.numeric(dat2$Larg_Leaf_Len_Bolt)
dat2$Larg_Leaf_Wid_Bolt<-as.numeric(dat2$Larg_Leaf_Wid_Bolt)

#Performing principal component analysis
pca<-prcomp(~GM_StemHeight_Bolt+GM_Leaf_Number_Bolt+Larg_Leaf_Len_Bolt+Larg_Leaf_Wid_Bolt,data=dat2,scale.=T,na.action=na.omit)
summary(pca)

#Assignign PCA bolt size data to the main data frame from analysis
prediction<-as.data.frame(predict(pca))
df<-tibble::rownames_to_column(prediction, "rownumber")
dat2[df$rownumber,"PC1BoltSize"]<-df$PC1
```


#PCA of Initial maple size
```{r}
#Creating a maple data frame
Maple<-dat2[dat2$treatment=="m"|dat2$treatment=="mcnt",]

#b|EFCC2-4-80|Q|144 and f|JBCHY1-1-50|Q|247,e|CBMCK1-1-0|N|49, e|JWBOY-2-80|Q|264 are simply not in the datafile. Nothing to do there - they will be deleted from the analysis. These genotypes are either dead, or we missed them when conducting the sampling.
Maple<-Maple[!is.na(Maple$Maple_StemHeight_End),]
Maple$treatment<-factor(Maple$treatment,levels = c("m","mcnt"))

#Selecting variables to use in the PCA (All initial and final maple measurements which could indicate performance)
PCAMaple<-Maple %>% select(maple_height_0,maple_leaf_length_0,maple_leaves_0,Maple_StemHeight_End,Maple_LeafNum_End,Maple_TotalLeafArea_End)

#Standardizing all variables.
PCAMaple<-data.frame(apply(PCAMaple,2,Standardize))

#Performing PCA model of initial maple size
pcaModelTotal<-prcomp(PCAMaple)
summary(pcaModelTotal)
pcaModelTotal

#All variables are correlated with the PC1 loading. 
plot(predict(pcaModelTotal)[,1]~PCAMaple$Maple_TotalLeafArea_End)
plot(predict(pcaModelTotal)[,1]~PCAMaple$maple_height_0)
plot(predict(pcaModelTotal)[,1]~PCAMaple$maple_leaf_length_0)
plot(predict(pcaModelTotal)[,1]~PCAMaple$maple_leaves_0)

#Adding in PC1 values of initial maple size to main maple data frame.
Maple$PC1Tot<-predict(pcaModelTotal)[,1]

#Creating a new data frame without maple controls (to be used in models that do not include maple treatment as a variable.) 
MapleModel<-Maple %>% filter(treatment=="m")
```


#What influences performance? 
```{r}
#Making fungal damage a factor for analyses
dat2$WhiteFungLogis<-as.factor(dat2$WhiteFungLogis)

#Modelling random effects.
fitfull<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PCCG_1+treatment*PCCG_2+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(Fern)+RGR1+(1|Family)+(1|gh_bench), data=dat2)

fitfull1<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PCCG_1+treatment*PCCG_2+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(Fern)+RGR1+(1|gh_bench), data=dat2)

fitfull2<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PCCG_1+treatment*PCCG_2+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(Fern)+RGR1+(1|Family), data=dat2)

summary(fitfull)
#Is family important? 
anova(fitfull,fitfull1) #No
#Is gh bench important? 
anova(fitfull,fitfull2) #Yes, gh_bench predicts performance. 


#Modelling fixed effects. 

#IS fern important? 
  fitfull1<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PCCG_1+treatment*PCCG_2+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(Fern)+RGR1+(1|gh_bench), data=dat2)
  fit2<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PCCG_1+treatment*PCCG_2+BlackPathDam*WhiteFungLogis*ThripsDam+RGR1+(1|gh_bench), data=dat2)
  anova(fitfull1,fit2) #yes

fit2<-update(fitfull1,~.-ThripsDam:BlackPathDam:WhiteFungLogis)
anova(fitfull1,fit2) #Not a significant three way interaction.

fit3<-update(fit2,~.-BlackPathDam:WhiteFungLogis)
anova(fit3,fit2) #There is not a significant two way interaction, 

fit4<-update(fit3,~.-BlackPathDam:ThripsDam)
anova(fit4,fit3)
#There is not a significant interaction between black path dam and thrips dam. 

fit5<-update(fit4,~.-WhiteFungLogis:ThripsDam)
anova(fit5,fit4) #There is not a significant whitefung dam and thrips dam interaction. 
summary(fit5)

#IS thrips dam significant?
fit11<-glmmTMB(Standardize(GM_TotalLeaf_Area) ~ treatment*PCCG_1+treatment*PCCG_2 + BlackPathDam +  WhiteFungLogis + ThripsDam  + RGR1 +Fern+(1 | gh_bench),data=dat2[!is.na(dat2$ThripsDam),])
fit12<-glmmTMB(Standardize(GM_TotalLeaf_Area) ~ treatment*PCCG_1+treatment*PCCG_2 + BlackPathDam +  WhiteFungLogis + RGR1+Fern+ (1 | gh_bench) ,data=dat2[!is.na(dat2$ThripsDam),])
anova(fit11,fit12) #No.

#Is  White Path dam significant
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PCCG_1+treatment*PCCG_2+BlackPathDam+WhiteFungLogis+RGR1+Fern+(1|gh_bench), data=dat2[!is.na(dat2$WhiteFungLogis),])
fit8<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PCCG_1+treatment*PCCG_2+BlackPathDam+RGR1+Fern+(1|gh_bench), data=dat2[!is.na(dat2$WhiteFungLogis),])
anova(fit6,fit8) #No

#Is  Black Path dam significant
fit5<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PCCG_1+treatment*PCCG_2+BlackPathDam+WhiteFungLogis+RGR1+Fern+(1|gh_bench), data=dat2[!is.na(dat2$BlackPathDam),])
fit7<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PCCG_1+treatment*PCCG_2+WhiteFungLogis+RGR1+Fern+(1|gh_bench), data=dat2[!is.na(dat2$BlackPathDam),])
anova(fit5,fit7) #Yes

#IS RGR1 significant?

fit4<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PCCG_1+treatment*PCCG_2+BlackPathDam+RGR1+Fern+(1|gh_bench), data=dat2[!is.na(dat2$RGR1),])
fit5<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PCCG_1+treatment*PCCG_2+BlackPathDam+Fern+(1|gh_bench), data=dat2[!is.na(dat2$RGR1),])
anova(fit5,fit6) # No

#IS the interaction between treatment and PCCG_2 significant?
fit6<-update(fit5,~.-treatment:PCCG_2)
anova(fit6,fit5) #No. 


#IS the interaction between treatment and PCCG_1 significant?
fit7<-update(fit6,~.-treatment:PCCG_1)
anova(fit7,fit6) #Yes

#IS PCCG_2 significant? 
fit8<-update(fit7,~.-PCCG_2)
anova(fit8,fit7) #No. 

#Is fern significant?  
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(PCCG_1)+Standardize(BlackPathDam)+Fern+(1|gh_bench),  data=dat2)
fit7<-glmmTMB(log(GM_TotalLeaf_Area)~treatment*Standardize(PCCG_1)+Standardize(BlackPathDam)+(1|gh_bench),  data=dat2)
anova(fit6,fit7)# No

#Best Model is: 
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(PCCG_1)+Standardize(BlackPathDam)+(1|gh_bench),  data=dat2)
summary(fit6)

plot(residuals(fit6)~fitted(fit6))
hist(residuals(fit6),breaks=20)

```

#Testing perfromance on residuals of leaf traits controlling for leaf size 
Reassessing PCCG_1 interaction after controlling for leaf area in PCCG_1. 
```{r}
#Removing Na's and making new dataframe with NAs excluded
datPlot<-dat2[!is.na(dat2$GM_TotalLeaf_Area)&!is.na(dat2$PCCG_1)&!is.na(dat2$BlackPathDam)&!is.na(dat2$gh_bench)&!is.na(dat2$GM_Leaf_Area),]

#For PCCG_1, Leaf Quality, obtaining the values of PCCG_1 after controlling for leaf area. 
fit<-glmmTMB(Standardize(PCCG_1)~Standardize(GM_Leaf_Area),data=datPlot)
fitResi<-residuals(fit)
datPlot$CGFResi<-as.single(fitResi)

#Assessing significance of interaction. 
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(CGFResi)+Standardize(BlackPathDam)+(1|gh_bench),  data=datPlot)

fit7<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment+Standardize(CGFResi)+Standardize(BlackPathDam)+(1|gh_bench),  data=datPlot)
anova(fit6,fit7) #Interaction is highly significant. p = 0.001

#Therefore, the  analysis without controlling for leaf area is similar to that with it controlled for.
summary(fit6)
```

#Performance visualization with other factors controlled for
```{r}
#Removing Na's and making new dataframe with NAs excluded
datPlot<-dat2[!is.na(dat2$PCCG_1)&!is.na(dat2$BlackPathDam)&!is.na(dat2$Fern)&!is.na(dat2$gh_bench),]

#Obtaining residuals from a model without the treatment*leafquality interaction
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~Standardize(BlackPathDam)+Standardize(Fern)+(1|gh_bench), data=datPlot)
summary(fit6)

#adding in residuals to the dataframe. 
fitResi<-residuals(fit6)
datPlot$GMSizeResi<-as.single(fitResi)

#Modelling the residuals against the interaction
fit7<-glmmTMB(GMSizeResi~treatment*Standardize(PCCG_1), data=datPlot)
summary(fit7) #The significance is still there. 


source("GGPlot_Themes.R")
#Is the cost dependent on the treatment? 

aloneSlope<-function(x){
  #y= 0.07142*x+ 0.34161
    y= 0*x+ 0.47445
  return(y)
}
mapleSlope<-function(x){
  y=( -0.09789 +0.33054  )*x+0.47445 -0.31869
  return(y)
}

mustardSlope<-function(x){
  #y=( 0.07142+0.03584)*x+0.34161-0.61888#Non significant slope
    y=0*x+0.47445-1.02501#Non significant slope
  return(y)
}

#Standardizing variables.
datPlot$PCCG_1S<-Standardize(datPlot$PCCG_1)

#Obtaining minimum and maximum values of leaf quality in each treatment.
minM<-min(datPlot$PCCG_1S[datPlot$treatment=="m"],na.rm = T)
maxM<-max(datPlot$PCCG_1S[datPlot$treatment=="m"],na.rm = T)

minA<-min(datPlot$PCCG_1S[datPlot$treatment=="a"],na.rm = T)
maxA<-max(datPlot$PCCG_1S[datPlot$treatment=="a"],na.rm = T)

minG<-min(datPlot$PCCG_1S[datPlot$treatment=="gm"],na.rm = T)
maxG<-max(datPlot$PCCG_1S[datPlot$treatment=="gm"],na.rm = T)

#Removing maple control
datPlot<-datPlot[datPlot$treatment!="mcnt",]


TLATiff<-ggplot(datPlot)+
  geom_point(aes(y=GMSizeResi,x=PCCG_1S,colour=treatment),size=1)+
  geom_segment(x=minA,xend=maxA,y=aloneSlope(minA),yend=aloneSlope(maxA),colour="#009E73",size=1.5)+
    geom_segment(x=minM,xend=maxM,y=mapleSlope(minM),yend=mapleSlope(maxM),colour="#E69F00",size=1.5)+
  geom_segment(x=minG,xend=maxG,y=mustardSlope(minG),yend=mustardSlope(maxG),colour="#56B4E9",size=1.5)+theme_simple_multiCol_First()+
  ylab(bquote(bold("Rosette Size Residuals")))+xlab("Leaf Quality (σ)")+
  scale_y_continuous(breaks=seq(-2,3,by=0.5))+
  scale_x_continuous(breaks=seq(-5,5,by=1))+

  scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Intraspecific","Interspecific"))

#tiff("Selection_Figures/LeafQualityOnSizeResiduals2.tiff", units="in", width=8, height=6, res=300)
TLATiff
#dev.off()

```


#Fecundity analysis redone with log data
I have not included flavonoids, nor white path or thrips dam, as these did not effect performance in year 1, therefore, i do not have reason to believe why they would affect fitness in year 2. 
```{r}
#Maximum model ... 
fit<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize)+(1|Family)+(1|Col_Field),data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

fit2<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

fit3<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize)+(1|Family)+(1|gh_bench),data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

fit4<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize)+(1|Family),data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

fit5<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize)+(1|Row_Field),data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

fit6<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

#IS column in field significant?
anova(fit,fit4) # No

#IS row in field significant?
anova(fit2,fit4) #No

#IS gh_bench  significant?
anova(fit3,fit4) #No.

#IS family  significant?
anova(fit5,fit2) #No, 0.06

###Modelling fixed effects 

#IS Black Path  dam significant?
fit1<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$BlackPathDam),])
fit2<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$BlackPathDam),])
anova(fit1,fit2) #No


#IS Fern significant?
fit2<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$Fern),])
fit3<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$Fern),])
anova(fit2,fit3) #No


###
# Testing life history data now
###

#Is RGR significant?
fit3<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$RGR1),])
fit4<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(GM_TotalLeaf_Area)+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$RGR1),])
anova(fit3,fit4) # Yes.......


#Is Total leaf area (year 1) significant?
fit3<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$GM_TotalLeaf_Area),])
fit4<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$GM_TotalLeaf_Area),])
anova(fit3,fit4) #No

#Is bolt size?
fit4<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$PC1BoltSize),])
fit5<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(RGR1),data=dat2[!is.na(dat2$PC1BoltSize),])
anova(fit4,fit5)# Yes it is.


###
# Testing leaf treats now
###
fit5<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1+treatment*PCCG_2+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2)


#IS the interaction between treatment and PCCG_2 significant?
fit6<-update(fit5,~.-treatment:PCCG_2)
anova(fit6,fit5) #No. 

#IS PCCG_2 significant? 
fit7<-update(fit6,~.-PCCG_2)
anova(fit7,fit6) #No 

#IS the interaction between treatment and PCCG_1 significant?
fit8<-update(fit7,~.-treatment:PCCG_1)
anova(fit8,fit7) #No. 

#IS PCCG_1 significant at all?
 fit10<-glmmTMB(log(GM_Fecundity) ~ treatment + PCCG_1 + Standardize(RGR1) +  
    Standardize(PC1BoltSize),data=dat2[!is.na(dat2$PCCG_1),])
  fit11<-glmmTMB(log(GM_Fecundity) ~ treatment  + Standardize(RGR1) +  
    Standardize(PC1BoltSize),data=dat2[!is.na(dat2$PCCG_1),])
anova(fit11,fit10) #No. 

#IS treatment significant at all?
 fit10<-glmmTMB(log(GM_Fecundity) ~ treatment +  Standardize(RGR1) +  
    Standardize(PC1BoltSize),data=dat2)
  fit11<-glmmTMB(log(GM_Fecundity) ~   + Standardize(RGR1) +  
    Standardize(PC1BoltSize),data=dat2)
anova(fit11,fit10) #Yes. treatment is significant 


#IS RGR1 still significant? 
fit11<-glmmTMB(log(GM_Fecundity)~treatment+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$RGR1),])
fit12<-glmmTMB(log(GM_Fecundity)~treatment+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$RGR1),])
anova(fit11, fit12) # No

#Best model is: 
fit12<-glmmTMB(log(GM_Fecundity)~treatment+Standardize(PC1BoltSize),data=dat2)
summary(fit12)

#Assessing interaction without boltsize.
 fit10<-glmmTMB(log(GM_Fecundity) ~ treatment * PCCG_1  ,data=dat2[!is.na(dat2$PCCG_1),])
  fit11<-glmmTMB(log(GM_Fecundity) ~ treatment + PCCG_1 ,data=dat2[!is.na(dat2$PCCG_1),])
anova(fit11,fit10) #No. 

#Assessing interaction without boltsize.
 fit10<-glmmTMB(log(GM_Fecundity) ~ treatment * PCCG_2  ,data=dat2[!is.na(dat2$PCCG_1),])
  fit11<-glmmTMB(log(GM_Fecundity) ~ treatment + PCCG_2 ,data=dat2[!is.na(dat2$PCCG_1),])
anova(fit11,fit10) #No. 


```



#Survival analysis updated to include PCA values. (also updated with correlations)
```{r}
#Maximum model ... is interaction significant?
fit<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+(1|Col_Field),data=dat2[!is.na(dat2$Col_Field),],family="binomial")

fit2<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$Col_Field),],family="binomial")

fit3<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+(1|gh_bench),data=dat2[!is.na(dat2$Col_Field),],family="binomial")

fit4<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family),data=dat2[!is.na(dat2$Col_Field),],family="binomial")

fit5<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Row_Field),data=dat2[!is.na(dat2$Col_Field),],family="binomial")

#IS column in field significant?
anova(fit,fit4) # No

#IS row in field significant?
anova(fit2,fit4) #Yes it is. 

#IS gh_bench  significant?
anova(fit3,fit4) #No.

#IS family  significant?
anova(fit5,fit2) #Yes

###Modelling fixed effects 

#IS Black path dam significant? 
fit0.1<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$BlackPathDam),],family="binomial")
fit1<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+Standardize(RGR1)+(1|Family)+(1|Row_Field)+Standardize(GM_TotalLeaf_Area),data=dat2[!is.na(dat2$BlackPathDam),],family="binomial")
anova(fit0.1,fit1)# no.

#IS fern significant? 
fit0.1<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$Fern),],family="binomial")
fit1<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(RGR1)+(1|Family)+(1|Row_Field)+Standardize(GM_TotalLeaf_Area),data=dat2[!is.na(dat2$Fern),],family="binomial")
anova(fit0.1,fit1)# Yes

#IS Total Leaf area (first year) significant? 
fit0.1<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$GM_TotalLeaf_Area),],family="binomial")
fit1<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+Standardize(RGR1)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$GM_TotalLeaf_Area),],family="binomial")
anova(fit0.1,fit1)# no.

#IS RGR significant? 
fit0.1<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+Standardize(RGR1)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$RGR1),],family="binomial")
fit1<-glmmTMB(Bolt_Survival~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$RGR1),],family="binomial")
anova(fit0.1,fit1)# no.

#IS the interaction between treatment and PCCG_2 significant?
fit2<-update(fit1,~.-treatment:PCCG_2)
anova(fit2,fit1) #No. 


#IS PCCG_2 significant? 
fit3<-update(fit2,~.-PCCG_2)
anova(fit2,fit3) #No. 


#IS the interaction between treatment and PCCG_1 significant?
fit4<-update(fit3,~.-treatment:PCCG_1)
anova(fit4,fit3) #yes, it is. 

#Best model
fit<- glmmTMB(Bolt_Survival ~ treatment*Standardize(PCCG_1) + Standardize(Fern) +  
    (1 | Family) + (1 | Row_Field) ,data=dat2, family="binomial")
summary(fit)


#There is a significantly positive selection gradient for pccg_1 in the gm treatment only... the same is true for leaf area of the sampled leaf.  
```


#Testing perfromance on residuals of leaf traits controlling for leaf size 
Reassessing PCCG_1 interaction after controlling for leaf area in PCCG_1. 
```{r}
#Removing Na's and making new dataframe with NAs excluded
datPlot<-dat2[!is.na(dat2$GM_Leaf_Area)&!is.na(dat2$PCCG_1)&!is.na(dat2$Fern)&!is.na(dat2$Row_Field)&!is.na(dat2$Bolt_Survival),]

#For PCCG_1, Leaf Quality, obtaining the values of PCCG_1 after controlling for leaf area. 
fit<-glmmTMB(Standardize(PCCG_1)~Standardize(GM_Leaf_Area),data=datPlot)
fitResi<-residuals(fit)
datPlot$CGResi<-as.single(fitResi)

#Assessing significance of interaction. 

fit1<- glmmTMB(Bolt_Survival ~ treatment*Standardize(CGResi) + Standardize(Fern) +  
    (1 | Family) + (1 | Row_Field) ,data=datPlot, family="binomial")
fit2<- glmmTMB(Bolt_Survival ~ treatment+Standardize(CGResi) + Standardize(Fern) +  
    (1 | Family) + (1 | Row_Field) ,data=datPlot, family="binomial")

anova(fit1,fit2) #Interaction is close to significance after controlling for leaf area of sampled leaf. 

summary(fit1)
```

#Modelling total relative fitness.
--did this wrong. the log doesnt work on 0 must be plus 1. 
```{r}
####
#Testing model fit
####

datPlot<-dat2[!is.na(dat2$GM_Fecundity2)&!is.na(dat2$PCCG_1)&!is.na(dat2$Fern)&!is.na(dat2$BlackPathDam)&!is.na(dat2$RGR1)&!is.na(dat2$PC1BoltSize),]

fit<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2)
hist(residuals(fit),breaks=20)
plot(residuals(fit)~fitted(fit))
plot(fitted(fit),log(datPlot$GM_Fecundity2+1))+abline(a=0,b=1) #This is actually a pretty good model. 
shapiro.test(residuals(fit)) #The fit is not that bad. 


####
#Modelling
####

#Maximum model ... 
fit<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize)+(1|Family)+(1|Col_Field),data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

fit2<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

fit3<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize)+(1|Family)+(1|gh_bench),data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

fit4<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize)+(1|Family),data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

fit5<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize)+(1|Row_Field),data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

fit6<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

#IS column in field significant?
anova(fit,fit4) # No

#IS row in field significant?
anova(fit2,fit4) #No

#IS gh_bench  significant?
anova(fit3,fit4) #No.

#IS family  significant?
anova(fit5,fit2) #No... but close - 0.07

###Modelling fixed effects 

#IS Black Path  dam significant?
fit1<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+BlackPathDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$BlackPathDam),])
fit2<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$BlackPathDam),])
anova(fit1,fit2) #No


#IS Fern significant?
fit2<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(Fern)+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$Fern),])
fit3<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$Fern),])
anova(fit2,fit3) #No


###
# Testing life history data now
###

#Is RGR significant?
fit3<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$RGR1),])
fit4<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(GM_TotalLeaf_Area)+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$RGR1),])
anova(fit3,fit4) # yes


#Is Total leaf area (year 1) significant?
fit3<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(GM_TotalLeaf_Area)+Standardize(PC1BoltSize)+Standardize(RGR1),data=dat2[!is.na(dat2$GM_TotalLeaf_Area),])
fit4<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(PC1BoltSize)+Standardize(RGR1),data=dat2[!is.na(dat2$GM_TotalLeaf_Area),])
anova(fit3,fit4) #No

#Is bolt size?
fit4<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$PC1BoltSize),])
fit5<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(RGR1),data=dat2[!is.na(dat2$PC1BoltSize),])
anova(fit4,fit5)# Yes it is.... very but perhaps a dumb variable to include beacuse all dead individuals also have 0 bolt size. 


###
# Testing leaf treats now
###
fit5<-glmmTMB(log(GM_Fecundity2+1)~treatment*PCCG_1+treatment*PCCG_2+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2)


#IS the interaction between treatment and PCCG_2 significant?
fit6<-update(fit5,~.-treatment:PCCG_2)
anova(fit6,fit5) #No. 

#IS PCCG_2 significant? 
fit7<-update(fit6,~.-PCCG_2)
anova(fit7,fit6) #No 

#IS the interaction between treatment and PCCG_1 significant?
fit8<-update(fit7,~.-treatment:PCCG_1)
anova(fit8,fit7) #No, but close

#Is pccg_1 significant?
fit12<-glmmTMB(log(GM_Fecundity2+1)~treatment+PCCG_1+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$PCCG_1),])
fit13<-glmmTMB(log(GM_Fecundity2+1)~treatment +Standardize(PC1BoltSize),data=dat2[!is.na(dat2$PCCG_1),])
anova(fit12,fit13)# No.

#Assessing PCCG_1 interaction without boltsize.
 fit10<-glmmTMB(log(GM_Fecundity2+1) ~ treatment * PCCG_1  ,data=dat2[!is.na(dat2$PCCG_1),])
  fit11<-glmmTMB(log(GM_Fecundity2+1) ~ treatment + PCCG_1 ,data=dat2[!is.na(dat2$PCCG_1),])
anova(fit11,fit10) #No. 0.15

#Assessing PCCG_2 interaction without boltsize.
 fit10<-glmmTMB(log(GM_Fecundity2+1) ~ treatment * PCCG_2  ,data=dat2[!is.na(dat2$PCCG_1),])
  fit11<-glmmTMB(log(GM_Fecundity2+1) ~ treatment + PCCG_2 ,data=dat2[!is.na(dat2$PCCG_1),])
anova(fit11,fit10) #No. 0.15


```

#Testing perfromance on residuals of leaf traits controlling for leaf size 
Reassessing PCCG_1 interaction after controlling for leaf area in PCCG_1. 
```{r}
#Removing Na's and making new dataframe with NAs excluded
datPlot<-dat2[!is.na(dat2$GM_Leaf_Area)&!is.na(dat2$GM_Fecundity2)&!is.na(dat2$PCCG_1)&!is.na(dat2$PC1BoltSize),]

#For PCCG_1, Leaf Quality, obtaining the values of PCCG_1 after controlling for leaf area. 
fit<-glmmTMB(Standardize(PCCG_1)~Standardize(GM_Leaf_Area),data=datPlot)
fitResi<-residuals(fit)
datPlot$CGResi<-as.single(fitResi)

#Assessing significance of interaction. 
fit12<-glmmTMB(log(GM_Fecundity2+1)~treatment*CGResi +Standardize(PC1BoltSize),data=datPlot)
fit13<-glmmTMB(log(GM_Fecundity2+1)~treatment+CGResi +Standardize(PC1BoltSize),data=datPlot)
anova(fit12,fit13) #The interaction is still not significant. 

anova(fit1,fit2) #Interaction is close to significance after controlling for leaf area of sampled leaf. 

summary(fit12)
```
#Relative fitness and permutation test p value.



#once down to significant predictors (include rosette size as predictor) then do permutation. Mean standardized fitness even with zeros in there. Calculate selection gradient then permutation and bootstrap on the relative fitness to get p values and standard errors. Do this simultaneous 


#look into structural equation modeling. https://jslefche.github.io/sem_book/global-estimation.html

#Phenotypic cor of the two traits and fitness... then 

#Path analysis
This will determine if the selection gradient of PCC1 on fitness is due to a direct effect on fitness, or an indirect effect through maple. 
```{r}
library(lavaan)

#Standardizing variables.
MapleModel$GM_TotalLeaf_AreaS<-Standardize(MapleModel$GM_TotalLeaf_Area)
MapleModel$Maple_TotalLeafArea_EndS<-Standardize(MapleModel$Maple_TotalLeafArea_End)
MapleModel$Maple_TotalLeafArea_EndL<-log(MapleModel$Maple_TotalLeafArea_End)

MapleModel$Maple_TotalLeafArea_EndSL<-Standardize(log(MapleModel$Maple_TotalLeafArea_End))
MapleModel$BlackPathDamS<-Standardize(MapleModel$BlackPathDam)

#Logging fecunity data for modelling.
MapleModel$GM_Fecundity2L<-log(MapleModel$GM_Fecundity2+1)



#Indirect effect of leaf traits on performance
MapleFormula.1 <- '
Maple_TotalLeafArea_EndS ~ PC1Tot+B1*PCCG_1 + MapleDamage + B2*PCCG_2

GM_TotalLeaf_AreaS ~ B3*Maple_TotalLeafArea_EndS + BlackPathDamS + PCCG_2 +PCCG_1

indirect := B2 * B3

'
fitPath<-sem(MapleFormula.1,data=MapleModel)

summary(fitPath,standardize=T)



#Indirect effect of leaf traits on survival
MapleFormula.2 <- '
Maple_TotalLeafArea_EndS ~ PC1Tot+B1*PCCG_1 + MapleDamage + B2*PCCG_2

Bolt_Survival ~ B3*Maple_TotalLeafArea_EndS + BlackPathDamS + PCCG_2 +PCCG_1

indirect := B2 * B3

'
fitPath<-sem(MapleFormula.2,data=MapleModel)

summary(fitPath,standardize=T)



#If Indirect effect of leaf traits on fitness. 
MapleFormula.3 <- '
Maple_TotalLeafArea_EndS ~ PC1Tot+B1*PCCG_1 + MapleDamage + B2*PCCG_2 

GM_Fecundity2L ~ B3*Maple_TotalLeafArea_EndS +PCCG_2 +PCCG_1

indirect := B2 * B3 
'
fitPath<-sem(MapleFormula.3,data=MapleModel)

summary(fitPath,standardize=T)



#If Indirect effect of leaf traits on all relative fitness Statistics performed in permutation test below, not logged data. 
MapleModel$GM_Fecundity3<-MapleModel$GM_Fecundity2/mean(MapleModel$GM_Fecundity2,na.rm=T)

MapleFormula.4 <- '
Maple_TotalLeafArea_EndS ~ PC1Tot+B1*PCCG_1 + MapleDamage + B2*PCCG_2 

GM_Fecundity3 ~ B3*Maple_TotalLeafArea_EndS +PCCG_2 +PCCG_1

indirect := B2 * B3 
'
fitPath<-sem(MapleFormula.4,data=MapleModel)

summary(fitPath,standardize=T)


```



#Functions for permutation test
```{r}
library(parallel)

#Function to provide a new data set filled with columns of permutations of a given vector.  
NewData<-function(data,Column,Column_Name=NA){ #Function to build a data frame with collumns representing permutations of the given vector.

  #Removing Rows with NA's for the focal column. 
  data<- data[!is.na(Column),]
   
   
    if(is.na(Column_Name)){
     stop("No column name provided, must be a character string")
    }
      Random<-sample(data$Column,replace=F)

  data[,Column_Name]<-Random
  return(data)
}


#Function to run the SEM model and obtain the output of interest from a data frame in a list 
Model_Over_List<-function(Formula, data_frame_as_list,L_or_A_pply="lapply", ...){
  
  if(L_or_A_pply=="apply"){
      Data<-as.data.frame(data_frame_as_list) #Modify list data to be in a data frame format
  }
  
  else
  Data=data_frame_as_list
  
 fit<-sem(Formula,data=Data, ...) #Model with the data

 invisible(capture.output(b<-summary(fit,standardize=T)[[1]])) #Summarize model 

Z<-b[b$lhs=="indirect","z"]#Extract coefficient of interest (z value)
 
  
  return(Z)
}


```


#Performing permutation tests for the indirect effect of PCC2 through maple after accounting for the main effect in the model. 
```{r}
#Models:
MapleFormula.1 #Performance
MapleFormula.2 #Survival (But not a binomial regression unfortunately.)
MapleFormula.3 #Fecundity
MapleFormula.4 #All fitness data 


#Performance - Indirect Effect 
Real_Z<-Model_Over_List(MapleFormula.1,data_frame_as_list=MapleModel)
Real_Z

#This function will replicate the data frame with the random variable as many times as i wish. 
Data_Frames<-replicate(2000,NewData(MapleModel,MapleModel$PCCG_2,"PCCG_2"),simplify=F)

head(Data_Frames)
#This applies the model over the list of data frames. 
random_Z<-mclapply(Data_Frames,Model_Over_List,Formula = MapleFormula.1)

Randon_Z<-unlist(random_Z)#removing list

length(Randon_Z[abs(Randon_Z)<abs(Real_Z)])/length(Randon_Z)# p= 0.0659... almost indirect selection against glucosinolate investment. 

hist(FVals3,breaks=50)+abline(v=a)

#The code is not good because it adds in NAs where there should not be. 
Data_Frames
```






#Fitness visualization with all available data. 
```{r}
fit7<-glmmTMB(log(GM_Fecundity)~treatment*PCCG_1, data=dat2)
summary(fit7) #The significance is still there. 


source("GGPlot_Themes.R")
#Is the cost dependent on the treatment? 

aloneSlope<-function(x){
  #No interaction slope:
  y=0.4091*x+0.3427
  #Interaction slope: 
  #  y= 0.31142 *x+ 0.45611
  return(y)
}
mapleSlope<-function(x){
    #No interaction slope:
 y=0.4091*x+ 0.3427-0.3417
    #Interaction slope: 
 # y=( 0.31142  +0.26758  )*x+0.45611 -0.47408 
  return(y)
}

mustardSlope<-function(x){
    #No interaction slope:
y=0.4091*x+  0.3427-0.6021 
    #Interaction slope: 
 #   y=0*x+0.45611-0.68846    #Non significant slope
  return(y)
}


#Obtaining minimum and maximum values of leaf quality in each treatment.
minM<-min(dat2$PCCG_1[dat2$treatment=="m"],na.rm = T)
maxM<-max(dat2$PCCG_1[dat2$treatment=="m"],na.rm = T)

minA<-min(dat2$PCCG_1[dat2$treatment=="a"],na.rm = T)
maxA<-max(dat2$PCCG_1[dat2$treatment=="a"],na.rm = T)

minG<-min(dat2$PCCG_1[dat2$treatment=="gm"],na.rm = T)
maxG<-max(dat2$PCCG_1[dat2$treatment=="gm"],na.rm = T)

#Removing maple control
dat2<-dat2[dat2$treatment!="mcnt",]


TLATiff<-ggplot(dat2)+
  geom_point(aes(y=log(GM_Fecundity),x=PCCG_1,colour=treatment),size=1)+
  geom_segment(x=minA,xend=maxA,y=aloneSlope(minA),yend=aloneSlope(maxA),colour="#009E73",size=1.5)+
    geom_segment(x=minM,xend=maxM,y=mapleSlope(minM),yend=mapleSlope(maxM),colour="#E69F00",size=1.5)+
  geom_segment(x=minG,xend=maxG,y=mustardSlope(minG),yend=mustardSlope(maxG),colour="#56B4E9",size=1.5)+theme_simple_multiCol_First()+
  ylab(bquote(bold("log(Fecundity)")))+xlab("PC1 Glucosinolate Chlorophyll (σ)")+
  scale_y_continuous(breaks=seq(-2,3,by=0.5))+
  scale_x_continuous(breaks=seq(-5,5,by=1))+

  scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Intraspecific","Interspecific"))

#tiff("Selection_Figures/PC1GC_OnFecundity2.tiff", units="in", width=8, height=6, res=300)
TLATiff
#dev.off()



```





