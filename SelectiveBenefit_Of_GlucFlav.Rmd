---
title: "Selective benefit of Glucosinolate and flavonoids"
output: html_notebook
---
#Part 1
The purpose of this notebook is to determine the selective benefit of glucosinolate and flavonoid compounds through plant competition by creating selection gradients. Selection gradients will involve final body mass as the proxy for fitness, but this will be replaced with fitness once the measurement is in. Concentration will be on the x-axis. This analysis will account for family and greenhouse location. 

#Part 2
The second purpose is to determine if glucosinolates and flavonoids influence suscpetibility to pathogens and if this susceptibility results in increased fitness




#Read in and prep data
```{r}
library(ggplot2)

library(glmmTMB)
library(cowplot)
library(grid)
library(gridExtra)
library(dplyr)
library(tidyr)
source("GGPlot_Themes.R")

#read in data
rm(list=ls())
dat<-read.csv("DataSynthesis.csv")

#Remove maple controls data from the data set.
#dat<-dat %>% filter(treatment!="mcnt") %>% droplevels()

#remove those with fertilizer treatment, and extra genotypes that are only in the alone treatment. 
dat<-dat[!grepl("i",dat$ID,fixed=T),] #Changed this from Sample to ID to get more specific.

#Initializing columns to avoid constant error messages. 
dat$WhiteFungLogis<-NA
dat$BlackFungLogis<-NA
```


#Generating data frames with summarized leaf data (dat2) and summarized genotype data (dat3)
```{r}

#Logging data
dat$FernClean<-dat$Fern
dat$Fern<-log(dat$Fern+1)
dat$gluc_Conc<-log(dat$gluc_Conc)
dat$flav_Conc<-log(dat$flav_Conc)
dat$ChlorA<-log(dat$ChlorA)
dat$ThripsDam<-log(dat$ThripsDam+1)
dat$BlackPathDam<-log(dat$BlackPathDam+1)



#Creating leaf area vector 
dat$GM_Leaf_Area<-dat$GM_Leaf_Len*dat$GM_Leaf_Wid


#Summarizing: Taking the mean value of leaves. This tibble contains data at the level of the plant means. 
dat2<-dat %>% group_by(Tag) %>% summarize(ChlorA=mean(ChlorA),ChlorB=mean(ChlorB),gluc_Conc=mean(gluc_Conc),flav_Conc=mean(flav_Conc),Family=first(Family),treatment=first(treatment),gh_row=first(gh_row),gh_bench=first(gh_bench),GM_TotalLeaf_Area=first(GM_TotalLeaf_Area),comp_number=first(comp_number),ThripsDam=mean(ThripsDam),WhiteFungDam=mean(WhiteFungDam),BlackPathDam=mean(BlackPathDam),Fern=mean(Fern),gh_col=first(gh_col),GM_Leaf_Area=mean(GM_Leaf_Area),Latitude=first(Latitude),Longitude=first(Longitude),Altitude=first(Altitude),RGR1=first(RGR1),FernClean=first(FernClean),ID=first(ID),MapleFinalMass=first(MapleFinalMass),Maple_TotalLeafArea_End=first(Maple_TotalLeafArea_End))

#All of these genotypes died (15 Genotypes).(We are simply missing a final measurement for e|JBCHY1-1-50|Q|240) That is only 3% Mortality. 
dead<-dat2[is.na(dat2$GM_TotalLeaf_Area),]

deadID<-dead %>% filter(treatment!="mcnt",Tag!="e|JBCHY1-1-50|Q|240") #Here there are 12 putative dead competitors because  ("e|JBCHY1-1-50|Q|240") did not die. 
#out of a total of 
dat2 %>% filter(treatment!="mcnt") #508 rows

#What are the frequencies in each treatment?

#Assinging those that died. 
deadID
dat2$FirstYearDeath<-c()
dat2$FirstYearDeath[dat2$Tag %in% deadID$Tag]<-"Died"
dat2$FirstYearDeath[is.na(dat2$FirstYearDeath)]<-"Alive"

#Making a table to determine the frequencies..
table(dat2$FirstYearDeath,dat2$treatment)
table(dat2$FirstYearDeath[dat2$treatment!="mcnt"])




#Determining which are absent from the main experiment.. 

#Removing those with dead competitors from the garlic mustard treatment. ("e|JBCHY1-1-50|Q|240") did not die, we are simply missing the final measurement for it.

dead_competitors<-dead %>% filter(treatment=="gm",Tag!="e|JBCHY1-1-50|Q|240") %>% select(comp_number)
dead_competitors

#Removing those with dead a petiolata competitors from the analysis. 
dat2<-dat2 %>% filter(!comp_number %in% dead_competitors$comp_number)
dat<-dat %>% filter(!comp_number %in% dead_competitors$comp_number)

#Removing dead individuals from the analysis. 
dat2<-dat2[dat2$FirstYearDeath=="Alive",]


#Making maple survival collumn. 
dat2$Maple_SurvivalY2<-c()
dat2$Maple_SurvivalY2[is.na(dat2$MapleFinalMass)]<-0 #Converting all those without a final measurement to dead.
dat2$Maple_SurvivalY2[!is.na(dat2$MapleFinalMass)]<-1 #Anything that is not NA (i.e. has a final measurment, is alive)
dat2$Maple_SurvivalY2[dat2$Maple_TotalLeafArea_End==0]<-NA#anything that died in the first year is now NA 

#Making a maple survival Y1 collumn
dat2$Maple_SurvivalY1<-c()
dat2$Maple_SurvivalY1[dat2$Maple_TotalLeafArea_End==0]<-0 #anything with a value of 0 is dead
dat2$Maple_SurvivalY1[is.na(dat2$Maple_TotalLeafArea_End)]<-NA #anything with NA is unknown
dat2$Maple_SurvivalY1[dat2$Maple_SurvivalY2==1]<-1 #Those with an NA will be overwritted if i have a record of their size in year two. 
dat2$Maple_SurvivalY1[dat2$Maple_TotalLeafArea_End>0]<-1 #anything with a value greater than zero is alive



#Removing those with dead maples from the analysis
dat2<-dat2[dat2$Maple_SurvivalY1==1 | is.na(dat2$Maple_SurvivalY1),]


#Because of how zero inflated white pathogen damage is, i will use a logistic regression to model it.
dat2$WhiteFungLogis<-NA
dat2$WhiteFungLogis[dat2$WhiteFungDam==0]<-0
dat2$WhiteFungLogis[dat2$WhiteFungDam>0]<-1


  #Function to standardize variables. 
Standardize<-function(x){
  standard<-(x-mean(x,na.rm=T))/sd(x,na.rm=T)
}

#Standardizing leaf area. 
dat2$GM_Leaf_Area<-Standardize(dat2$GM_Leaf_Area)

dat2 %>% filter(treatment=="mcnt")


```

#Descriptive statistics... to be used without the logged data. 
```{r}
tapply(dat2$gluc_Conc,dat2$treatment,mean,na.rm=T)
tapply(dat2$flav_Conc,dat2$treatment,mean,na.rm=T)
tapply(dat2$ChlorA,dat2$treatment,mean,na.rm=T)

```




#Generating PCA for Glucosinolate, Flavonoid and Chlorophyll
```{r}
#######
#Trying a pca with all three variables.
#########
pcaGlucCorFlav<-prcomp(~Standardize(gluc_Conc)+Standardize(ChlorA)+Standardize(flav_Conc),data=dat2,na.action=na.omit)
biplot(pcaGlucCorFlav)
pcaGlucCorFlav
summary(pcaGlucCorFlav)

#Loading to data frame.
prediction<-as.data.frame(predict(pcaGlucCorFlav))


df2<-tibble::rownames_to_column(prediction, "rownumber")
dat2[df2$rownumber,"PC1AllCGF"]<-df2$PC1
dat2[df2$rownumber,"PC2All_CF"]<-df2$PC2
dat2[df2$rownumber,"PC3All_CG"]<-df2$PC3

#PC2 is off diagonal for flav. (Higher values is higher flavonoid:Chlorophyll)
#PC3 is the off diagonal for glucosinolate.  (Higher values is higher glucosinolate:Chlorophyll)



```






#What influences performance (update with PCA model selection) (Redoing estimate without family)? 
```{r}
dat2$WhiteFungLogis<-as.factor(dat2$WhiteFungLogis)
#Modelling random effects.
fitfull<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_Leaf_Area)+Standardize(Fern)+RGR1+(1|Family)+(1|gh_bench), data=dat2)

fitfull1<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_Leaf_Area)+Standardize(Fern)+RGR1+(1|gh_bench), data=dat2)

fitfull2<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_Leaf_Area)+Standardize(Fern)+RGR1+(1|Family), data=dat2)

summary(fitfull)
#Is family important? 
anova(fitfull,fitfull1) #Marginal
#Is gh bench important? 
anova(fitfull,fitfull2) #Yes, gh_bench predicts performance. 

#Modelling fixed effects. 

#IS fern important? 
  fitfull1<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_Leaf_Area)+Standardize(Fern)+RGR1+(1|gh_bench), data=dat2)
  fit2<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_Leaf_Area)+RGR1+(1|gh_bench), data=dat2)
  anova(fitfull1,fit2) #No

fit2<-update(fitfull1,~.-ThripsDam:BlackPathDam:WhiteFungLogis)
anova(fitfull1,fit2) #Not a significant three way interaction.

fit3<-update(fit2,~.-BlackPathDam:WhiteFungLogis)
anova(fit3,fit2) #There is not a significant two way interaction, 

fit4<-update(fit3,~.-BlackPathDam:ThripsDam)
anova(fit4,fit3)
#There is not a significant interaction between black path dam and thrips dam. 

fit5<-update(fit4,~.-WhiteFungLogis:ThripsDam)
anova(fit5,fit4) #There is not a significant whitefung dam and thrips dam interaction. 

#IS the interaction between treatment and PC3All_CG significant?
fit6<-update(fit5,~.-treatment:PC3All_CG)
anova(fit6,fit5) #No. 

#IS the interaction between treatment and PC2All_CF significant?
fit7<-update(fit6,~.-treatment:PC2All_CF)
anova(fit7,fit6) #No. 


#IS PC3All_CG significant? 
fit8<-update(fit7,~.-PC3All_CG)
anova(fit8,fit7) #No. 

#IS PC2All_CF significant? 
fit9<-update(fit8,~.-PC2All_CF)
anova(fit9,fit8) #No. 


#IS the interaction between treatment and PC1AllCGF significant?
fit10<-update(fit9,~.-treatment:PC1AllCGF)
anova(fit10,fit9) #No... but it is marginal. (p=0.054)

#IS thrips dam significant?
fit11<-glmmTMB(Standardize(GM_TotalLeaf_Area) ~ treatment + PC1AllCGF + BlackPathDam +  WhiteFungLogis + ThripsDam + Standardize(GM_Leaf_Area)  + (1 | gh_bench) + treatment:PC1AllCGF,data=dat2[!is.na(dat2$ThripsDam),])
fit12<-glmmTMB(Standardize(GM_TotalLeaf_Area) ~ treatment + PC1AllCGF + BlackPathDam +  WhiteFungLogis  + Standardize(GM_Leaf_Area) + (1 | gh_bench) + treatment:PC1AllCGF,data=dat2[!is.na(dat2$ThripsDam),])
anova(fit11,fit12) #No it is not. (0.08537)

#IS RGR1 significant?
fit12<-glmmTMB(Standardize(GM_TotalLeaf_Area) ~ treatment + PC1AllCGF + BlackPathDam +  WhiteFungLogis  + Standardize(GM_Leaf_Area) + RGR1 + (1 | gh_bench) + treatment:PC1AllCGF,data=dat2[!is.na(dat2$RGR1),])
fit13<-glmmTMB(Standardize(GM_TotalLeaf_Area) ~ treatment + PC1AllCGF + BlackPathDam +  WhiteFungLogis  + Standardize(GM_Leaf_Area) + (1 | gh_bench) + treatment:PC1AllCGF,data=dat2[!is.na(dat2$RGR1),])
anova(fit13,fit12) #No it is not.
summary(fit12)

#IS the interaction between treatment and PC1AllCGF significant?
fit13<-glmmTMB(Standardize(GM_TotalLeaf_Area) ~ treatment + PC1AllCGF + BlackPathDam +  WhiteFungLogis  + Standardize(GM_Leaf_Area)  + (1 | gh_bench) + treatment:PC1AllCGF,data=dat2)
fit14<-update(fit13,~.-treatment:PC1AllCGF)
anova(fit13,fit14) #Yes it is significant after thrips was removed. ... 0.037067


#Is  White Path dam significant
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PC1AllCGF+BlackPathDam+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|gh_bench), data=dat2[!is.na(dat2$WhiteFungLogis),])
fit8<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PC1AllCGF+BlackPathDam+Standardize(GM_Leaf_Area)+(1|gh_bench), data=dat2[!is.na(dat2$WhiteFungLogis),])
anova(fit6,fit8) #Yes

#Is  Black Path dam significant
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PC1AllCGF+BlackPathDam+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|gh_bench), data=dat2[!is.na(dat2$BlackPathDam),])
fit8<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PC1AllCGF+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|gh_bench), data=dat2[!is.na(dat2$BlackPathDam),])
anova(fit6,fit8) #Yes

#Is interaction significant?. 
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(PC1AllCGF)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|gh_bench), data=dat2[!is.na(dat2$BlackPathDam),])
fit6b<-update(fit6,~.-treatment:Standardize(PC1AllCGF))
anova(fit6,fit6b) #yes

#IS RGR Significant?
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(PC1AllCGF)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(GM_Leaf_Area)+Standardize(RGR1)+(1|gh_bench), data=dat2[!is.na(dat2$RGR1),])
fit6b<-update(fit6,~.-Standardize(RGR1))
anova(fit6,fit6b) #no


#Is GM_leaf area significant?
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(PC1AllCGF)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|gh_bench), data=dat2[!is.na(dat2$GM_Leaf_Area),])
fit7<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(PC1AllCGF)+Standardize(BlackPathDam)+WhiteFungLogis+(1|gh_bench), data=dat2[!is.na(dat2$GM_Leaf_Area),])
anova(fit6,fit7)


#Is greenhouse significant?
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(PC1AllCGF)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$GM_Leaf_Area),])
fit7<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(PC1AllCGF)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|Family), data=dat2[!is.na(dat2$GM_Leaf_Area),])
anova(fit6,fit7)


#Final Model
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(PC1AllCGF)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|gh_bench), data=dat2[!dat2$Family=="EFCC2",])
summary(fit6)
dat2[!dat2$Family=="EFCC2",]
unique(dat2$Family)

fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(ChlorA)+treatment*Standardize(gluc_Conc)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|gh_bench), data=dat2[!is.na(dat2$flav_Conc),])

fit7<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(ChlorA)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|gh_bench), data=dat2[!is.na(dat2$flav_Conc),])
anova(fit6,fit7)

fit8<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(gluc_Conc)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|gh_bench), data=dat2[!is.na(dat2$flav_Conc),])

fit9<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(flav_Conc)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|gh_bench), data=dat2[!is.na(dat2$flav_Conc),])
anova(fit6,fit8,fit9)

AIC(fit7,fit8)

fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(ChlorA)+treatment*Standardize(gluc_Conc)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|gh_bench), data=dat2[!is.na(dat2$BlackPathDam),])

#Just depends which one i remove from the model first, that one is the significant one because the effect is shared between chlor A and gluc_Conc. 

summary(fit6)




#Treatment effect 
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment+Standardize(BlackPathDam)+WhiteFungLogis+(1|Family)+(1|gh_bench), data=dat2)
fit7<-glmmTMB(Standardize(GM_TotalLeaf_Area)~Standardize(BlackPathDam)+WhiteFungLogis+(1|Family)+(1|gh_bench), data=dat2)
anova(fit6,fit7)



```




#Visualization -- The conditional benefit of PC1 (allelopathy)
```{r}
source("GGPlot_Themes.R")
#Is the cost dependent on the treatment? 

aloneSlope<-function(x){
  #y= 0.07142*x+ 0.34161
    y= 0*x+ 0.34161
  return(y)
}
mapleSlope<-function(x){
  y=( 0.07142+0.22952 )*x+0.34161 -0.23701
  return(y)
}

mustardSlope<-function(x){
  #y=( 0.07142+0.03584)*x+0.34161-0.61888#Non significant slope
    y=0*x+0.34161-0.61888#Non significant slope
  return(y)
}

#Standardizing variables.
dat2$GM_TotalLeaf_AreaS<-Standardize(dat2$GM_TotalLeaf_Area)
dat2$PC1AllCGFS<-Standardize(dat2$PC1AllCGF)

minM<-min(dat2$PC1AllCGFS[dat2$treatment=="m"],na.rm = T)
maxM<-max(dat2$PC1AllCGFS[dat2$treatment=="m"],na.rm = T)

minA<-min(dat2$PC1AllCGFS[dat2$treatment=="a"],na.rm = T)
maxA<-max(dat2$PC1AllCGFS[dat2$treatment=="a"],na.rm = T)

minG<-min(dat2$PC1AllCGFS[dat2$treatment=="gm"],na.rm = T)
maxG<-max(dat2$PC1AllCGFS[dat2$treatment=="gm"],na.rm = T)

datVis<-dat2[dat2$treatment!="mcnt",]
TLATiff<-ggplot(datVis)+
  geom_point(aes(y=GM_TotalLeaf_AreaS,x=PC1AllCGFS,colour=treatment,shape=treatment),size=2)+
  geom_segment(x=minA,xend=maxA,y=aloneSlope(minA),yend=aloneSlope(maxA),colour="#009E73",size=1.5)+
    geom_segment(x=minM,xend=maxM,y=mapleSlope(minM),yend=mapleSlope(maxM),colour="#E69F00",size=1.5)+
  geom_segment(x=minG,xend=maxG,y=mustardSlope(minG),yend=mustardSlope(maxG),colour="#56B4E9",size=1.5)+theme_simple_multiCol_First()+
  ylab(bquote(bold("Rosette Size (σ)")))+xlab("Leaf Quality (σ)")+
  scale_y_continuous(breaks=seq(-2,3,by=0.5))+
  scale_x_continuous(breaks=seq(-5,5,by=1))+

  scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Intraspecific","Interspecific"))


TLATiff


```





#Modelling: Effect of Fern on GM
```{r}
#Because there are two garlic mustard individuals per pot, and the unit we are looking at is only replicable at the pot level (fern abundance in a pot) duplicates within the same pot in the garlic mustard treatment need to be removed and averaged to remove pseudoreplication. 

#What i will do is make the competition number the tag for those in the GM treatment. This will have the effect of maintaining the leaf variation, but averaging it over each pot. 

# I will need to use dat2, summarized at the individual level, because we have a single observation at the pot level, not at the leaf level. 
datFern<-dat2
datFern$Tag<-as.character(datFern$Tag)
for(i in 1:length(datFern$Tag)){
  if(!is.na(datFern$comp_number[i])){
    datFern$Tag[i]<-datFern$comp_number[i]
  }
}

#Averaging pot values in the GM treatment.
datFernGM<-datFern %>% group_by(Tag) %>% filter(treatment=="gm") %>% summarize_all(~mean(.))
datFernGM$treatment<-"gm"

#Binding collumns back together. Family should not be used as those in the GM treatment represent the average of two families. 
datFern2<-rbind(datFernGM,datFern[datFern$treatment!="gm",])

#From Old Model -- all that is important.
fit_full1<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(Fern)+(1|gh_bench),data=datFern2)

summary(fit_full1)

```
#Fern Statistics 
```{r}

ConfidenceInt<-function(x){
  x<-x[!is.na(x)]#remove NA
  N<-length(x)
  SE<-sd(x)/sqrt(N) #get Standard Error
  Conf<-SE*qt(0.975,N-1)# Get confidence intercal
  return(Conf)
}


tapply(datFern2$FernClean,datFern2$treatment,mean)
tapply(datFern2$FernClean,datFern2$treatment,ConfidenceInt)

```



#What influences performance (update with PCA model selection)? 
```{r}
#Modelling random effects.
fitfull<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_Leaf_Area)+RGR1+(1|Family)+(1|gh_bench), data=dat2)

fitfull1<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_Leaf_Area)+RGR1+(1|gh_bench), data=dat2)

fitfull2<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_Leaf_Area)+RGR1+(1|Family), data=dat2)

summary(fitfull)
#Is family important? 
anova(fitfull,fitfull1) #Marginal
#Is gh bench important? 
anova(fitfull,fitfull2) #Yes, gh_bench predicts performance. 

#Modelling fixed effects. 

fit2<-update(fitfull,~.-ThripsDam:BlackPathDam:WhiteFungLogis)
anova(fitfull,fit2) #Not a significant three way interaction.

fit3<-update(fit2,~.-BlackPathDam:WhiteFungLogis)
anova(fit3,fit2) #There is not a significant two way interaction, 

fit4<-update(fit3,~.-BlackPathDam:ThripsDam)
anova(fit4,fit3)
#There is not a significant interaction between black path dam and thrips dam. 

fit5<-update(fit4,~.-WhiteFungLogis:ThripsDam)
anova(fit5,fit4) #There is not a significant whitefung dam and thrips dam interaction. 

#IS the interaction between treatment and PC3All_CG significant?
fit6<-update(fit5,~.-treatment:PC3All_CG)
anova(fit6,fit5) #No. 

#IS the interaction between treatment and PC2All_CF significant?
fit7<-update(fit6,~.-treatment:PC2All_CF)
anova(fit7,fit6) #No. 


#IS PC3All_CG significant? 
fit8<-update(fit7,~.-PC3All_CG)
anova(fit8,fit7) #No. 

#IS PC2All_CF significant? 
fit9<-update(fit8,~.-PC2All_CF)
anova(fit9,fit8) #No. 


#IS the interaction between treatment and PC1AllCGF significant?
fit10<-update(fit9,~.-treatment:PC1AllCGF)
anova(fit10,fit9) #No... but it is marginal. (p=0.054)

#IS thrips dam significant?
fit11<-glmmTMB(Standardize(GM_TotalLeaf_Area) ~ treatment + PC1AllCGF + BlackPathDam +  WhiteFungLogis + ThripsDam + Standardize(GM_Leaf_Area) +  (1 | Family) + (1 | gh_bench) + treatment:PC1AllCGF,data=dat2[!is.na(dat2$ThripsDam),])
fit12<-glmmTMB(Standardize(GM_TotalLeaf_Area) ~ treatment + PC1AllCGF + BlackPathDam +  WhiteFungLogis  + Standardize(GM_Leaf_Area) +  (1 | Family) + (1 | gh_bench) + treatment:PC1AllCGF,data=dat2[!is.na(dat2$ThripsDam),])
anova(fit11,fit12) #No it is not. (0.08537)

#IS RGR1 significant?
fit12<-glmmTMB(Standardize(GM_TotalLeaf_Area) ~ treatment + PC1AllCGF + BlackPathDam +  WhiteFungLogis  + Standardize(GM_Leaf_Area) + RGR1+  (1 | Family) + (1 | gh_bench) + treatment:PC1AllCGF,data=dat2[!is.na(dat2$RGR1),])
fit13<-glmmTMB(Standardize(GM_TotalLeaf_Area) ~ treatment + PC1AllCGF + BlackPathDam +  WhiteFungLogis  + Standardize(GM_Leaf_Area) +  (1 | Family) + (1 | gh_bench) + treatment:PC1AllCGF,data=dat2[!is.na(dat2$RGR1),])
anova(fit13,fit12) #No it is not.
summary(fit12)

#IS the interaction between treatment and PC1AllCGF significant?
fit13<-glmmTMB(Standardize(GM_TotalLeaf_Area) ~ treatment + PC1AllCGF + BlackPathDam +  WhiteFungLogis  + Standardize(GM_Leaf_Area) +  (1 | Family) + (1 | gh_bench) + treatment:PC1AllCGF,data=dat2)
fit14<-update(fit13,~.-treatment:PC1AllCGF)
anova(fit13,fit14) #Yes it is significant after thrips was removed. ... 0.04067


#Is  White Path dam significant
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PC1AllCGF+BlackPathDam+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$WhiteFungLogis),])
fit8<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PC1AllCGF+BlackPathDam+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$WhiteFungLogis),])
anova(fit6,fit8) #Yes

#Is  Black Path dam significant
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PC1AllCGF+BlackPathDam+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$BlackPathDam),])
fit8<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*PC1AllCGF+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$BlackPathDam),])
anova(fit6,fit8) #Yes

#Is interaction significant?. 
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(PC1AllCGF)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$BlackPathDam),])
fit6b<-update(fit6,~.-treatment:Standardize(PC1AllCGF))
anova(fit6,fit6b) #yes

#IS RGR Significant?
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(PC1AllCGF)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(GM_Leaf_Area)+Standardize(RGR1)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$RGR1),])
fit6b<-update(fit6,~.-Standardize(RGR1))
anova(fit6,fit6b) #no


#Is GM_leaf area significant?
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(PC1AllCGF)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$GM_Leaf_Area),])
fit7<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(PC1AllCGF)+Standardize(BlackPathDam)+WhiteFungLogis+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$GM_Leaf_Area),])
anova(fit6,fit7)

#Is Family significant?
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(PC1AllCGF)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$GM_Leaf_Area),])
fit7<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(PC1AllCGF)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|gh_bench), data=dat2[!is.na(dat2$GM_Leaf_Area),])
anova(fit6,fit7)

#Is greenhouse significant?
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(PC1AllCGF)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$GM_Leaf_Area),])
fit7<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(PC1AllCGF)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|Family), data=dat2[!is.na(dat2$GM_Leaf_Area),])
anova(fit6,fit7)


#Final Model
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(PC1AllCGF)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$BlackPathDam),])


summary(fit6)




#Treatment effect 
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment+Standardize(BlackPathDam)+WhiteFungLogis+(1|Family)+(1|gh_bench), data=dat2)
fit7<-glmmTMB(Standardize(GM_TotalLeaf_Area)~Standardize(BlackPathDam)+WhiteFungLogis+(1|Family)+(1|gh_bench), data=dat2)
anova(fit6,fit7)



```

#Modelling: Fern Negative Binomial
```{r}
#Because there are two garlic mustard individuals per pot, and the unit we are looking at is only replicable at the pot level (fern abundance in a pot) duplicates within the same pot in the garlic mustard treatment need to be removed and averaged to remove pseudoreplication. 

#What i will do is make the competition number the tag for those in the GM treatment. This will have the effect of maintaining the leaf variation, but averaging it over each pot. 

# I will need to use dat2, summarized at the individual level, because we have a single observation at the pot level, not at the leaf level. 
datFern<-dat2
datFern$Tag<-as.character(datFern$Tag)
for(i in 1:length(datFern$Tag)){
  if(!is.na(datFern$comp_number[i])){
    datFern$Tag[i]<-datFern$comp_number[i]
  }
}
library(dplyr)
#Averaging pot values in the GM treatment.
datFernGM<-datFern %>% group_by(Tag) %>% filter(treatment=="gm") %>% summarize_all(~mean(.))
datFernGM$treatment<-"gm"

#Binding collumns back together. Family should not be used as those in the GM treatment represent the average of two families. 
datFern2<-rbind(datFernGM,datFern[datFern$treatment!="gm",])


#Modelling random effects 
fit_full<-glmmTMB(FernClean~treatment+PC1AllCGF+PC2All_CF+PC3All_CG+(1|gh_bench),family=nbinom2,data=datFern2)

fit_full_0.1<-glmmTMB(FernClean~treatment+PC1AllCGF+PC2All_CF+PC3All_CG,family=nbinom2,data=datFern2)

anova(fit_full,fit_full_0.1)#Bench is an extremely important predictor. 


#Is PC3 important?
fit2<-update(fit_full,~.-PC3All_CG)
anova(fit_full,fit2) #No

#Is PC2 important?
fit3<-update(fit2,~.-PC2All_CF)
anova(fit2,fit3) #Yes, PC2 Is important predictor. 

#Is PC1 important?
fit3<-update(fit2,~.-PC1AllCGF)
anova(fit2,fit3) #No, 

#s treatment important?
fit4<-update(fit3,~.-treatment)
anova(fit4,fit3) #No, 

summary(fit4)
#Reassessing with full sample set. 

fit_t<-glmmTMB(FernClean~treatment,family=nbinom2,data=datFern2)
fit_t2<-update(fit_t,~.-treatment)

anova(fit_t,fit_t2) #Yes, with the maple control treatment is extremely important.

summary(fit_t)

fit3<-glmmTMB(FernClean~Standardize(PC2All_CF)+(1|gh_bench),family=nbinom2,data=datFern2)

summary(fit3)
exp(-0.579)
exp(0.579)

datFern2

```




















####Old Analyses Below








#What influences performance (update with gluc model selection)? 
```{r}
#Modelling random effects.
fitfull<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*gluc_Conc+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2)

fitfull1<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*gluc_Conc+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_Leaf_Area)+(1|gh_bench), data=dat2)

fitfull2<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*gluc_Conc+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_Leaf_Area)+(1|Family), data=dat2)

fitfull3<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*gluc_Conc+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_Leaf_Area)+(1|Family/treatment)+(1|gh_bench), data=dat2)

#Is family important? 
anova(fitfull,fitfull1) #Yes, family predicts performance. 
#Is gh bench important? 
anova(fitfull,fitfull2) #Yes, gh_bench predicts performance. 
#Is there a GxE interaction? 
anova(fitfull,fitfull3) #No there does not appear to be. 

#Modelling fixed effects. 
fit<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*gluc_Conc+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2)

fit2<-update(fit,~.-ThripsDam:BlackPathDam:WhiteFungLogis)
anova(fit,fit2) #Not a significant three way interaction.

fit3<-update(fit2,~.-BlackPathDam:WhiteFungLogis)
anova(fit3,fit2) #There is not a significant two way interaction, 

fit4<-update(fit3,~.-BlackPathDam:ThripsDam)
anova(fit4,fit3)
#There is not a significant interaction between black path dam and thrips dam. 

fit5<-update(fit4,~.-WhiteFungLogis:ThripsDam)
anova(fit5,fit4) #There is not a significant whitefung dam and thrips dam interaction. 

summary(fit5)

#Is black path dam significant
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*gluc_Conc+BlackPathDam+WhiteFungLogis+ThripsDam+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$BlackPathDam),])
fit7<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*gluc_Conc+WhiteFungLogis+ThripsDam+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$BlackPathDam),])
anova(fit6,fit7) #Yes ver

#Is  White Path dam significant
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*gluc_Conc+BlackPathDam+WhiteFungLogis+ThripsDam+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$WhiteFungLogis),])
fit8<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*gluc_Conc+BlackPathDam+ThripsDam+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$WhiteFungLogis),])
anova(fit6,fit8) #Yes

#Is thrips  dam significant
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*gluc_Conc+BlackPathDam+WhiteFungLogis+ThripsDam+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$ThripsDam),])
fit9<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*gluc_Conc+BlackPathDam+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$ThripsDam),])
anova(fit6,fit9) #It is on the edge, i will retain it. 

#Is gluc*treatment significant?
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*gluc_Conc+BlackPathDam+WhiteFungLogis+ThripsDam+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2)
fit10<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment+gluc_Conc+BlackPathDam+WhiteFungLogis+ThripsDam+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2)
anova(fit6,fit10) #Yes it is.

#What is the influence of flavonoids? 
fit<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment+flav_Conc+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(ThripsDam)+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$flav_Conc),])
fit2<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(ThripsDam)+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$flav_Conc),])
anova(fit,fit2)


summary(fit6)
summary(fit)

plot(residuals(fit6,type="pearson",fitted(fit6)))
qqnorm(residuals(fit6))
plot(residuals(fit,type="pearson",fitted(fit)))
qqnorm(residuals(fit))
```

#Coefficients Grabbing for figures
```{r}

#Coefficients for glucosinolate table 
fit<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*Standardize(gluc_Conc)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(ThripsDam)+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2)
summary(fit)

#Modified coefficients (glucosinolate) with chlorophyll A for figure
fit<-glmmTMB(GM_TotalLeaf_Area~treatment*Standardize(ChlorA)+treatment*Standardize(gluc_Conc)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(ThripsDam)+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2)

fit1<-glmmTMB(GM_TotalLeaf_Area~treatment*Standardize(ChlorA)+treatment+Standardize(gluc_Conc)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(ThripsDam)+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2)
summary(fit)
anova(fit,fit1)


#Modified coefficients (flavonoid) with chlorophyll A for figure
fit<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment+flav_Conc+Standardize(ChlorA)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(ThripsDam)+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$flav_Conc),])

fit1<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment+Standardize(ChlorA)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(ThripsDam)+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$flav_Conc),])
anova(fit,fit1)


#Coefficients without glucosinolate table 
fit<-glmmTMB(GM_TotalLeaf_Area~treatment+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(ThripsDam)+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2)
summary(fit)


```

#Graphs of effects With Chlrophyll included.
```{r}
fit<-glmmTMB(GM_TotalLeaf_Area~treatment*Standardize(ChlorA)+treatment*gluc_Conc+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(ThripsDam)+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2)
summary(fit)

source("GGPlot_Themes.R")

aloneSlope<-function(x){
  y=-741.2*x+ 7725.3
  return(y)
}
mapleSlope<-function(x){
  y=(-741.2+2855.1)*x+7725.3 +3905.2
  return(y)
}

mustardSlope<-function(x){
  y=(-741.2+1692.5)*x+7725.3+758.8#Non significant slope
  return(y)
}

minM<-min(dat2$gluc_Conc[dat2$treatment=="m"],na.rm = T)
maxM<-max(dat2$gluc_Conc[dat2$treatment=="m"],na.rm = T)

minA<-min(dat2$gluc_Conc[dat2$treatment=="a"],na.rm = T)
maxA<-max(dat2$gluc_Conc[dat2$treatment=="a"],na.rm = T)

minG<-min(dat2$gluc_Conc[dat2$treatment=="gm"],na.rm = T)
maxG<-max(dat2$gluc_Conc[dat2$treatment=="gm"],na.rm = T)

#tiff("Selection_Figures/Gluc_Benefit.tiff", units="in", width=10, height=6, res=300)
ggplot(dat2)+
  geom_point(aes(y=GM_TotalLeaf_Area,x=gluc_Conc,colour=treatment),size=2)+
  geom_segment(x=minA,xend=maxA,y=aloneSlope(minA),yend=aloneSlope(maxA),colour="#009E73",size=1.5)+
    geom_segment(x=minM,xend=maxM,y=mapleSlope(minM),yend=mapleSlope(maxM),colour="#E69F00",size=1.5)+
  geom_segment(x=minG,xend=maxG,y=mustardSlope(minG),yend=mustardSlope(maxG),colour="#56B4E9",size=1.5)+theme_simple()+
  ylab(bquote(bold("Performance\n(Total Leaf Area "~(mm^2)*")")))+xlab(bquote(bold("[Total Glucosinolate] (log" (mg/ml)*")")))+
  scale_y_continuous(breaks=seq(0,20000,by=2000))+
  scale_x_continuous(breaks=seq(-3,0,by=0.25))+
  scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Intraspecific","Interspecific"))
#dev.off()

```




#Visualization -- The conditional benefit of glucosinolates (allelopathy)
```{r}
source("GGPlot_Themes.R")
#Is the cost dependent on the treatment? 
fit7<-glmmTMB(GM_TotalLeaf_Area~treatment*gluc_Conc+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(ThripsDam)+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2)
summary(fit7) 


plot(residuals(fit7))

aloneSlope<-function(x){
  y=130.69*x+ 9158.16
  return(y)
}
mapleSlope<-function(x){
  y=(130.69+2830.28)*x+9158.16 +3864.18
  return(y)
}

mustardSlope<-function(x){
  y=(130.69+1071.01)*x+9158.16-306.22#Non significant slope
  return(y)
}

minM<-min(dat2$gluc_Conc[dat2$treatment=="m"],na.rm = T)
maxM<-max(dat2$gluc_Conc[dat2$treatment=="m"],na.rm = T)

minA<-min(dat2$gluc_Conc[dat2$treatment=="a"],na.rm = T)
maxA<-max(dat2$gluc_Conc[dat2$treatment=="a"],na.rm = T)

minG<-min(dat2$gluc_Conc[dat2$treatment=="gm"],na.rm = T)
maxG<-max(dat2$gluc_Conc[dat2$treatment=="gm"],na.rm = T)

#tiff("Selection_Figures/Gluc_Benefit.tiff", units="in", width=10, height=6, res=300)
ggplot(dat2)+
  geom_point(aes(y=GM_TotalLeaf_Area,x=gluc_Conc,colour=treatment),size=2)+
  geom_segment(x=minA,xend=maxA,y=aloneSlope(minA),yend=aloneSlope(maxA),colour="#009E73",size=1.5)+
    geom_segment(x=minM,xend=maxM,y=mapleSlope(minM),yend=mapleSlope(maxM),colour="#E69F00",size=1.5)+
  geom_segment(x=minG,xend=maxG,y=mustardSlope(minG),yend=mustardSlope(maxG),colour="#56B4E9",size=1.5)+theme_simple()+
  ylab(bquote(bold("Performance\n(Total Leaf Area "~(mm^2)*")")))+xlab(bquote(bold("[Total Glucosinolate] (log" (mg/ml)*")")))+
  scale_y_continuous(breaks=seq(0,20000,by=2000))+
  scale_x_continuous(breaks=seq(-3,0,by=0.25))+

  scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Intraspecific","Interspecific"))
#dev.off()

minA


```


#Visualizing the effect of flavonoid on fitness.
```{r}
fit6<-glmmTMB(GM_TotalLeaf_Area~treatment+BlackPathDam+WhiteFungLogis+ThripsDam+GM_Leaf_Area+flav_Conc+Fern+(1|Family)+(1|gh_bench), data=dat2)
summary(fit6)


aloneSlope<-function(x){
  y=1707.79  *x+  13430.46
  return(y)
}
mapleSlope<-function(x){
  y=(1707.79 )*x+ 13430.46 -958.66
  return(y)
}

mustardSlope<-function(x){
  y=1707.79  *x+ 13430.46-1952.74 #Non significant slope
  return(y)
}

minM<-min(dat2$flav_Conc[dat2$treatment=="m"],na.rm = T)
maxM<-max(dat2$flav_Conc[dat2$treatment=="m"],na.rm = T)

minA<-min(dat2$flav_Conc[dat2$treatment=="a"],na.rm = T)
maxA<-max(dat2$flav_Conc[dat2$treatment=="a"],na.rm = T)

minG<-min(dat2$flav_Conc[dat2$treatment=="gm"],na.rm = T)
maxG<-max(dat2$flav_Conc[dat2$treatment=="gm"],na.rm = T)


#tiff("Selection_Figures/Flav_Benefit.tiff", units="in", width=10, height=6, res=300)
ggplot(dat2)+
  geom_point(aes(y=GM_TotalLeaf_Area,x=flav_Conc,colour=treatment),size=2)+
  geom_segment(x=minA,xend=maxA,y=aloneSlope(minA),yend=aloneSlope(maxA),colour="#009E73",size=1.5)+
    geom_segment(x=minM,xend=maxM,y=mapleSlope(minM),yend=mapleSlope(maxM),colour="#E69F00",size=1.5)+theme_simple()+
  geom_segment(x=minG,xend=maxG,y=mustardSlope(minG),yend=mustardSlope(maxG),colour="#56B4E9",size=1.5)+theme_simple()+
  ylab(bquote(bold("Performance\n(Total Leaf Area "~(mm^2)*")")))+
  xlab(bquote(bold("[Total Flavonoid] (log(" (mg/ml)*")")))+
    scale_y_continuous(breaks=seq(0,20000,by=2000))+
  scale_x_continuous(breaks=seq(-4,0,by=0.25))+
  scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Intraspecific","Interspecific"))
#dev.off()
```


#Multiplot
```{r}
source("GGPlot_Themes.R")

aloneSlope<-function(x){
  y=130.69*x+ 9158.16
  return(y)
}
mapleSlope<-function(x){
  y=(130.69+2830.28)*x+9158.16 +3864.18
  return(y)
}

mustardSlope<-function(x){
  y=(130.69+1071.01)*x+9158.16-306.22#Non significant slope
  return(y)
}

minM<-min(dat2$gluc_Conc[dat2$treatment=="m"],na.rm = T)
maxM<-max(dat2$gluc_Conc[dat2$treatment=="m"],na.rm = T)

minA<-min(dat2$gluc_Conc[dat2$treatment=="a"],na.rm = T)
maxA<-max(dat2$gluc_Conc[dat2$treatment=="a"],na.rm = T)

minG<-min(dat2$gluc_Conc[dat2$treatment=="gm"],na.rm = T)
maxG<-max(dat2$gluc_Conc[dat2$treatment=="gm"],na.rm = T)
a<-ggplot(dat2)+
  geom_point(aes(y=GM_TotalLeaf_Area,x=gluc_Conc,colour=treatment),size=2)+
  geom_segment(x=minA,xend=maxA,y=aloneSlope(minA),yend=aloneSlope(maxA),colour="#009E73",size=1.5)+
    geom_segment(x=minM,xend=maxM,y=mapleSlope(minM),yend=mapleSlope(maxM),colour="#E69F00",size=1.5)+
  geom_segment(x=minG,xend=maxG,y=mustardSlope(minG),yend=mustardSlope(maxG),colour="#56B4E9",size=1.5)+
  theme_simple_multiCol_First()+
  ylab(bquote(bold("Total Leaf Area "~(mm^2))))+
  xlab(bquote(bold("[Total Glucosinolate] (log" (mg/ml)*")")))+
  scale_y_continuous(breaks=seq(0,20000,by=2000))+
  scale_x_continuous(breaks=seq(-3,0,by=0.25))+
  scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Intraspecific","Interspecific"))

aloneSlope<-function(x){
  y=1707.79  *x+  13430.46
  return(y)
}
mapleSlope<-function(x){
  y=(1707.79 )*x+ 13430.46 -958.66
  return(y)
}

mustardSlope<-function(x){
  y=1707.79  *x+ 13430.46-1952.74 #Non significant slope
  return(y)
}

minM<-min(dat2$flav_Conc[dat2$treatment=="m"],na.rm = T)
maxM<-max(dat2$flav_Conc[dat2$treatment=="m"],na.rm = T)

minA<-min(dat2$flav_Conc[dat2$treatment=="a"],na.rm = T)
maxA<-max(dat2$flav_Conc[dat2$treatment=="a"],na.rm = T)

minG<-min(dat2$flav_Conc[dat2$treatment=="gm"],na.rm = T)
maxG<-max(dat2$flav_Conc[dat2$treatment=="gm"],na.rm = T)


b<-ggplot(dat2)+
  geom_point(aes(y=GM_TotalLeaf_Area,x=flav_Conc,colour=treatment),size=2)+
  geom_segment(x=minA,xend=maxA,y=aloneSlope(minA),yend=aloneSlope(maxA),colour="#009E73",size=1.5)+
    geom_segment(x=minM,xend=maxM,y=mapleSlope(minM),yend=mapleSlope(maxM),colour="#E69F00",size=1.5)+theme_simple()+
  geom_segment(x=minG,xend=maxG,y=mustardSlope(minG),yend=mustardSlope(maxG),colour="#56B4E9",size=1.5)+
  theme_simple_multiCol()+
  ylab(bquote(bold("Total Leaf Area "~(mm^2))))+
  xlab(bquote(bold("[Total Flavonoid] (log(" (mg/ml)*")")))+
    scale_y_continuous(breaks=seq(0,20000,by=2000))+
  scale_x_continuous(breaks=seq(-4,0,by=0.25))+
  scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Intraspecific","Interspecific"))

c<-ggplot(dat2)+
  geom_point(aes(y=GM_TotalLeaf_Area,x=flav_Conc,colour=treatment),size=2)+
  geom_segment(x=minA,xend=maxA,y=aloneSlope(minA),yend=aloneSlope(maxA),colour="#009E73",size=1.5)+
    geom_segment(x=minM,xend=maxM,y=mapleSlope(minM),yend=mapleSlope(maxM),colour="#E69F00",size=1.5)+theme_simple()+
  geom_segment(x=minG,xend=maxG,y=mustardSlope(minG),yend=mustardSlope(maxG),colour="#56B4E9",size=1.5)+
  theme_simple()+
  ylab(bquote(bold("Performance\n(Total Leaf Area "~(mm^2)*")")))+
  xlab(bquote(bold("[Total Flavonoid] (log(" (mg/ml)*")")))+
    scale_y_continuous(breaks=seq(0,20000,by=2000))+
  scale_x_continuous(breaks=seq(-4,0,by=0.25))+
  scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Intraspecific","Interspecific"))

d<-get_legend(c)

plots <- align_plots(a, b,align="hv")

top<-plot_grid(plots[[1]],plots[[2]],ncol=2,rel_widths=c(1,1),rel_heights = c(1,1),labels = c("a","b"),label_fontfamily = "Arial",label_size = 18)

tiff("Selection_Figures/GlucFlav_Benefit.tiff", units="in", width=14, height=8, res=300)
plot_grid(d,top,ncol=1,rel_heights = c(1,3.5))
dev.off()
```





#Visualizing -- effect of treatment
```{r}
source("GGPlot_Themes.R")
library(ggridges)

#Generating within treatment effects
 #-0.24305 is the SD/ SD effect of maple on GM. 
#-0.0354822 The effect of GM size on maple is  SD/SD
#-0.31502 # Within treatment effect of GM on GM SD/SD
#Loading in SD of competitors. 
GM_SD_OnMap<-read.csv("GM_SD_OnMap.csv")[,2]
Map_SD_OnGM<-read.csv("Map_SD_OnGM.csv")[,2]
GM_SD_OnGM<-read.csv("GM_SD_OnGM.csv")[,2]
#Fern_SD_OnGM<-Standardize(dat2$Fern)

# GM_SD_OnMap<-GM_SD_OnMap+abs(min(GM_SD_OnMap,na.rm=T))
 #Map_SD_OnGM<-Map_SD_OnGM+abs(min(Map_SD_OnGM,na.rm=T))
# GM_SD_OnGM<-GM_SD_OnGM+abs(min(GM_SD_OnGM,na.rm=T))
# #Generating the range of effects that size within treatment can have. 

MaponGM<-(-0.24305*Map_SD_OnGM)-0.36 -0.089# +mean(Map_SD_OnGM,na.rm=T) #intercept of model

GMonGM<-(-0.31502*GM_SD_OnGM)-1.16 #+mean(GM_SD_OnGM,na.rm=T) # intercept of model 

GMonMap<-(-0.0354822*GM_SD_OnMap)-0.63990#+mean(GM_SD_OnMap,na.rm=T)#Intercept of model 

#Fern effect on Garlic mustard
#Fern_SD_OnGM<-Fern_SD_OnGM+abs(min(Fern_SD_OnGM,na.rm=T))
#FernonGM<-(-0.14912*Fern_SD_OnGM)



WithinEffect<-data.frame(
  SD=c(MaponGM,GMonGM,GMonMap),
  Type=factor(c(rep("MaponGM",length(MaponGM)),rep("GMonGM",length(GMonGM)),rep("GMonMap",length(GMonMap))),levels=c("GMonGM","MaponGM","GMonMap")),
  
  Focal=c(rep("A. petiolata",length(MaponGM)),rep("A. petiolata",length(GMonGM)),rep("A. saccharum",length(GMonMap))),
  
  Comp=c(rep("A. saccharum",length(MaponGM)),rep("A. petiolata",length(GMonGM)),rep("A. petiolata",length(GMonMap)))
)
#rep("FernonGM",length(FernonGM)



#Generating dataframe
Competitors<-factor(c("MaponGM","GMonGM","GMonMap"),levels=c("GMonGM","MaponGM","GMonMap"))
Values<-c(-0.36,-1.16,-0.6399022)
min<-c(-0.19,-0.93,-0.35334370)
max<-c(-0.54,-1.38,-0.9264607)
Focal<-c("A. petiolata","A. petiolata","A. saccharum")
Comp<-factor(c("A. saccharum","A. petiolata","A. petiolata"),levels=c("A. petiolata","A. saccharum"))
point<-data.frame(Competitors,Values,min,max,Focal,Comp)


source("GGPlot_Themes.R")

tiff("Other_Figures/StandardizedCompetitionEffects3.tiff", units="in", width=10, height=6, res=300)
 ggplot()+
  scale_x_continuous(limits=c(-2.5,0),breaks=seq(-2.5,0,0.5))+
    geom_point(aes(x=SD,y=Type,fill=factor(Comp)),panel_scaling = F,scale=0.9,data=WithinEffect,rel_min_height=0.01,position = position_nudge(y=-0.05),colour="#0072B2",alpha=0.35)+

     # geom_density_ridges2(aes(x=SD,y=Type,fill=Comp),panel_scaling = F,scale=0.9,data=WithinEffect,rel_min_height=0.03)+
   
   geom_pointrange(aes(y=Competitors,x=Values,xmin=min,xmax=max,fill=Comp),data=point,position = position_nudge(y=0.1))+

   geom_vline(aes(xintercept=0),lty="88")+
  theme_simple_vertScientific()+
   theme( legend.position="none")+
   scale_y_discrete(labels=c("A. petiolata","A. petiolata","A. saccharum"))+
  labs(y="Focal Plant",fill="Competitor:",x="Estimated change in TLA\ndue to competition (σ)")
  dev.off()
```













#Visualizing -- effect of flavonoids on fern abundance. 
```{r}

PoisSlope=function(x,int){
  y=exp((-0.02353 -3.12475)*x+int)
  return(y)
}
exp(-0.6571)

flavplot=seq(min(dat$flav_Conc,na.rm = T),max(dat$flav_Conc,na.rm=T),length.out = 707)

flavyA<-PoisSlope(flavplot,-2.1683)
flavyM<-PoisSlope(flavplot,-1.60546-2.81450)
flavyGM<-PoisSlope(flavplot,-2.1683-0.2786)


#tiff("Defence_Figures/FlavonoidFern.tiff", units="in", width=10, height=6, res=300)
ggplot(dat)+
  geom_point(aes(y=Fern,x=flav_Conc,colour=treatment))+theme_simple()+
 # geom_path(x=flavplot,y=flavyA,size=1,colour="#009E73")
  #geom_path(x=flavplot,y=flavyGM,size=1,colour="#56B4E9")
  geom_path(x=flavplot,y=flavyM,size=1,colour="#E69F00")+
      scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Garlic Mustard","Maple"))+
  scale_y_continuous(breaks=c(0,5,10,15,20,25,30,35,40))+
  ylab("Fern Abundance")+
xlab(bquote(bold("[Total Flavonoid] " (mg/ml))))
#dev.off()

```

How can we know that healthy plants dont just exhibit more secondary compounds and not that those with more secondary compounds are healthier?



#Generating table of genotype location and sample size. 
```{r}
table(dat$Family,dat$Longitude,dat$Latitude,dat$Altitude)

GenotypeLocation<-dat %>% group_by(Family) %>% summarize(Longitude=first(Longitude),Latitude=first(Latitude),Altitude=first(Altitude))

# Before Sample Loss. 
repTable<-dat2 %>% filter(treatment != "mcnt") %>% group_by(Family,treatment) %>% summarize(SampleSize=n())


#Making the table into a wide format
repTableWide<-repTable %>% pivot_wider(names_from = treatment,values_from = SampleSize)

##Adding a column for total sample size per genotype
repTableWide$Total<-repTableWide$a+repTableWide$gm+repTableWide$m

##Ordering the data set.  
repTableWide<-repTableWide[order(repTableWide$Total,decreasing = T),]
repTableWide

apply(repTableWide[,2:5],2,sum)
##Printing table. 
write.csv(repTableWide,"SampleSizeUpdate.csv")
#write.csv(GenotypeLocation,"GenotypeLocation.csv")

```













#Searching for a fitness trade-off between the alone and interspecific competition treatment. 
```{r}
source("GGPlot_Themes.R")

#Calculating family means within treatment. 
TradeOff<-dat3 %>% filter(treatment=="a") %>% drop_na(GM_TotalLeaf_Area) %>%  select(LeafSizeAlone=GM_TotalLeaf_Area,Family,gluc_ConcAlone=gluc_Conc) %>% right_join(dat3 %>% filter(treatment=="m") %>%  select(LeafSizeMaple=GM_TotalLeaf_Area,Family,gluc_ConcMaple=gluc_Conc),by="Family")

#Calculating standard error of each family
StdErr<-dat2 %>% select(Family,treatment,GM_TotalLeaf_Area) %>% group_by(Family,treatment) %>% drop_na(GM_TotalLeaf_Area) %>%  summarize(StdErr=sd(GM_TotalLeaf_Area)/sqrt(length(GM_TotalLeaf_Area)),size=length(GM_TotalLeaf_Area))

#Shifting the data to be in long form. 
StdErr2<-StdErr %>% filter(treatment=="a") %>% select(StdErrAlone=StdErr,Family) %>% right_join(StdErr %>% filter(treatment=="m") %>% select(StdErrMaple=StdErr,Family),by="Family")

TradeOff2<-StdErr2 %>% left_join(TradeOff)


#tiff("Selection_Figures/TradeOff.tiff", units="in", width=10, height=6, res=300)

ggplot(TradeOff2,aes(y=LeafSizeAlone,x=LeafSizeMaple))+
  geom_point()+
  geom_linerange(aes(ymin = LeafSizeAlone - StdErrAlone, 
                    ymax = LeafSizeAlone + StdErrAlone))+
  geom_errorbarh(aes(xmin = LeafSizeMaple - StdErrMaple,
                    xmax = LeafSizeMaple + StdErrMaple))+
theme_simple()+
  xlab("Performance with Maple")+
  ylab("Performance Alone")
#dev.off()
summary(lm(LeafSizeAlone~LeafSizeMaple,data=TradeOff2))

```





