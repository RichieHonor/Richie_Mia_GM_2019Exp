---
title: "Selective benefit of Glucosinolate and flavonoids"
output: html_notebook
---
#Part 1
The purpose of this notebook is to determine the selective benefit of glucosinolate and flavonoid compounds through plant competition by creating selection gradients. Selection gradients will involve final body mass as the proxy for fitness, but this will be replaced with fitness once the measurement is in. Concentration will be on the x-axis. This analysis will be done in each treatment seperately and account for family and greenhouse location. 

#Part 2
The second purpose is to determine if glucosinolates and flavonoids influence suscpetibility to pathogens and if this susceptibility results in increased fitness

#Need to add in graph to model how ferns affect fitness and one to model how   flavonoid reducing fern abundance. 



Read in and prep data
```{r}
library(ggplot2)
library(dplyr)
library(lme4)

#read in data
rm(list=ls())
dat<-read.csv("DataSynthesis.csv")

ggplot(dat)+
  geom_boxplot(aes(y=gluc_Conc,x=Pool))

ggplot(dat)+
  geom_boxplot(aes(y=flav_Conc,x=Pool))

#Remove maple data from the data set for the time being.
dat<-dat[!grepl("aple",dat$Tag, fixed =T),]
#(including maple controls): 
dat<-dat[!dat$treatment=="mcnt",]

#Removing NA's
dat<-dat[!is.na(dat$Sample),]
dat<-dat[!is.na(dat$gluc_Conc),]

#Assign family column
prefamily<-gsub("*.\\|","",dat$Tag)
dat$Family<-gsub("\\-.*","",prefamily)

#remove those with fertilizer treatment, and extra genotypes that are only in the alone treatment. 
dat<-dat[!grepl("i",dat$Sample,fixed=T),]


```


#Correlation between Glucosinolate and Flavonol Concentration
```{r}

SlopeCalc<-function(x,y){
  int<-lm(y~x)$coefficients[[1]]
  slope<-lm(y~x)$coefficients[[2]]
  return(c(int,slope))
}


#Remove Pools
dat2<-dat[dat$Pool=="No",]

#Average Duplicates. 
dat2<-dat2 %>% group_by(Tag) %>% summarize(ChlorA=mean(ChlorA),ChlorB=mean(ChlorB),gluc_Conc=mean(gluc_Conc),flav_Conc=mean(flav_Conc),Family=first(Family),GA3=first(GA3),treatment=first(treatment),gh_row=first(gh_row),gh_bench=first(gh_bench),GM_TotalLeaf_Area=first(GM_TotalLeaf_Area),comp_number=first(comp_number),ThripsDam=mean(ThripsDam),WhiteFungDam=mean(WhiteFungDam),BlackPathDam=mean(BlackPathDam),Fern=mean(Fern),gh_col=first(gh_col))


#Visualizing mean result.

dat3<-dat2 %>% group_by(Family,treatment) %>% drop_na(GM_TotalLeaf_Area) %>% summarize_if(is.numeric,mean)


table(dat2$Family)


#There may be an issue with pathogen damage because it appears that the number varies amoung leaves within the same plant. ... Fuck a duck i did record pathogen damage on each leaf! that is remarkable. I will need to update the analysis below including leaf number and pathogen damage. 


GFSlopeInt<-SlopeCalc(x=dat2$gluc_Conc,y=dat2$flav_Conc)
ggplot(dat2)+
  geom_point(aes(x=gluc_Conc,y=flav_Conc))+
  geom_abline(aes(slope=GFSlopeInt[2],intercept=GFSlopeInt[1]))

boxplot(gluc_Conc~treatment,data=dat2)



```

#This is looking at a fitness trade off. I should do this on thefull dataset too. 
```{r}
#Calculating family means within treatment. 
TradeOff<-dat3 %>% filter(treatment=="a") %>% drop_na(GM_TotalLeaf_Area) %>%  select(LeafSizeAlone=GM_TotalLeaf_Area,Family,gluc_ConcAlone=gluc_Conc) %>% right_join(dat3 %>% filter(treatment=="m") %>%  select(LeafSizeMaple=GM_TotalLeaf_Area,Family,gluc_ConcMaple=gluc_Conc),by="Family")




TradeOff
#Note these are now standard erors, not confidence intervals. 
ConfInt<-dat2 %>% select(Family,treatment,GM_TotalLeaf_Area) %>% group_by(Family,treatment) %>% drop_na(GM_TotalLeaf_Area) %>%  summarize(ConfInt=sd(GM_TotalLeaf_Area)/sqrt(length(GM_TotalLeaf_Area)),size=length(GM_TotalLeaf_Area))

ConfInt

ConfInt2<-ConfInt %>% filter(treatment=="a") %>% select(ConfIntAlone=ConfInt,Family) %>% right_join(ConfInt %>% filter(treatment=="m") %>% select(ConfIntMaple=ConfInt,Family),by="Family")

TradeOff2<-ConfInt2 %>% left_join(TradeOff)
library(tidyr)
TradeOff2

#tiff("Selection_Figures/TradeOff.tiff", units="in", width=10, height=6, res=300)
ggplot(TradeOff2,aes(y=LeafSizeAlone,x=LeafSizeMaple))+
  geom_point()+
  geom_linerange(aes(ymin = LeafSizeAlone - ConfIntAlone, 
                    ymax = LeafSizeAlone + ConfIntAlone))+
  geom_errorbarh(aes(xmin = LeafSizeMaple - ConfIntMaple,
                    xmax = LeafSizeMaple + ConfIntMaple))+
theme_simple()+
  xlab("Performance with Maple")+
  ylab("Performance Alone")
#dev.off()
summary(lm(LeafSizeAlone~LeafSizeMaple,data=TradeOff2))
```






#Standardizing greenhouse location 
The purpose of this is to get one numeric vector which can be used to determine the location of individuals in the greenhouse. It will summarize the distance to the walls of the greenhouse. 

```{r}

plot(dat2$gluc_Conc~dat2$gh_bench*dat2$gh_row)



ggplot(dat2)+
  geom_point(aes(y=gluc_Conc,x=gh_row,colour=as.factor(gh_bench)))

ggplot(dat2)+
  geom_point(aes(y=gluc_Conc,x=gh_col,colour=as.factor(gh_bench)))


plot(dat2$gluc_Conc~as.numeric(dat2$gh_row))

#Investigating genetic differences
boxplot(gluc_Conc~Family,data=dat2[dat2$treatment=="a",])
boxplot(gluc_Conc~Family,data=dat2[dat2$treatment=="m",])
boxplot(gluc_Conc~Family,data=dat2[dat2$treatment=="gm",])

boxplot(GM_TotalLeaf_Area~Family,data=dat2[dat2$treatment=="a",])
boxplot(GM_TotalLeaf_Area~Family,data=dat2[dat2$treatment=="m",])
boxplot(GM_TotalLeaf_Area~Family,data=dat2[dat2$treatment=="gm",])

#I will nest as bench/row/collumn and determine from there what effects need to be retained or not via anova. 
dat2$GM_TotalLeaf_Area
```


#Effect of glucosinolates & flavonols on fitness (bodymass for proxy)
```{r}
#removing those without fitness measurements
dat2<-dat2[!is.na(dat2$GM_TotalLeaf_Area),]

#in the maple treatment
ggplot(dat2[dat2$treatment=="m",])+
  geom_point(aes(y=GM_TotalLeaf_Area,x=gluc_Conc))

#in the garlic mustard treatment
ggplot(dat2[dat2$treatment=="gm",])+
  geom_point(aes(y=GM_TotalLeaf_Area,x=gluc_Conc))

#alone
ggplot(dat2[dat2$treatment=="a",])+
  geom_point(aes(y=GM_TotalLeaf_Area,x=gluc_Conc))


#in the maple treatment
ggplot(dat3[dat3$treatment=="m",])+
  geom_point(aes(y=GM_TotalLeaf_Area,x=gluc_Conc,colour=Family))

#in the garlic mustard treatment
ggplot(dat3[dat3$treatment=="gm",])+
  geom_point(aes(y=GM_TotalLeaf_Area,x=gluc_Conc))

#alone
ggplot(dat3[dat3$treatment=="a",])+
  geom_point(aes(y=GM_TotalLeaf_Area,x=gluc_Conc))


#Trade off in alone and maple treatment 



```




#Based on these results, it seems as though i need to include family to avoid psuedo replication, and i need to include bench, but adding greenhouse row does not seem to increase the predictive power that much so i will leave that out. Now i will compare all variables which i am interested in predicting fitness with these random effects.  

```{r}
#This is the full model, i expect that the influence of gluc conc and flav conc could vary between treatments because of allelopathy, but i have no reason to think that pathogens could influence fitness differently in different treatments. The same goes with ferns. Competition from ferns would affect fitness equally in all treatments, even though there may be more ferns in certain treatments, but this is not what i am testing with this analyis. Let us continue with backwards model selection. 

#First lets ensure we are using the correct random effects.
fitfull0<-lmer(GM_TotalLeaf_Area~treatment*gluc_Conc*flav_Conc+BlackPathDam+WhiteFungDam+ThripsDam+Fern+(1|Family), data=dat2)

fitfull<-lmer(GM_TotalLeaf_Area~treatment*gluc_Conc*flav_Conc+BlackPathDam+WhiteFungDam+ThripsDam+Fern+(1|Family)+(1|gh_bench), data=dat2)

fitfull2<-lmer(GM_TotalLeaf_Area~treatment*gluc_Conc*flav_Conc+BlackPathDam+WhiteFungDam+ThripsDam+Fern+(1|Family)+(1|gh_bench/gh_row), data=dat2)

fitfull3<-lmer(GM_TotalLeaf_Area~treatment*gluc_Conc*flav_Conc+BlackPathDam+WhiteFungDam+ThripsDam+Fern+(1|Family)+(1|gh_bench/gh_col), data=dat2)


#Gh_Col is the best predictor for the data by far, so i will use that as the random effects in the model. 

anova(fitfull0,fitfull) #Strong evidence to use bench.
 #Strong evidence to use bench.

anova(fitfull,fitfull2) #Using bench/row is the same as the null model.
anova(fitfull,fitfull3) #There is strong evidence to use bench/collumn however. 

#Modelling fixed effects. 
fitfull3<-lmer(GM_TotalLeaf_Area~treatment*gluc_Conc*flav_Conc+BlackPathDam+WhiteFungDam+ThripsDam+Fern+(1|Family)+(1|gh_bench/gh_col), data=dat2)

#Removing three way interaction
fit.1<-update(fitfull3, ~.-treatment:gluc_Conc:flav_Conc)
anova(fitfull3,fit.1) #Good to remove

fit.2<-update(fit.1,~.-gluc_Conc:flav_Conc)
anova(fit.2,fit.1) #Good to remove. 

fit.3<-update(fit.2,~.-treatment:flav_Conc)
anova(fit.2,fit.3) #Good to remove. 

fit.4<-update(fit.3,~.-treatment:gluc_Conc)
anova(fit.4,fit.3)  #That significantly affected the predictive power. Did Not Remove 

#It seems as though flav conc has less sample size and so an anova cannot be done.I will refit the model with the same data set but without flav_Conc to test if it is significant. 
fit.4<-lmer(GM_TotalLeaf_Area ~ treatment + gluc_Conc + BlackPathDam + WhiteFungDam +  
    ThripsDam + Fern +   treatment:gluc_Conc+ (1 | Family) + (1 | gh_bench/gh_col)  ,data=dat2[!is.na(dat2$flav_Conc),])

fit.3<-lmer(GM_TotalLeaf_Area ~ treatment + gluc_Conc + BlackPathDam + WhiteFungDam +  
    ThripsDam + Fern +   treatment:gluc_Conc+flav_Conc+ (1 | Family) + (1 | gh_bench/gh_col)  ,data=dat2[!is.na(dat2$flav_Conc),])



anova(fit.3,fit.4) #Did not remove.  
#Flav_Conc is a significant predictor on its own. 

fit.4<-update(fit.3,~.-BlackPathDam)
anova(fit.3,fit.4) #do not remove black path dam.

fit.4<-update(fit.3,~.-WhiteFungDam)
anova(fit.3,fit.4)  #removing whitefungdam. Not significant but lower AIC value. 

fit.5<-update(fit.4,~.-ThripsDam)
anova(fit.5,fit.4)  #removing ThripsDam. #but model has lower AIC value and lower BIC value too. 

fit.6<-update(fit.5,~.-Fern)
anova(fit.6,fit.5)  #Fern is significnat predictor of garlic mustard fitness! 

#fit.6 is therefore the best model
#Is the effect of glucosinolate and treatment still apparent when using the whole dataset? 
fit.6.Whole<-lmer(GM_TotalLeaf_Area ~ treatment*gluc_Conc + 
(1 | Family) + (1 | gh_bench/gh_col) ,data=dat2)
fit.6.noInt<-lmer(GM_TotalLeaf_Area ~ treatment+gluc_Conc + 
(1 | Family) + (1 | gh_bench/gh_col) ,data=dat2) 
anova(fit.6.Whole,fit.6.noInt)#The effect is still significant. 



#Is family even a significant predictor?
fit.6.Whole.nf<-lmer(GM_TotalLeaf_Area ~ treatment*gluc_Conc + (1 | gh_bench/gh_col) ,data=dat2)
anova(fit.6.Whole,fit.6.Whole.nf) #No it is not. 


#Is it gluc_Conc still significant without family?
fit.6.Whole.nf.ng<-lmer(GM_TotalLeaf_Area ~ treatment+gluc_Conc + (1 | gh_bench/gh_col) ,data=dat2)
anova(fit.6.Whole.nf,fit.6.Whole.nf.ng) #yes it is - but excluding family will alter the results. 

#Is there an effect of whitefungal damage on the whole dataset? 
fit.6.Whole<-lmer(GM_TotalLeaf_Area ~ treatment + 
(1 | Family) + (1 | gh_bench/gh_col) ,data=dat2[!is.na(dat2$WhiteFungDam),])
fit.6.Whole.wf<-lmer(GM_TotalLeaf_Area ~ treatment + WhiteFungDam+
(1 | Family) + (1 | gh_bench/gh_col) ,data=dat2[!is.na(dat2$WhiteFungDam),])
anova(fit.6.Whole,fit.6.Whole.wf) #The effect is not significant, but the AIC is about the same. 

#What is the effect of black of black path damage. 
fit.6.Whole<-lmer(GM_TotalLeaf_Area ~ 
(1 | Family) + (1 | gh_bench/gh_col) ,data=dat2[!is.na(dat2$BlackPathDam),])
fit.6.Whole.bf<-lmer(GM_TotalLeaf_Area ~ BlackPathDam+
(1 | Family) + (1 | gh_bench/gh_col) ,data=dat2[!is.na(dat2$BlackPathDam),])
anova(fit.6.Whole,fit.6.Whole.bf) #The effect is very significant,

#Does it change if we remove gh_col from the analysis? 
fit.6.nocolG<-lmer(GM_TotalLeaf_Area ~ treatment*gluc_Conc + 
(1 | Family) + (1 | gh_bench) ,data=dat2)
fit.6.nocol<-lmer(GM_TotalLeaf_Area ~ treatment+gluc_Conc + 
(1 | Family) + (1 | gh_bench) ,data=dat2)
anova(fit.6.nocolG,fit.6.nocol) #No it does not. 

#Since family is not significant, what will happen if i remove it? 
library(lmerTest)
summary(lmer(GM_TotalLeaf_Area ~ treatment*gluc_Conc+Fern+BlackPathDam +flav_Conc + (1 | gh_bench/gh_col) ,data=dat2))


```



Perhaps i need to include treatment in the nesting because each family may have different amount of individuals in different treatments, which could bias the fitness estimate of that family (the total estimate). 

```{r}
#GlucConcInteraction
fit.6.Whole<-lmer(GM_TotalLeaf_Area ~ treatment*gluc_Conc + BlackPathDam+Fern+
(1 | Family) + (1 | gh_bench/gh_col) ,data=dat2)

#BlackPathDam effect
summary(fit.6.Whole.bf)

summary(fit.6.Whole)

confint(fit.6.Whole)

coef(fit.6.Whole)
#no heteroscedasticity
plot(fit.6.Whole)
#fairly normal. 
qqnorm(resid(fit.6.Whole))

#Flavonoid is significant, but just barely, there are also alot of samples missing there and I know there is a decent amount of sampling variance there, so i think i will ignore the small positive eeffect of flavonoids on the reduced dataset and continue with the whole one. 
```





#Conclusion, there is a benefit to producing glucosniolates in the maple treamtment and it is detrimental in the alone treatment. In the garlic mustard treatment, there were mixed results. 

#Visualization -- The conditional benefit of glucosinolates (allelopathy)
```{r}
library(ggplot2)
library(cowplot)
library(grid)
library(gridExtra)
source("GGPlot_Themes.R")

summary(fit.6.Whole)

aloneSlope<-function(x){
  y=-3966.60*x+ 13751.96
  return(y)
}
mapleSlope<-function(x){
  y=(-4254.2+8417.95)*x+13751.96 -9243.71
  return(y)
}

mustardSlope<-function(x){
  y=+13751.96-8376.67#Non significant slope
  return(y)
}

minM<-min(dat2$gluc_Conc[dat2$treatment=="m"])
maxM<-max(dat2$gluc_Conc[dat2$treatment=="m"])

minA<-min(dat2$gluc_Conc[dat2$treatment=="a"])
maxA<-max(dat2$gluc_Conc[dat2$treatment=="a"])

minG<-min(dat2$gluc_Conc[dat2$treatment=="gm"])
maxG<-max(dat2$gluc_Conc[dat2$treatment=="gm"])

tiff("Selection_Figures/Gluc_Benefit.tiff", units="in", width=10, height=6, res=300)
library(ggplot2)
ggplot(dat2)+
  geom_point(aes(y=GM_TotalLeaf_Area,x=gluc_Conc,colour=treatment),size=2)+
  geom_segment(x=minA,xend=maxA,y=aloneSlope(minA),yend=aloneSlope(maxA),colour="#009E73",size=1.5)+
    geom_segment(x=minM,xend=maxM,y=mapleSlope(minM),yend=mapleSlope(maxM),colour="#E69F00",size=1.5)+theme_simple()+
  geom_segment(x=minG,xend=maxG,y=mustardSlope(minG),yend=mustardSlope(maxG),colour="#56B4E9",size=1.5)+theme_simple()+
  ylab(bquote(bold("Performance\n(Total Leaf Area "~(mm^2)~")")))+xlab(bquote(bold("[Total Glucosinolate] " (mg/ml))))+
  scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Garlic Mustard","Maple"))
dev.off()




```

The Effect of Flavonoid
```{r}
summary(lmer(GM_TotalLeaf_Area~treatment+flav_Conc+BlackPathDam+Fern+(1|Family)+(1|gh_bench/gh_col), data=dat2))

summary(fit.6.Whole)

aloneSlope<-function(x){
  y=2024.62 *x+  8035.30
  return(y)
}
mapleSlope<-function(x){
  y=(2024.62 )*x+ 8035.30 -1067.02
  return(y)
}

mustardSlope<-function(x){
  y=2024.62 *x+ 8035.30-3746.91#Non significant slope
  return(y)
}

minM<-min(dat2$flav_Conc[dat2$treatment=="m"],na.rm = T)
maxM<-max(dat2$flav_Conc[dat2$treatment=="m"],na.rm = T)

minA<-min(dat2$flav_Conc[dat2$treatment=="a"],na.rm = T)
maxA<-max(dat2$flav_Conc[dat2$treatment=="a"],na.rm = T)

minG<-min(dat2$flav_Conc[dat2$treatment=="gm"],na.rm = T)
maxG<-max(dat2$flav_Conc[dat2$treatment=="gm"],na.rm = T)


#tiff("Selection_Figures/Flav_Benefit.tiff", units="in", width=10, height=6, res=300)
ggplot(dat2)+
  geom_point(aes(y=GM_TotalLeaf_Area,x=flav_Conc,colour=treatment),size=2)+
  geom_segment(x=minA,xend=maxA,y=aloneSlope(minA),yend=aloneSlope(maxA),colour="#009E73",size=1.5)+
    geom_segment(x=minM,xend=maxM,y=mapleSlope(minM),yend=mapleSlope(maxM),colour="#E69F00",size=1.5)+theme_simple()+
  geom_segment(x=minG,xend=maxG,y=mustardSlope(minG),yend=mustardSlope(maxG),colour="#56B4E9",size=1.5)+theme_simple()+
  ylab(bquote(bold("Performance\n(Total Leaf Area "~(mm^2)~")")))+xlab(bquote(bold("[Total Flavonoid] " (mg/ml))))+
  scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Garlic Mustard","Maple"))
#dev.off()
```

#Visualization-- The Detriment of pathogens and ferns
```{r}

summary(lmer(GM_TotalLeaf_Area ~ Fern+
(1 | Family) + (1 | gh_bench/gh_col) ,data=dat2))

a<-ggplot(dat2)+
  geom_point(aes(y=GM_TotalLeaf_Area,x=BlackPathDam))+theme_simple_multiCol()+
  geom_abline(intercept=8281.76,slope = -105.28,size=1.5)+
  xlab("Black Pathogen Damage")

b<-ggplot(dat2[dat2$WhiteFungDam<30,])+
  geom_point(aes(y=GM_TotalLeaf_Area,x=WhiteFungDam),colour="#999999")+theme_simple_multiCol()+
  theme(axis.title.x = element_text(color = "#999999", size = 16, face = "bold",margin=margin(3,0,3,0)),
      )+xlab("Powdery Mildew Damage")

c<-ggplot(dat2)+
  geom_point(aes(y=GM_TotalLeaf_Area,x=ThripsDam),colour="#E69F00")+theme_simple_multiCol()+xlab("Thrips Damage")+
    theme(axis.title.x = element_text(color = "#E69F00", size = 16, face = "bold",margin=margin(3,0,3,0)))

d<-ggplot(dat2)+
  geom_point(aes(y=GM_TotalLeaf_Area,x=Fern),colour="#009E73")+theme_simple_multiCol()+xlab("Fern Abundance")+
   geom_abline(intercept=8003.44,slope = -179.47,size=1.5,color="#009E73")+
  theme(axis.title.x = element_text(color = "#009E73", size = 16, face = "bold",margin=margin(3,0,3,0)))
   


plot<-plot_grid(a, b,ncol=2,rel_widths = c(1,1))

plot2<-plot_grid(d, c,ncol=2,rel_widths = c(1,1))

plot3<-plot_grid(a,b,c,d,ncol=2,rel_widths = c(1,1))

plot4<-plot_grid(a,b,c,ncol=1,rel_widths = c(1,1,1))
plot5<-plot_grid(a,b,c,ncol=3,rel_widths = c(1,1,1))


y.grob<-textGrob(bquote(bold("Shoot Area "(mm^2))),gp=gpar(fontface="bold",fontsize=20),rot=90)


#tiff("Selection_Figures/PathogenEffect.tiff", units="in", width=14, height=6, res=300)
grid.arrange(plot,left=y.grob)
#dev.off()

#tiff("Selection_Figures/PathogenEffect2.tiff", units="in", width=14, height=6, res=300)
grid.arrange(plot2,left=y.grob)
#dev.off()

#tiff("Selection_Figures/PathogenEffect3.tiff", units="in", width=14, height=10, res=300)
grid.arrange(plot3,left=y.grob)
#dev.off

grid.arrange(plot4,left=y.grob)


#tiff("Selection_Figures/PathogenEffect5.tiff", units="in", width=16, height=5, res=300)
grid.arrange(plot5,left=y.grob)
#dev.off

#tiff("Selection_Figures/FernEffect.tiff", units="in", width=8, height=6, res=300)
grid.arrange(d,left=y.grob)
#dev.off

```



#Visualization-- The unconditional benefit of flavonoids. 
```{r}
#Getting the effect of flavonols
summary(lmer(GM_TotalLeaf_Area~flav_Conc+(1|Family)+(1|gh_bench/gh_col), data=dat2))

library(ggplot2)

#tiff("Selection_Figures/FlavonolEffect.tiff", units="in", width=10, height=6, res=300)
ggplot(dat2)+
  geom_point(aes(y=GM_TotalLeaf_Area,x=flav_Conc))+
  geom_abline(intercept=4328,slope=4226,size=1.5)+theme_simple()+ 
  
  ylab(bquote(bold("Shoot Area "(mm^2))))+xlab(bquote(bold("[Total Flavonoid] " (mg/ml))))
#dev.off()




```












#-----------------------------------------
#Part 2




#Influence of gluc and flav on defence. 
```{r}

hist(dat$Fern)
hist(dat$ThripsDam)
hist(dat$WhiteFungDam)
hist(dat$BlackPathDam)

#This data is insanely zero inflated and a poisson model will be too overdispersed. I am afraid that a negative binomial will be as well. 

```


#Significant testing 




#Remodelling as a logistic regression, because of the massive amount of zero inflation. And for white pathogen damage, the amount of fungus there may have been subjective


#WhitePathDam -- lostistic 
```{r}

#Remodelling data. ... The model is too complex and there are singular fits. I will try to do this with dat2 and remove the variation in the leaf. ...That did the trick

dat2$WhiteFungLogis[dat2$WhiteFungDam==0]<-0
dat2$WhiteFungLogis[dat2$WhiteFungDam>0]<-1


#This is the biggest model that could converge. ... interaction with flavonoid could not.
fit_full_g<-glmer(WhiteFungLogis~treatment*gluc_Conc+flav_Conc+(1|Family),family=binomial,data=dat2[!is.na(dat2$flav_Conc),])

fit.1<-update(fit_full_g,~.-flav_Conc)
anova(fit_full_g,fit.1) #Flavonoids not significant. 

fit.2<-glmer(WhiteFungLogis~treatment*gluc_Conc+(1|Family),family=binomial,data=dat2)
fit.3<-glmer(WhiteFungLogis~treatment+gluc_Conc+(1|Family),family=binomial,data=dat2)

anova(fit.2,fit.3) #Interaction not significant. 
fit.4<-glmer(WhiteFungLogis~treatment+(1|Family),family=binomial,data=dat2)
anova(fit.4,fit.3) #GlucConc not significant.

fit.5<-glmer(WhiteFungLogis~1+(1|Family),family=binomial,data=dat2)
anova(fit.4,fit.5)
#treatment is significant......

summary(fit.4) #Maples have less occurence of fungal colonization. 

plot(fit.4)


```

#Visualizing -- effect of treatment on proportion of fungal abundance. 
```{r}

fit.1<-glmer(WhiteFungLogis~1+(1|Family),family=binomial,data=dat2)
fit.2<-glmer(WhiteFungLogis~treatment+(1|Family)+(1|gh_bench),family=binomial,data=dat2)
summary(fit.2)


dat2$BlackPathLogis[dat2$BlackPathDam==0]<-0
dat2$BlackPathLogis[dat2$BlackPathDam>0]<-1



plot<-dat2 %>% drop_na(WhiteFungLogis) %>% group_by(treatment) %>% summarize(PercWhitFung=sum(WhiteFungLogis)/length(WhiteFungLogis)*100)

plot0.1<-dat2 %>% drop_na(WhiteFungLogis) %>% group_by(treatment) %>% summarize(PercWhitFung=mean(WhiteFungLogis))


plot2<-dat2 %>% drop_na(BlackPathDam) %>% group_by(treatment) %>% summarize(BlackPathAve=mean(BlackPathDam,na.rm=T))

plot3<-dat2 %>% drop_na(ThripsDam) %>% group_by(treatment) %>% summarize(ThripsDam=mean(ThripsDam,na.rm=T))

dat2$BlackPathDam


sum(dat2$BlackPathDam<0,na.rm=T)

ggplot(plot)+
  geom_col(aes(x=treatment,y=PercWhitFung,fill=treatment))+theme_simple()+ylab("Fungal Abundance\n (% colonized)")+xlab("Treatment")+theme(legend.position = "none")

ggplot(plot0.1)+
  geom_col(aes(x=treatment,y=PercWhitFung,fill=treatment))+theme_simple()+ylab("Fungal Abundance\n (% colonized)")+xlab("Treatment")+theme(legend.position = "none")



ggplot(plot2)+
  geom_col(aes(x=treatment,y=BlackPathAve,fill=treatment))+theme_simple()+ylab("Fungal Abundance\n (% colonized)")+xlab("Treatment")+theme(legend.position = "none")


ggplot(plot3)+
  geom_col(aes(x=treatment,y=ThripsDam,fill=treatment))+theme_simple()+ylab("Fungal Abundance\n (% colonized)")+xlab("Treatment")+theme(legend.position = "none")

```


#WhitePathDam -- poisson. 
```{r}
#Glucosinolate and flavonoids are correlated, but the R2 is only 0.39, so i dont think it is a very big deal. 

library(lme4)
library(MASS)
dat2$WhiteFungDam<-ceiling(dat2$WhiteFungDam)
datWFnonzero<-dat2[dat2$WhiteFungDam>0,]


fit.G<-glm.nb(WhiteFungDam~treatment+gluc_Conc,data=dat2,init.theta=100)
summary(fit.G)
plot(fit.G)

getME(fit.G,"glmer.nb.theta")

fit_full<-glmer(WhiteFungDam~treatment*gluc_Conc+treatment*flav_Conc+(1|Family/Tag)+(1|gh_bench),family=poisson,data=dat)

fit.1<-update(fit_full,~.-flav_Conc:treatment)
anova(fit.1,fit_full) #Fit1 is a better model


fit.2<-update(fit.1,~.-gluc_Conc:treatment)
anova(fit.2,fit.1) #models are the same... eliminating interaction.


fit.3<-update(fit.2,~.-gluc_Conc)
anova(fit.3,fit.2) #The model including glucConc is better. 

fit.2<-update(fit.2,data=dat[!is.na(dat$flav_Conc),]) #Using a model with a data subset.
fit.3<-update(fit.2,~.-flav_Conc) 
anova(fit.3,fit.2)#flav_Conc is unimportant. 

#going to now model using the full data set. 
fit.3<-glmer(WhiteFungDam~gluc_Conc+(1|Family/Tag)+(1|gh_bench),family=poisson,data=dat)
fit.4<-glmer(WhiteFungDam~gluc_Conc+treatment+(1|Family/Tag)+(1|gh_bench),family=poisson,data=dat)

anova(fit.3,fit.4)
#treatment is also important.

#Therefore, the best model is: fit.4 using gluc_Conc and treatment to explain whitefungal damage. 
summary(fit.4)
```
#Visuallizing -- white fungal damage is influenced by gluc and treatmnet. 
```{r}

PoisSlope=function(x,int){
  y=exp(-2.32292*x+int)
  return(y)
}


glucplot=seq(min(dat$gluc_Conc),max(dat$gluc_Conc),length.out = 695)

FungA<-PoisSlope(glucplot,-0.15701)
FungM<-PoisSlope(glucplot,-0.15701-0.82060)
FungGM<-PoisSlope(glucplot,-0.15701+0.02483)

FungA[1]
FungM[2]
FungGM[3]

any(is.na(FungM))


fit.g<-glm(WhiteFungDam~gluc_Conc+treatment,family=poisson,data=dat)
summary(fit.g)


predict(fit.g,type="response",newdata=data.frame("treatment"=rep("a",695),"gluc_Conc"=glucplot))


datv<-dat[!is.na(dat$WhiteFungDam),]

#tiff("Defence_Figures/GlucosinolateFungi.tiff", units="in", width=10, height=6, res=300)
ggplot(datv[datv$WhiteFungDam<30,])+
  geom_point(aes(y=WhiteFungDam,x=gluc_Conc,colour=treatment))+
    scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00","#009E73","#56B4E9","#E69F00"),labels=c("Alone","Garlic Mustard","Maple"))+theme_simple()+
  scale_y_continuous(breaks=c(0,2,4,6,8,10,12))+
  geom_path(x=glucplot,y=FungA,colour="#009E73")+
  geom_path(x=glucplot,y=FungM,colour="#E69F00")+
  ylab("Powdery Mildew Damage")+
xlab(bquote(bold("[Total Glucosinolate] " (mg/ml))))
#dev.off()




```


#BlackPathDam
```{r}
#Glucosinolate and flavonoids are correlated, but the R2 is only 0.39, so i dont think it is a very big deal. 
summary(lm(gluc_Conc~flav_Conc,dat=dat))

fit_full<-glmer(BlackPathDam~treatment*gluc_Conc+treatment*flav_Conc+(1|Family/Tag)+(1|gh_bench),family=poisson,data=dat)

fit.1<-update(fit_full,~.-flav_Conc:treatment)
anova(fit.1,fit_full) #Fit1 is a better model


fit.2<-update(fit.1,~.-gluc_Conc:treatment)
anova(fit.2,fit.1) #Fit2 is technically better, but the model stil failed to converge, so the estimate may not be reliable. Especially since non of the gluc conc terms are significant. It will be removed. 
summary(fit.2)


fit.3<-update(fit.2,~.-gluc_Conc)
anova(fit.3,fit.2) #There is no difference in a model with and without gluc_Conc. Therefore, it is removed. 

fit.3<-update(fit.3,data=dat[!is.na(dat$flav_Conc),]) #Using a model with a data subset.
fit.4<-update(fit.3,~.-flav_Conc) 
anova(fit.4,fit.3)#flav_Conc is very significant.Keeping this in the model.

fit.4<-update(fit.3,~.-treatment)

anova(fit.4,fit.3)
#treatment is not important. 

#Therefore, the best model to account for black pathogen damage is simply flavonoids. 

fit.4<-glmer(BlackPathDam~flav_Conc+(1|Family/Tag)+(1|gh_bench),family=poisson,data=dat)


ggplot(dat)+
  geom_point(aes(y=BlackPathDam,x=flav_Conc))

summary(fit.4) #Flav conc is actually a very significant predictor. 

```

#Visuallizing -- Black Pathogen damage is influenced by flavonols. 
```{r}


PoisSlope=function(x){
  y=exp(-1.1150*x+1.6816)
  return(y)
}


flavplot=seq(min(dat$flav_Conc,na.rm = T),max(dat$flav_Conc,na.rm=T),length.out = 687)

flavy<-PoisSlope(flavplot)

#tiff("Defence_Figures/FlavonoidBlackPath.tiff", units="in", width=10, height=6, res=300)
ggplot(dat[!is.na(dat$flav_Conc)&!is.na(dat$flav_Conc),])+
  geom_point(aes(y=BlackPathDam,x=flav_Conc))+theme_simple()+
  geom_path(x=flavplot,y=flavy,size=1,colour="#999999")+
  
  scale_y_continuous(breaks=c(0,5,10,15,20,25,30))+
  ylab("Black Pathogen Damage")+
xlab(bquote(bold("[Total Flavonoid] " (mg/ml))))
#dev.off()

```


#ThripsDam
```{r}
#Glucosinolate and flavonoids are correlated, but the R2 is only 0.39, so i dont think it is a very big deal. 
summary(lm(gluc_Conc~flav_Conc,dat=dat))

fit_full<-glmer(ThripsDam~treatment+gluc_Conc+flav_Conc+(1|Family/Tag)+(1|gh_bench),family=poisson,data=dat)

fit.1<-update(fit_full,~.-gluc_Conc)
anova(fit.1,fit_full) #Gluc Conc is in no way a significant predictor. 


fit.2<-update(fit.1,~.-treatment)
anova(fit.1,fit.2) #treatment is not a significant predictor. 


fit.2<-update(fit.2,data=dat[!is.na(dat$flav_Conc),])#Changing data set to account for missing flavonoid data. 
fit.3<-update(fit.2,~.-flav_Conc)
anova(fit.3,fit.2) #There is no difference in a model with and without gluc_Conc. Therefore, it is removed. 

fit.3<-update(fit.3,data=dat[!is.na(dat$flav_Conc),]) #Using a model with a data subset.
fit.4<-update(fit.3,~.-flav_Conc) 
anova(fit.4,fit.3)#flav_Conc is very significant.Keeping this in the model.


ggplot(dat)+
  geom_point(aes(y=ThripsDam,x=flav_Conc))

fit.4<-glmer(ThripsDam~flav_Conc+(1|Family/Tag)+(1|gh_bench),family=poisson,data=dat)

summary(fit.4) #Flav conc is again, a very significant predictor. 

```

#Visualizing
```{r}

PoisSlope=function(x){
  y=exp(-2.3319*x+3.5249)
  return(y)
}


flavplot=seq(min(dat$flav_Conc,na.rm = T),max(dat$flav_Conc,na.rm=T),length.out = 687)

flavy<-PoisSlope(flavplot)

#tiff("Defence_Figures/FlavonoidThrips.tiff", units="in", width=10, height=6, res=300)
ggplot(dat[!is.na(dat$flav_Conc)&!is.na(dat$flav_Conc),])+
  geom_point(aes(y=ThripsDam,x=flav_Conc))+theme_simple()+
  geom_path(x=flavplot,y=flavy,size=1,colour="#999999")+
  
  scale_y_continuous(breaks=c(0,5,10,15,20,25,30,35,40))+
  ylab("Thrips Damage")+
xlab(bquote(bold("[Total Flavonoid] " (mg/ml))))
#dev.off()

```









# Influence of treament and secondary compounds on Fern abundance.
```{r}






#Glucosinolate and flavonoids are correlated, but the R2 is only 0.39, so i dont think it is a very big deal. 
summary(lm(gluc_Conc~flav_Conc,dat=dat))

fit_full<-glmer(Fern~treatment+gluc_Conc+flav_Conc+(1|Family)+(1|gh_bench/gh_col),family=poisson,data=dat2)

glmer(Fern~treatment+gluc_Conc+flav_Conc+(1|Family)+(1|gh_bench/gh_col),family=poisson,data=dat2)

glmer.nb(Fern~treatment+gluc_Conc+flav_Conc+(1|Family)+(1|gh_bench/gh_col),data=dat2)



fit.1<-update(fit_full,~.-gluc_Conc)
anova(fit.1,fit_full) #Gluc Conc is in no way a significant predictor. 


fit.2<-update(fit.1,~.-treatment)
anova(fit.1,fit.2) #treatment is a significant predictor. This will be retained


fit.1<-update(fit.1,data=dat[!is.na(dat$flav_Conc),])#Changing data set to account for missing flavonoid data. 
fit.2<-update(fit.1,~.-flav_Conc)
anova(fit.1,fit.2) #Flav Conc is a significant predictor. This is the simplest,best model. (fit.1)

summary(fit.1) #Flav conc and treatment predict fern abudnance. 

#Is there an interaction? I didnt check 
fit.11<-glmer(Fern~treatment*flav_Conc+(1|Family)+(1|gh_bench),family=poisson,data=dat2)
fit.1<-glmer(Fern~treatment+flav_Conc+(1|Family)+(1|gh_bench),family=poisson,data=dat2)

anova(fit.11,fit.1)# There is strong evidence for an interation actually. 

glmer.nb(Fern~flav_Conc+(1|Family)+(1|gh_bench),family=poisson,data=dat2)

summary(fit.11)

plot(fit.1)
check_over

#Maples have more ferns and flavonols decrease their abundance. 

```


#effect on maples
```{r}

PoisSlope=function(x,int){
  y=exp((-0.02353 -3.12475)*x+int)
  return(y)
}
exp(-0.6571)

flavplot=seq(min(dat$flav_Conc,na.rm = T),max(dat$flav_Conc,na.rm=T),length.out = 707)

flavyA<-PoisSlope(flavplot,-2.1683)
flavyM<-PoisSlope(flavplot,-1.60546-2.81450)
flavyGM<-PoisSlope(flavplot,-2.1683-0.2786)


#tiff("Defence_Figures/FlavonoidFern.tiff", units="in", width=10, height=6, res=300)
ggplot(dat)+
  geom_point(aes(y=Fern,x=flav_Conc,colour=treatment))+theme_simple()+
 # geom_path(x=flavplot,y=flavyA,size=1,colour="#009E73")
  #geom_path(x=flavplot,y=flavyGM,size=1,colour="#56B4E9")
  geom_path(x=flavplot,y=flavyM,size=1,colour="#E69F00")+
      scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Garlic Mustard","Maple"))+
  scale_y_continuous(breaks=c(0,5,10,15,20,25,30,35,40))+
  ylab("Fern Abundance")+
xlab(bquote(bold("[Total Flavonoid] " (mg/ml))))
#dev.off()

```






