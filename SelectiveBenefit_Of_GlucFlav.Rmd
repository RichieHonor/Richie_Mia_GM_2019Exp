---
title: "Selective benefit of Glucosinolate and flavonoids"
output: html_notebook
---
#Part 1
The purpose of this notebook is to determine the selective benefit of glucosinolate and flavonoid compounds through plant competition by creating selection gradients. Selection gradients will involve final body mass as the proxy for fitness, but this will be replaced with fitness once the measurement is in. Concentration will be on the x-axis. This analysis will account for family and greenhouse location. 

#Part 2
The second purpose is to determine if glucosinolates and flavonoids influence suscpetibility to pathogens and if this susceptibility results in increased fitness




#Read in and prep data
```{r}
library(ggplot2)
#library(tidyr)
library(glmmTMB)
library(cowplot)
library(grid)
library(gridExtra)
library(dplyr)
source("GGPlot_Themes.R")

#read in data
rm(list=ls())
dat<-read.csv("DataSynthesis.csv")

#Remove maple controls data from the data set.
dat<-dat %>% filter(treatment!="mcnt") %>% droplevels()

#remove those with fertilizer treatment, and extra genotypes that are only in the alone treatment. 
dat<-dat[!grepl("i",dat$Sample,fixed=T),]

#Initializing columns to avoid constant error messages. 
dat$WhiteFungLogis<-NA
dat$BlackFungLogis<-NA
```


#Generating data frames with summarized leaf data (dat2) and summarized genotype data (dat3)
```{r}
hist(dat$gluc_Conc)
hist(dat$flav_Conc)
#Both concentrations are above zero. 
min(dat$gluc_Conc,na.rm=T)
min(dat$flav_Conc,na.rm=T)


#Logging data
dat$Fern<-log(dat$Fern+1)
dat$gluc_Conc<-log(dat$gluc_Conc)
dat$flav_Conc<-log(dat$flav_Conc)
dat$ChlorA<-log(dat$ChlorA)
dat$ThripsDam<-log(dat$ThripsDam+1)
dat$BlackPathDam<-log(dat$BlackPathDam+1)



#Creating leaf area vector 
dat$GM_Leaf_Area<-dat$GM_Leaf_Len*dat$GM_Leaf_Wid


#Summarizing: Taking the mean value of leaves. This tibble contains data at the level of the plant means. 
dat2<-dat %>% group_by(Tag) %>% summarize(ChlorA=mean(ChlorA),ChlorB=mean(ChlorB),gluc_Conc=mean(gluc_Conc),flav_Conc=mean(flav_Conc),Family=first(Family),treatment=first(treatment),gh_row=first(gh_row),gh_bench=first(gh_bench),GM_TotalLeaf_Area=first(GM_TotalLeaf_Area),comp_number=first(comp_number),ThripsDam=mean(ThripsDam),WhiteFungDam=mean(WhiteFungDam),BlackPathDam=mean(BlackPathDam),Fern=mean(Fern),gh_col=first(gh_col),GM_Leaf_Area=mean(GM_Leaf_Area),Latitude=first(Latitude),Longitude=first(Longitude),Altitude=first(Altitude))
dat

#All of these genotypes died (15 Genotypes).(We are simply missing a final measurement for e|JBCHY1-1-50|Q|240) That is only 3% Mortality. 
dead<-dat2[is.na(dat2$GM_TotalLeaf_Area),]

#Removing those with dead competitors from the garlic mustard treatment. ("e|JBCHY1-1-50|Q|240") did not die, we are simply missing the final measurement for it.

dead_competitors<-dead %>% filter(treatment=="gm",Tag!="e|JBCHY1-1-50|Q|240") %>% select(comp_number)

#Removing those with dead competitors from the analysis. 
dat2<-dat2 %>% filter(!comp_number %in% dead_competitors$comp_number)
dat<-dat %>% filter(!comp_number %in% dead_competitors$comp_number)


##Summarizing: Taking the mean value of plants. This tibble contains data at the level of the family means within each treatment. 
#dat3<-dat2 %>% drop_na(GM_TotalLeaf_Area) %>% group_by(Family,treatment)  %>% summarize_if(is.numeric,mean)



#Because of how zero inflated white pathogen damage is, i will use a logistic regression to model it.
dat2$WhiteFungLogis<-NA
dat2$WhiteFungLogis[dat2$WhiteFungDam==0]<-0
dat2$WhiteFungLogis[dat2$WhiteFungDam>0]<-1


  #Function to standardize variables. 
Standardize<-function(x){
  standard<-(x-mean(x,na.rm=T))/sd(x,na.rm=T)
}

#Standardizing leaf area. 
dat2$GM_Leaf_Area<-Standardize(dat2$GM_Leaf_Area)

```



#What influences performance (update with gluc model selection)? 
```{r}

#Modelling random effects.
fitfull<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*gluc_Conc+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2)

fitfull1<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*gluc_Conc+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_Leaf_Area)+(1|gh_bench), data=dat2)

fitfull2<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*gluc_Conc+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_Leaf_Area)+(1|Family), data=dat2)

fitfull3<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*gluc_Conc+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_Leaf_Area)+(1|Family/treatment)+(1|gh_bench), data=dat2)

#Is family important? 
anova(fitfull,fitfull1) #Yes, family predicts performance. 
#Is gh bench important? 
anova(fitfull,fitfull2) #Yes, gh_bench predicts performance. 
#Is there a GxE interaction? 
anova(fitfull,fitfull3) #No there does not appear to be. 

#Modelling fixed effects. 
fit<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*gluc_Conc+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2)

fit2<-update(fit,~.-ThripsDam:BlackPathDam:WhiteFungLogis)
anova(fit,fit2) #Not a significant three way interaction.

fit3<-update(fit2,~.-BlackPathDam:WhiteFungLogis)
anova(fit3,fit2) #There is not a significant two way interaction, 

fit4<-update(fit3,~.-BlackPathDam:ThripsDam)
anova(fit4,fit3)
#There is not a significant interaction between black path dam and thrips dam. 

fit5<-update(fit4,~.-WhiteFungLogis:ThripsDam)
anova(fit5,fit4) #There is not a significant whitefung dam and thrips dam interaction. 

summary(fit5)

#Is black path dam significant
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*gluc_Conc+BlackPathDam+WhiteFungLogis+ThripsDam+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$BlackPathDam),])
fit7<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*gluc_Conc+WhiteFungLogis+ThripsDam+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$BlackPathDam),])
anova(fit6,fit7) #Yes ver

#Is  White Path dam significant
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*gluc_Conc+BlackPathDam+WhiteFungLogis+ThripsDam+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$WhiteFungLogis),])
fit8<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*gluc_Conc+BlackPathDam+ThripsDam+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$WhiteFungLogis),])
anova(fit6,fit8) #Yes

#Is thrips  dam significant
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*gluc_Conc+BlackPathDam+WhiteFungLogis+ThripsDam+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$ThripsDam),])
fit9<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*gluc_Conc+BlackPathDam+WhiteFungLogis+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2[!is.na(dat2$ThripsDam),])
anova(fit6,fit9) #It is on the edge, i will retain it. 

#Is gluc*treatment significant?
fit6<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment*gluc_Conc+BlackPathDam+WhiteFungLogis+ThripsDam+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2)
fit10<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment+gluc_Conc+BlackPathDam+WhiteFungLogis+ThripsDam+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2)
anova(fit6,fit10) #Yes it is.

#What is the influence of flavonoids? 
fit<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment+flav_Conc+BlackPathDam+WhiteFungLogis+ThripsDam+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2)
summary(fit6)
summary(fit)

plot(residuals(fit6,type="pearson",fitted(fit6)))
qqnorm(residuals(fit6))
plot(residuals(fit,type="pearson",fitted(fit)))
qqnorm(residuals(fit))


#Coefficients for table 
fit<-glmmTMB(GM_TotalLeaf_Area~treatment*Standardize(gluc_Conc)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(ThripsDam)+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2)
summary(fit)

fit<-glmmTMB(GM_TotalLeaf_Area~treatment*Standardize(ChlorA)+treatment*Standardize(gluc_Conc)+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(ThripsDam)+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2)
summary(fit)


#Coefficients without glucosinolate table 
fit<-glmmTMB(GM_TotalLeaf_Area~treatment+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(ThripsDam)+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench), data=dat2)
summary(fit)

```





#Visualization -- The conditional benefit of glucosinolates (allelopathy)
```{r}
source("GGPlot_Themes.R")
#Is the cost dependent on the treatment? 
fit7<-glmmTMB(GM_TotalLeaf_Area~treatment*gluc_Conc+Standardize(BlackPathDam)+WhiteFungLogis+Standardize(ThripsDam)+Standardize(GM_Leaf_Area)+Standardize(Fern)+(1|Family)+(1|gh_bench), data=dat2)
summary(fit7) 


plot(residuals(fit7))

aloneSlope<-function(x){
  y=130.69*x+ 9158.16
  return(y)
}
mapleSlope<-function(x){
  y=(130.69+2830.28)*x+9158.16 +3864.18
  return(y)
}

mustardSlope<-function(x){
  y=(130.69+1071.01)*x+9158.16-306.22#Non significant slope
  return(y)
}

minM<-min(dat2$gluc_Conc[dat2$treatment=="m"],na.rm = T)
maxM<-max(dat2$gluc_Conc[dat2$treatment=="m"],na.rm = T)

minA<-min(dat2$gluc_Conc[dat2$treatment=="a"],na.rm = T)
maxA<-max(dat2$gluc_Conc[dat2$treatment=="a"],na.rm = T)

minG<-min(dat2$gluc_Conc[dat2$treatment=="gm"],na.rm = T)
maxG<-max(dat2$gluc_Conc[dat2$treatment=="gm"],na.rm = T)

#tiff("Selection_Figures/Gluc_Benefit.tiff", units="in", width=10, height=6, res=300)
ggplot(dat2)+
  geom_point(aes(y=GM_TotalLeaf_Area,x=gluc_Conc,colour=treatment),size=2)+
  geom_segment(x=minA,xend=maxA,y=aloneSlope(minA),yend=aloneSlope(maxA),colour="#009E73",size=1.5)+
    geom_segment(x=minM,xend=maxM,y=mapleSlope(minM),yend=mapleSlope(maxM),colour="#E69F00",size=1.5)+
  geom_segment(x=minG,xend=maxG,y=mustardSlope(minG),yend=mustardSlope(maxG),colour="#56B4E9",size=1.5)+theme_simple()+
  ylab(bquote(bold("Performance\n(Total Leaf Area "~(mm^2)*")")))+xlab(bquote(bold("[Total Glucosinolate] (log" (mg/ml)*")")))+
  scale_y_continuous(breaks=seq(0,20000,by=2000))+
  scale_x_continuous(breaks=seq(-3,0,by=0.25))+

  scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Intraspecific","Interspecific"))
#dev.off()

minA


```


#Visualizing the effect of flavonoid on fitness.
```{r}
fit6<-glmmTMB(GM_TotalLeaf_Area~treatment+BlackPathDam+WhiteFungLogis+ThripsDam+GM_Leaf_Area+flav_Conc+Fern+(1|Family)+(1|gh_bench), data=dat2)
summary(fit6)


aloneSlope<-function(x){
  y=1707.79  *x+  13430.46
  return(y)
}
mapleSlope<-function(x){
  y=(1707.79 )*x+ 13430.46 -958.66
  return(y)
}

mustardSlope<-function(x){
  y=1707.79  *x+ 13430.46-1952.74 #Non significant slope
  return(y)
}

minM<-min(dat2$flav_Conc[dat2$treatment=="m"],na.rm = T)
maxM<-max(dat2$flav_Conc[dat2$treatment=="m"],na.rm = T)

minA<-min(dat2$flav_Conc[dat2$treatment=="a"],na.rm = T)
maxA<-max(dat2$flav_Conc[dat2$treatment=="a"],na.rm = T)

minG<-min(dat2$flav_Conc[dat2$treatment=="gm"],na.rm = T)
maxG<-max(dat2$flav_Conc[dat2$treatment=="gm"],na.rm = T)


#tiff("Selection_Figures/Flav_Benefit.tiff", units="in", width=10, height=6, res=300)
ggplot(dat2)+
  geom_point(aes(y=GM_TotalLeaf_Area,x=flav_Conc,colour=treatment),size=2)+
  geom_segment(x=minA,xend=maxA,y=aloneSlope(minA),yend=aloneSlope(maxA),colour="#009E73",size=1.5)+
    geom_segment(x=minM,xend=maxM,y=mapleSlope(minM),yend=mapleSlope(maxM),colour="#E69F00",size=1.5)+theme_simple()+
  geom_segment(x=minG,xend=maxG,y=mustardSlope(minG),yend=mustardSlope(maxG),colour="#56B4E9",size=1.5)+theme_simple()+
  ylab(bquote(bold("Performance\n(Total Leaf Area "~(mm^2)*")")))+
  xlab(bquote(bold("[Total Flavonoid] (log(" (mg/ml)*")")))+
    scale_y_continuous(breaks=seq(0,20000,by=2000))+
  scale_x_continuous(breaks=seq(-4,0,by=0.25))+
  scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Intraspecific","Interspecific"))
#dev.off()
```


#Multiplot
```{r}
source("GGPlot_Themes.R")

aloneSlope<-function(x){
  y=130.69*x+ 9158.16
  return(y)
}
mapleSlope<-function(x){
  y=(130.69+2830.28)*x+9158.16 +3864.18
  return(y)
}

mustardSlope<-function(x){
  y=(130.69+1071.01)*x+9158.16-306.22#Non significant slope
  return(y)
}

minM<-min(dat2$gluc_Conc[dat2$treatment=="m"],na.rm = T)
maxM<-max(dat2$gluc_Conc[dat2$treatment=="m"],na.rm = T)

minA<-min(dat2$gluc_Conc[dat2$treatment=="a"],na.rm = T)
maxA<-max(dat2$gluc_Conc[dat2$treatment=="a"],na.rm = T)

minG<-min(dat2$gluc_Conc[dat2$treatment=="gm"],na.rm = T)
maxG<-max(dat2$gluc_Conc[dat2$treatment=="gm"],na.rm = T)
a<-ggplot(dat2)+
  geom_point(aes(y=GM_TotalLeaf_Area,x=gluc_Conc,colour=treatment),size=2)+
  geom_segment(x=minA,xend=maxA,y=aloneSlope(minA),yend=aloneSlope(maxA),colour="#009E73",size=1.5)+
    geom_segment(x=minM,xend=maxM,y=mapleSlope(minM),yend=mapleSlope(maxM),colour="#E69F00",size=1.5)+
  geom_segment(x=minG,xend=maxG,y=mustardSlope(minG),yend=mustardSlope(maxG),colour="#56B4E9",size=1.5)+
  theme_simple_multiCol_First()+
  ylab(bquote(bold("Total Leaf Area "~(mm^2))))+
  xlab(bquote(bold("[Total Glucosinolate] (log" (mg/ml)*")")))+
  scale_y_continuous(breaks=seq(0,20000,by=2000))+
  scale_x_continuous(breaks=seq(-3,0,by=0.25))+
  scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Intraspecific","Interspecific"))

aloneSlope<-function(x){
  y=1707.79  *x+  13430.46
  return(y)
}
mapleSlope<-function(x){
  y=(1707.79 )*x+ 13430.46 -958.66
  return(y)
}

mustardSlope<-function(x){
  y=1707.79  *x+ 13430.46-1952.74 #Non significant slope
  return(y)
}

minM<-min(dat2$flav_Conc[dat2$treatment=="m"],na.rm = T)
maxM<-max(dat2$flav_Conc[dat2$treatment=="m"],na.rm = T)

minA<-min(dat2$flav_Conc[dat2$treatment=="a"],na.rm = T)
maxA<-max(dat2$flav_Conc[dat2$treatment=="a"],na.rm = T)

minG<-min(dat2$flav_Conc[dat2$treatment=="gm"],na.rm = T)
maxG<-max(dat2$flav_Conc[dat2$treatment=="gm"],na.rm = T)


b<-ggplot(dat2)+
  geom_point(aes(y=GM_TotalLeaf_Area,x=flav_Conc,colour=treatment),size=2)+
  geom_segment(x=minA,xend=maxA,y=aloneSlope(minA),yend=aloneSlope(maxA),colour="#009E73",size=1.5)+
    geom_segment(x=minM,xend=maxM,y=mapleSlope(minM),yend=mapleSlope(maxM),colour="#E69F00",size=1.5)+theme_simple()+
  geom_segment(x=minG,xend=maxG,y=mustardSlope(minG),yend=mustardSlope(maxG),colour="#56B4E9",size=1.5)+
  theme_simple_multiCol()+
  ylab(bquote(bold("Total Leaf Area "~(mm^2))))+
  xlab(bquote(bold("[Total Flavonoid] (log(" (mg/ml)*")")))+
    scale_y_continuous(breaks=seq(0,20000,by=2000))+
  scale_x_continuous(breaks=seq(-4,0,by=0.25))+
  scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Intraspecific","Interspecific"))

c<-ggplot(dat2)+
  geom_point(aes(y=GM_TotalLeaf_Area,x=flav_Conc,colour=treatment),size=2)+
  geom_segment(x=minA,xend=maxA,y=aloneSlope(minA),yend=aloneSlope(maxA),colour="#009E73",size=1.5)+
    geom_segment(x=minM,xend=maxM,y=mapleSlope(minM),yend=mapleSlope(maxM),colour="#E69F00",size=1.5)+theme_simple()+
  geom_segment(x=minG,xend=maxG,y=mustardSlope(minG),yend=mustardSlope(maxG),colour="#56B4E9",size=1.5)+
  theme_simple()+
  ylab(bquote(bold("Performance\n(Total Leaf Area "~(mm^2)*")")))+
  xlab(bquote(bold("[Total Flavonoid] (log(" (mg/ml)*")")))+
    scale_y_continuous(breaks=seq(0,20000,by=2000))+
  scale_x_continuous(breaks=seq(-4,0,by=0.25))+
  scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Intraspecific","Interspecific"))

d<-get_legend(c)

plots <- align_plots(a, b,align="hv")

top<-plot_grid(plots[[1]],plots[[2]],ncol=2,rel_widths=c(1,1),rel_heights = c(1,1),labels = c("a","b"),label_fontfamily = "Arial",label_size = 18)

tiff("Selection_Figures/GlucFlav_Benefit.tiff", units="in", width=14, height=8, res=300)
plot_grid(d,top,ncol=1,rel_heights = c(1,3.5))
dev.off()
```



#Modelling: Negative Binomial- Fern abundance
```{r}
#Because there are two garlic mustard individuals per pot, and the unit we are looking at is only replicable at the pot level (fern abundance in a pot) duplicates within the same pot in the garlic mustard treatment need to be removed and averaged to remove pseudoreplication. 

#What i will do is make the competition number the tag for those in the GM treatment. This will have the effect of maintaining the leaf variation, but averaging it over each pot. 

# I will need to use dat2, summarized at the individual level, because we have a single observation at the pot level, not at the leaf level. 
datFern<-dat2
datFern$Tag<-as.character(datFern$Tag)
for(i in 1:length(datFern$Tag)){
  if(!is.na(datFern$comp_number[i])){
    datFern$Tag[i]<-datFern$comp_number[i]
  }
}

#Averaging pot values in the GM treatment.
datFernGM<-datFern %>% group_by(Tag) %>% filter(treatment=="gm") %>% summarize_all(~mean(.))
datFernGM$treatment<-"gm"

#Binding collumns back together. Family should not be used as those in the GM treatment represent the average of two families. 
datFern2<-rbind(datFernGM,datFern[datFern$treatment!="gm",])


#Modelling fern effect. 
fit_full<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment+Standardize(Fern)+Standardize(BlackPathDam)+WhiteFungLogis+ThripsDam+(1|gh_bench),data=datFern2)
summary(fit_full) #Thrips dam not significant.

#What is the effect of ferns?
fit_full1<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment+Standardize(Fern)+Standardize(BlackPathDam)+WhiteFungLogis+(1|gh_bench),data=datFern2)
fit_full2<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment+Standardize(BlackPathDam)+WhiteFungLogis+(1|gh_bench),data=datFern2)
anova(fit_full1,fit_full2) #Fern highly significant

summary(fit_full1)

#Modelling to get coefficients
fit<-glmmTMB(GM_TotalLeaf_Area~treatment+Standardize(Fern)+Standardize(BlackPathDam)+WhiteFungLogis+(1|gh_bench),data=datFern2)

summary(fit)

#With standardized coefficients
fit<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment+Standardize(Fern)+Standardize(BlackPathDam)+WhiteFungLogis+(1|gh_bench),data=datFern2)
summary(fit)

confint(fit)

```


#Visualizing -- effect of treatment
```{r}
source("GGPlot_Themes.R")

Competitors<-factor(c("Maple on GM","GM on GM","GM on Maple"),levels=c("Maple on GM","GM on GM","GM on Maple"))
Values<-c(-0.36,-1.16,-0.55)
min<-c(-0.19,-0.93,-0.30)
max<-c(-0.54,-1.38,-0.81)
col<-c("a","a","b")

point<-data.frame(Competitors,Values,min,max,col)

ggplot(point)+
geom_pointrange(aes(x=Competitors,y=Values,ymin=min,ymax=max,colour=col))+
  scale_y_continuous(limits=c(-1.5,0))+
  theme_simple_multiCol_First()+
  labs(y="Reduction in Performance\n (Standard Deviation TLA)",x="")
  
 
```













#Visualizing -- effect of flavonoids on fern abundance. 
```{r}

PoisSlope=function(x,int){
  y=exp((-0.02353 -3.12475)*x+int)
  return(y)
}
exp(-0.6571)

flavplot=seq(min(dat$flav_Conc,na.rm = T),max(dat$flav_Conc,na.rm=T),length.out = 707)

flavyA<-PoisSlope(flavplot,-2.1683)
flavyM<-PoisSlope(flavplot,-1.60546-2.81450)
flavyGM<-PoisSlope(flavplot,-2.1683-0.2786)


#tiff("Defence_Figures/FlavonoidFern.tiff", units="in", width=10, height=6, res=300)
ggplot(dat)+
  geom_point(aes(y=Fern,x=flav_Conc,colour=treatment))+theme_simple()+
 # geom_path(x=flavplot,y=flavyA,size=1,colour="#009E73")
  #geom_path(x=flavplot,y=flavyGM,size=1,colour="#56B4E9")
  geom_path(x=flavplot,y=flavyM,size=1,colour="#E69F00")+
      scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Garlic Mustard","Maple"))+
  scale_y_continuous(breaks=c(0,5,10,15,20,25,30,35,40))+
  ylab("Fern Abundance")+
xlab(bquote(bold("[Total Flavonoid] " (mg/ml))))
#dev.off()

```

How can we know that healthy plants dont just exhibit more secondary compounds and not that those with more secondary compounds are healthier?



#Generating table of genotype location and sample size. 
```{r}
table(dat$Family,dat$Longitude,dat$Latitude,dat$Altitude)

GenotypeLocation<-dat %>% group_by(Family) %>% summarize(Longitude=first(Longitude),Latitude=first(Latitude),Altitude=first(Altitude))

# Before Sample Loss. 
repTable<-dat2 %>% group_by(Family,treatment) %>% summarize(SampleSize=n())

#Making the table into a wide format
repTableWide<-repTable %>% pivot_wider(names_from = treatment,values_from = SampleSize)

##Adding a column for total sample size per genotype
repTableWide$Total<-repTableWide$a+repTableWide$gm+repTableWide$m

##Ordering the data set.  
repTableWide<-repTableWide[order(repTableWide$Total,decreasing = T),]

apply(repTableWide[,2:5],2,sum)
##Printing table. 
#write.csv(repTableWide,"SampleSize.csv")
#write.csv(GenotypeLocation,"GenotypeLocation.csv")

```













#Searching for a fitness trade-off between the alone and interspecific competition treatment. 
```{r}
source("GGPlot_Themes.R")

#Calculating family means within treatment. 
TradeOff<-dat3 %>% filter(treatment=="a") %>% drop_na(GM_TotalLeaf_Area) %>%  select(LeafSizeAlone=GM_TotalLeaf_Area,Family,gluc_ConcAlone=gluc_Conc) %>% right_join(dat3 %>% filter(treatment=="m") %>%  select(LeafSizeMaple=GM_TotalLeaf_Area,Family,gluc_ConcMaple=gluc_Conc),by="Family")

#Calculating standard error of each family
StdErr<-dat2 %>% select(Family,treatment,GM_TotalLeaf_Area) %>% group_by(Family,treatment) %>% drop_na(GM_TotalLeaf_Area) %>%  summarize(StdErr=sd(GM_TotalLeaf_Area)/sqrt(length(GM_TotalLeaf_Area)),size=length(GM_TotalLeaf_Area))

#Shifting the data to be in long form. 
StdErr2<-StdErr %>% filter(treatment=="a") %>% select(StdErrAlone=StdErr,Family) %>% right_join(StdErr %>% filter(treatment=="m") %>% select(StdErrMaple=StdErr,Family),by="Family")

TradeOff2<-StdErr2 %>% left_join(TradeOff)


#tiff("Selection_Figures/TradeOff.tiff", units="in", width=10, height=6, res=300)

ggplot(TradeOff2,aes(y=LeafSizeAlone,x=LeafSizeMaple))+
  geom_point()+
  geom_linerange(aes(ymin = LeafSizeAlone - StdErrAlone, 
                    ymax = LeafSizeAlone + StdErrAlone))+
  geom_errorbarh(aes(xmin = LeafSizeMaple - StdErrMaple,
                    xmax = LeafSizeMaple + StdErrMaple))+
theme_simple()+
  xlab("Performance with Maple")+
  ylab("Performance Alone")
#dev.off()
summary(lm(LeafSizeAlone~LeafSizeMaple,data=TradeOff2))

```





