---
title: "Growth Rate Analysis"
output: html_notebook
---

This document is to compile the various measurements I have taken, for all genotypes in the competition experiment. The data from the fertilizer experiement is also included in this data set, but is properly integrated with the data pertaining to the fertilizer experiment in the document "FertilizerSynthesis.csv".

*Done*
###File for *initial size of GM and Maples, greenhouse location, treatment and competition number*: **"Data_collection_GH.csv"**. In R/masters_thesis

*Done*
###File for *germination transplant date, and gibberelic acid treatment*. **clean_germination_data_2.csv**. In R/masters_thesis.

*Done*
###File for *final manual measurement of maple size* **Maple_data.txt**. in Python/Raw_Data.

*Done*
###File for *final manual measurement of Alliaria leaf size* **Leaf_data.txt**. in Python/Final_GM_Data_CompetitionExp.

###File for *Growth Rate of Alliaria* **All_photo_data.txt**. in Python/python_pics_analysis.

*Done*
###File for *fern abundance and moss presence* **fern_cover.txt**. in Raw_Data. 

Note for analysis: 
only record as dead if I have the barcode, because some lost the barcode but did not die. Also, ferns were recorded for only one genotype if they were in the competition treatment, but it applied to both plants in the compeition treatment. 

*Done*
###File for *Pathogen damage* 

*Done*
###File for *Glocosinolate,Flavonoid and Chlorophyll content* **All_UV_Data.txt**. in masters_thesis/UVSpec

--------------------
--Goal of Analysis is to combine the documents into one master document that can be used to look at the data while considering all variables. 


#Incorporate Data_collection_GH_0.csv (treatment, ID, etc.) with Glucosinolate, Flavonoid and chlorophyll data (All_UV_Data.txt).
```{r}
library(dplyr)
library(tidyr)


#-------------------------------------------------------------------
#----------GH Data Prep
#-------------------------------------------------------------------

#read in GH data
dat=read.csv("Data_Moities/Data_collection_GH.csv",stringsAsFactors = F)

#Fix column names
colnames(dat)[9:12]<-c("comp_number","maple_leaf_length_0","maple_height_0","maple_leaves_0")

#Removing first row (Which contains no data).
dat<-dat[2:length(dat$gh_bench),]

#Remove maple controls (for now) This is because the strsplit is mis identifying the maple controls for garlic mustard data. I will have to fix this later.
dat<-dat[!grepl("aple",dat$Tag),]

#TO FIX
#The tag "c|MSMID1-1-20|Q|381" was mislabled as "c|MSMID1-1-20|G381". This is fixed below.
dat$Tag[grep("G381",dat$Tag)]<-"c|MSMID1-1-20|Q|381"

```


```{r}
#####
#Spec data prep--------------------------------------

#Importing functions created to clean up the UV spec data.
source("UVSpecProcessingModule.R")

##-----------------------------------

#Seperate spec data into Chlorophyll a and b
ChlorAB<-CleanData("Data_Moities/All_UV_Data.txt")[[2]]

#.... and Glucosinolate and flavonoid data
GF<-CleanData("Data_Moities/All_UV_Data.txt")[[1]]

```




#Sample Identification!
```{r}
#Using the Tag (fill ID) from the greenhouse data, assign a Tag to the ID numbers in the spec data.

#Glucosinolates and flavonoids.
for(i in 1:length(GF$Sample)){
  ID<-strsplit(GF$Sample[i],"_")[[1]][1]
  #Ensure the lable is surrounded by symbols, not numbers to ensure no faulty matches ... ex |4 cound be in |48, but not |4| in |48|
  ID<-paste("|",ID,"|",sep = "")
  GF$ID[i]<-ID
  count=0
  for(j in 1:length(dat$Tag)){
    #Modify tag locally to avoid mis matches. 
    locTag<-paste(dat$Tag[j],"|",sep="")
    if(grepl(ID,locTag,fixed=T)){
      GF$Tag[i]<-dat$Tag[j]
      count=count+1
    }
  }
  
  #Pool samples will be assigned a tag of simply "pool" and an ID of pool and date. 
  if (count==0){
    GF$Tag[i]<-GF$Sample[i]
    GF$Sample[i]<-paste(GF$Sample[i],GF$DataFile[i],sep="-")
  }
}


#Chlorophyll Samples
for(i in 1:length(ChlorAB$Sample)){
  ID<-strsplit(ChlorAB$Sample[i],"_")[[1]][1]
  ID<-paste("|",ID,"|",sep = "")
  ChlorAB$ID[i]<-ID
  count=0
  for(j in 1:length(dat$Tag)){
    locTag<-paste(dat$Tag[j],"|",sep="")
    if(grepl(ID,locTag,fixed=T)){
      ChlorAB$Tag[i]<-dat$Tag[j]
      count=count+1
    }
  }
   #Pool samples will be assigned a tag of simply "pool" and an ID of pool and date.  
  if (count==0){
    ChlorAB$Tag[i]<-ChlorAB$Sample[i]
    ChlorAB$Sample[i]<-paste(ChlorAB$Sample[i],ChlorAB$DataFile[i],sep="-")
  }
}

#-----------------------------------------
#Seperate GF into glucosinolate and flavonoid dataframes,these will be joined in a wide format. 

#Glucosinolate
gluc<-GF[GF$Compound=="gluc",]

#Flavonoid
flav<-GF[GF$Compound=="flav",]


#Making glucosinolate specific column names
colnames(gluc)<-paste("gluc",colnames(gluc),sep="_")

#Making flavonoid specific column names
colnames(flav)<-paste("flav",colnames(flav),sep="_")

#Removing controls from chlorophyll
ChlorNoCont<-ChlorAB[ChlorAB$ID!="|cont|",]

ChlorNoCont[grepl("Feb_13",ChlorNoCont$DataFile),]

```

#Removing Duplicates and checking for errors. 
```{r}

#Searching for those with more replicates than they should have. They should have 2 because each leaf has two technical replicates. For some reason, the same sample is appearing for those that should not have more than 1 sample per leaf (i.e. those not in the fertilizer treatment)
errors<-gluc %>% group_by(gluc_Sample) %>% summarize(n=n()) %>% filter(n>2)
errors<-errors[!grepl("i",errors$gluc_Sample),]

#Datafile containing the errors... I must go through each one and check it. they will be deleted, not averaged if there is a duplicate. 
errors<-gluc %>% select(gluc_Sample,gluc_DataFile,gluc_Tag,gluc_Conc) %>% right_join(errors,by="gluc_Sample") %>% filter(gluc_Tag!="pool")



# I went through these errors and could not explain them. I believe these errors were brought about because of poor transcribing during the data collection  process. This is unfortunate, but they must be deleted from the analysis because i an unsure of which sample is the correct sample and which is the transcribing error. This is done in the next chunk.

```


#Averaging duplicates (i.e. technical replicates) 
```{r}
#Averaging duplicates
#------
#gluc
#------
#Creating pool collumn to help differentiate. 
gluc$poolID[gluc$gluc_Column<6]<-"lower"
gluc$poolID[gluc$gluc_Column>6]<-"upper"

#Making an ID specific to each duplicated value on the plate. 
gluc$gluc_Sample[gluc$gluc_Tag=="pool"]<-paste(gluc$gluc_Sample[gluc$gluc_Tag=="pool"],gluc$poolID[gluc$gluc_Tag=="pool"],sep="_")

Average_gluc<-gluc %>% group_by(gluc_Sample) %>% summarize(gluc_Conc=mean(gluc_Conc))

Average_gluc[grepl("pool",Average_gluc$gluc_Sample),]

#------
#flav
#------

#Creating pool collumn to help differentiate. 
flav$poolID[flav$flav_Column<6]<-"lower"
flav$poolID[flav$flav_Column>6]<-"upper"

#Making an ID specific to each duplicated value on the plate. 
flav$flav_Sample[flav$flav_Tag=="pool"]<-paste(flav$flav_Sample[flav$flav_Tag=="pool"],flav$poolID[flav$flav_Tag=="pool"],sep="_")

Average_flav<-flav %>% group_by(flav_Sample) %>% summarize_at(.vars = vars(flav_Conc),.funs=mean)

Average_flav[grepl("pool",Average_flav$flav_Sample),]


#-------
#ChlorNoCont
#-------

#Creating pool collumn to help differentiate. 
ChlorNoCont$poolID[ChlorNoCont$Column<3]<-"lower"
ChlorNoCont$poolID[ChlorNoCont$Column>=3]<-"upper"

#Making an ID specific to each duplicated value on the plate. 
ChlorNoCont$Sample[ChlorNoCont$Tag=="pool"]<-paste(ChlorNoCont$Sample[ChlorNoCont$Tag=="pool"],ChlorNoCont$poolID[ChlorNoCont$Tag=="pool"],sep="_")

Average_ChlorNoCont<-ChlorNoCont %>% group_by(Sample) %>% summarize_at(.vars=vars(ChlorA,ChlorB),.funs=mean)


Average_ChlorNoCont[grepl("pool",Average_ChlorNoCont$Sample),]

#-----
#Add in missing columns

#Remove duplicates, this is so that other columns in the chlorophyll data frame can be aded back in. #the column Datafile, is no longer relevant for fertilizer files as samples were averaged over multiple datafiles. 
Col_Merger0.1<-ChlorNoCont[!duplicated(ChlorNoCont$Sample),]
#Select relevant columns
Col_Merger<-Col_Merger0.1 %>% select(Sample,Tag,DataFile)

#Check to ensure that the merge went okay and no values were lost. 
if(length(Col_Merger$Sample)!=length(Average_ChlorNoCont$Sample)){
  stop("Columns mismatch in the merge of chlorophyll factor columns with chlorophyll data columns.")
}

#Merging dataframs.
Average_ChlorNoCont2<-left_join(Average_ChlorNoCont,Col_Merger,by="Sample")


#------
#Merge all three dataframes into a wide format. 
All_Wide0.1<-left_join(Average_ChlorNoCont2,Average_gluc,by=c("Sample"="gluc_Sample"))
All_Wide<-left_join(All_Wide0.1,Average_flav,by=c("Sample"="flav_Sample"))

#Check to ensure it was done correctly: 
if(length(All_Wide$Sample)!=length(Average_ChlorNoCont$Sample) |length(All_Wide$Sample)!=length(Average_gluc$gluc_Sample)
|length(All_Wide$Sample)!=length(Average_flav$flav_Sample)){

 stop("gluc, flav and chlorophyll samples did not match up after duplicates were averaged.")
}


#removing errors found in the previous chunk. Sample size reduced from 1108 to 1093
All_Wide<-All_Wide %>% filter(!Tag %in% errors$gluc_Tag)



```


#--------Taking care of mismatching Tag/ID!!!!
```{r}

#a273_2_dupl is a|KVEDG1-1-80|Q|273 and shares a number with d|JBCHY1-1-50|Q|273. Because of the a identifier, i am assiging this plant to a|KVEDG1-1-80|Q|273. "da" stands for duplicate A

#Leaf one
All_Wide$Tag[All_Wide$Tag=="a273_1"]<-"a|KVEDG1-1-80|Q|273"
All_Wide$Sample[All_Wide$Sample=="a273_1-Dat_Jan_17_2020_PM.txt"]<-"273da_1"

#Leaf two 
All_Wide$Tag[All_Wide$Tag=="a273_2_dupl"]<-"a|KVEDG1-1-80|Q|273"
All_Wide$Sample[All_Wide$Sample=="a273_2_dupl-Dat_Dec_6_2019.txt"]<-"273da_2"

#d273_JBCHY_1_dup is the second duplicate from above. It will be changed to d|JBCHY1-1-50|Q|273 "dd" stand for duplicate "d". - this is because of the germination treatment.

#Leaf 1
All_Wide$Tag[All_Wide$Tag=="d273_JBCHY_1_dup"]<-"d|JBCHY1-1-50|Q|273"
All_Wide$Sample[All_Wide$Sample=="d273_JBCHY_1_dup-Dat_Dec_9_2019.txt"]<-"273dd_1"

#Leaf 2
All_Wide$Tag[All_Wide$Tag=="d273_Jbchy_2"]<-"d|JBCHY1-1-50|Q|273"
All_Wide$Sample[All_Wide$Sample=="d273_Jbchy_2-Dat_Jan_17_2020_PM.txt"]<-"273dd_2"

#b?wsswm3-1-0_2 is unknown because we did not record the number.There is one genotype which is actually named "b|WSSWM3-1-0|?" Let us see if it is this genotype that is missing from All_Wide..
All_Wide<-All_Wide[!All_Wide$Tag=="b?wsswm3-1-0_2",]
All_Wide<-All_Wide[!All_Wide$Tag=="b?wsswm3-1-0_dup",]


#"e?JBCHY_dup" Belongs to the genotype "e|JBCHY1-1-50|?". This will be modified. 
All_Wide$Tag[All_Wide$Tag=="e?JBCHY_dup"]<-"e|JBCHY1-1-50|?"
All_Wide$Sample[All_Wide$Tag=="e|JBCHY1-1-50|?"]<-"?_1"


#Sample 381 is listed as G381, which is why it was not identified, i will change it to be appropriate

All_Wide[All_Wide$Sample=="381_1-Dat_Jan_21_2020_AM.txt",]<-"381_1"

All_Wide[All_Wide$Tag=="381_1",]<-"c|MSMID1-1-20|G381"




```




#Merging of clean greenhouse data (initial measurements from the greenhouse) and clean UV data with duplicates averaged.
```{r}
0.6/18
#This full join will keep all data from all individuals, whether or not we have glucosinolate and flavonoid data for them. 

Final<-full_join(All_Wide,dat,by="Tag")


Final<-Final %>% select(-new._code_needed.,-Helper.date)


#Check for those that did not get properly identified. 
Final[is.na(Final$gh_bench)&Final$Tag!="pool",]

#i110_1 belongs to the genotype “c|CBMCK1-2-80|N|i110”. I know this genotype is in the alone treatment because of the i prefix and that is it not in the fertilizer experiement. Unfortunately, i do not have information on its greenhouse location, but i will fill out what i know about it. 

#Filling in sample #
Final[Final$Tag=="i110_1"|Final$Tag=="i110_2","Sample"]<-Final[Final$Tag=="i110_1"|Final$Tag=="i110_2","Tag"]

#Filling in tag name
Final[Final$Tag=="i110_1"|Final$Tag=="i110_2","Tag"]<-"c|CBMCK1-2-80|N|i110"

#Filling in treatment
Final[Final$Tag=="c|CBMCK1-2-80|N|i110"|Final$Tag=="i110_2","treatment"]<-"a"

write.csv(Final,"DataSynthesis.csv")


min(dat2$GM_Fecundity,na.rm=T)
max(dat2$GM_Fecundity,na.rm=T)


exp(7.08)/(1+exp(7.08))
```

The output above will be empty if all labels were matched correctly. Else there will be a dataframe containing the samples that were not matched. 




Integrating
###File for *fern abundance and moss presence* **fern_cover.csv**. in Raw_Data.

```{r}
#Clear Environment. 
rm(list=ls())
library(dplyr)


#Read in data
dat<-read.csv("Data_Moities/fern_cover.csv",stringsAsFactors = F)

final0.1<-read.csv("DataSynthesis.csv",stringsAsFactors = F)

#Modyfiyng tag to match final document. 
dat$Genotype<-gsub("\\","|",dat$Genotype,fixed=T)
dat$Genotype<-gsub("/","-",dat$Genotype,fixed=T)

#Modifying column names to match final document.
colnames(dat)[1]<-"Tag"

#Genotype "e|SMITH1-1-0|Q|i159" was entered twice into the fern datasheet. As there is no way to assign an identity, and fern data are ratically different (i.e. 1 vs 15). This will be treated as a NA unless evidence for an ID arises. 
dat[dat$Tag=="e|SMITH1-1-0|Q|i159",c("Moss.tf","Fern")]<-NA

#Removing the duplicate
dat<-dat[!duplicated(dat$Tag),]

#Joining
final<-left_join(final0.1,dat,by="Tag")


#Blank values from the fern file in the garlic mustard treatment must be made to match the competitior in the sheet. This is because fern abundance was only recorded for one of the competititors. This will need to be accounted for later to avoid pseudoreplicaiton, because both individuals in the garlic mustard treatment are facing the same amount of ferns. 


#Assigning the same values to those with the same competition number (only one genotype was recorded for efficiency)
final<-final %>% filter(treatment=="gm") %>% drop_na(comp_number) %>% group_by(comp_number) %>% summarize(Fern2=min(Fern,na.rm = T)) %>% right_join(final,by="comp_number")

#Replacing fern values for those in the competition treatment with correct values. 
for(i in 1:length(final$Fern)){
  if(!is.na(final$Fern2[i])){ #If there is a value in fern2 column...
    final$Fern[i]<-final$Fern2[i]#assign the fern 2 column to fern. 
  }
}

#Cleaning the dataframe. (i.e. those that are NA are now zero and those that are Inf are now zero. This is because we did not sample those that did not have ferns in order to save time. )
final$Fern[is.na(final$Fern)]<-0
final$Fern[is.infinite(final$Fern)]<-0

#Removing helper column: fern2 and random column X
final<-final %>% select(-Fern2,-X)


write.csv(final,"DataSynthesis.csv")


```




Removing Runs from dec 8 and 9. These runs were performed before the evaporation step was integrated into the protocol. Also, glucosinolate and flavonoid data from Jan 30 PM, Jan 31 AM and Jan 31 PM will be removed. These runs were performed on a different plate as the old plate was becomming quite stained. These runs had very low pools with much more variance, and thus the glucosinolate and flavonoid values need to be removed as the data is not reliable.The chlorophyll data for these runs is, however, okay because the chlorophyll samples were performed on the same plate. In Mabels run on feb 3 2020 AM, she added twice the amount of stain by mistake.(I.e. final samples were 300ul instead of 200, beause she added 100ul of CHCOOH and ALCL3 instead of 50ul of each). For this reason flavonoids will be removed from this run. 
```{r}
rm(list=ls())
library(dplyr)
dat<-read.csv("DataSynthesis.csv",stringsAsFactors = F)


#Removing all spec data from runs on Dec 6 2019 and Dec 8 2019 
dat[which(dat$DataFile=="Dat_Dec_6_2019.txt"| dat$DataFile=="Dat_Dec_8_2019.txt"),c("gluc_Conc","flav_Conc","ChlorA","ChlorB")]<-NA


#Removing only glucosinolate and flavonoid runs from Dat_Jan_30_2020_PM.txt, Dat_Jan_31_2020_AM.txt, Dat_Jan_31_2020_PM.txt
dat[which(dat$DataFile=="Dat_Jan_30_2020_PM.txt" | dat$DataFile=="Dat_Jan_31_2020_AM.txt"| dat$DataFile=="Dat_Jan_31_2020_PM.txt"),c("gluc_Conc","flav_Conc")]<-NA


#Removing Flavonoid data from Mabels Run on Feb 3rd 2020 AM.
dat$flav_Conc[dat$DataFile=="Dat_Feb_3_2020_AM.txt" ]<-NA

####---------------------------


#Removing irrelevant collumns, X and moss. This is because we stopped recording moss levels because they all had some moss. 

dat<-dat %>% select(-X,-Moss.tf)

library(ggplot2)

#####
#Visualizing data So far
####
  
#Making a column for the pools to check them out. 
dat$Pool[dat$Tag=="pool"]<-"Yes"
dat$Pool[dat$Tag!="pool"]<-"No"

source("GGPlot_Themes.R")


#Glucosinolate
ggplot()+
  geom_boxplot(aes(y=as.numeric(dat$gluc_Conc),x=as.factor(dat$Pool)))+
  theme_simple_vert()+ylab(bquote(bold("[Total Glucosinolate] " (mg/ml))))+xlab("")


var(dat$gluc_Conc[dat$Pool=="Yes"],na.rm=T)/var(dat$gluc_Conc[dat$Pool=="No"],na.rm=T)*100

var(dat$flav_Conc[dat$Pool=="Yes"],na.rm=T)/var(dat$flav_Conc[dat$Pool=="No"],na.rm=T)*100

var(dat$ChlorA[dat$Pool=="Yes"],na.rm=T)/var(dat$ChlorA[dat$Pool=="No"],na.rm=T)*100



#Flavonoid
ggplot()+
  geom_boxplot(aes(y=as.numeric(dat$flav_Conc),x=as.factor(dat$Pool)))+
    theme_simple()+ylab(bquote(bold("[Total Flavonoid] " (mg/ml))))+xlab("")

#ChlorA
ggplot()+
  geom_boxplot(aes(y=as.numeric(dat$ChlorA),x=as.factor(dat$Pool)))

#ChlorB
ggplot()+
  geom_boxplot(aes(y=as.numeric(dat$ChlorB),x=as.factor(dat$Pool)))


write.csv(dat,"DataSynthesis.csv")

```





###File for *final manual measurement of Alliaria leaf size*
**Pathogen_Damage_Manual.csv** is the data file containing the holepunched leaf data, along with pathogen damage. 
**Gm_Final_Leaf_data.txt** is the data pertaining to the rest of the leaves. 
```{r}
#This file contains the length and width of every leaf in the competition treatment that did not have a whole punch. This data has a complementary set of photos of each leaf that was holepunched, along with the length and width of each holepunched leaf. This, together, can be used to determine how leaf size affects secondary compound production, but can also be amalgamated into a final biomass measurement. 

#Clear Environment. 
rm(list=ls())

#Read in master file. 
main<-read.csv("DataSynthesis.csv",stringsAsFactors = F)


if(colnames(main)[1]=="X"){
  main<-select(main,-X)
}

#Read in pathogen damage and final leaf data files. 
dat<-read.csv("Data_Moities/Gm_Final_Leaf_data.txt",header = T,stringsAsFactors = F)#This data contains information on leaves that were not punched. If leaf 1 and 2 are in this file, it means that there is no punches performed on these plants, either deliberately to see the effect of punches, or in the case where there were no good leaves available to punch. 
datP<-read.csv("Data_Moities/Pathogen_Damage_Manual.csv",header = T,stringsAsFactors = F)


#------------
#Fixing Genotype barcodes and converting data to numeric. 
#------------

#DatP (pathogen and punched data leaves)
datP$Genotype<-gsub("§","|",datP$Genotype)
datP$BlackPathDam<-as.numeric(datP$BlackPathDam)
datP$ThripsDam<-as.numeric(datP$ThripsDam)
datP$GM_Leaf_Len<-as.numeric(gsub("\\D","",datP$GM_Leaf_Len))
datP$GM_Leaf_Wid<-as.numeric(gsub("\\D","",datP$GM_Leaf_Wid))
datP$GM_Leaf_Number<-as.numeric(gsub("\\D","",datP$GM_Leaf_Number))


#Dat (non-punched and no pathogen data on leaves)
dat$Genotype<-gsub("§","|",dat$Genotype)
dat$GM_Leaf_Len<-as.numeric(gsub("\\D","",dat$GM_Leaf_Len))
dat$GM_Leaf_Wid<-as.numeric(gsub("\\D","",dat$GM_Leaf_Wid))
dat$GM_Leaf_Number<-as.numeric(gsub("\\D","",dat$GM_Leaf_Number))

#------------
# Calculating total leaf area and number of leaves.
#------------

#Finding the total leaf length and and width
tempSize<-rbind(dat,datP[1:4])

#Calculating area of each leaf. 
tempSize$GM_Leaf_Area<-tempSize$GM_Leaf_Len*tempSize$GM_Leaf_Wid


#Calculating total leaf area by summing leaf area for each genotype. Also record number of leaves.
tempArea<-tempSize %>% group_by(Genotype) %>% summarize("GM_TotalLeaf_Area"=sum(GM_Leaf_Area),"GM_NumberOfLeaves"= n())

#Merging the whole plant data with the leaf punch data. This has the effect of retaining pathogen damage on each leaf and having the total area corresponding to each genotype (in long form). 
final0.1<-left_join(datP,tempArea,by="Genotype") 

final0.1

#NoPunch: These genotypes did not get punched, and so were left out of the  previous join.The final body mass and number of leaves of these plants will be integrated into the final data frame. anti_join returns rows in x tempArea (leaves without punches) that do not have leaves with punches (datP) - these are the genotypes that were not punched. 
NoPunch<-anti_join(tempArea,datP,by="Genotype") 

#Generating "Sample" Collumn, this is used to merge this data with the master. 
final0.1$Sample<-paste(gsub(".*\\|","",final0.1$Genotype),final0.1$GM_Leaf_Number,sep = "_")


#Implementing changes to ID here to match that in the master file. 
final0.1$Sample[final0.1$Genotype=="d|JBCHY1-1-50|Q|273"]<-c("273dd_1","273dd_2")
final0.1$Sample[final0.1$Genotype=="a|KVEDG1-1-80|Q|273"]<-c("273da_1","273da_2")

#Mergining clean data with spec data with "Synthesis" dataframe.
final<-left_join(main,final0.1,by="Sample")

#Merging total leaf area of genotypes WITHOUT data on leaf pathogen or spec data with the final data frame.  
for(i in 1:length(NoPunch$Genotype)){
  focalTag<-NoPunch$Genotype[i]#Isolating focal genotype to be added in
  final$GM_TotalLeaf_Area[final$Tag==focalTag]<-NoPunch$GM_TotalLeaf_Area[i]#Adding in final body size. 
    final$GM_NumberOfLeaves[final$Tag==focalTag]<-NoPunch$GM_NumberOfLeaves[i]#Adding in final body size. 
}

#This dataframe contains genotypes for which we have leaf data on (pathogen abundance as well as leaf size), but for which there is no matching leaf data in the main dataframe. 
UnJoined<-anti_join(final0.1,main,by="Sample")


#I select that which are NA
Remainder<-final %>% filter(is.na(GM_TotalLeaf_Area),)

#Filtering out fertilizer and pools that went unmatched. 
Remainder<-Remainder[!grepl("SMITH1-3-80",Remainder$Tag,fixed=T)&
!grepl("KVEDG1-8-60",Remainder$Tag,fixed=T)&
  !grepl("MSMID1-2-0",Remainder$Tag,fixed=T)&
  !grepl("pool",Remainder$Tag,fixed=T),]


#These are those that do not have bodymass or pathogen data for
Remainder

#Did any of the UnPunched genotypes not get properly identified (are any in the remainder?)
Remainder %>% filter(Tag %in% NoPunch$Genotype)
#All genotypes from the Unpunched were properly identified. 

#These are the leaves which we we have bodymass and pathogen data for, but do not correspond to leaves in the final dataframe.
UnJoined

#This will determine if there are genotypes in the Remainder that have final body mass and pathogen data available, that we can add in. 


#Unmatched leaves that have genotypes in the remainder.
UnJoined %>% filter(Genotype %in% Remainder$Tag)

#Are there any genotypes for which we have no initial data on? 
UnJoined %>% filter(!Genotype %in% final$Tag) %>% select(Genotype)
#There are no genotypes that we have final measurements on that are not in the final data frame. This is good. 

####Good to Here##### 

#Determine which samples (leaf data) in the remainder do not have genotypes in the final data set.

#Remove remainder from the final data set in a new vector of Genotypes/Tags
AntiRemainder<-final %>% filter(!is.na(GM_TotalLeaf_Area))

#Which genotypes are we completely missing pathogen data and final body mass data on in the final data set? 
Remainder2<-Remainder %>% filter(!Tag %in% AntiRemainder$Tag)
#34/36 genotypes that are missing final measurements do not have any genotypes in the final data frame with final final measurements.

#These genotypes do have a leaf with pathogen data in the final data set. But more information could be obtained from them by taking the average. 
Remainder3<-Remainder %>% filter(Tag %in% AntiRemainder$Tag)

#Now I will replace those in the Remainder2 data frame with available data from the UnJoined2 data. Then i will merge them. 

#Averaging leaf pathogen data at the level of the genotype
UnJoined2<-UnJoined %>% group_by(Genotype) %>% summarize_if(~is.numeric(.), ~mean(.))

#Replacing data in remainer2 (i.e. genotypes which we have no pathogen or final information for) and adding in the average for the genotype. 
for(i in 1:length(UnJoined2$GM_TotalLeaf_Area)){
  FocalTag<-UnJoined2$Genotype[i]
  FocalWhiteF<-UnJoined2$WhiteFungDam[i]
  FocalBlackP<-UnJoined2$BlackPathDam[i]
  FocalThripsD<-UnJoined2$ThripsDam[i]
  FocalLA<-UnJoined2$GM_TotalLeaf_Area[i]
  FocalTLN<-UnJoined2$GM_NumberOfLeaves[i]
  #add in White Path Dam
  Remainder2[Remainder2$Tag==FocalTag,"WhiteFungDam"]<-FocalWhiteF
  #add in Black Path Dam
  Remainder2[Remainder2$Tag==FocalTag,"BlackPathDam"]<-FocalBlackP
  #add in Thrips Dam
  Remainder2[Remainder2$Tag==FocalTag,"ThripsDam"]<-FocalThripsD
  #add in total leaf area
  Remainder2[Remainder2$Tag==FocalTag,"GM_TotalLeaf_Area"]<-FocalLA
  #add in leaf number
  Remainder2[Remainder2$Tag==FocalTag,"GM_NumberOfLeaves"]<-FocalTLN
}
  #Checking to ensure that no genotypes without final measurements in remainder 2 have final measurements available.
Remainder2 %>% select(Tag,GM_TotalLeaf_Area) %>% filter(is.na(GM_TotalLeaf_Area)) %>% filter(Tag %in% tempSize$Genotype)

#Good, there are no genotypes left unaccountd for in the final analysis. 


#Now to add final measurements to remainder3. This data frame consists of leaf data for which there are other leaf data corresponding to this genotype, just not this leaf data available. 

UnJoined2 %>% filter(Genotype %in% Remainder3$Tag)

#There are two genotypes in the remainder which have only final body mass data, but data avalailable at the leaf level. These will be added in to remainder3 here.  

Remainder3[Remainder3$Tag=="b|CWRIC2-X2|Q|85",c("GM_TotalLeaf_Area","GM_NumberOfLeaves")]<-tempArea[tempArea$Genotype=="b|CWRIC2-X2|Q|85",c("GM_TotalLeaf_Area","GM_NumberOfLeaves")]

Remainder3[Remainder3$Tag=="c|SMITH1-20|Q|467",c("GM_TotalLeaf_Area","GM_NumberOfLeaves")]<-tempArea[tempArea$Genotype=="c|SMITH1-20|Q|467",c("GM_TotalLeaf_Area","GM_NumberOfLeaves")]


#Merging all three dataframes back together. 
final<-AntiRemainder %>% bind_rows(Remainder2) %>% bind_rows(Remainder3)
#There are a few observations lost here. These are those in the fertilizer experiment and pools are no longer in this dataframe. 

#Clarifying the names in the dataframe. 
colnames(final)[colnames(final)=="leaf_length"]<-"GM_Leaf_Len_Initial"
colnames(final)[colnames(final)=="true_leaves"]<-"GM_NumberOfLeaves_Initial"

#Writing csv
write.csv(final,"DataSynthesis.csv")
```




###File for *Growth Rate of Alliaria* 
```{r}
#This is integrated in GrowthRate_Analysis.rmd
```



##Insert Final Maple biomass and Data on the Control Maples - both initial and final measurements. 
```{r}
rm(list=ls())
library(dplyr)
#------------------------------
#Integrating initial maple control measurements.... initial values of maples in treatments are already in the data. 
#read in GH data
dat=read.csv("Data_Moities/Data_collection_GH.csv",stringsAsFactors = F)

#Fix column names
colnames(dat)[9:12]<-c("comp_number","maple_leaf_length_0","maple_height_0","maple_leaves_0")


#Removing first row (Which contains no data).
dat<-dat[2:length(dat$gh_bench),]

#Isolate maple controls 
dat<-dat[grepl("aple",dat$Tag),]

#Select relevant columns. 
CntrZero<-dat %>% select(Tag,treatment,maple_leaf_length_0,maple_height_0,maple_leaves_0)


#------------------------------
#Integrating final maple measurements, controls and in competition. 
MapDat<-read.csv("Data_Moities/Maple_data.txt",header=F,stringsAsFactors = F)

#Creating column names
colnames(MapDat)<-c("Nothing","Tag","Leaf","Length","Width","Damage","SampleTime","StemHeight")


#Replacing Characters in Tag Column. 
MapDat$Tag<-gsub("§","|",MapDat$Tag,perl = F)
MapDat$Tag<-gsub("_","?",MapDat$Tag,perl = F)



#Removing strings from numeric columns. 
MapDat$Length<-gsub("\\D","",MapDat$Length)
MapDat$Width<-gsub("\\D","",MapDat$Width)
MapDat$StemHeight<-gsub("\\D","",MapDat$StemHeight)
MapDat$Leaf<-gsub("\\D","",MapDat$Leaf)


#Fixing genotype labels. 
#DVGM-20|Q|117 has a genotype lable of "b" in the main synthesis file, but it is "c" here. I will change it in the final maple data file and take the main file as correct.
MapDat$Tag[MapDat$Tag=="c|DVGM-20|Q|117"]<-"b|DVGM-20|Q|117"
MapDat$Tag[MapDat$Tag=="b|WSSWM3-1-0|?"]<-"b|WSSWM3-1-0|?|?"



#Replacing Damage with a 1 for yes and 0 for no, so that i can take the mean. This will represent the percent of damaged leaves on the plant. 
MapDat$Damage[MapDat$Damage=="damage-n"]<-0
MapDat$Damage[MapDat$Damage=="damage-y"]<-1

#making columns numeric. 
class(MapDat[,3])<-"numeric"
class(MapDat[,4])<-"numeric"
class(MapDat[,5])<-"numeric"
class(MapDat[,6])<-"numeric"
class(MapDat[,8])<-"numeric"
class(MapDat[,2])<-"Factor"


#Making a leaf area column. 
MapDat$Area<-MapDat$Length*MapDat$Width

MapDat$Tag<-as.factor(MapDat$Tag)
#Summarizing data on the whole plant. 
MapFinal<-MapDat %>% group_by(Tag) %>% summarize(Maple_LeafNum_End = max(Leaf), Maple_Damage_End=mean(Damage), Maple_TotalLeafArea_End=sum(Area),Maple_StemHeight_End=mean(StemHeight))


#---------------------------
#Reading in the synthesis file to integrate these data. 
Synth<-read.csv("DataSynthesis.csv",stringsAsFactors = F)
Synth<-Synth %>% select(-X)


#--------------------------
#Integrating
#Integrating Controls into one dataframe.
ControlFinal<-left_join(CntrZero,MapFinal,by="Tag")

#Integrating final maple data into the original synthesis file, which lack maple controls. 
SynthFinal<-left_join(Synth,MapFinal,by="Tag")


 ControlFinal$maple_leaf_length_0<-as.numeric(ControlFinal$maple_leaf_length_0)
 ControlFinal$maple_height_0   <-as.numeric(    ControlFinal$maple_height_0)
 ControlFinal$maple_leaves_0  <-as.numeric( ControlFinal$maple_leaves_0 )

 #Merging maple control data with the master dataframe. 
Final<-bind_rows(ControlFinal,SynthFinal)

Final[!which(is.na(Final$Maple_StemHeight_End)),]

#Writing to file. 
write.csv(Final,"DataSynthesis.csv")

```

#Insert Germination date and germination treatment. 
```{r}
rm(list=ls())
#Read in germination data
dat<-read.csv("Data_Moities/clean_germination_data_2.csv",stringsAsFactors = F)
dat<-dat %>% select(-X.1,-X)

#Read in master data frame. 
master<-read.csv("DataSynthesis.csv",stringsAsFactors = F)
master <- master %>% select(-X)

#I was planning on using the date moved in the analysis, but i decided not to because it may not represent the date that the plant germinated, and because the same plate continued to germinate and was moved up to three times, making it not possible to identify the exact date that any given plant was moved into the growing chamber. For certain genotypes, i actually recorded the length of each hypocotyle that was moved. It is unfortunate to not use this data. 

#Selecting relevant columns. 
dat<-dat %>% select(Petri.Dish,GA3)

#Cleaning up the column GA3
dat$GA3[!grepl("y",dat$GA3)]<-"n"

#Merging the dataframes. 

master$GA3<-NA
for(i in 1:length(dat$Petri.Dish)){
  #finding all tags in the master data frame corresponding to the petri dish plate at i. 
 master$GA3[grepl(dat$Petri.Dish[i],master$Tag,fixed=T)]<-dat$GA3[i]
}

write.csv(master,"DataSynthesis.csv")


```


#Insert Genotype location (longitude and lattitude).
```{r}
rm(list=ls())

#Reading in data
popinfo<-read.csv("Data_Moities/S0_population_info.csv")
dat<-read.csv("DataSynthesis.csv")

#Assign family column
prefamily<-gsub("*.\\|","",dat$Tag)
dat$Family<-gsub("\\-.*","",prefamily)

#Correcting labels to match the population information data sheet
dat$Family[dat$Family=="JWBOY"]<-"JWBOY1"
dat$Family[dat$Family=="MAVELK"]<-"MAVELK1"
dat$Family[dat$Family=="VSGARO1"]<-"VSGAR01"
dat$Family[dat$Family=="CRSOSO"]<-"CRSORO"
dat$Family[dat$Family=="PDVRT1"]<-"PDRVT1"

#All but DSGAR were found and all were grown in yihans experiment. 

#PDVRT1 is the only one that is not in the file at all. 

#Which families are not identified? 
dat %>% filter(!Family %in% popinfo$Pop_Code) #%>% select("Family")


#Finding populations in my experiment
DatJoin<-popinfo %>% filter(Pop_Code %in% dat$Family) %>% select(Pop_Code,Region,Latitude,Longitude,Altitude,Pop_Size,RosDens,AdultDens)

#Joining information with the final data set
Final<-dat %>% left_join(DatJoin,by=c("Family"="Pop_Code"))

#Writting to file. 
write.csv(Final,"DataSynthesis.csv")


```

#Insert mortality data. 
```{r}
rm(list=ls())

field<-read.csv("Data_Moities/Bolt_Field_Data_May132020.csv",stringsAsFactors = F)

#Replacing NA's with "Dead"
field[is.na(field$GM_StemHeight_Bolt),c("Larg_Leaf_Len_Bolt","Larg_Leaf_Wid_Bolt","GM_StemHeight_Bolt","GM_Leaf_Number_Bolt")]<-"Dead"


#Reading in Dat
dat<-read.csv("DataSynthesis.csv",stringsAsFactors = F)
dat<-dat %>% select(-X.1,-X)

#Creating a collumn called ID to be identified. 
for(i in 1:length(dat$Tag)){
  ID<-tail(strsplit(dat$Tag[i],split="|",fixed=T)[[1]],n=1)
  dat$ID[i]<-ID
  if(dat$Family[i]=="maple"){
    dat$ID[i]<-dat$Tag[i]
  }
}

 
#Forseeing any issues of multiple joins
table(field$ID)[table(field$ID)>1] #There are many that were not IDed properly. I will need to determine which these are with reference to thier families. 

#Creating a vector of ID labels that are replicated in the field (in error)
Multi<-c("?","131", '160' ,'189', '273' , '28'  ,'31', '375' ,'464' )

#Looking at the discepencies and how to fix them.
dat %>% filter(ID %in% Multi) %>% select(ID,Family)

field %>% filter(ID %in% Multi) %>% select(ID,Family)
  

#First fix -> 160 is recorded in field data as both Jar and Smith. There should hav ebeen an i in front of smith. This will be fixed. .. 
dat %>% filter(ID == "i160") %>% select(ID,Family)

field[field$ID==160 & field$Family=="smi","ID"]<-"i160"

#Second fix -> 273 This is a known duplicate. That with family jbc is '273dd', that with kvedge is '273da'. This will be fixed. .. 
dat[grepl("273",dat$Sample),c("ID","Family")] 

field[field$ID==273 & field$Family=="jbc","ID"]<-"273dd"
field[field$ID==273 & field$Family=="kve","ID"]<-"273da"

dat[dat$ID==273 & dat$Family=="JBCHY1","ID"]<-"273dd"
dat[dat$ID==273 & dat$Family=="KVEDG1","ID"]<-"273da"

#Third fix -> 131 . This is recorded as both Mav and dvg. The Mav genotype was suppose to be i131.  This will be fixed. .. 
dat[grepl("131",dat$ID),c("ID","Family")]
field[field$ID==131 & field$Family=="mav","ID"]<-"i131"



#Fourth fix -> 375 . This is recorded as msm twice.. This is actually not a mistake as there are two msmid 375. There is no way for me to differentiate the genotypes but luckily they both died so it doesnt matterif they are mis identified. 
dat[grepl("375",dat$ID),]
field[field$ID==375,]

dat[grepl("375",dat$ID),"ID"]<-c("375a","375b")
field[field$ID==375,"ID"]<-c("375a","375b")


#Fifth fix -> 189 is recorded as jar and jbb. 189 is indeed JAr in the master file, however, jbb goes down as low as 194. There is a 198. I will check to see if the number has been reversed. 
field[grepl("198",field$ID),] #198 is not in the data frame. which means i will replace 189 with 198 in the field data to represent jbb. 

dat[grepl("189",dat$Tag),]
dat %>% filter(Family=="JBBLB2")

#Altering ID. 
field[field$ID==189 & field$Family=="jbb","ID"]<-198

#Sixth fix -> 31 is recorded as bwp and jwp. I need to determine which is going into which. The JWp genotype was replicated in the field measurements and can be deleted. 
field<-field[field$ID!="31"|field$Family!="jwp",]



#Seventh fix -> 28 is recorded as bwp and cwr. #The only ID listed as 28 in the data frame is bwp. 
dat[dat$ID==28,]
dat[dat$Family=="CWRIC2",]# The only CWR recorded in the master data file is 82. I will check to determine if that is in the field data and then i will alter it. 

field[field$ID==28 & field$Family=="cwr","ID"]<-82

#Seventh fix -> ?. There are two ? one for wss and one for jbc. this corresponds to the duplication in the master data file. I will fix this now. 
field[field$ID=="?",]
dat[dat$ID=="?",]

dat[dat$Tag=="e|JBCHY1-1-50|?","ID"]<-"?-JBC"
dat[dat$Tag=="b|WSSWM3-1-0|?|?","ID"]<-"?-WSS"

field[field$ID=="?"&field$Family=="wsswm3-1-3","ID"]<-"?-WSS"
field[field$ID=="?"&field$Family=="jbchy","ID"]<-"?-JBC"


#Eigth fix -> 464 There are two 464. one from smi and one from mhn. There exists 364 for mhn, but not 464. Becuase 464 does not exist in the field data, I will replace it.
field[field$ID=="464",]
field[field$ID=="364",]
dat[dat$Family=="MHNAT1",]

field[field$ID=="464"&field$Family=="mhn","ID"]<-"364"



#Checking again for errors 
table(field$ID)[table(field$ID)>1]
#There are no errors there. 





anti_join(field,dat,by="ID") #there are two genotypes that didnt make it in. vrp 250 and mav i310, which are both dead. 

#vrp250 is really vrp 520. This can be changed. 
field[field$ID==250,"ID"]<-"520"


#Joining data frames....Those that are not identified are considered to have died in the greenhouse experiment and were not brought out to the field. 
#Removing family column 
field <-field %>% select(-Family)
dat<-left_join(dat,field,by="ID") 


write.csv(dat,"DataSynthesis.csv")
```

#Adding growth Rate Data
Growth rate data were organised under "GrowthRate_Analysis.rmd".
```{r}
rm(list=ls())

#Reading in data
dat<-read.csv("DataSynthesis.csv",stringsAsFactors = F)
RGR<-read.csv("Data_Moities/RGR_Dat.csv",stringsAsFactors = F)

#Removing bad collumns
dat<-dat %>% select(-X)
RGR<-RGR %>% select(-X)

#Everything in the master file that didnt get joined
dat %>% anti_join(RGR,by=c("Tag"="Genotype"))
#8 genotypes are missing from the growth rate analysis. 

#Everything in the growthrate file that didnt get joined
RGR %>% anti_join(dat,by=c("Genotype"="Tag"))

#Modyfying two names. There are still missing genotypes for which i dont know why they are missing. 
RGR$Genotype[RGR$Genotype=="b|WSSWM3-1-0|?"]<-"b|WSSWM3-1-0|?|?"
RGR$Genotype[RGR$Genotype=="e|JBCHY1-1-50|Q|?"]<-"e|JBCHY1-1-50|?"

#Joining to master data frame. 
final<-dat %>% left_join(RGR,by=c("Tag"="Genotype"))

write.csv(final,"DataSynthesis.csv")
```






Integrating
###Adding in fern data for the maple controls

```{r}
#Clear Environment. 
rm(list=ls())
library(dplyr)


#Read in data
dat<-read.csv("Data_Moities/fern_cover.csv",stringsAsFactors = F)

final0.1<-read.csv("DataSynthesis.csv",stringsAsFactors = F)

#Modyfiyng tag to match final document. 
dat$Genotype<-gsub("\\","|",dat$Genotype,fixed=T)
dat$Genotype<-gsub("/","-",dat$Genotype,fixed=T)

#Modifying column names to match final document.
colnames(dat)[1]<-"Tag"

#Genotype "e|SMITH1-1-0|Q|i159" was entered twice into the fern datasheet. As there is no way to assign an identity, and fern data are ratically different (i.e. 1 vs 15). This will be treated as a NA unless evidence for an ID arises. 
dat[dat$Tag=="e|SMITH1-1-0|Q|i159",c("Moss.tf","Fern")]<-NA

#Removing the duplicate
dat<-dat[!duplicated(dat$Tag),]

#Generating dataframe without maple controls 
final0.2<-final0.1[!grepl("maple",final0.1$Tag),]


#Isolating maple values
final0.3<-final0.1[grepl("maple",final0.1$Tag),]

#Isolating fern values for maple controls 
fernVal<-dat[grepl("maple",dat$Tag),]

#Removing the fern collumn (which is blank) from the main data frame subset.
final0.3<-final0.3 %>% select(-Fern)

#Adding in the fern values 
MapleCntComplete<-fernVal %>% select(-Moss.tf) %>% left_join(final0.3,by="Tag") #%>% select(-X)


#Merging the data back with the original dataframe. 
final<-rbind(final0.2,MapleCntComplete)

final<-final %>% select(-X)

#Writting to file. 
write.csv(final,"DataSynthesis.csv")


```



```{r}
library(dplyr)
#Loading master file
dat<-read.csv("DataSynthesis.csv")

#Loading fitness data 
fec<-read.csv("Data_Moities/Fecundity.csv",stringsAsFactors = F)

#Maple indicates the plant is a maple, Together indicates the maple was with the GM competitor, BigBag represents the bag that was used, y = big bag, n=other relevant bag. 

#Remove NA. 
fec<-fec[!is.na(fec$Together),]

#Change the symbols to be correct. 
#Replacing Characters in Tag Column. 
fec$Tag<-gsub("§","|",fec$Tag,perl = F)
fec$Tag<-gsub("_","?",fec$Tag,perl = F)
fec$Tag<-gsub("/","-",fec$Tag,perl = F)
fec
#Changing BigBag column to be reflective of the bag used. 

#Maple bags are denoted by no big bag and yes maple
fec$BigBag[fec$BigBag=="n"&fec$Maple=="y"]<-"MapleBag"

#Regular GM bags are denoted by no big bag and no maple
fec$BigBag[fec$BigBag=="n"&fec$Maple=="n"]<-"RegGM"

#big bags are denoted by y
fec$BigBag[fec$BigBag=="y"]<-"BigGM"

#Subtracting weight of the bag from the total weight of the plant + bag
#Maples
fec$Mass[fec$BigBag=="MapleBag"]<-fec$Mass[fec$BigBag=="MapleBag"]-5.74

#BigBag
fec$Mass[fec$BigBag=="BigGM"]<-fec$Mass[fec$BigBag=="BigGM"]-14.14

#Regular Bag
fec$Mass[fec$BigBag=="RegGM"]<-fec$Mass[fec$BigBag=="RegGM"]-8.57

hist(fec$Mass[fec$Maple=="y"],breaks=20)

hist(fec$Mass[fec$Maple=="n"],breaks=20)

#Eliminating unneccesairy columns

fec<-fec %>% select(Tag,Mass,Maple)

#Convert data to longer form. 
library(tidyr)
fec<-fec %>% pivot_wider(id_cols=Tag,names_from = Maple,values_from = Mass)

#Renaming columns to be correct. 
colnames(fec)<-c("Tag","MapleFinalMass","GM_Fecundity")

#Merging data frame with master file. 

#Random corrections to labels. 
fec$Tag[fec$Tag=="c|DVGM-20|Q|117"]<-"b|DVGM-20|Q|117"
fec$Tag[fec$Tag=="b|WSSWM3-1-0|?"]<-"b|WSSWM3-1-0|?|?"


dat<-dat %>% left_join(fec)

write.csv(dat,"DataSynthesis.csv")


```

























