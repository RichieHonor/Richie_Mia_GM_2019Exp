---
title: "Growth Rate Analysis"
output: html_notebook
---

This document is to compile the various growth rate measurements I have taken, along with initial and final manual measurements of body mass, gibberrelic acid, fern, pathogen damage. This document is also to analyse the data once it has been compiled. 

###File for *initial size of GM and Maples, greenhouse location, treatment and competition number*: **"Data_collection_GH.csv"**. In R/masters_thesis

###File for *germination transplant date, and gibberelic acid treatment*. **clean_germination_data_2.csv**. In R/masters_thesis.

###File for *final manual measurement of maple size* **Maple_data.txt**. in Python/Raw_Data.

###File for *final manual measurement of Alliaria leaf size* **Leaf_data.txt**. in Python/Final_GM_Data_CompetitionExp.

###File for *Growth Rate of Alliaria* **All_photo_data.txt**. in Python/python_pics_analysis.

*Done*
###File for *fern abundance and moss presence* **fern_cover.txt**. in Raw_Data. 

Note for analysis: 
only record as dead if I have the barcode, because some lost the barcode but did not die. Also, ferns were recorded for only one genotype if they were in the competition treatment, but it applied to both plants in the compeition treatment. 

###File for *Pathogen damage* **NOT YET MADE**.

*Done*
###File for *Glocosinolate,Flavonoid and Chlorophyll content* **All_UV_Data.txt**. in masters_thesis/UVSpec

--------------------
--Goal of Analysis is to combine the documents into one master document that can be used to look at the data while considering all variables. 


#Incorporate Data_collection_GH_0.csv (treatment, ID, etc.) with Glucosinolate, Flavonoid and chlorophyll data (All_UV_Data.txt).
```{r}
library(dplyr)

#-------------------------------------------------------------------
#----------GH Data Prep
#-------------------------------------------------------------------

#read in GH data
dat=read.csv("Data_Moities/Data_collection_GH.csv",stringsAsFactors = F)

#Fix column names
colnames(dat)[9:12]<-c("comp_number","maple_leaf_length_0","maple_height_0","maple_leaves_0")

#Removing first row (Which contains no data).
dat<-dat[2:length(dat$gh_bench),]

#Remove maple controls (for now) This is because the strsplit is mis identifying the maple controls for garlic mustard data. I will have to fix this later.
dat<-dat[!grepl("aple",dat$Tag),]


```


```{r}
#####
#Spec data prep--------------------------------------

#Importing functions created to clean up the UV spec data.
source("../UVSpecProcessingModule.R")

##-----------------------------------

#Seperate spec data into Chlorophyll a and b
ChlorAB<-CleanData("../UVSpec/All_UV_Data.txt")[[2]]

#.... and Glucosinolate and flavonoid data
GF<-CleanData("../UVSpec/All_UV_Data.txt")[[1]]


###-----------------------------------------------------------------
#Sample Identification!
####----------------------------------------------------------------

#Using the Tag (fill ID) from the greenhouse data, assign a Tag to the ID numbers in the spec data.

#Glucosinolates and flavonoids.
for(i in 1:length(GF$Sample)){
  ID<-strsplit(GF$Sample[i],"_")[[1]][1]
  #Ensure the lable is surrounded by symbols, not numbers to ensure no faulty matches ... ex |4 cound be in |48, but not |4| in |48|
  ID<-paste("|",ID,"|",sep = "")
  GF$ID[i]<-ID
  count=0
  for(j in 1:length(dat$Tag)){
    #Modify tag locally to avoid mis matches. 
    locTag<-paste(dat$Tag[j],"|",sep="")
    if(grepl(ID,locTag,fixed=T)){
      GF$Tag[i]<-dat$Tag[j]
      count=count+1
    }
  }
  
  #Pool samples will be assigned a tag of simply "pool" and an ID of pool and date. 
  if (count==0){
    GF$Tag[i]<-GF$Sample[i]
    GF$Sample[i]<-paste(GF$Sample[i],GF$DataFile[i],sep="-")
  }
}


#Chlorophyll Samples
for(i in 1:length(ChlorAB$Sample)){
  ID<-strsplit(ChlorAB$Sample[i],"_")[[1]][1]
  ID<-paste("|",ID,"|",sep = "")
  ChlorAB$ID[i]<-ID
  count=0
  for(j in 1:length(dat$Tag)){
    locTag<-paste(dat$Tag[j],"|",sep="")
    if(grepl(ID,locTag,fixed=T)){
      ChlorAB$Tag[i]<-dat$Tag[j]
      count=count+1
    }
  }
   #Pool samples will be assigned a tag of simply "pool" and an ID of pool and date.  
  if (count==0){
    ChlorAB$Tag[i]<-ChlorAB$Sample[i]
    ChlorAB$Sample[i]<-paste(ChlorAB$Sample[i],ChlorAB$DataFile[i],sep="-")
  }
}

#-----------------------------------------
#Seperate GF into glucosinolate and flavonoid dataframes,these will be joined in a wide format. 

#Glucosinolate
gluc<-GF[GF$Compound=="gluc",]

#Flavonoid
flav<-GF[GF$Compound=="flav",]

#Making glucosinolate specific column names
colnames(gluc)<-paste("gluc",colnames(gluc),sep="_")

#Making flavonoid specific column names
colnames(flav)<-paste("flav",colnames(flav),sep="_")

#Removing controls from chlorophyll
ChlorNoCont<-ChlorAB[ChlorAB$ID!="|cont|",]

####-----------------------------------------------------
#Removing Duplicates and checking for errors. 
####-----------------------------------------------------

#Some caution should be advised. Ensure the sample 254_1	is still in the Final data frame All_Wide, this could occur if the standard deviaiton of the samples was attempted to be integrated into this workflow where, sd() cannot take the sd of one number, but mean can so it is okay.


#Checking for duplicated samples (not technical replicates-two samples with the same name)... 
print("These are the duplicates that we know about: 142_2,441_1,i136_1, there should be no others besides the pool below and the glucosinolate flavonoid and chlorophyll dataframes should have the same amount of erroneous duplicates (i.e. 4 technical replicates):")
table(gluc$gluc_Sample)[table(gluc$gluc_Sample)>2 ]       
table(ChlorNoCont$Sample)[table(ChlorNoCont$Sample)>2 ]    
table(flav$flav_Sample)[table(flav$flav_Sample)>2 ]       

#Averaging duplicates (i.e. technical replicates) 
print("Averaging duplicates and exceptions..")

#gluc
Average_gluc<-gluc %>% group_by(gluc_Sample) %>% summarize_at(vars(gluc_Conc), .funs=mean)

#flav
Average_flav<-flav %>% group_by(flav_Sample) %>% summarize_at(.vars = vars(flav_Conc),.funs=mean)

#ChlorNoCont
Average_ChlorNoCont<-ChlorNoCont %>% group_by(Sample) %>% summarize_at(.vars=vars(ChlorA,ChlorB),.funs=mean)

#-----
#Add in missing columns

#Remove (not summarize duplicates)
Col_Merger0.1<-ChlorNoCont[!duplicated(ChlorNoCont$Sample),]
#Select relevant columns
Col_Merger<-Col_Merger0.1 %>% select(Sample,Tag,DataFile)

#Check to ensure that the merge went okay and no values were lost. 
if(length(Col_Merger$Sample)!=length(Average_ChlorNoCont$Sample)){
  stop("Columns mismatch in the merge of chlorophyll factor columns with chlorophyll data columns.")
}

#Merging dataframs.
Average_ChlorNoCont2<-left_join(Average_ChlorNoCont,Col_Merger,by="Sample")

#------
#Merge all three dataframes into a wide format. 
All_Wide0.1<-left_join(Average_ChlorNoCont2,Average_gluc,by=c("Sample"="gluc_Sample"))
All_Wide<-left_join(All_Wide0.1,Average_flav,by=c("Sample"="flav_Sample"))

#Check to ensure it was done correctly: 
if(length(All_Wide$Sample)!=length(Average_ChlorNoCont$Sample) |length(All_Wide$Sample)!=length(Average_gluc$gluc_Sample)
|length(All_Wide$Sample)!=length(Average_flav$flav_Sample)){

  stop("gluc, flav and chlorophyll samples did not match upafter duplicates were averaged.")
}

#-------------------------------------------------------------------
#--------Taking care of mismatching Tag/ID!!!!
#-------------------------------------------------------------------

#a273_2_dupl is a|KVEDG1-1-80|Q|273 and shares a number with d|JBCHY1-1-50|Q|273. BEcause of the a identifier, i am assiging this plant to a|KVEDG1-1-80|Q|273. "da" stands for duplicate A

#Leaf one
All_Wide$Tag[All_Wide$Tag=="a273_1"]<-"a|KVEDG1-1-80|Q|273"
All_Wide$Sample[All_Wide$Sample=="a273_1-Dat_Jan_17_2020_PM.txt"]<-"273da_1"

#Leaf two 
All_Wide$Tag[All_Wide$Tag=="a273_2_dupl"]<-"a|KVEDG1-1-80|Q|273"
All_Wide$Sample[All_Wide$Sample=="a273_2_dupl-Dat_Dec_6_2019.txt"]<-"273da_2"




#d273_JBCHY_1_dup is the second duplicate from above. It will be changed to d|JBCHY1-1-50|Q|273 "dd" stand for duplicate "d". - this is because of the germination treatment.

#Leaf 1
All_Wide$Tag[All_Wide$Tag=="d273_JBCHY_1_dup"]<-"d|JBCHY1-1-50|Q|273"
All_Wide$Sample[All_Wide$Sample=="d273_JBCHY_1_dup-Dat_Dec_9_2019.txt"]<-"273dd_1"

#Leaf 2
All_Wide$Tag[All_Wide$Tag=="d273_Jbchy_2"]<-"d|JBCHY1-1-50|Q|273"
All_Wide$Sample[All_Wide$Sample=="d273_Jbchy_2-Dat_Jan_17_2020_PM.txt"]<-"273dd_2"

#b?wsswm3-1-0_2 is unknown because we did not record the number. It is being removed from the analysis unless evidence is found to indicate the treatment. 
All_Wide<-All_Wide[!All_Wide$Tag=="b?wsswm3-1-0_2",]
All_Wide<-All_Wide[!All_Wide$Tag=="b?wsswm3-1-0_dup",]


#Sample 381 is listed as G381, which is why it was not identified, i will change it to be appropriate

All_Wide[All_Wide$Sample=="381_1-Dat_Jan_21_2020_AM.txt",]<-"381_1"

All_Wide[All_Wide$Tag=="381_1",]<-"c|MSMID1-1-20|G381"


```

Final Merging of clean greenhouse data and clean UV data with duplicates averaged. 
```{r}
#This left join will keep all individuals that we have glucosinolate and flavonoid data on. 
Final<-left_join(All_Wide,dat,by="Tag")

Final<-Final %>% select(-new._code_needed.,-Helper.date)

#Check for those that did not get properly identified. 
Final[is.na(Final$gh_bench)&Final$Tag!="pool",]

#table(Final$Sample)[table(Final$Sample)>1]
write.csv(Final,"DataSynthesis.csv")



```


Notes:
NA's are pools

Likely need to normalize gluc and flav data by chlorophyll content, a less effective work around may be to distinguish leaf number. 

The two earliest sampling dates (i.e. ) need to be adjusted to account for higher pool values. 

Remove pseudoreplication (i.e. cant have duplicates in there)

-Appears like the alone treatment has most chlorophyll, followed by maple, then GM. 











Integrating
###File for *fern abundance and moss presence* **fern_cover.csv**. in Raw_Data.

```{r}
#Clear Environment. 
rm(list=ls())

library(dplyr)


#Read in data
dat<-read.csv("Data_Moities/fern_cover.csv",stringsAsFactors = F)

#dat<-dat[!grepl("aple",),]
final0.1<-read.csv("DataSynthesis.csv",stringsAsFactors = F)

#Modyfiyng tag to match final document. 
dat$Genotype<-gsub("\\","|",dat$Genotype,fixed=T)
dat$Genotype<-gsub("/","-",dat$Genotype,fixed=T)

#Modifying column names to match final document.
colnames(dat)[1]<-"Tag"

#Genotype "e|SMITH1-1-0|Q|i159" was entered twice into the fern datasheet. As there is no way to assign an identity, and fern data are ratically different (i.e. 1 vs 15). This will be treated as a NA unless evidence for an ID arises. 

dat[dat$Tag=="e|SMITH1-1-0|Q|i159",c("Moss.tf","Fern")]<-NA
dat[dat$Tag=="e|SMITH1-1-0|Q|i159",c("Moss.tf","Fern")]

#Removing the duplicate
dat<-dat[!duplicated(dat$Tag),]

#Joining
final<-left_join(final0.1,dat,by="Tag")


#Those that we did not enter must be made to zero for both. 
for(i in 1:length(final$Fern)){
  if(is.na(final$Fern[i])){
    final$Moss.tf[i]<-"n"
    final$Fern[i]<-0
  }
  else next
}

if(colnames(final)[1]=="X"){
  final<-select(final,-X)
}
final
write.csv(final,"DataSynthesis.csv")



```


Removing Runs from dec 8 and 9. After looking at the data, It now appears way too far off from the rest of the samples, and thus needs to be removed. 
```{r}
rm(list=ls())
library(dplyr)
dat<-read.csv("DataSynthesis.csv")
dat<-dat[dat$DataFile!="Dat_Dec_6_2019.txt"&dat$DataFile!="Dat_Dec_8_2019.txt",]

dat<-dat %>% select(Sample:Fern)

write.csv(dat,"DataSynthesis.csv")



```






###File for *final manual measurement of Alliaria leaf size* **Leaf_data.txt**. in Python/Final_GM_Data_CompetitionExp.
```{r}
#This file contains the length and width of every leaf in the competition treatment that did not have a whole punch. This data has a complementary set of photos of each leaf that was holepunched, along with the length and width of each holepunched leaf. This, together, can be used to determine how leaf size affects secondary compound production, but can also be amalgamated into a final biomass measurement. 


#Clear Environment. 
rm(list=ls())
dat<-read.csv("Data_Moities/Gm_Final_Leaf_data.txt",header = F)

table(dat$V2)

```









