---
title: "Plasticity_Analysis2.0"
author: "Richard Honor"
date: "04/06/2020"
output: html_document
---
#Read in and prep data
```{r}
library(ggplot2)
#library(lme4)
library(glmmTMB)
#library(tidyr)
library(cowplot)
library(grid)
library(gridExtra)
library(dplyr)
source("GGPlot_Themes.R")

#read in data
rm(list=ls())
dat<-read.csv("DataSynthesis.csv")

#Remove maple controls data from the data set.
dat<-dat %>% filter(treatment!="mcnt") %>% droplevels()

#remove those with fertilizer treatment, and extra genotypes that are only in the alone treatment. 
dat<-dat[!grepl("i",dat$Sample,fixed=T),]

#Initializing columns to avoid constant error messages. 
dat$WhiteFungLogis<-NA
dat$BlackFungLogis<-NA
```


#Generating data frames with summarized leaf data (dat2) and summarized genotype data (dat3)
```{r}
hist(dat$gluc_Conc)
hist(dat$flav_Conc)
#Both concentrations are above zero. 
min(dat$gluc_Conc,na.rm=T)
min(dat$flav_Conc,na.rm=T)


#Logging data
dat$Fern<-log(dat$Fern+1)
dat$gluc_Conc<-log(dat$gluc_Conc)
dat$flav_Conc<-log(dat$flav_Conc)
dat$ChlorA<-log(dat$ChlorA)
dat$ThripsDam<-log(dat$ThripsDam+1)
dat$BlackPathDam<-log(dat$BlackPathDam+1)
dat$Fern<-log(dat$Fern+1)



#Creating leaf area vector 
dat$GM_Leaf_Area<-dat$GM_Leaf_Len*dat$GM_Leaf_Wid


#Summarizing: Taking the mean value of leaves. This tibble contains data at the level of the plant means. 
dat2<-dat %>% group_by(Tag) %>% summarize(ChlorA=mean(ChlorA),ChlorB=mean(ChlorB),gluc_Conc=mean(gluc_Conc),flav_Conc=mean(flav_Conc),Family=first(Family),treatment=first(treatment),gh_row=first(gh_row),gh_bench=first(gh_bench),GM_TotalLeaf_Area=first(GM_TotalLeaf_Area),comp_number=first(comp_number),ThripsDam=mean(ThripsDam),WhiteFungDam=mean(WhiteFungDam),BlackPathDam=mean(BlackPathDam),Fern=mean(Fern),gh_col=first(gh_col),GM_Leaf_Area=mean(GM_Leaf_Area),Latitude=first(Latitude),Longitude=first(Longitude),Altitude=first(Altitude), RGR1=first(RGR1),GM_Leaf_Len_Initial=first(GM_Leaf_Len_Initial),
                                          GM_Fecundity=first(GM_Fecundity),
MapleFinalMass=first(MapleFinalMass),
GM_StemHeight_Bolt=first(GM_StemHeight_Bolt),
Maple_Died=first(Maple_Died))


#All of these genotypes died (15 Genotypes).(We are simply missing a final measurement for e|JBCHY1-1-50|Q|240) That is only 3% Mortality. 
dead<-dat2[is.na(dat2$GM_TotalLeaf_Area),]

#Removing those with dead competitors from the garlic mustard treatment. ("e|JBCHY1-1-50|Q|240") did not die, we are simply missing the final measurement for it.

dead_competitors<-dead %>% filter(treatment=="gm",Tag!="e|JBCHY1-1-50|Q|240") %>% select(comp_number)

#Removing those with dead competitors from the analysis. 
dat2<-dat2 %>% filter(!comp_number %in% dead_competitors$comp_number)
dat<-dat %>% filter(!comp_number %in% dead_competitors$comp_number)


##Summarizing: Taking the mean value of plants. This tibble contains data at the level of the family means within each treatment. 
#dat3<-dat2 %>% drop_na(GM_TotalLeaf_Area) %>% group_by(Family,treatment)  %>% summarize_if(is.numeric,mean)



#Because of how zero inflated white pathogen damage is, i will use a logistic regression to model it.
dat2$WhiteFungLogis<-NA
dat2$WhiteFungLogis[dat2$WhiteFungDam==0]<-0
dat2$WhiteFungLogis[dat2$WhiteFungDam>0]<-1


  #Function to standardize variables. 
Standardize<-function(x){
  standard<-(x-mean(x,na.rm=T))/sd(x,na.rm=T)
}

#Standardizing leaf area. 
dat2$GM_Leaf_Area<-Standardize(dat2$GM_Leaf_Area)

#Function to extract random effect heritabilities from a glmmTMB model. 
Xtract<-function(x,Resi){
  temp<-VarCorr(x)
GXE=temp$cond$`Family:treatment`[[1]]
E=temp$cond$treatment[[1]]
G=temp$cond$Family[[1]]

G_by_E<-GXE/(GXE+E+G+Resi)
Envir<-E/(GXE+E+G+Resi)
Genet<-G/(GXE+E+G+Resi)
data.frame(Type=c("GXE","E","G"),Value=c(G_by_E,Envir,Genet)*100)
}

#Function to extract residuals from models. 
resiCalc<-function(formula, ...){
  
  #Extracting residuals
fit<-lm(formula, ...)

Residual<-as.data.frame(resid(fit))

resi<-tibble::rownames_to_column(Residual, "Pos")

#Extracting the length of the data frame. 
resi[,1]<-as.numeric(resi[,1])
a<-max(resi[,1])

#Adding in NA values where there are none. ...

#Creating NA data frame 
blankDF<-data.frame(Pos=seq(1:a),blank=NA)
#Joining NA data frame to create new rows with NA where data is missing. 
newDF<-left_join(blankDF,resi,by="Pos") %>% select(-blank)

return(Standardize(newDF[,2]))
}



#Creating Survival Data.1 = survived, 0= dead.
dat2$Bolt_Survival[dat2$GM_StemHeight_Bolt=="Dead"]<-0
dat2$Bolt_Survival[dat2$GM_StemHeight_Bolt!="Dead"]<-1


#Creating Maple Survival Data.1 = survived, 0= dead.
dat2$Maple_Died<-as.character(dat2$Maple_Died)
dat2$Maple_Survival[dat2$Maple_Died!="Y"]<-1
dat2$Maple_Survival[dat2$Maple_Died=="Y"]<-0
dat2<-dat2 %>% select(-Maple_Died)
```


#Cluster analysis. ... doesnt look great.
```{r}

#Generating pca with values that are controlled for (gh bench, leaf area, initial size... etc. )
pcaAll<-prcomp(~resiCalc(gluc_Conc~GM_Leaf_Area+gh_bench,data=dat2)+
                 resiCalc(ChlorA~GM_Leaf_Area+gh_bench,data=dat2)+
                 resiCalc(GM_TotalLeaf_Area~gh_bench,data=dat2)+
               resiCalc(RGR1~gh_bench+GM_Leaf_Len_Initial,data=dat2)+
                 resiCalc(flav_Conc~GM_Leaf_Area+gh_bench,data=dat2)
               ,na.action=na.omit)


pcaAll
summary(pcaAll)

#Generating data
prediction<-as.data.frame(predict(pcaAll))

df<-tibble::rownames_to_column(prediction, "rownumber")

dat2[df$rownumber,"PC1All"]<-df$PC1
dat2[df$rownumber,"PC2All"]<-df$PC2

ggplot(dat2)+
  geom_point(aes(y=PC1All,x=PC2All,color=treatment))

#Even with accounting for gh bench and initial size, and leaf size, the clusters are not very distinct.   



```






#Generating pc1 pc2 values. 
```{r}
pcaGlucCor<-prcomp(~Standardize(gluc_Conc)+Standardize(ChlorA),data=dat2,na.action=na.omit)

prediction<-as.data.frame(predict(pcaGlucCor))

df<-tibble::rownames_to_column(prediction, "rownumber")

biplot(pcaGlucCor)
pcaGlucCor
summary(pcaGlucCor)
dat2[df$rownumber,"PC1GC"]<-df$PC1
dat2[df$rownumber,"PC2GC"]<-df$PC2

#Trying a pca with all three variables. 
pcaGlucCorFlav<-prcomp(~Standardize(gluc_Conc)+Standardize(ChlorA)+Standardize(flav_Conc),data=dat2,na.action=na.omit)
biplot(pcaGlucCorFlav)
pcaGlucCorFlav
summary(pcaGlucCorFlav)
pcaGlucCorFlav

pcaCorFlav<-prcomp(~Standardize(ChlorA)+Standardize(flav_Conc),data=dat2,na.action=na.omit)
biplot(pcaCorFlav)
summary(pcaCorFlav)
pcaCorFlav
prediction2<-as.data.frame(predict(pcaCorFlav))


df2<-tibble::rownames_to_column(prediction2, "rownumber")
dat2[df2$rownumber,"PC1FC"]<-df2$PC1
dat2[df2$rownumber,"PC2FC"]<-df2$PC2

```

#I dont think another pca is the way to go. 
```{r}
pcaAll<-prcomp(~Standardize(gluc_Conc)+Standardize(ChlorA)+(Standardize(RGR1)+Standardize(GM_TotalLeaf_Area)+Standardize(flav_Conc)),data=dat2,na.action=na.omit)
summary(pcaAll)
biplot(pcaAll)
pcaAll
```

#Fitness variance partition analysis
```{r}
#Fecundity
fit<-glmmTMB(GM_Fecundity~as.factor(gh_bench)+(1|treatment/Family)+(1|Family),data=dat2)
summary(fit)
#Is there an effect of GXE? 
fit2<-glmmTMB(GM_Fecundity~as.factor(gh_bench)+(1|treatment)+(1|Family),data=dat2)
anova(fit,fit2)#No.

#Is there an effect of family? 
fit3<-glmmTMB(GM_Fecundity~as.factor(gh_bench)+(1|treatment),data=dat2)
anova(fit2,fit3)#No. 

#Is there an effect of treatment? 
fit4<-glmmTMB(GM_Fecundity~as.factor(gh_bench)+(1|Family),data=dat2)
anova(fit2,fit4)#Yes. 

summary(fit)
Xtract(fit,5.492e+00) #Large effect of treatment on the values fecundity. 


#Survival 
#some genotypes that were recorded as dead actually grew again from the root to produce a bolt and seeds. I am replacing these with a 1 to designate that they are alive. 
dat2$Bolt_Survival[dat2$GM_StemHeight_Bolt=="Dead"&!is.na(dat2$GM_Fecundity)]<-1


#Conducting analysis on Survival
fit<-glmmTMB(Bolt_Survival~as.factor(gh_bench)+(1|treatment/Family)+(1|Family),data=dat2,family="binomial")
summary(fit)
#Is there an effect of GXE? 
fit2<-glmmTMB(Bolt_Survival~as.factor(gh_bench)+(1|treatment)+(1|Family),data=dat2,family="binomial")
anova(fit,fit2)#No.

#Is there an effect of family? 
fit3<-glmmTMB(Bolt_Survival~as.factor(gh_bench)+(1|treatment),data=dat2,family="binomial")
anova(fit2,fit3)#Yes, very strong effect. 

#Is there an effect of treatment? 
fit4<-glmmTMB(Bolt_Survival~as.factor(gh_bench)+(1|Family),data=dat2,family="binomial")
anova(fit2,fit4)#No, Not at all. 

summary(fit)
Xtract(fit,pi^2/3) #Large effect of treatment on the values fecundity. 
df.residual(fit)
pi^2/3
```



#Gluc Flav variance partition analysis
```{r}
#Glucosinolate
fit<-glmmTMB(gluc_Conc~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment/Family)+(1|Family),data=dat2)
summary(fit)
#Is there an effect of GXE? 
fit2<-glmmTMB(gluc_Conc~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment)+(1|Family),data=dat2)
anova(fit,fit2)#No.

#Is there an effect of family? 
fit3<-glmmTMB(gluc_Conc~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment),data=dat2)
anova(fit2,fit3)#Yes. 

#Is there an effect of treatment? 
fit4<-glmmTMB(gluc_Conc~GM_Leaf_Area+as.factor(gh_bench)+(1|Family),data=dat2)
anova(fit2,fit4)#Yes. 

summary(fit)
Xtract(fit,0.067131)



##Flavonoids...
fit<-glmmTMB(flav_Conc~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment/Family)+(1|Family),data=dat2)
summary(fit)
#Is there an effect of GXE? 
fit2<-glmmTMB(flav_Conc~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment)+(1|Family),data=dat2)
anova(fit,fit2)#No.

#Is there an effect of family? 
fit3<-glmmTMB(flav_Conc~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment),data=dat2)
anova(fit2,fit3)#No. 

#Is there an effect of treatment? 
fit4<-glmmTMB(flav_Conc~GM_Leaf_Area+as.factor(gh_bench)+(1|Family),data=dat2)
anova(fit2,fit4)#Yes. 

summary(fit)
Xtract(fit,7.751e-02)


```

#Total leaf area RGR and Chlor A
```{r}
#Total leaf area. 
fit<-glmmTMB(Standardize(GM_TotalLeaf_Area)~Standardize(BlackPathDam)+as.factor(gh_bench)+(1|treatment/Family)+(1|Family),data=dat2)
summary(fit)

#Is there an effect of GXE? 
fit2<-glmmTMB(Standardize(GM_TotalLeaf_Area)~Standardize(BlackPathDam)+as.factor(gh_bench)+(1|treatment)+(1|Family),data=dat2)
anova(fit,fit2)#No.

#Is there an effect of family? 
fit3<-glmmTMB(Standardize(GM_TotalLeaf_Area)~Standardize(BlackPathDam)+as.factor(gh_bench)+(1|treatment),data=dat2)
anova(fit2,fit3)#Yes. 

#Is there an effect of treatment? 
fit4<-glmmTMB(Standardize(GM_TotalLeaf_Area)~Standardize(BlackPathDam)+as.factor(gh_bench)+(1|Family),data=dat2)
anova(fit2,fit4)#Yes. 

summary(fit)
Xtract(fit,0.39888)

dat2$GM_Leaf_Len_Initial

##Relative growth rate. 
fit<-glmmTMB(Standardize(RGR1)~as.factor(gh_bench)+GM_Leaf_Len_Initial+(1|treatment/Family)+(1|Family),data=dat2)
summary(fit)
#Is there an effect of GXE? 
fit2<-glmmTMB(Standardize(RGR1)~as.factor(gh_bench)+GM_Leaf_Len_Initial+(1|treatment)+(1|Family),data=dat2)
anova(fit,fit2)#No.

#Is there an effect of family? 
fit3<-glmmTMB(Standardize(RGR1)~as.factor(gh_bench)+GM_Leaf_Len_Initial+(1|treatment),data=dat2)
anova(fit2,fit3)#No. 

#Is there an effect of treatment? 
fit4<-glmmTMB(Standardize(RGR1)~as.factor(gh_bench)+GM_Leaf_Len_Initial+(1|Family),data=dat2)
anova(fit2,fit4)#Yes. 

summary(fit)
Xtract(fit,5.626e-01)

##Chlor A
fit<-glmmTMB(Standardize(ChlorA)~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment/Family)+(1|Family),data=dat2)
summary(fit)
#Is there an effect of GXE? 
fit2<-glmmTMB(Standardize(ChlorA)~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment)+(1|Family),data=dat2)
anova(fit,fit2)#No.

#Is there an effect of family? 
fit3<-glmmTMB(Standardize(ChlorA)~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment),data=dat2)
anova(fit2,fit3)#No. 

#Is there an effect of treatment? 
fit4<-glmmTMB(Standardize(ChlorA)~GM_Leaf_Area+as.factor(gh_bench)+(1|Family),data=dat2)
anova(fit2,fit4)#Yes. 

summary(fit)
Xtract(fit,8.592e-01)



```



#Principle component glucosinolate and chlorophyll. 
```{r}
#PC1
fit<-glmmTMB(PC1GC~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment/Family)+(1|Family),data=dat2)
summary(fit)
#Is there an effect of GXE? 
fit2<-glmmTMB(PC1GC~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment)+(1|Family),data=dat2)
anova(fit,fit2)#No.

#Is there an effect of family? 
fit3<-glmmTMB(PC1GC~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment),data=dat2)
summary(fit3)
anova(fit2,fit3)#No... not when assessing in this model. 

#Is there an effect of treatment? 
fit4<-glmmTMB(PC1GC~GM_Leaf_Area+as.factor(gh_bench)+(1|Family),data=dat2)
anova(fit2,fit4)#Yes. 

summary(fit)
Xtract(fit,1.38577) #Extremely high environmental effect fot PC1


#PC2
fit<-glmmTMB(PC2GC~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment/Family)+(1|Family),data=dat2)
summary(fit)
#Is there an effect of GXE? 
fit2<-glmmTMB(PC2GC~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment)+(1|Family),data=dat2)
anova(fit,fit2)#No.

#Is there an effect of family? 
fit3<-glmmTMB(PC2GC~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment),data=dat2)
anova(fit2,fit3)#YEs.... extremely high as well. 

#Is there an effect of treatment? 
fit4<-glmmTMB(PC2GC~GM_Leaf_Area+as.factor(gh_bench)+(1|Family),data=dat2)
anova(fit2,fit4)#Not at all. 

summary(fit)
Xtract(fit,2.538e-01) #Extremely high Genetic effect fot PC2
#Very interesting. 
```
#fit<-glmmTMB(gluc_Conc~1+(name|treatment/Family)+(name|Family),data=dat2)
for gmatrix model 


#G,GXE and E for flav pc
```{r}
library(glmmTMB)
#PC1
fit<-glmmTMB(PC1FC~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment/Family)+(1|Family),data=dat2)
summary(fit)
#Is there an effect of GXE? 
fit2<-glmmTMB(PC1FC~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment)+(1|Family),data=dat2)
anova(fit,fit2)#No.

#Is there an effect of family? 
fit3<-glmmTMB(PC1FC~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment),data=dat2)
anova(fit2,fit3)#No... not when assessing in this model. 

#Is there an effect of treatment? 
fit4<-glmmTMB(PC1FC~GM_Leaf_Area+as.factor(gh_bench)+(1|Family),data=dat2)
anova(fit2,fit4)#Yes. ... very high. 

summary(fit4)
summary(fit)
Xtract(fit,1.324e+00) #Extremely high environmental effect fot PC1


#PC2
fit<-glmmTMB(PC2FC~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment/Family)+(1|Family),data=dat2)
summary(fit)
#Is there an effect of GXE? 
fit2<-glmmTMB(PC2FC~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment)+(1|Family),data=dat2)
anova(fit,fit2)#No.

#Is there an effect of family? 
fit3<-glmmTMB(PC2FC~GM_Leaf_Area+as.factor(gh_bench)+(1|treatment),data=dat2)
anova(fit2,fit3)#No....not at all. 

#Is there an effect of treatment? 
fit4<-glmmTMB(PC2FC~GM_Leaf_Area+as.factor(gh_bench)+(1|Family),data=dat2)
anova(fit2,fit4)#....Almost. interesting.  

summary(fit)
Xtract(fit,0.406801) #

```



#For modelling. 






#Glucosinolate plastsicity
```{r}
library(glmmTMB)
#Maximum model
fit<-glmmTMB(gluc_Conc~treatment+GM_Leaf_Area+(1|Family)+(1|gh_bench),data=dat2)
fit2<-glmmTMB(gluc_Conc~treatment+GM_Leaf_Area+(1|Family),data=dat2)
fit3<-glmmTMB(gluc_Conc~treatment+GM_Leaf_Area+(1|gh_bench),data=dat2)
fit3.3<-glmmTMB(gluc_Conc~treatment+GM_Leaf_Area+(1|Family/treatment),data=dat2)

anova(fit2,fit3.3) #Is a GXE significant? # no. 
anova(fit,fit2) #Greenhouse bench is not
anova(fit3,fit) #Family and Tag is very significant. 

#Significance of plasticity for glucosinolates 
fit<-glmmTMB(gluc_Conc~treatment+Standardize(GM_Leaf_Area)+(1|Family),data=dat2)
fit4<-glmmTMB(gluc_Conc~Standardize(GM_Leaf_Area)+(1|Family),data=dat2)
anova(fit,fit4)
summary(fit)
confint(fit)

#"Active plasticity" Eventhough it could still be passive after accounting for chlorophyll
fit<-glmmTMB(gluc_Conc~treatment+Standardize(GM_Leaf_Area)+Standardize(ChlorA)+(1|Family),data=dat2)
fit2<-glmmTMB(gluc_Conc~Standardize(GM_Leaf_Area)+Standardize(ChlorA)+(1|Family),data=dat2)
anova(fit,fit2)
confint(fit)

summary(fit) #Treatment is still significant, however, the magnitude of the significance is much reduced, i think that it is sharing the significance with chlorophyll. 
```

#Visualization of Apparent treatment means glucosinolate
```{r}
source("GGPlot_Themes.R")

#Visualizing passive plasticity
a<--1.55899177
gm<--1.55899177-0.16618664
m<--1.55899177-0.18518751
Vis<-data.frame(
  treatment=c("Alone","Garlic Mustard","Maple"),estimate=c(a,gm,m),upper=c(-1.50051001,a-0.09022637,a-0.11887264),lower=c(-1.61747353,a-0.24214691,a-0.25150238 ))


Gpassive<-ggplot(Vis,aes(x = treatment, 
                    y = estimate, colour = treatment))+
  geom_point(size = 5)+
  geom_errorbar(ymin = Vis$lower,
                ymax = Vis$upper, width = 0.1)+
  scale_x_discrete(name="",labels=c("Alone","Intraspecific","Interspecific"))+
  scale_y_continuous(limits = c(-1.9,-1.4), name = bquote(bold("[Glucosinolate] (log" (mg/mL)~")")),breaks=seq(-1.9,-1.4,by=0.1))+
  scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Garlic Mustard","Maple"))+
  theme_simple_multiCol()+theme(
    axis.title.y =  element_text(color = "black", size = 16, face = "bold",margin=margin(3,20,3,0),angle = 90),
  )

a<--1.63713694
gm<--1.63713694-0.06113577
m<--1.63713694-0.07089345
Vis<-data.frame(
  treatment=c("Alone","Garlic Mustard","Maple"),estimate=c(a,gm,m),upper=c(-1.585805632,a-0.005747620,a-0.021957509),lower=c(-1.68846825,a-0.11652391,a-0.11982939 ))

#Visualizing Active plasticity
Gactive<-ggplot(Vis,aes(x = treatment, 
                    y = estimate, colour = treatment))+
  geom_point(size = 5)+
  geom_errorbar(ymin = Vis$lower,
                ymax = Vis$upper, width = 0.1)+
  scale_x_discrete(name="",labels=c("Alone","Intraspecific","Interspecific"))+
  scale_y_continuous(limits = c(-1.9,-1.4),breaks=seq(-1.9,-1.4,by=0.1))+
  scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Garlic Mustard","Maple"))+
  theme_simple_multiCol()

tiff("Plasticity_Figures/Glucosinolate_Plasticity.tiff", units="in", width=12, height=6, res=300)
plot_grid(passive,active,labels = c("a","b"),rel_widths = c(1.1,1))
dev.off()
```

#Flavonoid plasticity
```{r}
library(glmmTMB)
#Maximum model
#Convergence problem forced to use replication at family level, not individual level
fit<-glmmTMB(flav_Conc~treatment+Standardize(GM_Leaf_Area)+(1|Family)+(1|gh_bench),data=dat2)
fit2<-glmmTMB(flav_Conc~treatment+Standardize(GM_Leaf_Area)+(1|Family),data=dat2) 
fit3<-glmmTMB(flav_Conc~treatment+Standardize(GM_Leaf_Area)+(1|gh_bench),data=dat2) #Convergence problem

fit3.3<-glmmTMB(flav_Conc~treatment+Standardize(GM_Leaf_Area)+(1|Family/treatment),data=dat2) 

anova(fit2,fit3.3)#No GXE effect. 
anova(fit,fit2) #Greenhouse bench is significant

anova(fit3,fit) #Family is not significant at all. No genetic variation for family.

summary(fit3)
confint(fit3)


#"apparent plasticity" Eventhough it could still be passive after accounting for chlorophyll
fit<-glmmTMB(flav_Conc~treatment+Standardize(GM_Leaf_Area)+(1|Family),data=dat2)
fit2<-glmmTMB(flav_Conc~Standardize(GM_Leaf_Area)+(1|Family),data=dat2)
summary(fit2)

anova(fit,fit2)




#"Active plasticity" Eventhough it could still be passive after accounting for chlorophyll
fit<-glmmTMB(flav_Conc~treatment+Standardize(GM_Leaf_Area)+Standardize(ChlorA)+(1|Family),data=dat2)

fit2<-glmmTMB(flav_Conc~Standardize(GM_Leaf_Area)+Standardize(ChlorA)+(1|Family),data=dat2)
summary(fit2)

anova(fit,fit2) #Treatment is not significant with flavonoids after accounting for chlorophyll. 
summary(fit)
confint(fit)

```

#Visualization of treatment means flavonoid
```{r}
#Visualizing passive plasticity
a<--2.21675805
gm<--2.21675805-0.20969999
m<--2.21675805-0.10422161
Vis<-data.frame(
  treatment=c("Alone","Garlic Mustard","Maple"),estimate=c(a,gm,m),upper=c(-2.11846559,a-0.12720992,a-0.03237505),lower=c(-2.31505050,a-0.29219007,a-0.17606816 ))


Fpassive<-ggplot(Vis,aes(x = treatment, 
                    y = estimate, colour = treatment))+
  geom_point(size = 5)+
  geom_errorbar(ymin = Vis$lower,
                ymax = Vis$upper, width = 0.1)+
  scale_x_discrete(name="",labels=c("Alone","Intraspecific","Interspecific"))+
  scale_y_continuous(limits = c(-2.6,-2), name = bquote(bold("[Flavonoid] (log" (mg/mL)~")")),breaks=seq(-2.6,-2,by=0.1))+
  scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Garlic Mustard","Maple"))+
  theme_simple_multiCol()+theme(
    axis.title.y =  element_text(color = "black", size = 16, face = "bold",margin=margin(3,20,3,0),angle = 90),
  )



#Visualizing active plasticity
a<--2.26994454
gm<--2.26994454-0.08570059
m<--2.26994454-0.01716435
Vis<-data.frame(
  treatment=c("Alone","Garlic Mustard","Maple"),estimate=c(a,gm,m),upper=c(-2.2211349151,a-0.0123743864,a+0.0487751134),lower=c(-2.3187541572,a-0.1590268033,a-0.0831038233 ))


Factive<-ggplot(Vis,aes(x = treatment, 
                    y = estimate, colour = treatment))+
  geom_point(size = 5)+
  geom_errorbar(ymin = Vis$lower,
                ymax = Vis$upper, width = 0.1)+
  scale_x_discrete(name="",labels=c("Alone","Intraspecific","Interspecific"))+
  scale_y_continuous(limits = c(-2.6,-2), name = bquote(bold("[Flavonoid] (log" (mg/mL)~")")),breaks=seq(-2.6,-2,by=0.1))+
  scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Garlic Mustard","Maple"))+
  theme_simple_multiCol()

tiff("Plasticity_Figures/Flavonoid_Plasticity.tiff", units="in", width=12, height=6, res=300)
plot_grid(Fpassive,Factive,labels = c("a","b"),rel_widths = c(1.1,1))
dev.off

```

#four panel plot
```{r}

tiff("Plasticity_Figures/FlavGluc_Plasticity.tiff", units="in", width=12, height=10, res=300)

plot_grid(Gpassive,Gactive,Fpassive,Factive,labels = c("a","b","c","d"),align = "hv",label_fontfamily = "Arial",label_size = 18)

dev.off()

```













#Visualizing correlation between gluc, flav and chlorophyll. 
```{r}
source("GGPlot_Themes.R")
library(cowplot)
library(gridExtra)




flav<-ggplot(dat)+
  geom_point(aes(y=flav_Conc,x=ChlorA))+
  ylab(bquote(bold("[Flavonoid] (log"*(mg/ml)*")")))+
  xlab(bquote(bold("[Chlorophyll A] (log"*(μg/ml)*")")))+
  geom_abline(slope=0.3939,intercept = -1.8336,size=1)+
  scale_y_continuous(breaks = seq(-4,1,0.25))+
  scale_x_continuous(breaks = seq(-4,1,0.5))+
  theme_simple_vert()
flav

gluc<-ggplot(dat)+
  geom_point(aes(y=gluc_Conc,x=ChlorA))+
  ylab(bquote(bold("[Glucosinolate] (log"*(mg/ml)*")")))+
  xlab(bquote(bold("[Chlorophyll A] (log"*(μg/ml)*")")))+
    geom_abline(slope=0.45340,intercept = -1.14540,size=1 )+
   scale_y_continuous(breaks = seq(-4,0,0.25))+
  scale_x_continuous(breaks = seq(-4,1,0.5))+
  theme_simple_vert()
gluc

flavfit<-lm(flav_Conc~ChlorA,data=dat)
glucfit<-lm(gluc_Conc~ChlorA,data=dat)

flavglucfit<-lm(gluc_Conc~flav_Conc,data=dat)

summary(flavfit)
summary(glucfit)
summary(flavglucfit)

tiff("Other_Figures/Log_GlucFlavChlor_Cor.tiff", units="in", width=12, height=6, res=300)
plot_grid(gluc,flav,ncol=2,nrow=1,labels=c("a","b"),label_fontfamily = "Arial",label_size = 18)
dev.off()


```



