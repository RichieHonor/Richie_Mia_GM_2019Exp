---
title: "Survival_Fitness_Analysis"
author: "Richard Honor"
date: "01/06/2020"
output: html_document
---
#Read in and prep data
```{r}
library(ggplot2)
library(glmmTMB)
#library(tidyr)
library(cowplot)
library(grid)
library(gridExtra)
library(dplyr)
source("GGPlot_Themes.R")

#read in data
rm(list=ls())
dat<-read.csv("DataSynthesis.csv")

#Remove maple controls data from the data set.
#dat<-dat %>% filter(treatment!="mcnt") %>% droplevels()

#remove those with fertilizer treatment, and extra genotypes that are only in the alone treatment. 
dat<-dat[!grepl("i",dat$ID,fixed=T),]


#Initializing columns to avoid constant error messages. 
dat$WhiteFungLogis<-NA
dat$BlackFungLogis<-NA

dat %>% filter(Tag=="b|PDVRT1-20|Q|406")
```


#Generating data frames with summarized leaf data (dat2) and summarized genotype data (dat3)
```{r}

#Logging data
dat$Fern<-log(dat$Fern+1)
dat$gluc_Conc<-log(dat$gluc_Conc)
dat$flav_Conc<-log(dat$flav_Conc)
dat$ChlorA<-log(dat$ChlorA)
dat$ThripsDam<-log(dat$ThripsDam+1)
dat$BlackPathDam<-log(dat$BlackPathDam+1)


#Creating leaf area vector 
dat$GM_Leaf_Area<-dat$GM_Leaf_Len*dat$GM_Leaf_Wid


#Summarizing: Taking the mean value of leaves. This tibble contains data at the level of the plant means. 
dat2<-dat %>% group_by(Tag) %>% summarize(ChlorA=mean(ChlorA),ChlorB=mean(ChlorB),gluc_Conc=mean(gluc_Conc),flav_Conc=mean(flav_Conc),Family=first(Family),treatment=first(treatment),gh_row=first(gh_row),gh_bench=first(gh_bench),GM_TotalLeaf_Area=first(GM_TotalLeaf_Area),comp_number=first(comp_number),ThripsDam=mean(ThripsDam),WhiteFungDam=mean(WhiteFungDam),BlackPathDam=mean(BlackPathDam),Fern=mean(Fern),gh_col=first(gh_col),GM_Leaf_Area=mean(GM_Leaf_Area),Latitude=first(Latitude),Longitude=first(Longitude),Altitude=first(Altitude),
GM_StemHeight_Bolt=first(GM_StemHeight_Bolt),
GM_Leaf_Number_Bolt=first(GM_Leaf_Number_Bolt),
Larg_Leaf_Len_Bolt=first(Larg_Leaf_Len_Bolt),
Larg_Leaf_Wid_Bolt=first(Larg_Leaf_Wid_Bolt),
Row_Field=first(Row_Field),
Col_Field=first(Col_Field),
Maple_Died=first(Maple_Died),
Maple_TotalLeafArea_End=first(Maple_TotalLeafArea_End),
GM_Fecundity=first(GM_Fecundity),
MapleFinalMass=first(MapleFinalMass),
RGR1=first(RGR1)
)


#All of these genotypes died (15 Genotypes).(We are simply missing a final measurement for e|JBCHY1-1-50|Q|240) That is only 3% Mortality. 
dead<-dat2[is.na(dat2$GM_TotalLeaf_Area),]

deadID<-dead %>% filter(treatment!="mcnt",Tag!="e|JBCHY1-1-50|Q|240") #Here there are 12 putative dead competitors because  ("e|JBCHY1-1-50|Q|240") did not die. 


#What are the frequencies in each treatment?
#Assinging those that died. 
dat2$GreenhouseSurvival<-c()
dat2$GreenhouseSurvival[dat2$Tag %in% deadID$Tag]<-0
dat2$GreenhouseSurvival[is.na(dat2$GreenhouseSurvival)]<-1



#Because of how zero inflated white pathogen damage is, i will use a logistic regression to model it.
dat2$WhiteFungLogis<-NA
dat2$WhiteFungLogis[dat2$WhiteFungDam==0]<-0
dat2$WhiteFungLogis[dat2$WhiteFungDam>0]<-1


#Creating Survival Data.1 = survived, 0= dead.
dat2$Bolt_Survival<-c()
dat2$Bolt_Survival[dat2$GM_StemHeight_Bolt=="Dead"]<-0
dat2$Bolt_Survival[dat2$GM_StemHeight_Bolt!="Dead"]<-1
dat2$Bolt_Survival[is.na(dat2$GM_StemHeight_Bolt)]<-0 # I am going to be consistent and call those without a value dead because i missed these ones. 
dat2$Bolt_Survival[dat2$GM_Fecundity>0]<-1 #Those with fecundity data are also alive... 
dat2$Bolt_Survival[dat2$treatment=="mcnt"]<-NA #those that dies in year 1 are NA
dat2$Bolt_Survival[dat2$treatment=="mcnt"]<-NA #Maple controls are NA


#Creating Maple Survival Data.
dat2$Maple_SurvivalY2<-c()
dat2$Maple_SurvivalY2[is.na(dat2$MapleFinalMass)]<-0 #Converting all those without a final measurement to dead.
dat2$Maple_SurvivalY2[!is.na(dat2$MapleFinalMass)]<-1 #Anything that is not NA (i.e. has a final measurment, is alive)
dat2$Maple_SurvivalY2[dat2$Maple_TotalLeafArea_End==0]<-NA #anything that died in the first year is overwritten as NA 
dat2$Maple_SurvivalY2[!dat2$treatment %in% c("mcnt","m")]<-NA

#Making a maple survival Y1 collumn
dat2$Maple_SurvivalY1<-c()
dat2$Maple_SurvivalY1[dat2$Maple_TotalLeafArea_End==0]<-0 #anything with a value of 0 is dead
dat2$Maple_SurvivalY1[is.na(dat2$Maple_TotalLeafArea_End)]<-NA #anything with NA is unknown
dat2$Maple_SurvivalY1[dat2$Maple_SurvivalY2==1]<-1 #Those with an NA will be overwritten if i have a record of their size in year two. 
dat2$Maple_SurvivalY1[dat2$Maple_TotalLeafArea_End>0]<-1 #anything with a value greater than zero is alive

#This Genotype was NA for maple total leaf area, but we know that it is dead. 
dat2$Maple_SurvivalY1[dat2$Tag=="e|CBMCK1-1-0|N|49"]<-0

```

#Descriptive statistics of survival
```{r}

TreatmentMortality<-function(data){
num<-tapply(data,dat2$treatment,sum,na.rm=T) #numerator
x<-tapply(data,dat2$treatment,mean,na.rm=T) #Survival rate
denom=num/x #Denominator

#Now mortality rate

NewNum<-denom-num
Mortality<-(1-x)*100

return(list(NewNum,denom,Mortality))
}

#Alliaria mortality
(1-mean(dat2$GreenhouseSurvival,na.rm = T))*100
(1-mean(dat2$Bolt_Survival,na.rm = T))*100

#Maple Mortality
(1-mean(dat2$Maple_SurvivalY1,na.rm = T))*100
(1-mean(dat2$Maple_SurvivalY2,na.rm = T))*100

#Treatment Specific Data

#alliaria year 1
TreatmentMortality(dat2$GreenhouseSurvival)
#MAple year 1
TreatmentMortality(dat2$Maple_SurvivalY1)

dat2 %>% select(Tag, GreenhouseSurvival,GM_TotalLeaf_Area,Bolt_Survival,Col_Field,GM_Fecundity,GM_StemHeight_Bolt) %>% filter(GreenhouseSurvival==0)

dat2[is.na(dat2$Maple_SurvivalY1) & dat2$treatment=="m",c("Tag","Maple_SurvivalY1","GreenhouseSurvival")]

dat2 %>% filter(Tag=="e|CBMCK1-1-0|N|49")

#These maples are still problematic. 
```




#Removing dead individuals and dead competitors from the analysis. 
```{r}
#Making a table to determine the frequencies..


#Removing those with dead competitors from the garlic mustard treatment. ("e|JBCHY1-1-50|Q|240") did not die, we are simply missing the final measurement for it.

dead_competitors<-dead %>% filter(treatment=="gm",Tag!="e|JBCHY1-1-50|Q|240") %>% select(comp_number)

#Removing those with dead competitors from the analysis. 
dat2<-dat2 %>% filter(!comp_number %in% dead_competitors$comp_number)
dat<-dat %>% filter(!comp_number %in% dead_competitors$comp_number)


#Removing dead individuals from the analysis. 
dat2<-dat2[dat2$GreenhouseSurvival==1,]


#Removing those with dead maples from the analysis
dat2<-dat2[dat2$Maple_SurvivalY1==1 | is.na(dat2$Maple_SurvivalY1),]


  #Function to standardize variables. 
Standardize<-function(x){
  standard<-(x-mean(x,na.rm=T))/sd(x,na.rm=T)
}


#Standardizing leaf area. 
dat2$GM_Leaf_Area<-Standardize(dat2$GM_Leaf_Area)

dat2 %>% filter(treatment!="mcnt")
```


#Descriptive statistics of year two with competitiors removed. 
```{r}

#alliaria year 1
TreatmentMortality(dat2$Bolt_Survival)
#MAple year 1
TreatmentMortality(dat2$Maple_SurvivalY2)

#Garlic mustard Data
tapply(dat2$RGR1,dat2$treatment,mean,na.rm=T)*1000000
tapply(dat2$GM_TotalLeaf_Area,dat2$treatment,mean,na.rm=T)
tapply(dat2$GM_Fecundity,dat2$treatment,mean,na.rm=T)





```




#PCA of GM SIZE in the second year. 
```{r}
#Removing dead individuals with zeros. 
dat2$GM_StemHeight_Bolt[which(dat2$GM_StemHeight_Bolt=="Dead")]<-0
dat2$GM_Leaf_Number_Bolt[which(dat2$GM_Leaf_Number_Bolt=="Dead")]<-0
dat2$Larg_Leaf_Len_Bolt[which(dat2$Larg_Leaf_Len_Bolt=="Dead")]<-0
dat2$Larg_Leaf_Wid_Bolt[which(dat2$Larg_Leaf_Wid_Bolt=="Dead")]<-0

#Making data numeric
dat2$GM_StemHeight_Bolt<-as.numeric(dat2$GM_StemHeight_Bolt)
dat2$GM_Leaf_Number_Bolt<-as.numeric(dat2$GM_Leaf_Number_Bolt)
dat2$Larg_Leaf_Len_Bolt<-as.numeric(dat2$Larg_Leaf_Len_Bolt)
dat2$Larg_Leaf_Wid_Bolt<-as.numeric(dat2$Larg_Leaf_Wid_Bolt)


pca<-prcomp(~GM_StemHeight_Bolt+GM_Leaf_Number_Bolt+Larg_Leaf_Len_Bolt+Larg_Leaf_Wid_Bolt,data=dat2,scale.=T,na.action=na.omit)
summary(pca)
pca

prediction<-as.data.frame(predict(pca))

df<-tibble::rownames_to_column(prediction, "rownumber")

dat2[df$rownumber,"PC1BoltSize"]<-df$PC1

hist(dat2$PC1BoltSize) #The data is very zero inflated because of the mortality. This isnt great but what can you do. 
```



#Generating PCA for Glucosinolate, Flavonoid and Chlorophyll
```{r}
#######
#Trying a pca with all three variables.
#########
pcaGlucCorFlav<-prcomp(~Standardize(gluc_Conc)+Standardize(ChlorA)+Standardize(flav_Conc),data=dat2,na.action=na.omit)
biplot(pcaGlucCorFlav)
pcaGlucCorFlav
summary(pcaGlucCorFlav)
pcaGlucCorFlav
#Loading to data frame.
prediction<-as.data.frame(predict(pcaGlucCorFlav))


df2<-tibble::rownames_to_column(prediction, "rownumber")
dat2[df2$rownumber,"PC1AllCGF"]<-df2$PC1
dat2[df2$rownumber,"PC2All_CF"]<-df2$PC2
dat2[df2$rownumber,"PC3All_CG"]<-df2$PC3

#PC2 is off diagonal for flav. (Higher values is higher flavonoid:Chlorophyll)
#PC3 is the off diagonal for glucosinolate.  (Higher values is higher glucosinolate:Chlorophyll)



```


#Descriptive Statistics
```{r}

dat2[is.na(dat2$Bolt_Survival),] #There are 5 missing genotypes from the field. These are just ones that i missed when assessing the plant's fecundity.I will leave as NA. 

dat2 %>% select(Bolt_Survival,Tag)

mean(dat2$GreenhouseSurvival,na.rm=T)


#Garlic mustard survival
sum(dat2$Bolt_Survival,na.rm = T)/length(dat2$Bolt_Survival[!is.na(dat2$Bolt_Survival)])

#Garlic mustard mortality
(length(dat2$Bolt_Survival[!is.na(dat2$Bolt_Survival)])-sum(dat2$Bolt_Survival[!is.na(dat2$Bolt_Survival)]))/length(dat2$Bolt_Survival[!is.na(dat2$Bolt_Survival)])

#or 
#Garlic mustard survival
1-sum(dat2$Bolt_Survival,na.rm = T)/length(dat2$Bolt_Survival[!is.na(dat2$Bolt_Survival)])


table(dat2$Bolt_Survival,dat2$treatment)
table(dat2$FirstYearDeath,dat2$treatment)
108/(108+57)*100 #Died in alone treatment 65.45
117/(117+56)*100 #Died in GM treatment 67.63
120/(120+44)*100 #Died in maple treatment 73.17

table(dat2$Maple_SurvivalY1,dat2$treatment)
table(dat2$Maple_SurvivalY2,dat2$treatment)

#There was 31.2% Survival into the field for garlic mustard plants. 
2/163

#Number of rows and columns 
unique(dat2$Col_Field)
length(unique(paste(dat2$Row_Field, dat2$Col_Field)))
unique(paste(dat2$Row_Field, dat2$Col_Field))
table(paste(dat2$Row_Field, dat2$Col_Field))

2/165*100

```





#Survival analysis Updated to include PCA values. (also updated with correlations)
```{r}


#Maximum model ... is interaction significant?
fit<-glmmTMB(Bolt_Survival~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+(1|Col_Field),data=dat2[!is.na(dat2$Col_Field),],family="binomial")

fit2<-glmmTMB(Bolt_Survival~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$Col_Field),],family="binomial")

fit3<-glmmTMB(Bolt_Survival~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+(1|gh_bench),data=dat2[!is.na(dat2$Col_Field),],family="binomial")

fit4<-glmmTMB(Bolt_Survival~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family),data=dat2[!is.na(dat2$Col_Field),],family="binomial")

fit5<-glmmTMB(Bolt_Survival~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Row_Field),data=dat2[!is.na(dat2$Col_Field),],family="binomial")

#IS column in field significant?
anova(fit,fit4) # No

#IS row in field significant?
anova(fit2,fit4) #Yes it is. 

#IS gh_bench  significant?
anova(fit3,fit4) #No.

#IS family  significant?
anova(fit5,fit2) #Yes

###Modelling fixed effects 
#Is leaf area significant?
fit0.1<-glmmTMB(Bolt_Survival~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam+GM_Leaf_Area+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$GM_Leaf_Area),],family="binomial")
fit1<-glmmTMB(Bolt_Survival~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$GM_Leaf_Area),],family="binomial")
anova(fit0.1,fit1)# no.

#IS Total Leaf area (first year) significant? 

fit0.1<-glmmTMB(Bolt_Survival~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$GM_TotalLeaf_Area),],family="binomial")
fit1<-glmmTMB(Bolt_Survival~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(RGR1)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$GM_TotalLeaf_Area),],family="binomial")
anova(fit0.1,fit1)# no.

#IS RGR significant? 

fit0.1<-glmmTMB(Bolt_Survival~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(RGR1)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$RGR1),],family="binomial")
fit1<-glmmTMB(Bolt_Survival~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$RGR1),],family="binomial")
anova(fit0.1,fit1)# no.

#Continuing selectino on full data set. 
fit1<-glmmTMB(Bolt_Survival~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam+(1|Family)+(1|Row_Field),data=dat2,family="binomial")

fit2<-update(fit1,~.-ThripsDam:BlackPathDam:WhiteFungLogis)
anova(fit1,fit2) #Not a significant three way interaction.

fit3<-update(fit2,~.-BlackPathDam:WhiteFungLogis)
anova(fit3,fit2) #There is not a significant two way interaction, 

fit4<-update(fit3,~.-BlackPathDam:ThripsDam)
anova(fit4,fit3)
#There is not a significant interaction between black path dam and thrips dam. 

fit5<-update(fit4,~.-WhiteFungLogis:ThripsDam)
anova(fit5,fit4) #There is not a significant whitefung dam and thrips dam interaction. 

#IS the interaction between treatment and PC3All_CG significant?
fit6<-update(fit5,~.-treatment:PC3All_CG)
anova(fit6,fit5) #No. 

#IS the interaction between treatment and PC2All_CF significant?
fit7<-update(fit6,~.-treatment:PC2All_CF)
anova(fit7,fit6) #Almost...  on the edge p=0.0566  will be checked again later. 

#IS PC3All_CG significant? 
fit8<-update(fit7,~.-PC3All_CG)
anova(fit8,fit7) #p=0.08... right on the edge will double check later. 


#IS the interaction between treatment and PC1AllCGF significant?
fit9<-update(fit7,~.-treatment:PC1AllCGF)
anova(fit9,fit7) #No, this interaction is not significant. p=0.06. Will double check after removing pathogen data. 

#IS thrips dam significant?
fit10<-glmmTMB(Bolt_Survival~treatment*PC1AllCGF+treatment*PC2All_CF+PC3All_CG+Standardize(Fern)+BlackPathDam+WhiteFungLogis+ThripsDam+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$ThripsDam),],family="binomial")
fit11<-glmmTMB(Bolt_Survival~treatment*PC1AllCGF+treatment*PC2All_CF+PC3All_CG+Standardize(Fern)+BlackPathDam+WhiteFungLogis+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$ThripsDam),],family="binomial")
anova(fit10,fit11) #No.


#IS Black Path dam significant?
fit10<-glmmTMB(Bolt_Survival~treatment*PC1AllCGF+treatment*PC2All_CF+PC3All_CG+Standardize(Fern)+BlackPathDam+WhiteFungLogis+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$BlackPathDam),],family="binomial")
fit11<-glmmTMB(Bolt_Survival~treatment*PC1AllCGF+treatment*PC2All_CF+PC3All_CG+Standardize(Fern)+WhiteFungLogis+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$BlackPathDam),],family="binomial")
anova(fit10,fit11) #No.

#IS White Fung dam significant?
fit10<-glmmTMB(Bolt_Survival~treatment*PC1AllCGF+treatment*PC2All_CF+PC3All_CG+Standardize(Fern)+WhiteFungLogis+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$WhiteFungLogis),],family="binomial")
fit11<-glmmTMB(Bolt_Survival~treatment*PC1AllCGF+treatment*PC2All_CF+PC3All_CG+Standardize(Fern)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$WhiteFungLogis),],family="binomial")
anova(fit10,fit11) #No.

#IS Fern significant?
fit10<-glmmTMB(Bolt_Survival~treatment*PC1AllCGF+treatment*PC2All_CF+PC3All_CG+Standardize(Fern)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$Fern),],family="binomial")
fit11<-glmmTMB(Bolt_Survival~treatment*PC1AllCGF+treatment*PC2All_CF+PC3All_CG+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$Fern),],family="binomial")
anova(fit10,fit11) #Yes, fern is highly significant. 


#IS the interaction between treatment and PC2All_CF significant (testing again)?
fit11<-update(fit10,~.-treatment:PC2All_CF)
anova(fit11,fit10) #Yes it is now significant at 0.032. 

#IS the interaction between treatment and PC1AllCGF significant (testing again)?
fit11<-update(fit10,~.-treatment:PC1AllCGF)
anova(fit11,fit10) #No this is no longer significant.

#IS  PC1AllCGF significant at all?
fit12<-update(fit11,~.-PC1AllCGF)
anova(fit12,fit11) #right on the edge... 0.064

#IS the interaction between treatment and PC2All_CF significant (testing a third time)?
fit13<-update(fit12,~.-treatment:PC2All_CF)
anova(fit13,fit12) #Yes, 0.036

summary(fit12) #Weird that fern is associated with increased survival. 

#Bad model for coefficients. 
fit10<-glmmTMB(Bolt_Survival~Standardize(PC1AllCGF)+treatment*Standardize(PC2All_CF)+Standardize(PC2All_CF)+Standardize(Fern)+Standardize(BlackPathDam)+Standardize(WhiteFungLogis)+Standardize(ThripsDam)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$ThripsDam),],family="binomial")
summary(fit10)

#Best model
fit<- glmmTMB(Bolt_Survival ~ treatment + Standardize(PC2All_CF) + Standardize(Fern) +  
    (1 | Family) + (1 | Row_Field) + treatment:Standardize(PC2All_CF),data=dat2, family="binomial")
summary(fit)


#treatment effect: 
fit<- glmmTMB(Bolt_Survival ~ treatment  + Standardize(Fern) +  
    (1 | Family) + (1 | Row_Field) ,data=dat2, family="binomial")
fit2<- glmmTMB(Bolt_Survival ~   Standardize(Fern) +  
    (1 | Family) + (1 | Row_Field) ,data=dat2, family="binomial")
anova(fit,fit2) #Treatment not significant. 
summary(fit)

exp(0.41)

#b|PDVRT1-20|Q|406 mystery, no column in the field but we hav ebolt survival data on it.
```


```{r}
slope1<-function(x){
  y=x+1
  return(y)
}
slope2<-function(x){
  y=2*x+1
   return(y)
}
slope3<-function(x){
  y=-3*x+1
   return(y)
}
slope3(1:100)

Tester<-data.frame("Values"=c(slope1(1:100),slope2(1:100),slope3(1:100)),"Treatment"=c(rep("A",100),rep("B",100),rep("C",100)),"Covariate"=c(1:100,1:100,1:100))
Tester

fitTest<-lm(Values~Treatment*Covariate,data=Tester)

ggplot(Tester)+
  geom_point(aes(y=Values,x=Covariate,colour=Treatment))
summary(fitTest)

1/2 #odds = 0.5

#probability = 1/3

log(0.5) #-0.693 = log odds

exp(-0.693)/(exp(-0.693)+1)#= probability

1-exp(-0.3)/(exp(-0.3)+1)

1-exp(-0.5)/(exp(-0.5)+1)


4*0.1

4-4*0.9


exp(0.3)
exp(-0.3)
exp(-0.5)

exp(-1)
```




#Effect on fecundity update with treatment*PCA interactions. (Updated with all traits included)  
```{r}
#Model selection
#Maximum model ... is interaction significant?
fit<-glmmTMB(Standardize(GM_Fecundity)~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize)+(1|Family)+(1|Col_Field),data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

fit2<-glmmTMB(Standardize(GM_Fecundity)~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize)+(1|Family)+(1|Row_Field),data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

fit3<-glmmTMB(Standardize(GM_Fecundity)~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize)+(1|Family)+(1|gh_bench),data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

fit4<-glmmTMB(Standardize(GM_Fecundity)~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize)+(1|Family),data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

fit5<-glmmTMB(Standardize(GM_Fecundity)~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize)+(1|Row_Field),data=dat2[!is.na(dat2$Col_Field|dat2$Row_Field),])

#IS column in field significant?
anova(fit,fit4) # No

#IS row in field significant?
anova(fit2,fit4) #No

#IS gh_bench  significant?
anova(fit3,fit4) #No.

#IS family  significant?
anova(fit5,fit2) #No.. fairly close however. 0.057

###Modelling fixed effects 

#Is leaf area significant?
fit0.1<-glmmTMB(Standardize(GM_Fecundity)~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2)
fit1<-glmmTMB(Standardize(GM_Fecundity)~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam+GM_Leaf_Area+Standardize(GM_TotalLeaf_Area)+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2)
anova(fit1,fit0.1)# no

#Is Total leaf area (year 1) significant?
fit0.1<-glmmTMB(Standardize(GM_Fecundity)~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(RGR1)+Standardize(GM_TotalLeaf_Area)+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$GM_TotalLeaf_Area),])
fit1<-glmmTMB(Standardize(GM_Fecundity)~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$GM_TotalLeaf_Area),])
anova(fit1,fit0.1)# no

#Is RGR significant?
fit0.1<-glmmTMB(Standardize(GM_Fecundity)~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(RGR1)+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$RGR1),])
fit1<-glmmTMB(Standardize(GM_Fecundity)~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$RGR1),])
anova(fit1,fit0.1)# no

#Is Bolt Size?
fit0.1<-glmmTMB(Standardize(GM_Fecundity)~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam+Standardize(PC1BoltSize),data=dat2[!is.na(dat2$PC1BoltSize),])
fit1<-glmmTMB(Standardize(GM_Fecundity)~treatment*PC1AllCGF+treatment*PC2All_CF+treatment*PC3All_CG+Standardize(Fern)+BlackPathDam*WhiteFungLogis*ThripsDam,data=dat2[!is.na(dat2$PC1BoltSize),])
anova(fit1,fit0.1)# Yes.... extremely.


fit2<-update(fit0.1,~.-ThripsDam:BlackPathDam:WhiteFungLogis)
anova(fit0.1,fit2) #Not a significant three way interaction.

fit3<-update(fit2,~.-BlackPathDam:WhiteFungLogis)
anova(fit3,fit2) #There is not a significant two way interaction. Although it is close (p=0.055)

fit4<-update(fit3,~.-BlackPathDam:ThripsDam)
anova(fit4,fit3)
#There is not a significant interaction between black path dam and thrips dam. 

fit5<-update(fit4,~.-WhiteFungLogis:ThripsDam)
anova(fit5,fit4) #There is not a significant whitefung dam and thrips dam interaction. 

#IS the interaction between treatment and PC3All_CG significant?
fit6<-update(fit5,~.-treatment:PC3All_CG)
anova(fit6,fit5) #No. 

#IS the interaction between treatment and PC2All_CF significant?
fit7<-update(fit6,~.-treatment:PC2All_CF)
anova(fit7,fit6) #No. 

#IS PC3All_CG significant? 
fit8<-update(fit7,~.-PC3All_CG)
anova(fit8,fit7) #No 

#IS the interaction between treatment and PC1AllCGF significant?
fit9<-update(fit8,~.-treatment:PC1AllCGF)
anova(fit9,fit8) #Yes, the interaction between PC1AllCGF and treatment is significant. p=0.009.. more significant than before. 

#IS  PC2_CFAllCG significant at all?
fit9<-update(fit8,~.-PC2All_CF)
anova(fit9,fit8) #No, not it is not significant at all. 

#IS thrips dam significant?
fit10<-glmmTMB(Standardize(GM_Fecundity)~treatment*PC1AllCGF+Standardize(Fern)+BlackPathDam+WhiteFungLogis+ThripsDam,data=dat2[!is.na(dat2$ThripsDam),])
fit11<-glmmTMB(Standardize(GM_Fecundity)~treatment*PC1AllCGF+Standardize(Fern)+BlackPathDam+WhiteFungLogis,data=dat2[!is.na(dat2$ThripsDam),])
anova(fit10,fit11) #No.


#IS Black Path dam significant?
fit10<-glmmTMB(Standardize(GM_Fecundity)~treatment*PC1AllCGF+Standardize(Fern)+BlackPathDam+WhiteFungLogis,data=dat2[!is.na(dat2$BlackPathDam),])
fit11<-glmmTMB(Standardize(GM_Fecundity)~treatment*PC1AllCGF+Standardize(Fern)+WhiteFungLogis,data=dat2[!is.na(dat2$BlackPathDam),])
anova(fit10,fit11) #No.


#IS White Fung dam significant?
fit10<-glmmTMB(Standardize(GM_Fecundity)~treatment*PC1AllCGF+Standardize(Fern)+WhiteFungLogis,data=dat2[!is.na(dat2$WhiteFungLogis),])
fit11<-glmmTMB(Standardize(GM_Fecundity)~treatment*PC1AllCGF+Standardize(Fern),data=dat2[!is.na(dat2$WhiteFungLogis),])
anova(fit10,fit11) #No.


#IS Fern significant?
fit10<-glmmTMB(Standardize(GM_Fecundity)~treatment*PC1AllCGF+Standardize(Fern),data=dat2[!is.na(dat2$Fern),])
fit11<-glmmTMB(Standardize(GM_Fecundity)~treatment*PC1AllCGF,data=dat2[!is.na(dat2$Fern),])
anova(fit10,fit11) #No.

#The simplest best model is

fit11<-glmmTMB(Standardize(GM_Fecundity)~treatment*Standardize(PC1AllCGF)+Standardize(PC1BoltSize),data=dat2)
fit11b<-update(fit11,~.-treatment:Standardize(PC1AllCGF))
anova(fit11,fit11b)
summary(fit11)


  -0.38306+0.37643 #GM slope
 -0.38306+0.72000 #Maple slope
#The exact same effect was observed for fecundity, which is incredibly wierd and slighly unsettling.

#treatment effect 
fit11<-glmmTMB(Standardize(GM_Fecundity)~treatment,data=dat2)
fit12<-glmmTMB(Standardize(GM_Fecundity)~1,data=dat2)
anova(fit11,fit12)
summary(fit11)


#Bad model for coefficients. 
fit10<-glmmTMB(Standardize(GM_Fecundity)~treatment*Standardize(PC1AllCGF)+Standardize(PC3All_CG)+Standardize(PC2All_CF)+Standardize(Fern)+Standardize(BlackPathDam)+Standardize(WhiteFungLogis)+Standardize(ThripsDam),data=dat2[!is.na(dat2$ThripsDam),])
summary(fit10)

```


#Visualization -- The conditional benefit of PC1 (allelopathy)
```{r}
source("GGPlot_Themes.R")
#Is the cost dependent on the treatment? 

aloneSlope<-function(x){
  y=-0.38306 *x+ -0.35445
  return(y)
}
mapleSlope<-function(x){
  y=(-0.38306 +0.72000)*x-0.35445 -0.19098
  return(y)
}

mustardSlope<-function(x){
  y=(-0.38306 +0.37643)*x-0.35445-0.65962
  return(y)
}

#Standardizing variables.
dat2$PC1AllCGFS<-Standardize(dat2$PC1AllCGF)

minM<-min(dat2$PC1AllCGFS[dat2$treatment=="m" & !is.na(dat2$GM_Fecundity)],na.rm = T)
maxM<-max(dat2$PC1AllCGFS[dat2$treatment=="m"& !is.na(dat2$GM_Fecundity)],na.rm = T)

minA<-min(dat2$PC1AllCGFS[dat2$treatment=="a"& !is.na(dat2$GM_Fecundity)],na.rm = T)
maxA<-max(dat2$PC1AllCGFS[dat2$treatment=="a"& !is.na(dat2$GM_Fecundity)],na.rm = T)

minG<-min(dat2$PC1AllCGFS[dat2$treatment=="gm"& !is.na(dat2$GM_Fecundity)],na.rm = T)
maxG<-max(dat2$PC1AllCGFS[dat2$treatment=="gm"& !is.na(dat2$GM_Fecundity)],na.rm = T)


#tiff("Selection_Figures/LeafQualityOnFecundity.tiff", units="in", width=8, height=6, res=300)
FecTiff<-ggplot(dat2)+
  geom_point(aes(y=Standardize(GM_Fecundity),x=PC1AllCGFS,colour=treatment),size=2)+
  geom_segment(x=minA,xend=maxA,y=aloneSlope(minA),yend=aloneSlope(maxA),colour="#009E73",size=1.5)+
    geom_segment(x=minM,xend=maxM,y=mapleSlope(minM),yend=mapleSlope(maxM),colour="#E69F00",size=1.5)+
  geom_segment(x=minG,xend=maxG,y=mustardSlope(minG),yend=mustardSlope(maxG),colour="#56B4E9",size=1.5)+theme_simple_multiCol_First()+
  ylab(bquote(bold("Fecundity (σ)")))+xlab("Leaf Quality (σ)")+
  scale_y_continuous(breaks=seq(-2,5,by=0.5),limits = c(-1.3,4))+
  scale_x_continuous(breaks=seq(-5,5,by=1))+
  scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Intraspecific","Interspecific"))

Leg<-ggplot(dat2)+
  geom_point(aes(y=Standardize(GM_Fecundity),x=PC1AllCGFS,colour=treatment),size=2)+
  geom_segment(x=minA,xend=maxA,y=aloneSlope(minA),yend=aloneSlope(maxA),colour="#009E73",size=1.5)+
    geom_segment(x=minM,xend=maxM,y=mapleSlope(minM),yend=mapleSlope(maxM),colour="#E69F00",size=1.5)+
  geom_segment(x=minG,xend=maxG,y=mustardSlope(minG),yend=mustardSlope(maxG),colour="#56B4E9",size=1.5)+theme_simple()+
  ylab(bquote(bold("Fecundity (σ)")))+xlab("Leaf Quality (σ)")+
  #scale_y_continuous(breaks=seq(-2,3,by=0.5))+
  #scale_x_continuous(breaks=seq(-5,5,by=1))+
  scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Intraspecific","Interspecific"))

#dev.off()


FecTiff
TLATiff



d<-get_legend(Leg)

plots <- align_plots(TLATiff,FecTiff,align="hv")

top<-plot_grid(plots[[1]],plots[[2]],ncol=2,rel_widths=c(1,1),rel_heights = c(1,1),labels = c("a","b"),label_fontfamily = "Arial",label_size = 18)

tiff("Selection_Figures/PC1SelectionMulti.tiff", units="in", width=14, height=8, res=300)
plot_grid(d,top,ncol=1,rel_heights = c(1,3.5))
dev.off()

```



#Fern effect on survival and fecundity with psedoreplication removed. 
```{r}
datFern<-dat2
datFern$Tag<-as.character(datFern$Tag)
for(i in 1:length(datFern$Tag)){
  if(!is.na(datFern$comp_number[i])){
    datFern$Tag[i]<-datFern$comp_number[i]
  }
}

#Averaging pot values in the GM treatment.
datFernGM<-datFern %>% group_by(Tag) %>% filter(treatment=="gm") %>% summarize_all(~mean(.))
datFernGM$treatment<-"gm"

#Binding collumns back together. Family should not be used as those in the GM treatment represent the average of two families. 
datFern2<-rbind(datFernGM,datFern[datFern$treatment!="gm",])

datFern2$Bolt_Survival<-as.integer(datFern2$Bolt_Survival)

#What is the effect of ferns?
fit_full1<-glmmTMB(Bolt_Survival~treatment+Standardize(Fern),data=datFern2,family="binomial")

fit_full2<-glmmTMB(Bolt_Survival~treatment,data=datFern2,family="binomial")
anova(fit_full1,fit_full2) #Fern highly significant

#Is treatment significant? 
fit_full1<-glmmTMB(Bolt_Survival~treatment+Standardize(Fern),data=datFern2,family="binomial")

fit_full2<-glmmTMB(Bolt_Survival~Standardize(Fern),data=datFern2,family="binomial")
anova(fit_full1,fit_full2) #No. What about if i remove Fern?

#Is treatment significant? 
fit_full1<-glmmTMB(Bolt_Survival~treatment,data=datFern2,family="binomial")

fit_full2<-glmmTMB(Bolt_Survival~1,data=datFern2,family="binomial")
anova(fit_full1,fit_full2) #Treatment is less significant if i remove fern from the analysis. Interestingly, fern is a very big predictor of survival. 


fit_full2<-glmmTMB(Bolt_Survival~Standardize(Fern),data=datFern2,family="binomial")


#Effect of fern on fecundity

#What is the effect of ferns?
fit_full1<-glmmTMB(Standardize(GM_Fecundity)~treatment+Standardize(Fern),data=datFern2)

fit_full2<-glmmTMB(Standardize(GM_Fecundity)~treatment,data=datFern2)
anova(fit_full1,fit_full2) 

#What is the effect of Treatment? 
fit_full2<-glmmTMB(Standardize(GM_Fecundity)~treatment,data=datFern2)
fit_full3<-glmmTMB(Standardize(GM_Fecundity)~1,data=datFern2)
anova(fit_full2,fit_full3)

summary(fit_full1)
summary(fit_full2)
#Fern not significant here. 
```

#Redoing survival in maple treatment
```{r}
datM<-dat2 %>% filter(treatment=="m")
datM$Maple_Survival<-as.factor(datM$Maple_Survival)
#Standardizing things.
datM$Fern<-Standardize(datM$Fern)
datM$Maple_TotalLeafArea_End<-Standardize(datM$Maple_TotalLeafArea_End)
datM$ThripsDam<-Standardize(datM$ThripsDam)
datM$BlackPathDam<-Standardize(datM$BlackPathDam)

#Modeling random effects. 

#gh_bench?
fit<-glmmTMB(Bolt_Survival~Maple_TotalLeafArea_End+Fern+ThripsDam*BlackPathDam*WhiteFungLogis+(1|gh_bench)+(1|Col_Field)+(1|Row_Field),data=datM,family="binomial")
fit2<-glmmTMB(Bolt_Survival~Maple_TotalLeafArea_End+Fern+ThripsDam*BlackPathDam*WhiteFungLogis+(1|Col_Field)+(1|Row_Field),data=datM,family="binomial")
anova(fit,fit2) # No

#field row?
fit<-glmmTMB(Bolt_Survival~Maple_TotalLeafArea_End+Fern+ThripsDam*BlackPathDam*WhiteFungLogis+(1|Col_Field)+(1|Row_Field),data=datM,family="binomial")
fit2<-glmmTMB(Bolt_Survival~Maple_TotalLeafArea_End+Fern+ThripsDam*BlackPathDam*WhiteFungLogis+(1|Col_Field),data=datM,family="binomial")
anova(fit,fit2) #No

#field col?
fit<-glmmTMB(Bolt_Survival~Maple_TotalLeafArea_End+Fern+ThripsDam*BlackPathDam*WhiteFungLogis+(1|Col_Field),data=datM,family="binomial")
fit2<-glmmTMB(Bolt_Survival~Maple_TotalLeafArea_End+Fern+ThripsDam*BlackPathDam*WhiteFungLogis,data=datM,family="binomial")
anova(fit,fit2)# no

###Fixed effects 

#IS there an effect of pathogens
fit0.1<-glmmTMB(Bolt_Survival~Standardize(Maple_TotalLeafArea_End)+Standardize(Fern)+ThripsDam*BlackPathDam*WhiteFungLogis,data=datM,family="binomial")

fit2<-update(fit0.1,~.-ThripsDam:BlackPathDam:WhiteFungLogis)
anova(fit0.1,fit2) #Not a significant three way interaction.

fit3<-update(fit2,~.-BlackPathDam:WhiteFungLogis)
anova(fit3,fit2) #There is not a significant two way interaction. 

fit4<-update(fit3,~.-BlackPathDam:ThripsDam)
anova(fit4,fit3)
#There a significant interaction between black path dam and thrips dam. 

fit5<-update(fit4,~.-WhiteFungLogis:ThripsDam)
anova(fit5,fit4) #There is not a significant whitefung dam and thrips dam interaction. 

#Adding interaction back in
fit6<-update(fit5,~.+BlackPathDam:ThripsDam) #It is significant. 
summary(fit6)

#Is fern significant? 
fit6<-glmmTMB(Bolt_Survival ~ Standardize(Maple_TotalLeafArea_End) + Standardize(Fern) +  
    ThripsDam + BlackPathDam + WhiteFungLogis + ThripsDam:BlackPathDam,data=datM[!is.na(datM$Fern),],family="binomial")

fit7<-glmmTMB(Bolt_Survival ~ Standardize(Maple_TotalLeafArea_End) + 
    ThripsDam + BlackPathDam + WhiteFungLogis + ThripsDam:BlackPathDam,data=datM[!is.na(datM$Fern),],family="binomial")

anova(fit6,fit7) #Yes. 

#Is white path dam significant? 
fit6<-glmmTMB(Bolt_Survival ~ Standardize(Maple_TotalLeafArea_End) +WhiteFungLogis+ Standardize(Fern) +  
    ThripsDam + BlackPathDam  + ThripsDam:BlackPathDam,data=datM[!is.na(datM$WhiteFungLogis),],family="binomial")

fit7<-glmmTMB(Bolt_Survival ~ Standardize(Maple_TotalLeafArea_End) + Standardize(Fern) +  
    ThripsDam + BlackPathDam  + ThripsDam:BlackPathDam,data=datM[!is.na(datM$WhiteFungLogis),],family="binomial")

anova(fit6,fit7) #No

#Is interaction significant? 
fit6<-glmmTMB(Bolt_Survival ~ Standardize(Maple_TotalLeafArea_End) + Standardize(Fern) +  
    ThripsDam + BlackPathDam  + ThripsDam:BlackPathDam,data=datM[!is.na(datM$WhiteFungLogis),],family="binomial")

fit7<-glmmTMB(Bolt_Survival ~ Standardize(Maple_TotalLeafArea_End) + Standardize(Fern) +  
    ThripsDam + BlackPathDam  ,data=datM[!is.na(datM$WhiteFungLogis),],family="binomial")

anova(fit6,fit7) #yes

##Effect of maple is... 

fit6<-glmmTMB(Bolt_Survival ~ Standardize(Maple_TotalLeafArea_End) + Standardize(Fern) +  
    ThripsDam*BlackPathDam,data=datM[!is.na(datM$Maple_TotalLeafArea_End),],family="binomial")

fit7<-glmmTMB(Bolt_Survival ~  Standardize(Fern) +  
    ThripsDam*BlackPathDam  ,data=datM[!is.na(datM$Maple_TotalLeafArea_End),],family="binomial")

anova(fit6,fit7) #Yes. 

summary(fit6)


```


#Redoing fecundity in maple treatment. 

```{r}
#Model convergence does not allow for fully saturated pathogen model.
#GHeffect
fit<-glmmTMB(Standardize(GM_Fecundity)~Standardize(Maple_TotalLeafArea_End)+Standardize(MapleFinalMass)+ThripsDam+BlackPathDam+WhiteFungLogis+(1|Family)+(1|gh_bench)+(1|Col_Field)+(1|Row_Field),data=datM[!is.na(datM$ChlorA),])
fit2<-glmmTMB(Standardize(GM_Fecundity)~Standardize(Maple_TotalLeafArea_End)+Standardize(MapleFinalMass)+ThripsDam+BlackPathDam+WhiteFungLogis+(1|Family)+(1|Col_Field)+(1|Row_Field),data=datM[!is.na(datM$ChlorA),])
anova(fit,fit2) #no

#Field row
fit<-glmmTMB(Standardize(GM_Fecundity)~Standardize(Maple_TotalLeafArea_End)+Standardize(MapleFinalMass)+ThripsDam+BlackPathDam+WhiteFungLogis+(1|Family)+(1|Col_Field)+(1|Row_Field),data=datM[!is.na(datM$ChlorA),])
fit2<-glmmTMB(Standardize(GM_Fecundity)~Standardize(Maple_TotalLeafArea_End)+Standardize(MapleFinalMass)+ThripsDam+BlackPathDam+WhiteFungLogis+(1|Family)+(1|Col_Field),data=datM[!is.na(datM$ChlorA),])
anova(fit,fit2) #no

#Field col
fit<-glmmTMB(Standardize(GM_Fecundity)~Standardize(Maple_TotalLeafArea_End)+Standardize(MapleFinalMass)+ThripsDam+BlackPathDam+WhiteFungLogis+(1|Family)+(1|Col_Field),data=datM[!is.na(datM$ChlorA),])
fit2<-glmmTMB(Standardize(GM_Fecundity)~Standardize(Maple_TotalLeafArea_End)+Standardize(MapleFinalMass)+ThripsDam+BlackPathDam+WhiteFungLogis+(1|Family),data=datM[!is.na(datM$ChlorA),])
anova(fit,fit2) #No

#Family
fit<-glmmTMB(Standardize(GM_Fecundity)~Standardize(Maple_TotalLeafArea_End)+Standardize(MapleFinalMass)+ThripsDam+BlackPathDam+WhiteFungLogis+(1|Family),data=datM[!is.na(datM$ChlorA),])
fit2<-glmmTMB(Standardize(GM_Fecundity)~Standardize(Maple_TotalLeafArea_End)+Standardize(MapleFinalMass)+ThripsDam+BlackPathDam+WhiteFungLogis,data=datM[!is.na(datM$ChlorA),])
anova(fit,fit2) #No

###Fixed effects 

#IS there an effect of pathogens
fit0.1<-glmmTMB(Standardize(GM_Fecundity)~Standardize(Maple_TotalLeafArea_End)+Standardize(MapleFinalMass)+Standardize(Fern)+ThripsDam*BlackPathDam*WhiteFungLogis,data=datM)

fit2<-update(fit0.1,~.-ThripsDam:BlackPathDam:WhiteFungLogis)
anova(fit0.1,fit2) #Yes... a significant three way interaction.


# is fern significant? 
fit7<-glmmTMB(Bolt_Survival~Standardize(Maple_TotalLeafArea_End)+Standardize(MapleFinalMass)+Standardize(Fern)+ThripsDam*BlackPathDam*WhiteFungLogis,data=datM)
fit8<-glmmTMB(Bolt_Survival~Standardize(Maple_TotalLeafArea_End)+Standardize(MapleFinalMass)+ThripsDam*BlackPathDam*WhiteFungLogis,data=datM)
anova(fit8,fit7) #Yes.

# IS initial Maple size?
fit7<-glmmTMB(Bolt_Survival~Standardize(Maple_TotalLeafArea_End)+Standardize(MapleFinalMass)+Standardize(Fern)+ThripsDam*BlackPathDam*WhiteFungLogis,data=datM[!is.na(datM$Maple_TotalLeafArea_End),])
fit8<-glmmTMB(Bolt_Survival~Standardize(MapleFinalMass)+Standardize(Fern)+ThripsDam*BlackPathDam*WhiteFungLogis,data=datM[!is.na(datM$Maple_TotalLeafArea_End),])
anova(fit8,fit7) #Yes.

# IS final Maple size?
fit7<-glmmTMB(Bolt_Survival~Standardize(Maple_TotalLeafArea_End)+Standardize(MapleFinalMass)+Standardize(Fern)+ThripsDam*BlackPathDam*WhiteFungLogis,data=datM[!is.na(datM$MapleFinalMass),])
fit8<-glmmTMB(Bolt_Survival~Standardize(Maple_TotalLeafArea_End)+Standardize(Fern)+ThripsDam*BlackPathDam*WhiteFungLogis,data=datM[!is.na(datM$MapleFinalMass),])
anova(fit8,fit7) #No.

#Reassessing....Is the three-way interaction significant?

fit9<-update(fit8,~.-ThripsDam:BlackPathDam:WhiteFungLogis)
anova(fit9,fit8) #Yes... a significant three way interaction.


summary(fit8)


```







