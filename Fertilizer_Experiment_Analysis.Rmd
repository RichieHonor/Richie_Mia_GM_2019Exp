---
title: "Fertilizer_Experiment_Analysis"
author: "Richard Honor"
date: "09/03/2020"
output: html_document
---


```{r}
library(ggplot2)
#library(plyr)
library(dplyr)

Final<-read.csv("Data_Moities/FertilizerExperiment/FertilizerSynthesis.csv")


#Checking to see if all those that died were removed from experiment
table(Final$comp_number)

Check<-Final %>% group_by(Tag) %>% summarize(comp_number=first(comp_number))


#No, I did not remove the competitors with individuals that died. I also gave the wrong number in the report!!! shit. it isnt 152, it is 76. Correct this.

#Individuals with only one competitiors in the GM treatment. These are to be removed. 
deadNeighbour<-names(table(Check$comp_number)[table(Check$comp_number)<2])


#removing those with dead competitors from the analysis. 
Final %>% filter(comp_number %in% deadNeighbour)
Final<-Final %>% filter(!comp_number %in% deadNeighbour)

#Check to ensure I did this correctly
table(Final$comp_number)#looks good. 

#some maples were not properly identified
Final[Final$treatment=="m" & is.na(Final$Maple_Area_sum_End),]
#Two individuals were not properly identified. ... let us see
#I cannot find these maples in either files, perhaps i missed. them. In any case, they will be excluded from the anlaysis as well. 

MapleTreat<-Final[Final$treatment=="m",]
OtherTreat<-Final[Final$treatment!="m",]

#Removing those with maples that have no 
MapleTreatRM<-MapleTreat[!is.na(MapleTreat$Maple_Area_sum_End)&MapleTreat$Maple_Area_sum_End!=0,] #That removed about half of the observations :(


#Now creating data frame with those with competitors that died in the experiment removed. 
Final<-bind_rows(MapleTreatRM,OtherTreat)

#Creating dataframe with replication at the genotype level
dat2<-Final %>% group_by(ID) %>% summarize(Tag=first(Tag),treatment=first(treatment),Fert=first(Fert),Family=first(Family))

```


#Generating table of sample size. 
```{r}

dat2$TreatFert<-paste(dat2$treatment,dat2$Fert,sep="_")

# Creating sample size table
repTable<-dat2 %>% group_by(Family,TreatFert) %>% summarize(SampleSize=n())


#Making the table into a wide format
repTableWide<-repTable %>% pivot_wider(names_from = TreatFert,values_from = SampleSize)

repTableWide

#Discerning sample size across genotype and treatment
apply(repTableWide[,-1],2,sum,na.rm = T)
apply(repTableWide[-1],1,sum,na.rm = T)


##Adding a column for total sample size per genotype
repTableWide$Total<-repTableWide$a+repTableWide$gm+repTableWide$m

##Ordering the data set.  
repTableWide<-repTableWide[order(repTableWide$Total,decreasing = T),]



repTableWide
##Printing table. 
#write.csv(repTableWide,"SampleSize.csv")
#write.csv(GenotypeLocation,"GenotypeLocation.csv")

```

#Modelling glucosinolate concentration. 
```{r}
library(glmmTMB)
#Modelling random effect of Tag (accounting for leaf psuedoreplication)

fit<-glmmTMB(gluc_Conc~treatment*Fert+ChlorA+GM_Leaf_Area+Family+(1|Tag),data=Final)
fit2<-glmmTMB(gluc_Conc~treatment*Fert+ChlorA+GM_Leaf_Area+Family,data=Final)
anova(fit,fit2)#Tag is not a significant predictor of glucosinolate concentration.I will therefore not account for it. 

#Modelling fixed effects

fit<-lm(gluc_Conc~treatment*Fert+ChlorA+GM_Leaf_Area+Family,data=Final)
fit2<-lm(gluc_Conc~treatment+Fert+ChlorA+Family+GM_Leaf_Area,data=Final)
fit3<-lm(gluc_Conc~treatment+Fert+Family+GM_Leaf_Area,data=Final)
fit4<-lm(gluc_Conc~Fert+ChlorA+Family+GM_Leaf_Area,data=Final)
fit5<-lm(gluc_Conc~Fert+ChlorA+GM_Leaf_Area,data=Final)

anova(fit,fit2)#no interaction
anova(fit3,fit2) #ChlorA imporatnt
anova(fit4,fit2) #treatment is not important.
anova(fit5,fit4) #family not important

summary(fit5)
library(car)
vif(fit5) #The correlation between of fertilizer and chlorophyll A are exceptionally high such that there is little difference between the two. Leaf size is very close to having a significant negative effect, however there is not one. 

#Could there be a higher order thing going on?
fit5.5<-lm(gluc_Conc~Fert+ChlorA+GM_Leaf_Area+I(GM_Leaf_Area^2),data=Final)
summary(fit5.5)#no there isnt.

fit6<-lm(gluc_Conc~Fert+ChlorA,data=Final)
anova(fit5,fit6) #Leaf size is significant.

fit6<-lm(gluc_Conc~ChlorA+GM_Leaf_Area,data=Final)
fit7<-lm(gluc_Conc~Fert+GM_Leaf_Area,data=Final)
summary(fit6)
summary(fit7)
#ChlorA and fertilizer are correlated and are essentially sharing the effect on glucosinolates completely


```

#Modelling Flavonoid concentration. 
```{r}
library(glmmTMB)
#Modelling random effect of Tag (accounting for leaf psuedoreplication)

fit<-glmmTMB(flav_Conc~treatment*Fert+ChlorA+GM_Leaf_Area+Family+(1|Tag),data=Final)
fit2<-glmmTMB(flav_Conc~treatment*Fert+ChlorA+GM_Leaf_Area+Family,data=Final)
anova(fit,fit2)
#Tag is not a significant predictor of glucosinolate concentration.I will therefore not account for it. 

#Continuing model to determine what determines leaf glucosinoalte concentration... 

#Modelling fixed effects

fit<-lm(flav_Conc~treatment*Fert+ChlorA+GM_Leaf_Area+Family,data=Final)
fit2<-lm(flav_Conc~treatment+Fert+ChlorA+Family+GM_Leaf_Area,data=Final)
fit3<-lm(flav_Conc~treatment+Fert+Family+GM_Leaf_Area,data=Final)
fit4<-lm(flav_Conc~Fert+ChlorA+Family+GM_Leaf_Area,data=Final)
fit5<-lm(flav_Conc~Fert+ChlorA+GM_Leaf_Area,data=Final)

anova(fit,fit2)#no interaction
anova(fit3,fit2) #ChlorA imporatnt
anova(fit4,fit2) #treatment is not important.
anova(fit5,fit4) #family not important

summary(fit5)
vif(fit5) #The correlation between of fertilizer and chlorophyll A are exceptionally high such that there is little difference between the two. Leaf size is very close to having a significant negative effect, however there is not one. 

#Could htere be a higher order thing going on?
fit5.5<-lm(flav_Conc~Fert+ChlorA+GM_Leaf_Area+I(GM_Leaf_Area^2),data=Final)
summary(fit5.5)#no there isnt.

fit6<-lm(flav_Conc~Fert+ChlorA,data=Final)
anova(fit5,fit6) #Leaf size is not significant, although it is very close (p=0.056, because it is significant above, i will keep it in the model because i am confident this effect is not random. )
summary(fit6)


fit6<-lm(flav_Conc~ChlorA+GM_Leaf_Area,data=Final)
fit7<-lm(flav_Conc~Fert+GM_Leaf_Area,data=Final)
summary(fit6)
summary(fit7)
#ChlorA and fertilizer are correlated and are essentially sharing the effect on flavonoid concentration completely


```


#Modelling Fitness  
```{r}
library(glmmTMB)
#Need to remove psuedoreplication, as there is no replication in shootmass here. 

Final2<-Final %>% group_by(Tag) %>% summarize(treatment=first(treatment),Family=first(Family),Fert=first(Fert),GM_Shoot_Mass=first(GM_Shoot_Mass),ChlorA=mean(ChlorA))

fit<-lm(GM_Shoot_Mass~treatment*Fert+Family,data=Final2)
fit2<-lm(GM_Shoot_Mass~treatment+Fert+Family,data=Final2)
fit3<-lm(GM_Shoot_Mass~treatment*Fert,data=Final2)

anova(fit,fit2)#There is an interaction
anova(fit3,fit) #Family is not imporatnt


summary(fit3)

#Where do the differences lie? 

TukeyHSD(aov(fit3))
#GM is significantly different than the maple and alone treatment when fertilizer is present. 
# GM is not significant different than maple or alone when there is not fertilizer present.

#Is there significance, however, if we look at only those without fertilizer?
summary(lm(GM_Shoot_Mass~treatment,data=Final2[Final2$Fert=="n",]))

#Infact, there is a reduction of about 50% bodymass in the garlic mustard treatment, therefore, an effect wasnt found above simply because of the scale of the variables in the no fertilizer treatment compared to the fertilizer treatment. 
```

There is an effect on body size of GM  when fertilizer is added, but not when it isnt. This suggests that competition between GM is mediated mainly by water and sunlight, not by nutrients. This is because there is no treatment effect when fertilizer is not present, suggesting that when there is limiting nutrients, comeptition between garlic mustard does not have a significant effect on fitness. However, when nutrients are limiting, competition between garlic mustard is very intense, despite the available nutrients. This could be because the nutrient surplus has allowed garlic mustard to grow very large and compete for water and sunlight. Further evidence that the deficit is not nutrient related is that there were no treatment effects for chlorophyll A , glucosinolates or flavonoids, which are all correlated strongly with fertilizer application. There is actually an effect of treatment in the no fertilizer treament as well. This suggests that when nutrients are not limiting, competition is for water and light.


#Visualizing 
```{r}
#Effect of treatment
ggplot(Final)+
  geom_point(aes(x=treatment,y=GM_Shoot_Mass,colour=Fert,shape=Family))
ggplot(Final)+
  geom_point(aes(x=treatment,y=gluc_Conc,colour=Fert,shape=Family))
ggplot(Final)+
  geom_point(aes(x=treatment,y=flav_Conc,colour=Fert,shape=Family))


#interestingly, garlic mustard plants had the highest glucosinolate expression in the gm treatment with fertilizer, but this did not translate to a change in final biomass for the genotype. 

Final[Final$GM_Shoot_Mass==max(Final$GM_Shoot_Mass,na.rm = T),]


table(Final$comp_number)
```

#Visualizing for publication - Body mass and Chlorphyll by treatment and fertilizer. 
```{r}
source("GGPlot_Themes.R")

#Body Mass figure. 
tiff("Fertilizer_Figures/BodyMass.tiff", units="in", width=10, height=6, res=300)
ggplot(Final2)+
  geom_boxplot(aes(x=Fert,y=GM_Shoot_Mass,fill=treatment))+theme_simple()+
  ylab("Shoot Mass (g)")+
  #scale_y_continuous(breaks = seq(0,5,0.25))+
scale_x_discrete(name="",labels=c("No Amendment","Fertilizer"))+
  scale_fill_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Garlic Mustard","Maple"))+
  theme(axis.title.y =  element_text(color = "black", size = 16, face = "bold",margin=margin(3,20,3,0)))
dev.off()
#Chlorophyll A figure. 

tiff("Fertilizer_Figures/Chlorophyll.tiff", units="in", width=10, height=6, res=300)
ggplot(Final)+
  geom_boxplot(aes(x=Fert,y=ChlorA,fill=treatment))+theme_simple()+
  ylab(bquote(bold("[Chlorophyll A]"~(ug/ml))))+
  scale_y_continuous(breaks = seq(0,5,0.25))+
scale_x_discrete(name="",labels=c("No Amendment","Fertilizer"))+
  scale_fill_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Garlic Mustard","Maple"))+
  theme(axis.title.y =  element_text(color = "black", size = 16, face = "bold",margin=margin(3,20,3,0),angle=90))
dev.off()

#Glucosinolate Figure
tiff("Fertilizer_Figures/Glucosinolate.tiff", units="in", width=10, height=6, res=300)
ggplot(Final)+
  geom_boxplot(aes(x=Fert,y=gluc_Conc,fill=treatment))+theme_simple()+
  ylab(bquote(bold("[Total Glucosinolate]"~(mg/ml))))+
  scale_y_continuous(breaks = seq(0,5,0.25),)+
scale_x_discrete(name="",labels=c("No Amendment","Fertilizer"))+
  scale_fill_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Garlic Mustard","Maple"))+
  theme(axis.title.y =  element_text(color = "black", size = 16, face = "bold",margin=margin(3,20,3,0),angle = 90))
dev.off()


#Flavonoid Figure
tiff("Fertilizer_Figures/Flavonoid.tiff", units="in", width=10, height=6, res=300)
ggplot(Final)+
  geom_boxplot(aes(x=Fert,y=flav_Conc,fill=treatment))+theme_simple()+
  ylab(bquote(bold("[Total Flavonoid]"~(mg/ml))))+
  scale_y_continuous(breaks = seq(0,5,0.25),)+
scale_x_discrete(name="",labels=c("No Amendment","Fertilizer"))+
  scale_fill_manual(values=c("#009E73","#56B4E9","#E69F00"),labels=c("Alone","Garlic Mustard","Maple"))+
  theme(axis.title.y =  element_text(color = "black", size = 16, face = "bold",margin=margin(3,20,3,0),angle = 90))
dev.off()


#There is a weird genotype there. 
min(Final$GM_Shoot_Mass[Final$Fert=="y"])
Final[Final$GM_Shoot_Mass==min(Final$GM_Shoot_Mass[Final$Fert=="y"]),]
```



Had much higher maple mortality. Competition is much higher in the GM treatment whent there are available nutrients. This could be because competition then comes for water or sunlight (like lonnie's paper would suggest). 
Most interesting here is that there is an effect of treatment on size when fertilizer is added, but not when it isnt. This suggests that competition between GM is mediated (is for) mainly by water and sunlight, not by nutrients. 

#Estimating coefficients. 
```{r}
fit1<-lm(gluc_Conc~Fert,data=Final)
fit2<-lm(flav_Conc~Fert,data=Final)
fit3<-lm(ChlorA~Fert,data=Final)
summary(fit1)
summary(fit2)
summary(fit3)

1-(1.005-0.081)/1.005

1-(1.005-0.085)/1.005

1-(0.869-0.046)/0.869
1-(0.869-0.110)/0.869



1-(0.388-0.095 )/0.388
1-(0.388-0.092 )/0.388
1-(0.388+0.846 )/0.388

```



GM appears to be in more competition with itself, but interestingly the amount of glucosinolates do not share the same reduction. Could this mean that apparent plasticity is not at play here and true plasticity is based on the lack of change in glucosinolate concentration, despite the change in biomass?!?! 


The same could be true with the weak negative correlation between glucosinote and leaf size, could those in the garlic mustard experiment be purposefully trying to increase the expression of glucosinolates? I think another study found that the self toxic effects of Glucosinolates may be more harmful than the effects on other species... idk. 






