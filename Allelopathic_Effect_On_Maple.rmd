---
title: "Competitive Ability and the influence of glucosinolates and flavonols"
author: "Richard Honor"
date: "31/03/2020"
output: html_document
---


#Read in and prep data
```{r}
library(ggplot2)
library(dplyr)
library(car)
library("glmmTMB")


#read in data
rm(list=ls())
dat<-read.csv("DataSynthesis.csv")

#remove those with fertilizer treatment, and extra genotypes that are only in the alone treatment. 
dat<-dat[!grepl("i",dat$Sample,fixed=T),]


#Function to weigh pathogen damage by leaf area. 
Weigh<-function(x){
  x/(dat$GM_Leaf_Len*dat$GM_Leaf_Wid)
}

#Function to standardize data.
Standardize<-function(x){
  standard<-(x-mean(x,na.rm=T))/sd(x,na.rm=T)
}

dat$BlackPathDamW<-Weigh(dat$BlackPathDam)
dat$ThripsDamW<-Weigh(dat$ThripsDam)
dat$WhiteFungDamW<-Weigh(dat$WhiteFungDam)


#Logging pathogen damage data variables as they are very skewed. 
dat$BlackPathDamW<-log(dat$BlackPathDamW+abs(min(dat$BlackPathDamW,na.rm=T)+1))
dat$ThripsDamW<-log(dat$ThripsDamW+abs(min(dat$ThripsDamW,na.rm=T)+1))
dat$Fern<-log(dat$Fern+1)
dat$gluc_Conc<-log(dat$gluc_Conc)
dat$flav_Conc<-log(dat$flav_Conc)
dat$ChlorA<-log(dat$ChlorA)
dat$ThripsDam<-log(dat$ThripsDam+1)
dat$BlackPathDam<-log(dat$BlackPathDam+1)


#Calculating leaf area 
dat$GM_Leaf_Area<-dat$GM_Leaf_Wid*dat$GM_Leaf_Len


#Average Duplicates. 
dat2<-dat %>% select(-X) %>% group_by(Tag) %>%  summarize(gh_col=first(gh_col),gh_bench=first(gh_bench),treatment=first(treatment),GA3=first(GA3),Family=first(Family),Maple_StemHeight_End=mean(Maple_StemHeight_End),Maple_LeafNum_End=mean(Maple_LeafNum_End),maple_leaf_length_0=mean(maple_leaf_length_0),maple_leaves_0=mean(maple_leaves_0),Maple_TotalLeafArea_End=mean(Maple_TotalLeafArea_End),MapleDamage=mean(Maple_Damage_End),Fern=first(Fern),gluc_Conc=mean(gluc_Conc),flav_Conc=mean(flav_Conc),maple_height_0=mean(maple_height_0),ChlorA=mean(ChlorA), GM_TotalLeaf_Area=first(GM_TotalLeaf_Area),ThripsDam=mean(ThripsDam),BlackPathDam=mean(BlackPathDam),WhiteFungDam=mean(WhiteFungDam),BlackPathDamW=mean(BlackPathDamW),ThripsDamW=mean(ThripsDamW),WhiteFungDamW=mean(WhiteFungDamW),comp_number=first(comp_number),GM_Leaf_Area=mean(GM_Leaf_Area))


#Converting white fungal damage to logistic. 
dat2$WhiteFungLogis<-NA
dat2$WhiteFungLogis[dat2$WhiteFungDam>0]<-"Yes"
dat2$WhiteFungLogis[dat2$WhiteFungDam==0]<-"No"



```

#Creating a maple dataframe. 
```{r}

#Creating a maple data frame
Maple<-dat2[dat2$treatment=="m"|dat2$treatment=="mcnt",]


Maple[is.na(Maple$Maple_StemHeight_End),]

#b|EFCC2-4-80|Q|144 and f|JBCHY1-1-50|Q|247,e|CBMCK1-1-0|N|49, e|JWBOY-2-80|Q|264 are simply not in the datafile. Nothing to do there - they will be deleted from the analyis. These genotypes are either dead, or we missed them when conducting the sampling.
Maple<-Maple[!is.na(Maple$Maple_StemHeight_End),]
Maple$treatment<-factor(Maple$treatment,levels = c("m","mcnt"))


#Correcting an error of initial maple height. A height of 8 is not possible. changing to 80 as this is a likely typo. 
Maple$maple_height_0[Maple$maple_height_0==8]<-80


min(Maple$maple_height_0)

max(Maple$maple_height_0)
hist(Maple$maple_height_0,breaks = 20)



```

#Maple PCA 
```{r}
#PCA values are based on the standard deviations of the variables included in the analysis. Therefore, it is neccessairy to scale the variables before using them in a PCA. Variables with high SD will have more weight in constructing the loadings than a variable with a low SD. I need all variables to have the same standard deviation. 


#Selecting variables to use in the PCA (All initial and final maple measurements which could indicate performance)
PCAMaple<-Maple %>% select(maple_height_0,maple_leaf_length_0,maple_leaves_0,Maple_StemHeight_End,Maple_LeafNum_End,Maple_TotalLeafArea_End)

#Standardizing all variables.
PCAMaple<-data.frame(apply(PCAMaple,2,Standardize))

#---------------
#Performing model 
#---------------

#Model with everything
pcaModelTotal<-prcomp(PCAMaple)

#All variables go in the same direction.
biplot(pcaModelTotal)

#40% of the variation in the data is explained in the first PCA. 
summary(pcaModelTotal)

#All variables are correlated with the PC1 loading. 
plot(predict(pcaModelTotal)[,1]~PCAMaple$Maple_TotalLeafArea_End)
plot(predict(pcaModelTotal)[,1]~PCAMaple$maple_height_0)
plot(predict(pcaModelTotal)[,1]~PCAMaple$maple_leaf_length_0)
plot(predict(pcaModelTotal)[,1]~PCAMaple$maple_leaves_0)

#Adding in PC1 vales from the pca. This will be used to control for initial maple size in my experiment. 
Maple$PC1Tot<-predict(pcaModelTotal)[,1]

#Removing maple controls (to be used in models that do not include controls) 
MapleModel<-Maple %>% filter(treatment=="m")


```

#Examinging differences in maple performance, while controlling for the initial maple size. 
```{r}



#Modelling
fitTreat<-lm(Maple_TotalLeafArea_End~PC1Tot+treatment,data=Maple)
summary(fitTreat) #This is highly significant effect of treatment.... 

fitTreatInt<-lm(Maple_TotalLeafArea_End~PC1Tot*treatment,data=Maple)
anova(fitTreat,fitTreatInt)#The interaction term is on the edge of significance.  
summary(fitTreatInt)



slopeComp<-function(x){
  y=1317.2*x+4844.0
  return(y)
}
Comp<-Maple$PC1Tot[Maple$treatment=="m"]
xComp<-seq(min(Comp),max(Comp),length.out = 194)

slopeCnt<-function(x){
  y=(1317.2+486.8)*x+4844.0+1309.9
  return(y)
}
Cnt<-Maple$PC1Tot[Maple$treatment=="mcnt"]
xCnt<-seq(min(Cnt),max(Cnt),length.out = 194)


source("GGPlot_Themes.R")

tiff("Maple_Figures/Maple_Control.tiff", units="in", width=10, height=6, res=300)
ggplot()+
  geom_point(aes(y=Maple$Maple_TotalLeafArea_End,x=Maple$PC1Tot,colour=Maple$treatment))+
  geom_path(aes(x=xCnt,y=slopeCnt(xCnt)),colour="black",size=1)+
  geom_path(aes(x=xComp,y=slopeComp(xComp)),colour="#E69F00",size=1)+
    scale_colour_manual(values=c("#E69F00", "black"),labels=c("Interspecific","Maple Alone"))+
  scale_y_continuous(breaks=seq(0,20000,2500))+
  scale_x_continuous(breaks=seq(-3,5,1))+

  theme_simple()+
  ylab(bquote(bold("Total Leaf Area"~(mm^2))))+
  xlab("Initial Size (PC1)")
dev.off()

#The conclusion is that, not only are maples in the mcnt treatment have higher fitness after controlling for differences in initial size, they also exhibit increased growth at a given body size. 
```



#Modelling no tweedie distribution
Normal distribution fits well enough, is much easier to interpret and does not change the outcome of the model. 
```{r}
fitTw1<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot*gluc_Conc+MapleDamage, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
summary(fitTw1) #The interaction is not important, but glucosinolate concentration and maple damage are. 

fitTw2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+gluc_Conc+MapleDamage, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
summary(fitTw2)
anova(fitTw1,fitTw2) #Interaction not significant


fitTw2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+gluc_Conc+ChlorA+MapleDamage, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
summary(fitTw2)


#Garlic mustard size doesnt even appear to effect maple. 
fitTw2<-glmmTMB(Standardize(Maple_TotalLeafArea_End)~PC1Tot+gluc_Conc+ChlorA+MapleDamage+GM_TotalLeaf_Area, data=MapleModel[!is.na(MapleModel$gluc_Conc),])

summary(fitTw2)
```



#Visualizing effect of glucosinolates on maple performance. 
```{r}
source("GGPlot_Themes.R")
fitTw2<-glmmTMB(Maple_TotalLeafArea_End~Standardize(PC1Tot)+gluc_Conc+Standardize(MapleDamage), data=MapleModel[!is.na(MapleModel$gluc_Conc),])
summary(fitTw2)

#ChlorA Slope
fitTw2<-glmmTMB(Maple_TotalLeafArea_End~Standardize(PC1Tot)+ChlorA+Standardize(MapleDamage), data=MapleModel)
summary(fitTw2)

glucSlope<-function(x){
  y=-1338.5  *x+2282.3 #Non significant slope
  return(y)
}
minG<-min(MapleModel$gluc_Conc,na.rm = T)
maxG<-max(MapleModel$gluc_Conc,na.rm = T)

chlorSlope<-function(x){
  y= -1751.0  *x+2307.9  #Non significant slope
  return(y)
}

minC<-min(MapleModel$ChlorA,na.rm = T)
maxC<-max(MapleModel$ChlorA,na.rm = T)



a<-ggplot(MapleModel)+
  geom_point(aes(y=Maple_TotalLeafArea_End,x=gluc_Conc),colour="#E69F00")+
    geom_segment(x=minG,xend=maxG,y=glucSlope(minG),yend=glucSlope(maxG),colour="black",size=1.5)+
  scale_y_continuous(breaks=seq(0,20000,2500))+
   scale_x_continuous(breaks=seq(-3,0,0.25))+
  theme_simple_multiCol_First()+
  ylab(bquote(bold("Total Leaf Area "*(mm^2))))+
  xlab(bquote(bold("[Total Glucosinolate] (log" (mg/ml)*")")))

b<-ggplot(MapleModel)+
  geom_point(aes(y=Maple_TotalLeafArea_End,x=ChlorA),colour="#E69F00")+
  geom_segment(x=minC,xend=maxC,y=chlorSlope(minC),yend=glucSlope(maxC),colour="black",size=1.5)+
  scale_y_continuous(breaks=seq(0,20000,2500))+
 scale_x_continuous(breaks=seq(-3,0,0.5))+
  theme_simple_multiCol()+
  ylab(bquote(bold("Total Leaf Area "~(mm^2))))+
  xlab(bquote(bold("[Chlorophyll A] (log"(μg/ml)*")")))

plots <- align_plots(a, b,align="hv")



tiff("Maple_Figures/Maple_Inhibition_gluc_Chlor.tiff", units="in", width=12, height=6, res=300)
plot_grid(plots[[1]],plots[[2]],ncol=2,rel_widths=c(1,1),rel_heights = c(1,1),labels = c("a","b"),label_fontfamily = "Arial",label_size = 18)
dev.off()

```




#Is there evidence that those in the maple and garlic mustard treatment have the same relationship between glucosinolate and chlorA? If glucosinolates are truly beneficial in one treatment but not in another, we might expect for the relationship between glucosinolates and ChlorA to be stronger in the treatment in which glucosinolates are beneficial. This is because if those that create more chlorophyll a passively allocate more resources to glucosinolates, this relationship may be a weaker relationship than if glucosinolates are increasing fitness and allowing an increased allocation to chlrophyll A. 
```{r}
fit<-lm(gluc_Conc~ChlorA*treatment,data=dat)
fit2<-lm(gluc_Conc~ChlorA+treatment,data=dat)
anova(fit,fit2)
#There is not a significant interaction when logged data are used...... This figure is now obsolete. 
summary(fit)
summary(fit2)
 
 
datplot<-dat %>% filter(treatment!="mcnt")
datplot$treatment<-droplevels.factor(datplot$treatment)

source("GGPlot_Themes.R")
tiff("Other_Figures/Gluc_Chlor*trement_Cor.tiff", units="in", width=10, height=6, res=300)
ggplot(datplot)+
  geom_point(aes(x=ChlorA,y=gluc_Conc,colour=treatment))+
  geom_abline(slope = 0.37585,intercept = 0.85057,colour="#009E73",size=1)+#alone
  geom_abline(slope = 0.37585+0.20463,intercept = 0.85057-0.09106,colour="#56B4E9",size=1)+#gm
  geom_abline(slope = 0.37585+0.18856,intercept = 0.85057-0.09837,colour="#E69F00",size=1)+#maple
  scale_colour_manual(values=c("#009E73","#56B4E9","#E69F00","black"),labels=c("Alone","Garlic Mustard","Maple"))+
  ylab(bquote(bold("[Glucosinolate] "(mg/ml))))+
  xlab(bquote(bold("[Chlorophyll A] "(μg/ml))))+
  theme_simple()
dev.off()

#This demonstrates that the relationship between glucosinolate and chlorophyll is steeper in the treatments with competition. Therefore, there may be a benefit to producing glucosinolates in the competition treatments? Those with high glucosinolates in the maple treatment have higher chlorophyll levels than those with high glucosinolates in the alone treatment. In other words, those in the competition treatment have lower levels of chlorophyll at low levels of glucosinolates, and have higher level of chlorphyll at higher levels of glucosinolates. In other words (again) glucosinolates may be increasing performance in the competition treatments. 
```


#Effect of maple on GM performance. 
I chose to seperate this model from the last due to the causality inherent in this data. Glucosinolate concentration should affect garlic mustard fitness only through effects on maple and pathogen abundance. Including glucosinolate concentration in a model with both of these variables to determien the effect of glucosinolates on fitness is actually determining how much glucosinolates affect fitness when these terms are controlled for, which should be not at all. Therefore multiple models are needed to test if glucosinolates influence abundance of pathogens and maple performance, after controlling for garlic mustard performance (Using chlorophyll A, because those with high performance might simply be making more glucosinolates). Then i can see how much maple and pathogens influence garlic mustard performance. 
```{r}
#ThripsDam and BlackPathDam represent standardized, logged data which are weighed by leaf size. 
MapleModel$GM_Leaf_Area<-Standardize(MapleModel$GM_Leaf_Area)
MapleModel$Maple_TotalLeafArea_End<-Standardize(MapleModel$Maple_TotalLeafArea_End)

#Modelling random effects 
fit<-glmmTMB(Standardize(GM_TotalLeaf_Area)~Maple_TotalLeafArea_End+Fern+ThripsDam*BlackPathDam*WhiteFungLogis+(1|Family)+(1|gh_bench),data=MapleModel)

fit2<-glmmTMB(Standardize(GM_TotalLeaf_Area)~Maple_TotalLeafArea_End+Fern+ThripsDam*BlackPathDam*WhiteFungLogis+(1|Family),data=MapleModel)

fit3<-glmmTMB(Standardize(GM_TotalLeaf_Area)~Maple_TotalLeafArea_End+Fern+ThripsDam*BlackPathDam*WhiteFungLogis+(1|gh_bench),data=MapleModel)


#Is Bench important? 
anova(fit,fit2) #Yes bench is very important

#Is family important? 
anova(fit,fit3) #Family is on the edge. but i will leave it for now. 

#Modeling fixed effects: 

fit<-glmmTMB(GM_TotalLeaf_Area~Maple_TotalLeafArea_End+Fern+ThripsDam*BlackPathDam*WhiteFungLogis+(1|Family)+(1|gh_bench),data=MapleModel)

fit2<-update(fit,~.-ThripsDam:BlackPathDam:WhiteFungLogis)
anova(fit,fit2) #Not a significant three way interaction.

fit3<-update(fit2,~.-BlackPathDam:WhiteFungLogis)
anova(fit3,fit2) #There is not a significant two way interaction.

fit4<-update(fit3,~.-BlackPathDam:ThripsDam)
anova(fit4,fit3)
#There is no significant interaction between black path dam and thrips dam interaction p=0.06 (very close). 

fit5<-update(fit4,~.-WhiteFungLogis:ThripsDam)
anova(fit5,fit4) #There is not significant white path and thripsdamage interaction.

summary(fit5) #White fungal damage not significant. 


fit6<-glmmTMB(GM_TotalLeaf_Area ~ Maple_TotalLeafArea_End + Fern +  
    ThripsDam + BlackPathDam +(1 | Family)+(1|gh_bench)  ,data= MapleModel)

summary(fit6)

#Thrips is not significant
fit7<-lmer(GM_TotalLeaf_Area ~ Maple_TotalLeafArea_End  +  
    Fern + Standardize(BlackPathDam ) +(1 | Family)+(1|gh_bench)  ,data= MapleModel)

summary(fit7) #Best model. 

#What is the p value of Maple?
fit8<-lmer(GM_TotalLeaf_Area ~    
   +Fern+ Standardize(BlackPathDam ) +(1 | Family)+(1|gh_bench)  ,data= MapleModel)
anova(fit7,fit8)

plot(fit7)
plot(residuals(fit7,type="pearson")~fitted(fit7))
qqnorm(residuals(fit7)) #looks good. 

#Modelling with standardized data to get coefficients.
fit7<-lmer(GM_TotalLeaf_Area ~ Standardize(Maple_TotalLeafArea_End)  +  
    Standardize(Fern) + Standardize(BlackPathDam ) +(1 | Family)+(1|gh_bench)  ,data= MapleModel)
summary(fit7)
```

#Using the best model of what determines fitness in the presense of competitor and pathogens, is there a cost to glucosinolates after holding these values constant? 
```{r}

#Cost of glucosinolates ?
fit7<-glmmTMB(GM_TotalLeaf_Area ~ Standardize(Maple_TotalLeafArea_End)   +  
    ThripsDam + BlackPathDam + (1 | Family) +  
    (1 | gh_bench) + Standardize(GM_Leaf_Area)+gluc_Conc,data=MapleModel)
summary(fit7) #Gluc conc is significantly positive. 


#Cost of Flavonoids ?
#Cost of glucosinolates ?
fit7<-glmmTMB(GM_TotalLeaf_Area ~ Maple_TotalLeafArea_End   +  
    ThripsDam + BlackPathDam + (1 | Family) +  
    (1 | gh_bench) + GM_Leaf_Area+flav_Conc,data=MapleModel)
summary(fit7) #no there is not.
```
I use the log(black path dam) but i do not have it weighted by leaf size. This is because i need to control for the influence that leaf size has on glucoisnolate concentration to avoid the autocorrelation between leaf size and performace (total leaf area)



#Modelling: Negative Binomial- Fern abundance
```{r}
#Because there are two garlic mustard individuals per pot, and the unit we are looking at is only replicable at the pot level (fern abundance in a pot) duplicates within the same pot in the garlic mustard treatment need to be removed and averaged to remove pseudoreplication. 

#What i will do is make the competition number the tag for those in the GM treatment. This will have the effect of maintaining the leaf variation, but averaging it over each pot. 

# I will need to use dat2, summarized at the individual level, because we have a single observation at the pot level, not at the leaf level. 
datFern<-dat2
datFern$Tag<-as.character(datFern$Tag)
for(i in 1:length(datFern$Tag)){
  if(!is.na(datFern$comp_number[i])){
    datFern$Tag[i]<-datFern$comp_number[i]
  }
}
datFern
#I am excluding flavonoid concentration because there were no detectable flavonoids in the root samples. 

#Modelling random effects 

fit_full<-glmmTMB(Fern~treatment+gluc_Conc+ChlorA+(1|Family)+(1|gh_bench),family=nbinom2,data=datFern)

fit_full_0.1<-glmmTMB(Fern~treatment+gluc_Conc+ChlorA+(1|Family),family=nbinom2,data=datFern)

fit_full_0.2<-glmmTMB(Fern~treatment+gluc_Conc+ChlorA+(1|gh_bench),family=nbinom2,data=datFern)

anova(fit_full,fit_full_0.1)#Bench is an extremenly important predictor. 
anova(fit_full,fit_full_0.2)#Family is not. 


fit_full<-glmmTMB(Fern~treatment+gluc_Conc+ChlorA+(1|gh_bench),family=nbinom2,data=datFern[!is.na(datFern$gluc_Conc),])

anova(fit_full,fit_1)#Glucosinolates are not a significant predictor of fern abundance (although the AIC is about the same)

summary(fit_full)
summary(fit_1)
#Using the whole data set...
fit_1<-glmmTMB(Fern~treatment+ChlorA+(1|gh_bench),family=nbinom2,data=datFern)
summary(fit_1)
#those with more ChlorA dont have less ferns. If anything, they have more ferns. It seems ferns are just along for the ride, if the pot is good enough, then ferns will grow.... Interestingly there are more ferns in the competition experiemnet. ...

fit_1<-glmmTMB(Fern~treatment+(1|gh_bench),family=nbinom2,data=datFern)
fit_2<-glmmTMB(Fern~1+(1|gh_bench),family=nbinom2,data=datFern)
anova(fit_2,fit_1)
#Fern abundance is predicted by treatment. 

summary(fit_1)$coef
plot(resid(fit_1))
plot(resid(fit_1)^2)

summary(fit_1)


# #Permutation test
# datPerTest<-datFern
# zStoretreatGM<-c()
# zStoretreatM<-c()
# 
# for(i in 1:500){
#   #Randomize flavonoid concentration.
#   datPerTest$treatment<-sample(datPerTest$treatment,length(datPerTest$treatment),replace = F)
# 
#   #New Model with randomized treatment and flavonoids
#   newMod<-update(fit_1,data=datPerTest)
#   
#   # Extract test statistics for maple (M) and garlic mustard (gm) treatments
#   MtreatZval<-summary(newMod)$coef[[1]][3,3]
#   GMtreatZval<-summary(newMod)$coef[[1]][3,2]
#   
#   #Store z value.
#   zStoretreatGM[i]<-GMtreatZval
#   zStoretreatM[i]<-MtreatZval
# }
# 
# sum(zStoretreatM>=2.316180)/length(zStoretreatM)
# #Estimated p value for the maple treatment is 0.01. This is very close to the actual p value of 0.02
# sum(zStoretreatGM>=2.231574)/length(zStoretreatGM)
# #Estimated p value for the garlic mustard treatment is 0. This is close to the actual p value of 0.02

summary(fit_1)
```

```{r}
ggplot(datFern)+
  geom_col(aes(x=treatment,y=Fern),stat=mean)

tapply(datFern$Fern,datFern$treatment,mean)#Wow....
```


If maples took hold at the end, it would explain why there is less glucosnilates in the treatment than expected, but total leaf area is just as high. This is consistent with the growth rate data and the fact that these were transplant maples 





