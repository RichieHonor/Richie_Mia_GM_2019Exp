---
title: "Competitive Ability and the influence of glucosinolates and flavonols"
author: "Richard Honor"
date: "31/03/2020"
output: html_document
---


#Read in and prep data
```{r}
library(ggplot2)
library(dplyr)
library(car)
library("glmmTMB")
library(cowplot)

#read in data
rm(list=ls())
dat<-read.csv("DataSynthesis.csv")

#remove those with fertilizer treatment, and extra genotypes that are only in the alone treatment. 
dat<-dat[!grepl("i",dat$Sample,fixed=T),]


#Function to standardize data.
Standardize<-function(x,set.sd=F,SD){
  if(set.sd==T){
      standard<-(x-mean(x,na.rm=T))/SD
  }
  else{
     standard<-(x-mean(x,na.rm=T))/sd(x,na.rm=T)
  }
}



#Logging pathogen damage data variables as they are very skewed. 
dat$Fern<-log(dat$Fern+1)
dat$gluc_Conc<-log(dat$gluc_Conc)
dat$flav_Conc<-log(dat$flav_Conc)
dat$ChlorA<-log(dat$ChlorA)
dat$ThripsDam<-log(dat$ThripsDam+1)
dat$BlackPathDam<-log(dat$BlackPathDam+1)


#Calculating leaf area 
dat$GM_Leaf_Area<-dat$GM_Leaf_Wid*dat$GM_Leaf_Len


#Average Duplicates. 
dat2<-dat %>% select(-X) %>% group_by(Tag) %>%  summarize(gh_col=first(gh_col),gh_bench=first(gh_bench),treatment=first(treatment),GA3=first(GA3),Family=first(Family),Maple_StemHeight_End=mean(Maple_StemHeight_End),Maple_LeafNum_End=mean(Maple_LeafNum_End),maple_leaf_length_0=mean(maple_leaf_length_0),maple_leaves_0=mean(maple_leaves_0),Maple_TotalLeafArea_End=mean(Maple_TotalLeafArea_End),MapleDamage=mean(Maple_Damage_End),Fern=first(Fern),gluc_Conc=mean(gluc_Conc),flav_Conc=mean(flav_Conc),maple_height_0=mean(maple_height_0),ChlorA=mean(ChlorA),RGR1=first(RGR1), GM_TotalLeaf_Area=first(GM_TotalLeaf_Area),ThripsDam=mean(ThripsDam),BlackPathDam=mean(BlackPathDam),WhiteFungDam=mean(WhiteFungDam),comp_number=first(comp_number),GM_Leaf_Area=mean(GM_Leaf_Area),MapleFinalMass=first(MapleFinalMass),GM_Fecundity=first(GM_Fecundity),GM_StemHeight_Bolt=first(GM_StemHeight_Bolt),
                                                          GM_Leaf_Number_Bolt=first(GM_Leaf_Number_Bolt),
Larg_Leaf_Len_Bolt=first(Larg_Leaf_Len_Bolt),
Col_Field=first(Col_Field),
Row_Field=first(Row_Field),
Larg_Leaf_Wid_Bolt=first(Larg_Leaf_Wid_Bolt))


#Converting white fungal damage to logistic. 
dat2$WhiteFungLogis<-NA
dat2$WhiteFungLogis[dat2$WhiteFungDam>0]<-1
dat2$WhiteFungLogis[dat2$WhiteFungDam==0]<-0


#Creating Survival Data.1 = survived, 0= dead.
dat2$Bolt_Survival<-c()
dat2$Bolt_Survival[dat2$GM_StemHeight_Bolt=="Dead"]<-0
dat2$Bolt_Survival[dat2$GM_StemHeight_Bolt!="Dead"]<-1
dat2$Bolt_Survival[is.na(dat2$GM_StemHeight_Bolt)]<-0 # I am going to be consistent and call those without a value dead because i missed these ones. 
dat2$Bolt_Survival[dat2$GM_Fecundity>0]<-1 #Those with fecundity data are also alive... 
dat2$Bolt_Survival[dat2$treatment=="mcnt"]<-NA #those that dies in year 1 are NA
dat2$Bolt_Survival[dat2$treatment=="mcnt"]<-NA #Maple controls are NA



dat2$Maple_SurvivalY2<-c()
dat2$Maple_SurvivalY2[is.na(dat2$MapleFinalMass)]<-0 #Converting all those without a final measurement to dead.
dat2$Maple_SurvivalY2[!is.na(dat2$MapleFinalMass)]<-1 #Anything that is not NA (i.e. has a final measurment, is alive)
dat2$Maple_SurvivalY2[dat2$Maple_TotalLeafArea_End==0]<-NA #anything that died in the first year is overwritten as NA 
dat2$Maple_SurvivalY2[!dat2$treatment %in% c("mcnt","m")]<-NA


#Making a maple survival Y1 collumn
dat2$Maple_SurvivalY1<-c()
dat2$Maple_SurvivalY1[dat2$Maple_TotalLeafArea_End==0]<-0 #anything with a value of 0 is dead
dat2$Maple_SurvivalY1[is.na(dat2$Maple_TotalLeafArea_End)]<-NA #anything with NA is unknown
dat2$Maple_SurvivalY1[dat2$Maple_SurvivalY2==1]<-1 #Those with an NA will be overwritted if i have a record of their size in year two. 
dat2$Maple_SurvivalY1[dat2$Maple_TotalLeafArea_End>0]<-1 #anything with a value greater than zero is alive

#This Genotype was NA for maple total leaf area, but we know that it is dead. 
dat2$Maple_SurvivalY1[dat2$Tag=="e|CBMCK1-1-0|N|49"]<-0


#Removing those with dead maples in year 1 from the analysis
dat2<-dat2[dat2$Maple_SurvivalY1==1 | is.na(dat2$Maple_SurvivalY1),]



#All of these genotypes died (15 Genotypes).(We are simply missing a final measurement for e|JBCHY1-1-50|Q|240) That is only 3% Mortality. 
dead<-dat2[is.na(dat2$GM_TotalLeaf_Area),]

deadID<-dead %>% filter(treatment!="mcnt",Tag!="e|JBCHY1-1-50|Q|240") #Here there are 12 putative dead competitors because  ("e|JBCHY1-1-50|Q|240") did not die. 


#Removing those with dead competitors from the garlic mustard treatment. ("e|JBCHY1-1-50|Q|240") did not die, we are simply missing the final measurement for it.
dead_competitors<-dead %>% filter(treatment=="gm",Tag!="e|JBCHY1-1-50|Q|240") %>% select(comp_number)

#Removing those with dead competitors from the analysis. 
dat2<-dat2 %>% filter(!comp_number %in% dead_competitors$comp_number)
dat<-dat %>% filter(!comp_number %in% dead_competitors$comp_number)


#What are the frequencies in each treatment?
#Assinging those that died. 
dat2$GreenhouseSurvival<-c()
dat2$GreenhouseSurvival[dat2$Tag %in% deadID$Tag]<-0
dat2$GreenhouseSurvival[is.na(dat2$GreenhouseSurvival)]<-1

#Removing dead individuals from the analysis. 
dat2<-dat2[dat2$GreenhouseSurvival==1,]


#Removing those with dead maples from the analysis
dat2<-dat2[dat2$Maple_SurvivalY1==1 | is.na(dat2$Maple_SurvivalY1),]



```



#PCA of GM SIZE in the second year. 
```{r}
#Removing dead individuals with zeros. 
dat2$GM_StemHeight_Bolt[which(dat2$GM_StemHeight_Bolt=="Dead")]<-0
dat2$GM_Leaf_Number_Bolt[which(dat2$GM_Leaf_Number_Bolt=="Dead")]<-0
dat2$Larg_Leaf_Len_Bolt[which(dat2$Larg_Leaf_Len_Bolt=="Dead")]<-0
dat2$Larg_Leaf_Wid_Bolt[which(dat2$Larg_Leaf_Wid_Bolt=="Dead")]<-0

#Making data numeric
dat2$GM_StemHeight_Bolt<-as.numeric(dat2$GM_StemHeight_Bolt)
dat2$GM_Leaf_Number_Bolt<-as.numeric(dat2$GM_Leaf_Number_Bolt)
dat2$Larg_Leaf_Len_Bolt<-as.numeric(dat2$Larg_Leaf_Len_Bolt)
dat2$Larg_Leaf_Wid_Bolt<-as.numeric(dat2$Larg_Leaf_Wid_Bolt)


pca<-prcomp(~GM_StemHeight_Bolt+GM_Leaf_Number_Bolt+Larg_Leaf_Len_Bolt+Larg_Leaf_Wid_Bolt,data=dat2,scale.=T,na.action=na.omit)

prediction<-as.data.frame(predict(pca))

df<-tibble::rownames_to_column(prediction, "rownumber")

dat2[df$rownumber,"PC1BoltSize"]<-df$PC1

hist(dat2$PC1BoltSize) #The data is very zero inflated because of the mortality. This isnt great but what can you do. 
```

#Generating PCA for Glucosinolate, Flavonoid and Chlorophyll
```{r}
#######
#Trying a pca with all three variables.
#########
pcaGlucCorFlav<-prcomp(~Standardize(gluc_Conc)+Standardize(ChlorA)+Standardize(flav_Conc),data=dat2,na.action=na.omit)
biplot(pcaGlucCorFlav)
pcaGlucCorFlav
summary(pcaGlucCorFlav)
pcaGlucCorFlav
#Loading to data frame.
prediction<-as.data.frame(predict(pcaGlucCorFlav))


df2<-tibble::rownames_to_column(prediction, "rownumber")
dat2[df2$rownumber,"PC1AllCGF"]<-df2$PC1
dat2[df2$rownumber,"PC2All_CF"]<-df2$PC2
dat2[df2$rownumber,"PC3All_CG"]<-df2$PC3

#PC2 is off diagonal for flav. (Higher values is higher flavonoid:Chlorophyll)
#PC3 is the off diagonal for glucosinolate.  (Higher values is higher glucosinolate:Chlorophyll)



```


#Creating a maple dataframe. 
```{r}

#Creating a maple data frame
Maple<-dat2[dat2$treatment=="m"|dat2$treatment=="mcnt",]

Maple[is.na(Maple$Maple_StemHeight_End),]

#b|EFCC2-4-80|Q|144 and f|JBCHY1-1-50|Q|247,e|CBMCK1-1-0|N|49, e|JWBOY-2-80|Q|264 are simply not in the datafile. Nothing to do there - they will be deleted from the analyis. These genotypes are either dead, or we missed them when conducting the sampling.
Maple<-Maple[!is.na(Maple$Maple_StemHeight_End),]
Maple$treatment<-factor(Maple$treatment,levels = c("m","mcnt"))


#Correcting an error of initial maple height. A height of 8 is not possible. changing to 80 as this is a likely typo. 
Maple$maple_height_0[Maple$maple_height_0==8]<-80


min(Maple$maple_height_0)

max(Maple$maple_height_0)
hist(Maple$maple_height_0,breaks = 20)

#how many maples are there?
Maple %>% filter(Family=="maple") #Only 29..... did two die?
dat %>% filter(Family=="maple") #Also 29... what the heck. 

192/194

Maple
```

#Maple PCA 
```{r}
#PCA values are based on the standard deviations of the variables included in the analysis. Therefore, it is neccessairy to scale the variables before using them in a PCA. Variables with high SD will have more weight in constructing the loadings than a variable with a low SD. I need all variables to have the same standard deviation. 


#Selecting variables to use in the PCA (All initial and final maple measurements which could indicate performance)
PCAMaple<-Maple %>% select(maple_height_0,maple_leaf_length_0,maple_leaves_0,Maple_StemHeight_End,Maple_LeafNum_End,Maple_TotalLeafArea_End)

#Standardizing all variables.
PCAMaple<-data.frame(apply(PCAMaple,2,Standardize))

#---------------
#Performing model 
#---------------

#Model with everything
pcaModelTotal<-prcomp(PCAMaple)


#40% of the variation in the data is explained in the first PCA. 
summary(pcaModelTotal)
pcaModelTotal

#All variables are correlated with the PC1 loading. 
plot(predict(pcaModelTotal)[,1]~PCAMaple$Maple_TotalLeafArea_End)
plot(predict(pcaModelTotal)[,1]~PCAMaple$maple_height_0)
plot(predict(pcaModelTotal)[,1]~PCAMaple$maple_leaf_length_0)
plot(predict(pcaModelTotal)[,1]~PCAMaple$maple_leaves_0)

#Adding in PC1 vales from the pca. This will be used to control for initial maple size in my experiment. 
Maple$PC1Tot<-predict(pcaModelTotal)[,1]

#Removing maple controls (to be used in models that do not include controls) 
MapleModel<-Maple %>% filter(treatment=="m")


```




```{r}

ConfidenceInt<-function(x){
  x<-x[!is.na(x)]#remove NA
  N<-length(x)
  SE<-sd(x)/sqrt(N) #get Standard Error
  Conf<-SE*qt(0.975,N-1)# Get confidence intercal
  return(Conf)
}

TreatmentMortality<-function(data,Survival=F){
num<-tapply(data,dat2$treatment,sum,na.rm=T) #numerator
x<-tapply(data,dat2$treatment,mean,na.rm=T) #Survival rate
denom=num/x #Denominator

#Now mortality rate

NewNum<-denom-num
Mortality<-(1-x)*100

if(Survival==T){
  return(list(num,denom,x*100))
}
else return(list(NewNum,denom,Mortality))
}

#Maple Data
tapply(Maple$PC1Tot,Maple$treatment,function(x) c(mean(x,na.rm = T), ConfidenceInt(x)))

tapply(Maple$Maple_TotalLeafArea_End,Maple$treatment,function(x) c(mean(x,na.rm = T), ConfidenceInt(x)))

tapply(Maple$MapleFinalMass,Maple$treatment,function(x) c(mean(x,na.rm = T), ConfidenceInt(x)))

tapply(Maple$MapleDamage,Maple$treatment,function(x) c(mean(x,na.rm = T), ConfidenceInt(x)))

#GM Data
tapply(dat2$RGR1,dat2$treatment,function(x) c(mean(x,na.rm = T)*1000000, ConfidenceInt(x)*1000000))

tapply(dat2$GM_TotalLeaf_Area,dat2$treatment,function(x) c(mean(x,na.rm = T), ConfidenceInt(x)))

tapply(dat2$GM_Fecundity,dat2$treatment,function(x) c(mean(x,na.rm = T), ConfidenceInt(x)))

tapply(dat2$BlackPathDam,dat2$treatment,function(x) c(mean(x,na.rm = T), ConfidenceInt(x)))

tapply(dat2$ThripsDam,dat2$treatment,function(x) c(mean(x,na.rm = T), ConfidenceInt(x)))


tapply(dat2$WhiteFungLogis,dat2$treatment,mean,na.rm=T)
dat2$WhiteFungLogis

TreatmentMortality(dat2$WhiteFungLogis,Survival=T)

dat$ini
```


#Visuallization: maple treatments -- initial maple size controlled.. 
```{r}
#Modelling

#Is Bench significant?
fit1<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+treatment+Fern+MapleDamage+(1|gh_bench),data=Maple)
fit2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+treatment+Fern+MapleDamage,data=Maple)
anova(fit1,fit2) #NO

#Is Damage significant?
fit1<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+treatment+Fern+MapleDamage,data=Maple)
fit2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+treatment+Fern,data=Maple)
anova(fit1,fit2) #Yes
summary(fit1)
#Is Fern significant?
fit1<-glmmTMB(Standardize(Maple_TotalLeafArea_End)~Standardize(PC1Tot)+treatment+Standardize(Fern)+Standardize(MapleDamage),data=Maple)
fit2<-glmmTMB(Standardize(Maple_TotalLeafArea_End)~Standardize(PC1Tot)+treatment+Standardize(MapleDamage),data=Maple)
anova(fit1,fit2) #Yes

#Is treatment significant?
fit1<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+Fern+MapleDamage,data=Maple)
fit2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+treatment+Fern+MapleDamage,data=Maple)
anova(fit1,fit2) #Yes

#Is there an interaction?
fit1<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+treatment+Fern+MapleDamage,data=Maple)
fit2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot*treatment+Fern+MapleDamage,data=Maple)
anova(fit1,fit2) #no, not at all when other variables are accounted for.

#Best model is: 
fit1<-glmmTMB(Standardize(Maple_TotalLeafArea_End)~Standardize(PC1Tot)+treatment+Standardize(Fern)+Standardize(MapleDamage),data=Maple)
summary(fit1)

```

#Year 2
```{r}
#Feild row and collumn could not be assessed here because the maple controls are missing those data. 

#Is Bench significant?
fit1<-glmmTMB(Standardize(MapleFinalMass)~PC1Tot+treatment+Fern+MapleDamage+(1|gh_bench),data=Maple)
fit2<-glmmTMB(Standardize(MapleFinalMass)~PC1Tot+treatment+Fern+MapleDamage,data=Maple)
anova(fit1,fit2) #NO

#Is Damage significant?
fit1<-glmmTMB(Standardize(MapleFinalMass)~PC1Tot+treatment+Fern+MapleDamage,data=Maple)
fit2<-glmmTMB(Standardize(MapleFinalMass)~PC1Tot+treatment+Fern,data=Maple)
anova(fit1,fit2) #No

summary(fit1)
#Is Fern significant?
fit1<-glmmTMB(Standardize(MapleFinalMass)~PC1Tot+treatment+Fern+MapleDamage,data=Maple)
fit2<-glmmTMB(Standardize(MapleFinalMass)~PC1Tot+treatment+MapleDamage,data=Maple)
anova(fit1,fit2) #No
#no
summary(fit1)

#Is treatment significant?
fit1<-glmmTMB(Standardize(MapleFinalMass)~PC1Tot,data=Maple)
fit2<-glmmTMB(Standardize(MapleFinalMass)~PC1Tot+treatment,data=Maple)
anova(fit1,fit2) #Yes

#Is PC1Tot significant?
fit1<-glmmTMB(Standardize(MapleFinalMass)~treatment+PC1Tot,data=Maple)
fit2<-glmmTMB(Standardize(MapleFinalMass)~treatment,data=Maple)
anova(fit1,fit2) #Yes



#Year two treatment effects. 
Maple$treatment<-relevel(Maple$treatment,ref=("mcnt"))
fit1<-glmmTMB(Standardize(MapleFinalMass)~Standardize(PC1Tot)+treatment,data=Maple)
fit2<-glmmTMB(Standardize(MapleFinalMass)~Standardize(PC1Tot),data=Maple)
anova(fit1,fit2) #Yes
summary(fit1)
Maple$treatment
#Generating coefficients
fit1<-glmmTMB(Standardize(Maple_TotalLeafArea_End)~PC1Tot+treatment+Standardize(Fern)+Standardize(MapleDamage),data=Maple)
summary(fit1)
slope<-function(x,PlusInt){
  y=1261.58*x+6674.52+PlusInt
  return(y)
}
#-1914.29 change in intercept in the competition treatment

#Competition x axis
Comp<-Maple$PC1Tot[Maple$treatment=="m"]
xComp<-seq(min(Comp),max(Comp),length.out = 194)

#Control x axis
Cont<-Maple$PC1Tot[Maple$treatment=="mcnt"]
xCont<-seq(min(Cont),max(Cont),length.out = 194)

```

#Visualizing maple treatment effects Year 1. 
```{r}

source("GGPlot_Themes.R")

tiff("Maple_Figures/Maple_Control.tiff", units="in", width=10, height=6, res=300)
ggplot()+
  geom_point(aes(y=Maple$Maple_TotalLeafArea_End,x=Maple$PC1Tot,colour=Maple$treatment))+
  geom_path(aes(x=xCont,y=slope(xCont,0)),colour="black",size=1)+
  geom_path(aes(x=xComp,y=slope(xComp,-1914.29)),colour="#E69F00",size=1)+
    scale_colour_manual(values=c("black","#E69F00" ),labels=c("Maple Alone","Interspecific"))+
  scale_y_continuous(breaks=seq(0,20000,2500))+
  scale_x_continuous(breaks=seq(-3,5,1))+

  theme_simple()+
  ylab(bquote(bold("Total Leaf Area"~(mm^2))))+
  xlab("Initial Size (PC1)")
dev.off()

#The conclusion is that, not only are maples in the mcnt treatment have higher fitness after controlling for differences in initial size, they also exhibit increased growth at a given body size. 

#Generating coefficients for display
Maple$treatment<-factor(Maple$treatment,levels=c("mcnt","m"))
fitTreat<-glmmTMB(Standardize(Maple_TotalLeafArea_End)~Standardize(PC1Tot)+treatment+Standardize(Fern)+Standardize(MapleDamage),data=Maple)
summary(fitTreat)

confint(fitTreat)
```


#Modelling: what effects maple performance year 1? -- Update with PCA values for secondary compounds
```{r}

#Is bench important? 
fit<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+PC1AllCGF+PC2All_CF+PC3All_CG+(1|gh_bench), data=MapleModel)
fit2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+PC1AllCGF+PC2All_CF+PC3All_CG, data=MapleModel)
anova(fit,fit2) #No it is not.

#Modelling fixed effects. 
fit<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+PC1AllCGF+PC2All_CF+PC3All_CG+MapleDamage+Family+GM_TotalLeaf_Area+Fern, data=MapleModel)
summary(fit) 

fit2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+PC1AllCGF+PC2All_CF+PC3All_CG+MapleDamage+GM_TotalLeaf_Area+Fern, data=MapleModel)
anova(fit,fit2) #Family not significant. 
summary(fit2)

fit3<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+PC1AllCGF+PC2All_CF+PC3All_CG+MapleDamage+Fern, data=MapleModel)
anova(fit2,fit3) #Total leaf area not significant. 

#Is family important if I add it back in? 
fit4<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+PC1AllCGF+PC2All_CF+PC3All_CG+MapleDamage+Family+Fern, data=MapleModel)
anova(fit4,fit3) #No, still not important.

#-----
#IS PC3_AllCG significant?
fit5<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+MapleDamage+Fern+PC1AllCGF+PC2All_CF, data=MapleModel)
anova(fit3,fit5) #Yes it is.... Very interesting. This is the glucosinolate ratio!!


#IS PC2_AllCF significant?
fit5<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+MapleDamage+Fern+PC1AllCGF+PC3All_CG, data=MapleModel)
anova(fit3,fit5) #No it is not, which is weird because this is the variable that was higher in the maple treatment. 

#IS PC1AllCGF significant?
fit6<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+MapleDamage+Fern+PC3All_CG, data=MapleModel)
anova(fit6,fit5) #Yes, this is also significant, which was the variable with a treatment interaction in the first place. 

#IS damage significant?
fit7<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+PC1AllCGF+PC3All_CG+Fern, data=MapleModel)
anova(fit7,fit5) #Yes it is. 

#IS Fern significant?
fit8<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+PC1AllCGF+PC3All_CG+MapleDamage, data=MapleModel)
anova(fit5,fit8) #No it is not. 

#IS initial size significant?
fit9<-glmmTMB(Maple_TotalLeafArea_End~PC1AllCGF+PC3All_CG+MapleDamage+Fern, data=MapleModel)
anova(fit9,fit8) #Yes it is. Very much so. 

#Is there an interaction between the two principle components here? 
fit10<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+PC1AllCGF*PC3All_CG+MapleDamage, data=MapleModel)
fit11<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+PC1AllCGF+PC3All_CG+MapleDamage, data=MapleModel)
anova(fit10,fit11) #No there is not.


#The bad model for coefficients 
fit3<-glmmTMB(Standardize(Maple_TotalLeafArea_End)~Standardize(PC1Tot)+Standardize(PC1AllCGF)+Standardize(PC3All_CG)+Standardize(MapleDamage)+Standardize(Fern)+Standardize(GM_TotalLeaf_Area)+Standardize(PC2All_CF), data=MapleModel)
summary(fit3)


#The best model is 
fit3<-glmmTMB(Standardize(Maple_TotalLeafArea_End)~Standardize(PC1Tot)+Standardize(PC1AllCGF)+Standardize(PC3All_CG)+Standardize(MapleDamage), data=MapleModel)
summary(fit3)




length(residuals(fit3))

plot(residuals(fit3,type="pearson"),fitted(fit3))

plot(residuals(fit3,type="pearson"))
qqnorm(residuals(fit3,type="pearson"))

#Very interesting result. I am not sure why i thought fern was significant.... odd. 

```

#Testing raw values
```{r}

fit3<-glmmTMB(Standardize(Maple_TotalLeafArea_End)~Standardize(PC1Tot)+Standardize(ChlorA)+Standardize(MapleDamage), data=MapleModel)
summary(fit3)

fit3<-glmmTMB(Standardize(Maple_TotalLeafArea_End)~Standardize(PC1Tot)+Standardize(gluc_Conc)+Standardize(MapleDamage), data=MapleModel)
summary(fit3)

fit3<-glmmTMB(Standardize(Maple_TotalLeafArea_End)~Standardize(PC1Tot)+Standardize(flav_Conc)+Standardize(MapleDamage), data=MapleModel)
summary(fit3)


source("GGPlot_Themes.R")

glucSlope<-function(x){
  y=-0.12388  *x+0.01303 #Non significant slope
  return(y)
}
minG<-min(Standardize(MapleModel$gluc_Conc),na.rm = T)
maxG<-max(Standardize(MapleModel$gluc_Conc),na.rm = T)

chlorSlope<-function(x){
  y= -0.225025  *x+0.001912   #Non significant slope
  return(y)
}
 
minC<-min(Standardize(MapleModel$ChlorA),na.rm = T)
maxC<-max(Standardize(MapleModel$ChlorA),na.rm = T)

flavSlope<-function(x){
  y= -0.12052  *x+0.03029   #Non significant slope
  return(y)
}

minF<-min(Standardize(MapleModel$flav_Conc),na.rm = T)
maxF<-max(Standardize(MapleModel$flav_Conc),na.rm = T)





a<-ggplot(MapleModel)+
  geom_point(aes(y=Standardize(Maple_TotalLeafArea_End),x=Standardize(gluc_Conc)),colour="#E69F00")+
    geom_segment(x=minG,xend=maxG,y=glucSlope(minG),yend=glucSlope(maxG),colour="black",size=1.5)+
  scale_y_continuous(breaks=seq(-3,5,1))+
   scale_x_continuous(breaks=seq(-3,3.5,1))+
  theme_simple_multiCol_First()+
  ylab(bquote(bold("Total Leaf Area "*(mm^2))))+
  xlab(bquote(bold("[Total Glucosinolate] (log" (mg/ml)*")")))


b<-ggplot(MapleModel)+
  geom_point(aes(y=Standardize(Maple_TotalLeafArea_End),x=Standardize(flav_Conc)),colour="#E69F00")+
  geom_segment(x=minC,xend=maxC,y=flavSlope(minF),yend=flavSlope(maxF),colour="black",size=1.5)+
  scale_y_continuous(breaks=seq(-3,5,1))+
 scale_x_continuous(breaks=seq(-3,3.5,1))+
  theme_simple_multiCol()+
  ylab(bquote(bold("Total Leaf Area "~(mm^2))))+
  xlab(bquote(bold("[Total Flavonoid] (log"(μg/ml)*")")))


c<-ggplot(MapleModel)+
  geom_point(aes(y=Standardize(Maple_TotalLeafArea_End),x=Standardize(ChlorA)),colour="#E69F00")+
  geom_segment(x=minC,xend=maxC,y=chlorSlope(minC),yend=chlorSlope(maxC),colour="black",size=1.5)+
  scale_y_continuous(breaks=seq(-3,5,1))+
 scale_x_continuous(breaks=seq(-3,3.5,1))+
  theme_simple_multiCol()+
  ylab(bquote(bold("Total Leaf Area "~(mm^2))))+
  xlab(bquote(bold("[Chlorophyll A] (log"(μg/ml)*")")))

plots <- align_plots(a, b,c,align="hv")



tiff("Maple_Figures/Maple_Inhibition_gluc_flav_Chlor.tiff", units="in", width=15, height=6, res=300)
plot_grid(plots[[1]],plots[[2]],plots[[3]],ncol=3,rel_widths=c(1,1,1),rel_heights = c(1,1,1),labels = c("a","b","c"),label_fontfamily = "Arial",label_size = 18)
dev.off()


```

#What affects maple performance (Year two)?
```{r}
MapleModel$Bolt_Survival<-as.factor(MapleModel$Bolt_Survival)

#Is bench important? 
fit<-glmmTMB(Standardize(MapleFinalMass)~PC1Tot+PC1AllCGF+PC2All_CF+PC3All_CG+(1|gh_bench), data=MapleModel)
fit2<-glmmTMB(Standardize(MapleFinalMass)~PC1Tot+PC1AllCGF+PC2All_CF+PC3All_CG, data=MapleModel)
anova(fit,fit2) #No it is not.

#Is col field important? 
fit<-glmmTMB(Standardize(MapleFinalMass)~PC1Tot+PC1AllCGF+PC2All_CF+PC3All_CG+(1|Col_Field), data=MapleModel[!is.na(MapleModel$Col_Field),])
fit2<-glmmTMB(Standardize(MapleFinalMass)~PC1Tot+PC1AllCGF+PC2All_CF+PC3All_CG, data=MapleModel[!is.na(MapleModel$Col_Field),])
anova(fit,fit2) #No it is not.

#Is row field important? 
fit<-glmmTMB(Standardize(MapleFinalMass)~PC1Tot+PC1AllCGF+PC2All_CF+PC3All_CG+(1|Row_Field), data=MapleModel[!is.na(MapleModel$Row_Field),])
fit2<-glmmTMB(Standardize(MapleFinalMass)~PC1Tot+PC1AllCGF+PC2All_CF+PC3All_CG, data=MapleModel[!is.na(MapleModel$Row_Field),])
anova(fit,fit2) #No it is not.... but it is close. 


#Modelling fixed effects. 
fit<-glmmTMB(Standardize(MapleFinalMass)~PC1Tot+PC1AllCGF+PC2All_CF+PC3All_CG+MapleDamage+Family+GM_TotalLeaf_Area+Fern+Bolt_Survival, data=MapleModel)
summary(fit) 

fit2<-glmmTMB(Standardize(MapleFinalMass)~PC1Tot+PC1AllCGF+PC2All_CF+PC3All_CG+MapleDamage+GM_TotalLeaf_Area+Fern+Bolt_Survival, data=MapleModel)
anova(fit,fit2) #Family not significant. 
summary(fit2)

fit3<-update(fit2,~.-GM_TotalLeaf_Area)
anova(fit2,fit3) #Total leaf area is highly significant. This is very interesting. Size of GM in first year effects the size of it in the second year. ... Even with the amount of mortality the effect was detectable. 

#Is PC3_AllCG significant?
fit4<-update(fit2,~.- PC3All_CG)
anova(fit2,fit4) #No

#Is PC2_AllCF significant?
fit5<-update(fit4,~.- PC2All_CF)
anova(fit5,fit4) #No
summary(fit5)

#Is Bolt_Survival significant?
fit5<-glmmTMB(Standardize(MapleFinalMass) ~ PC1Tot + PC1AllCGF + MapleDamage +  
    GM_TotalLeaf_Area + Fern + Bolt_Survival,data=MapleModel[!is.na(MapleModel$Bolt_Survival),])
fit6<-update(fit5,~.- Bolt_Survival)
anova(fit5,fit6) #No

#IS maple damage significant? 
fit6<-glmmTMB(Standardize(MapleFinalMass) ~ PC1Tot + PC1AllCGF + MapleDamage +  
    GM_TotalLeaf_Area + Fern ,data=MapleModel)
fit7<-glmmTMB(Standardize(MapleFinalMass) ~ PC1Tot + PC1AllCGF  +  
    GM_TotalLeaf_Area + Fern ,data=MapleModel)
anova(fit6,fit7)#No.
summary(fit7)

#IS PC1AllCGF?
fit7<-glmmTMB(Standardize(MapleFinalMass) ~ PC1Tot + PC1AllCGF  +  
    GM_TotalLeaf_Area + Fern ,data=MapleModel[!is.na(MapleModel$PC1AllCGF),])
fit8<-update(fit7,~.-PC1AllCGF)
anova(fit7,fit8) #no

#Is Fern
fit9<-glmmTMB(Standardize(MapleFinalMass) ~ PC1Tot   +  
    GM_TotalLeaf_Area + Fern ,data=MapleModel[!is.na(MapleModel$Fern),])
fit10<-update(fit9,~.-Fern)
anova(fit9,fit10) #no Fern did not have effects on maple at all. 


#Is GM size in second year important? 
fit9<-glmmTMB(Standardize(MapleFinalMass) ~ PC1Tot   +  
    GM_TotalLeaf_Area +PC1BoltSize ,data=MapleModel[!is.na(MapleModel$PC1BoltSize),])
fit10<-update(fit9,~.-PC1BoltSize)
anova(fit9,fit10) #No Size in the second year is not important. This suggests that GM is having delayed effects on maple performance. 

#Is any of the three gluc chlor or flav significant in only the survivors? 
fit9<-glmmTMB(Standardize(MapleFinalMass) ~ PC1Tot   +PC2All_CF+
    GM_TotalLeaf_Area  ,data=MapleModel[!is.na(MapleModel$PC1BoltSize),])
summary(fit9) # no. 




#Is gm size first year significant?  
fit9<-glmmTMB(Standardize(MapleFinalMass) ~ Standardize(PC1Tot)  +
   Standardize( GM_TotalLeaf_Area ) ,data=MapleModel[!is.na(MapleModel$GM_TotalLeaf_Area),])
fit10<-update(fit9, ~.-Standardize( GM_TotalLeaf_Area ))
anova(fit9,fit10)
summary(fit9) # Yes. 

#Is maple initial size significant?
fit9<-glmmTMB(Standardize(MapleFinalMass) ~ Standardize(PC1Tot)  +
   Standardize( GM_TotalLeaf_Area ) ,data=MapleModel[!is.na(MapleModel$PC1Tot),])
fit10<-update(fit9, ~.-Standardize( PC1Tot ))
anova(fit9,fit10) #Yes.

#Best model is


#Bad model for coefficients
fit<-glmmTMB(Standardize(MapleFinalMass)~Standardize(PC1Tot)+Standardize(PC1AllCGF)+Standardize(PC2All_CF)+Standardize(PC3All_CG)+Standardize(MapleDamage)+Family+Standardize(GM_TotalLeaf_Area)+Standardize(Fern)+Bolt_Survival, data=MapleModel)
summary(fit)

fit9<-glmmTMB(Standardize(MapleFinalMass) ~ Standardize(PC1Tot)   +  
    Standardize(GM_TotalLeaf_Area) +Standardize(PC1BoltSize) ,data=MapleModel[!is.na(MapleModel$PC1BoltSize),])
summary(fit9)

#Best model is

fit9<-glmmTMB(Standardize(MapleFinalMass) ~ Standardize(PC1Tot)  +
   Standardize( GM_TotalLeaf_Area ) ,data=MapleModel[!is.na(MapleModel$PC1Tot),])
summary(fit9)
```




#Visualizing effect of PC1 and PC3 on maple performance. 
```{r}
source("GGPlot_Themes.R")
fit3<-glmmTMB(Standardize(Maple_TotalLeafArea_End)~Standardize(PC1Tot)+Standardize(PC1AllCGF)+Standardize(PC3All_CG)+Standardize(MapleDamage), data=MapleModel)
summary(fit3)

PC1Slope<-function(x){
  y=-0.20226  *x+0.02921  
  return(y)
}


min1<-min(Standardize(MapleModel$PC1AllCGF),na.rm = T)
max1<-max(Standardize(MapleModel$PC1AllCGF),na.rm = T)

PC3Slope<-function(x){
  y= 0.16155  *x+0.02921  
  return(y)
}

min3<-min(Standardize(MapleModel$PC3All_CG),na.rm = T)
max3<-max(Standardize(MapleModel$PC3All_CG),na.rm = T)



a<-ggplot(MapleModel)+
  geom_point(aes(y=Standardize(Maple_TotalLeafArea_End),x=Standardize(PC1AllCGF)),colour="#E69F00")+
    geom_segment(x=min1,xend=max1,y=PC1Slope(min1),yend=PC1Slope(max1),colour="black",size=1.5)+
  scale_y_continuous(breaks=seq(-3,5,0.5))+
   #scale_x_continuous(breaks=seq(-3,0,0.25))+
  theme_simple_multiCol_First()+
  ylab("Total Leaf Area (σ)")+
  xlab("Leaf Quality (σ)")

b<-ggplot(MapleModel)+
  geom_point(aes(y=Standardize(Maple_TotalLeafArea_End),x=Standardize(PC3All_CG)),colour="#E69F00")+
  geom_segment(x=min3,xend=max3,y=PC3Slope(min3),yend=PC3Slope(max3),colour="black",size=1.5)+
  scale_y_continuous(breaks=seq(-3,5,0.5))+
# scale_x_continuous(breaks=seq(-3,0,0.5))+
  theme_simple_multiCol()+
  ylab("Total Leaf Area (σ)")+
  xlab("Relative Glucosinolate Investment (σ)")

plots <- align_plots(a, b,align="hv")



tiff("Maple_Figures/Maple_Inhibition_PCA.tiff", units="in", width=12, height=6, res=300)
plot_grid(plots[[1]],plots[[2]],ncol=2,rel_widths=c(1,1),rel_heights = c(1,1),labels = c("a","b"),label_fontfamily = "Arial",label_size = 18)
dev.off()

```



#Modelling: what effects maple performance?
```{r}
#Is bench important? 
fit<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+gluc_Conc+(1|gh_bench), data=MapleModel[!is.na(MapleModel$gluc_Conc),])
fit2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+gluc_Conc, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
anova(fit,fit2) #No it is not.

#Modelling fixed effects. 
fit<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+gluc_Conc+MapleDamage+Family+GM_TotalLeaf_Area+Fern, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
summary(fit) 

fit2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+gluc_Conc+MapleDamage+GM_TotalLeaf_Area+Fern, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
anova(fit,fit2) #Family not significant. 
summary(fit2)

fit3<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+gluc_Conc+MapleDamage+Fern, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
anova(fit2,fit3) #Total leaf area not significant. 

#Is family important if I add it mack in? 
fit4<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+gluc_Conc+MapleDamage+Family+Fern, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
anova(fit4,fit3) #No, still not important.

#IS glucosinolate significant?
fit5<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+MapleDamage+Fern, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
anova(fit3,fit5) #Yes it is. 

#IS damage significant?
fit6<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+gluc_Conc+Fern, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
anova(fit3,fit6) #Yes it is. 

#IS Fern significant?
fit7<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+gluc_Conc+MapleDamage, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
anova(fit3,fit7) #No it is not. 

#IS initial size significant?
fit8<-glmmTMB(Maple_TotalLeafArea_End~gluc_Conc+MapleDamage, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
anova(fit7,fit8) #YEs it is.


#The best model is 
fit3<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+Standardize(gluc_Conc)+Standardize(MapleDamage)+Standardize(Fern), data=MapleModel[!is.na(MapleModel$gluc_Conc),])
summary(fit3)
length(residuals(fit3))

plot(residuals(fit3,type="pearson"),fitted(fit3))

plot(residuals(fit3,type="pearson"))
qqnorm(residuals(fit3,type="pearson"))

#What is the effect with chlorophyll included?
fit0.1<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+gluc_Conc+MapleDamage+ChlorA, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
fit0.2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+MapleDamage+ChlorA, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
anova(fit0.1,fit0.2) #

#What is the effect of chlorophyll?
fit0.1<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+gluc_Conc+MapleDamage+ChlorA, data=MapleModel[!is.na(MapleModel$ChlorA),])
fit0.2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+gluc_Conc+MapleDamage, data=MapleModel[!is.na(MapleModel$ChlorA),])
anova(fit0.1,fit0.2) #


```



```{r}
#Generating SD for figure. This model has the standard deviation of the enire maple data set to make it translateable to the model scale. 
fit3<-glmmTMB(Standardize(Maple_TotalLeafArea_End,set.sd = T,3132.683)~Standardize(PC1Tot)+Standardize(GM_TotalLeaf_Area)+Standardize(MapleDamage), data=MapleModel)

summary(fit3)

#The effect of GM size on maple is -0.0354822  SD/SD

GM_SD_OnMap<-Standardize(MapleModel$GM_TotalLeaf_Area)
GM_SD_OnMap
#write.csv(GM_SD_OnMap,"GM_SD_OnMap.csv")

#Ferns did not effect maple.....
```



#Visualizing effect of glucosinolates on maple performance. 
```{r}
source("GGPlot_Themes.R")
fitTw2<-glmmTMB(Maple_TotalLeafArea_End~Standardize(PC1Tot)+gluc_Conc+Standardize(MapleDamage), data=MapleModel[!is.na(MapleModel$gluc_Conc),])
summary(fitTw2)

#ChlorA Slope
fitTw2<-glmmTMB(Maple_TotalLeafArea_End~Standardize(PC1Tot)+ChlorA+Standardize(MapleDamage), data=MapleModel)
summary(fitTw2)

glucSlope<-function(x){
  y=-1338.5  *x+2282.3 #Non significant slope
  return(y)
}
minG<-min(MapleModel$gluc_Conc,na.rm = T)
maxG<-max(MapleModel$gluc_Conc,na.rm = T)

chlorSlope<-function(x){
  y= -1751.0  *x+2307.9  #Non significant slope
  return(y)
}

minC<-min(MapleModel$ChlorA,na.rm = T)
maxC<-max(MapleModel$ChlorA,na.rm = T)



a<-ggplot(MapleModel)+
  geom_point(aes(y=Maple_TotalLeafArea_End,x=gluc_Conc),colour="#E69F00")+
    geom_segment(x=minG,xend=maxG,y=glucSlope(minG),yend=glucSlope(maxG),colour="black",size=1.5)+
  scale_y_continuous(breaks=seq(0,20000,2500))+
   scale_x_continuous(breaks=seq(-3,0,0.25))+
  theme_simple_multiCol_First()+
  ylab(bquote(bold("Total Leaf Area "*(mm^2))))+
  xlab(bquote(bold("[Total Glucosinolate] (log" (mg/ml)*")")))

b<-ggplot(MapleModel)+
  geom_point(aes(y=Maple_TotalLeafArea_End,x=ChlorA),colour="#E69F00")+
  geom_segment(x=minC,xend=maxC,y=chlorSlope(minC),yend=chlorSlope(maxC),colour="black",size=1.5)+
  scale_y_continuous(breaks=seq(0,20000,2500))+
 scale_x_continuous(breaks=seq(-3,0,0.5))+
  theme_simple_multiCol()+
  ylab(bquote(bold("Total Leaf Area "~(mm^2))))+
  xlab(bquote(bold("[Chlorophyll A] (log"(μg/ml)*")")))

b<-ggplot(MapleModel)+
  geom_point(aes(y=Maple_TotalLeafArea_End,x=ChlorA),colour="#E69F00")+
  geom_segment(x=minC,xend=maxC,y=chlorSlope(minC),yend=chlorSlope(maxC),colour="black",size=1.5)+
  scale_y_continuous(breaks=seq(0,20000,2500))+
 scale_x_continuous(breaks=seq(-3,0,0.5))+
  theme_simple_multiCol()+
  ylab(bquote(bold("Total Leaf Area "~(mm^2))))+
  xlab(bquote(bold("[Chlorophyll A] (log"(μg/ml)*")")))

plots <- align_plots(a, b,align="hv")



tiff("Maple_Figures/Maple_Inhibition_gluc_Chlor.tiff", units="in", width=12, height=6, res=300)
plot_grid(plots[[1]],plots[[2]],ncol=2,rel_widths=c(1,1),rel_heights = c(1,1),labels = c("a","b"),label_fontfamily = "Arial",label_size = 18)
dev.off()

```

#Genetic correlation model to determine if genotype or glucosinolate is responsible 
```{r}
library(tidyr)

MapleModel$Family<-as.character(MapleModel$Family)
#Standardizing variables
MapleModel$gluc_ConcS<-Standardize(MapleModel$gluc_Conc)
MapleModel$ChlorAS<-Standardize(MapleModel$ChlorA)
MapleModel$GM_TotalLeaf_AreaS<-Standardize(MapleModel$GM_TotalLeaf_Area)
MapleModel$PC1TotS<-Standardize(MapleModel$PC1Tot)
MapleModel$MapleDamageS<-Standardize(MapleModel$MapleDamage)
MapleModel$Maple_TotalLeafArea_EndS<-Standardize(MapleModel$Maple_TotalLeafArea_End)

  #Genetic correlation model to determine if genotype or glucosinolate is responsible 


#Shifting data wide
datG<-MapleModel %>% select(Tag,Family,gluc_ConcS,ChlorAS,GM_TotalLeaf_AreaS,gh_bench,MapleDamageS,PC1TotS,Maple_TotalLeafArea_EndS,Maple_TotalLeafArea_End) %>%  pivot_longer(c(Maple_TotalLeafArea_End,gluc_ConcS,ChlorAS,GM_TotalLeaf_AreaS))

#try with pc1 and pc2. can not do pc2 if no genetic variation. 

#Genetic variation for all traits
fit1<-glmmTMB(value ~ name*PC1TotS+name*MapleDamageS+(-1+name|Family),REML=T,data=datG)
#Would not converge. Removing damage interaction as it has a small effect. ... why would damage be expected to effect garlic mustard traits? 
summary(fit1)


fit2<-glmmTMB(value ~ name*PC1TotS+MapleDamageS+(-1+name|Family),REML=T,data=datG) 
#Still no good. ..Removing damage entirely. 

fit3<-glmmTMB(value ~ name*PC1TotS+(-1+name|Family),REML=T,data=datG) 
#Still no convergence.


#Trying model without garlic mustard size, as i found that that was not significant predictor
datG<-MapleModel %>% select(Tag,Family,gluc_ConcS,ChlorAS,GM_TotalLeaf_AreaS,gh_bench,MapleDamageS,PC1TotS,Maple_TotalLeafArea_EndS,Maple_TotalLeafArea_End) %>%  pivot_longer(c(Maple_TotalLeafArea_EndS,gluc_ConcS,ChlorAS))

fit1<-glmmTMB(value ~ name*PC1TotS+name*MapleDamageS+(-1+name|Family),REML=T,data=datG)
#Would not converge. Removing damage interaction 

fit2<-glmmTMB(value ~ name*PC1TotS+MapleDamageS+(-1+name|Family),REML=T,data=datG) 
#Still no good. ..Removing damage entirely. 

fit3<-glmmTMB(value ~ name*PC1TotS+(-1+name|Family),REML=T,data=datG) 
#Still no convergence.
summary(fit3)
fit4<-glmmTMB(value ~-1 +(-1+name|Family),REML=T,data=datG) 



#Removing Chlor A as there is little genetic correlation for it anyways 
datG<-MapleModel %>% select(Tag,Family,gluc_ConcS,ChlorAS,GM_TotalLeaf_AreaS,gh_bench,MapleDamageS,PC1TotS,Maple_TotalLeafArea_EndS,Maple_TotalLeafArea_End) %>%  pivot_longer(c(Maple_TotalLeafArea_End,gluc_ConcS))

fit1<-glmmTMB(value ~ name*PC1TotS+name*MapleDamageS+(-1+name|Family),REML=T,data=datG)
#Would not converge. Removing damage interaction 

fit2<-glmmTMB(value ~ name*PC1TotS+MapleDamageS+(-1+name|Family),REML=T,data=datG) 
#Still no good. ..Removing damage entirely. 

fit3<-glmmTMB(value ~ name*PC1TotS+(-1+name|Family),REML=T,data=datG) 
#Still no convergence.
summary(fit3)


fit4<-glmmTMB(value ~ PC1TotS+(-1+name|Family),REML=T,data=datG) 
summary(fit4)

fit4<-glmmTMB(value ~ -1+(-1+name|Family),REML=T,data=datG) 
summary(fit4)
#Model just wont run. 
```

#Calculating genetic correlation between gluc, chlor and total size. 
```{r}
datG<-MapleModel %>% select(Tag,Family,gluc_ConcS,ChlorAS,GM_TotalLeaf_AreaS,gh_bench,MapleDamageS,PC1TotS,Maple_TotalLeafArea_EndS,Maple_TotalLeafArea_End) %>%  pivot_longer(c(gluc_ConcS,ChlorAS,GM_TotalLeaf_AreaS))

glmmTMB(value ~ -1+name*gh_bench+(-1+name|Family),REML=T,data=datG)
#did not converge... removing bench interaction.

glmmTMB(value ~ -1+name+gh_bench+(-1+name|Family),REML=T,data=datG)
#Did not converge, removing bench. 
glmmTMB(value ~ -1+(-1+name|Family),REML=T,data=datG)
#Still did not converge. 

```



#Effect of maple on GM performance. 
I chose to seperate this model from the last due to the causality inherent in this data. Glucosinolate concentration should affect garlic mustard fitness only through effects on maple and pathogen abundance. Including glucosinolate concentration in a model with both of these variables to determien the effect of glucosinolates on fitness is actually determining how much glucosinolates affect fitness when these terms are controlled for, which should be not at all. Therefore multiple models are needed to test if glucosinolates influence abundance of pathogens and maple performance, after controlling for garlic mustard performance (Using chlorophyll A, because those with high performance might simply be making more glucosinolates). Then i can see how much maple and pathogens influence garlic mustard performance. 
```{r}
#ThripsDam and BlackPathDam represent standardized, logged data which are weighed by leaf size. 
MapleModel$GM_Leaf_Area<-Standardize(MapleModel$GM_Leaf_Area)
MapleModel$Maple_TotalLeafArea_End<-Standardize(MapleModel$Maple_TotalLeafArea_End)

#Modelling random effects 
fit<-glmmTMB(Standardize(GM_TotalLeaf_Area)~Maple_TotalLeafArea_End+Fern+ThripsDam*BlackPathDam*WhiteFungLogis+(1|Family)+(1|gh_bench),data=MapleModel)

fit2<-glmmTMB(Standardize(GM_TotalLeaf_Area)~Maple_TotalLeafArea_End+Fern+ThripsDam*BlackPathDam*WhiteFungLogis+(1|Family),data=MapleModel)

fit3<-glmmTMB(Standardize(GM_TotalLeaf_Area)~Maple_TotalLeafArea_End+Fern+ThripsDam*BlackPathDam*WhiteFungLogis+(1|gh_bench),data=MapleModel)


#Is Bench important? 
anova(fit,fit2) #Yes bench is very important

#Is family important? 
anova(fit,fit3) #Family is on the edge. but i will leave it for now. 

#Modeling fixed effects: 

fit<-glmmTMB(GM_TotalLeaf_Area~Maple_TotalLeafArea_End+Fern+ThripsDam*BlackPathDam*WhiteFungLogis+(1|Family)+(1|gh_bench),data=MapleModel)

fit2<-update(fit,~.-ThripsDam:BlackPathDam:WhiteFungLogis)
anova(fit,fit2) #Not a significant three way interaction.

fit3<-update(fit2,~.-BlackPathDam:WhiteFungLogis)
anova(fit3,fit2) #There is not a significant two way interaction.

fit4<-update(fit3,~.-BlackPathDam:ThripsDam)
anova(fit4,fit3)
#There is no significant interaction between black path dam and thrips dam interaction p=0.06 (very close). 

fit5<-update(fit4,~.-WhiteFungLogis:ThripsDam)
anova(fit5,fit4) #There is not significant white path and thripsdamage interaction.

summary(fit5) #White fungal damage not significant. 


fit6<-glmmTMB(GM_TotalLeaf_Area ~ Maple_TotalLeafArea_End + Fern +  
    ThripsDam + BlackPathDam +(1 | Family)+(1|gh_bench)  ,data= MapleModel)

summary(fit6)

#Thrips is not significant
fit7<-lmer(GM_TotalLeaf_Area ~ Maple_TotalLeafArea_End  +  
    Fern + Standardize(BlackPathDam ) +(1 | Family)+(1|gh_bench)  ,data= MapleModel)

summary(fit7) #Best model. 

#What is the p value of Maple?
fit8<-lmer(GM_TotalLeaf_Area ~    
   +Fern+ Standardize(BlackPathDam ) +(1 | Family)+(1|gh_bench)  ,data= MapleModel)
anova(fit7,fit8)

plot(fit7)
plot(residuals(fit7,type="pearson")~fitted(fit7))
qqnorm(residuals(fit7)) #looks good. 

#Modelling with standardized data to get coefficients.
fit7<-lmer(GM_TotalLeaf_Area ~ Standardize(Maple_TotalLeafArea_End)  +  
    Standardize(Fern) + Standardize(BlackPathDam) +(1 | Family)+(1|gh_bench)  ,data= MapleModel)
summary(fit7)


fit7<-lmer(Standardize(GM_TotalLeaf_Area) ~ Standardize(Maple_TotalLeafArea_End)  + Standardize(gluc_Conc)  
    Standardize(Fern) + Standardize(BlackPathDam ) +(1 | Family)+(1|gh_bench)  ,data= MapleModel)
summary(fit7)

#Getting coefficients from standardized data (respective to the whole data set)
fit7<-glmmTMB(Standardize(GM_TotalLeaf_Area,set.sd=T,3549.252) ~  Standardize(Maple_TotalLeafArea_End)  +
    Standardize(Fern) + Standardize(BlackPathDam ) +(1 | Family)+(1|gh_bench)  ,data= MapleModel)
summary(fit7)


 #-0.24305 is the SD/ SD effect of maple on GM. 

MaponGM<-Standardize(MapleModel$Maple_TotalLeafArea_End)
MaponGM
write.csv(MaponGM,"Map_SD_OnGM.csv")


```

#Using the best model of what determines fitness in the presense of competitor and pathogens, is there a cost to glucosinolates after holding these values constant? 
```{r}

#Cost of glucosinolates ?
fit7<-glmmTMB(Standardize(GM_TotalLeaf_Area) ~ Standardize(Maple_TotalLeafArea_End)   +  
    ThripsDam + BlackPathDam + (1 | Family) +  
    (1 | gh_bench) + Standardize(GM_Leaf_Area)+gluc_Conc,data=MapleModel)
AIC(fit7) #Gluc conc is significantly positive. 

fit7<-glmmTMB(Standardize(GM_TotalLeaf_Area) ~ Standardize(Maple_TotalLeafArea_End)   +  
    ThripsDam + BlackPathDam + (1 | Family) +  
    (1 | gh_bench) + Standardize(GM_Leaf_Area)+flav_Conc,data=MapleModel)
AIC(fit7) #Gluc conc is significantly positive. 

fit7<-glmmTMB(Standardize(GM_TotalLeaf_Area) ~ Standardize(Maple_TotalLeafArea_End)   +  
    ThripsDam + BlackPathDam + (1 | Family) +  
    (1 | gh_bench) + Standardize(GM_Leaf_Area)+ChlorA,data=MapleModel)
AIC(fit7) #Gluc conc is significantly positive. 



#Cost of Flavonoids ?
#Cost of glucosinolates ?
fit7<-glmmTMB(GM_TotalLeaf_Area ~ Maple_TotalLeafArea_End   +  
    ThripsDam + BlackPathDam + (1 | Family) +  
    (1 | gh_bench) + GM_Leaf_Area+flav_Conc,data=MapleModel)
summary(fit7) #no there is not.
```
I use the log(black path dam) but i do not have it weighted by leaf size. This is because i need to control for the influence that leaf size has on glucoisnolate concentration to avoid the autocorrelation between leaf size and performace (total leaf area)



#Modelling: Negative Binomial- Fern abundance
```{r}
#Because there are two garlic mustard individuals per pot, and the unit we are looking at is only replicable at the pot level (fern abundance in a pot) duplicates within the same pot in the garlic mustard treatment need to be removed and averaged to remove pseudoreplication. 

#What i will do is make the competition number the tag for those in the GM treatment. This will have the effect of maintaining the leaf variation, but averaging it over each pot. 

# I will need to use dat2, summarized at the individual level, because we have a single observation at the pot level, not at the leaf level. 
datFern<-dat2
datFern$Tag<-as.character(datFern$Tag)
for(i in 1:length(datFern$Tag)){
  if(!is.na(datFern$comp_number[i])){
    datFern$Tag[i]<-datFern$comp_number[i]
  }
}
datFern
#I am excluding flavonoid concentration because there were no detectable flavonoids in the root samples. 

#Modelling random effects 

fit_full<-glmmTMB(Fern~treatment+gluc_Conc+ChlorA+(1|Family)+(1|gh_bench),family=nbinom2,data=datFern)

fit_full_0.1<-glmmTMB(Fern~treatment+gluc_Conc+ChlorA+(1|Family),family=nbinom2,data=datFern)

fit_full_0.2<-glmmTMB(Fern~treatment+gluc_Conc+ChlorA+(1|gh_bench),family=nbinom2,data=datFern)

anova(fit_full,fit_full_0.1)#Bench is an extremenly important predictor. 
anova(fit_full,fit_full_0.2)#Family is not. 



#Testing the effect of glucosinolates without chlorophyll in the model
fit_full<-glmmTMB(Fern~treatment+gluc_Conc+(1|gh_bench),family=nbinom2,data=datFern[!is.na(datFern$gluc_Conc),])
fit_1<-glmmTMB(Fern~treatment+(1|gh_bench),family=nbinom2,data=datFern[!is.na(datFern$gluc_Conc),])

anova(fit_full,fit_1)



fit_full<-glmmTMB(Fern~treatment+gluc_Conc+ChlorA+(1|gh_bench),family=nbinom2,data=datFern[!is.na(datFern$gluc_Conc),])
fit_1<-glmmTMB(Fern~treatment+ChlorA+(1|gh_bench),family=nbinom2,data=datFern[!is.na(datFern$gluc_Conc),])

anova(fit_full,fit_1)#Glucosinolates are not a significant predictor of fern abundance (although the AIC is about the same)



summary(fit_full)
summary(fit_1)
#Using the whole data set...
fit_1<-glmmTMB(Fern~treatment+ChlorA+(1|gh_bench),family=nbinom2,data=datFern)
summary(fit_1)
#those with more ChlorA dont have less ferns. If anything, they have more ferns. It seems ferns are just along for the ride, if the pot is good enough, then ferns will grow.... Interestingly there are more ferns in the competition experiemnet. ...

fit_1<-glmmTMB(Fern~treatment+(1|gh_bench),family=nbinom2,data=datFern)
fit_2<-glmmTMB(Fern~1+(1|gh_bench),family=nbinom2,data=datFern)
anova(fit_2,fit_1)
#Fern abundance is predicted by treatment. 

summary(fit_1)$coef
plot(resid(fit_1))
plot(resid(fit_1)^2)

summary(fit_1)


# #Permutation test
# datPerTest<-datFern
# zStoretreatGM<-c()
# zStoretreatM<-c()
# 
# for(i in 1:500){
#   #Randomize flavonoid concentration.
#   datPerTest$treatment<-sample(datPerTest$treatment,length(datPerTest$treatment),replace = F)
# 
#   #New Model with randomized treatment and flavonoids
#   newMod<-update(fit_1,data=datPerTest)
#   
#   # Extract test statistics for maple (M) and garlic mustard (gm) treatments
#   MtreatZval<-summary(newMod)$coef[[1]][3,3]
#   GMtreatZval<-summary(newMod)$coef[[1]][3,2]
#   
#   #Store z value.
#   zStoretreatGM[i]<-GMtreatZval
#   zStoretreatM[i]<-MtreatZval
# }
# 
# sum(zStoretreatM>=2.316180)/length(zStoretreatM)
# #Estimated p value for the maple treatment is 0.01. This is very close to the actual p value of 0.02
# sum(zStoretreatGM>=2.231574)/length(zStoretreatGM)
# #Estimated p value for the garlic mustard treatment is 0. This is close to the actual p value of 0.02

summary(fit_1)
```

```{r}
ggplot(datFern)+
  geom_col(aes(x=treatment,y=Fern),stat=mean)

tapply(datFern$Fern,datFern$treatment,mean)
tapply(Maple$Fern
,Maple$treatment
,mean,na.rm=T)

dat
Maple
MapleModel$Fern
tapply(datFern$Fern,datFern$treatment,mean)#Wow....
```


If maples took hold at the end, it would explain why there is less glucosnilates in the treatment than expected, but total leaf area is just as high. This is consistent with the growth rate data and the fact that these were transplant maples 





