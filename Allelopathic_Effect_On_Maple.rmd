---
title: "Competitive Ability and the influence of glucosinolates and flavonols"
author: "Richard Honor"
date: "31/03/2020"
output: html_document
---


#Read in and prep data
```{r}
library(ggplot2)
library(dplyr)
library(car)
library("glmmTMB")


#read in data
rm(list=ls())
dat<-read.csv("DataSynthesis.csv")

#remove those with fertilizer treatment, and extra genotypes that are only in the alone treatment. 
dat<-dat[!grepl("i",dat$Sample,fixed=T),]


#Function to standardize data.
Standardize<-function(x,set.sd=F,SD){
  if(set.sd==T){
      standard<-(x-mean(x,na.rm=T))/SD
  }
  else{
     standard<-(x-mean(x,na.rm=T))/sd(x,na.rm=T)
  }
}



#Logging pathogen damage data variables as they are very skewed. 
dat$Fern<-log(dat$Fern+1)
dat$gluc_Conc<-log(dat$gluc_Conc)
dat$flav_Conc<-log(dat$flav_Conc)
dat$ChlorA<-log(dat$ChlorA)
dat$ThripsDam<-log(dat$ThripsDam+1)
dat$BlackPathDam<-log(dat$BlackPathDam+1)


#Calculating leaf area 
dat$GM_Leaf_Area<-dat$GM_Leaf_Wid*dat$GM_Leaf_Len


#Average Duplicates. 
dat2<-dat %>% select(-X) %>% group_by(Tag) %>%  summarize(gh_col=first(gh_col),gh_bench=first(gh_bench),treatment=first(treatment),GA3=first(GA3),Family=first(Family),Maple_StemHeight_End=mean(Maple_StemHeight_End),Maple_LeafNum_End=mean(Maple_LeafNum_End),maple_leaf_length_0=mean(maple_leaf_length_0),maple_leaves_0=mean(maple_leaves_0),Maple_TotalLeafArea_End=mean(Maple_TotalLeafArea_End),MapleDamage=mean(Maple_Damage_End),Fern=first(Fern),gluc_Conc=mean(gluc_Conc),flav_Conc=mean(flav_Conc),maple_height_0=mean(maple_height_0),ChlorA=mean(ChlorA),RGR1=first(RGR1), GM_TotalLeaf_Area=first(GM_TotalLeaf_Area),ThripsDam=mean(ThripsDam),BlackPathDam=mean(BlackPathDam),WhiteFungDam=mean(WhiteFungDam),comp_number=first(comp_number),GM_Leaf_Area=mean(GM_Leaf_Area))


#Converting white fungal damage to logistic. 
dat2$WhiteFungLogis<-NA
dat2$WhiteFungLogis[dat2$WhiteFungDam>0]<-"Yes"
dat2$WhiteFungLogis[dat2$WhiteFungDam==0]<-"No"



```

#Creating a maple dataframe. 
```{r}

#Creating a maple data frame
Maple<-dat2[dat2$treatment=="m"|dat2$treatment=="mcnt",]


Maple[is.na(Maple$Maple_StemHeight_End),]

#b|EFCC2-4-80|Q|144 and f|JBCHY1-1-50|Q|247,e|CBMCK1-1-0|N|49, e|JWBOY-2-80|Q|264 are simply not in the datafile. Nothing to do there - they will be deleted from the analyis. These genotypes are either dead, or we missed them when conducting the sampling.
Maple<-Maple[!is.na(Maple$Maple_StemHeight_End),]
Maple$treatment<-factor(Maple$treatment,levels = c("m","mcnt"))


#Correcting an error of initial maple height. A height of 8 is not possible. changing to 80 as this is a likely typo. 
Maple$maple_height_0[Maple$maple_height_0==8]<-80


min(Maple$maple_height_0)

max(Maple$maple_height_0)
hist(Maple$maple_height_0,breaks = 20)



```

#Maple PCA 
```{r}
#PCA values are based on the standard deviations of the variables included in the analysis. Therefore, it is neccessairy to scale the variables before using them in a PCA. Variables with high SD will have more weight in constructing the loadings than a variable with a low SD. I need all variables to have the same standard deviation. 


#Selecting variables to use in the PCA (All initial and final maple measurements which could indicate performance)
PCAMaple<-Maple %>% select(maple_height_0,maple_leaf_length_0,maple_leaves_0,Maple_StemHeight_End,Maple_LeafNum_End,Maple_TotalLeafArea_End)

#Standardizing all variables.
PCAMaple<-data.frame(apply(PCAMaple,2,Standardize))

#---------------
#Performing model 
#---------------

#Model with everything
pcaModelTotal<-prcomp(PCAMaple)

pcaModelEnd<-prcomp(PCAMaple %>% select(Maple_StemHeight_End,Maple_LeafNum_End,Maple_TotalLeafArea_End))
pcaModelZero<-prcomp(PCAMaple %>% select(maple_height_0,maple_leaf_length_0,maple_leaves_0))


#All variables go in the same direction.
biplot(pcaModelTotal)
biplot(pcaModelZero)
biplot(pcaModelEnd)


#40% of the variation in the data is explained in the first PCA. 
summary(pcaModelTotal)
summary(pcaModelEnd)
summary(pcaModelZero)

#All variables are correlated with the PC1 loading. 
plot(predict(pcaModelTotal)[,1]~PCAMaple$Maple_TotalLeafArea_End)
plot(predict(pcaModelTotal)[,1]~PCAMaple$maple_height_0)
plot(predict(pcaModelTotal)[,1]~PCAMaple$maple_leaf_length_0)
plot(predict(pcaModelTotal)[,1]~PCAMaple$maple_leaves_0)

#Adding in PC1 vales from the pca. This will be used to control for initial maple size in my experiment. 
Maple$PC1Tot<-predict(pcaModelTotal)[,1]

#Removing maple controls (to be used in models that do not include controls) 
MapleModel<-Maple %>% filter(treatment=="m")


```

#Getting residuals of simple correlation between final leaf area and initial size
```{r}
fit<-lm(Maple_TotalLeafArea_End~PC1Tot,data=MapleModel)
residual<-as.data.frame(resid(fit))

summary(fit)

resi<-tibble::rownames_to_column(residual, "rownumber")

#Adding in residuals to data frame. 
MapleModel[resi$rownumber,"MapleLeafAreaResidual"]<-resi$'resid(fit)'

MapleModel$MapleLeafAreaResidualS<-Standardize(MapleModel$MapleLeafAreaResidual)
```



#Genetic correlation with PCA for glucosinolates and chlorA 
```{r}
#Standardizing Variables.
MapleModel$GM_TotalLeaf_AreaS<-Standardize(MapleModel$GM_TotalLeaf_Area)
MapleModel$flav_ConcS<-Standardize(MapleModel$flav_Conc)
MapleModel$gluc_ConcS<-Standardize(MapleModel$gluc_Conc)
MapleModel$MapleDamageS<-Standardize(MapleModel$MapleDamage)
MapleModel$ChlorAS<-Standardize(MapleModel$ChlorA)
MapleModel$RGR1S<-Standardize(MapleModel$RGR1)
MapleModel$GM_Leaf_AreaS<-Standardize(MapleModel$GM_Leaf_Area)
MapleModel$gh_bench<-as.factor(MapleModel$gh_bench)
MapleModel$PC1TotS<-Standardize(MapleModel$PC1Tot)
MapleModel$MapleDamageS<-Standardize(MapleModel$MapleDamage)
MapleModel$Maple_TotalLeafArea_EndS<-Standardize(MapleModel$Maple_TotalLeafArea_End)


pcaGlucCor<-prcomp(~gluc_ConcS+ChlorAS,data=MapleModel,na.action=na.omit)

prediction<-as.data.frame(predict(pcaGlucCor))

df<-tibble::rownames_to_column(prediction, "rownumber")

biplot(pcaGlucCor)

MapleModel[df$rownumber,"PC1GC"]<-df$PC1
MapleModel[df$rownumber,"PC2GC"]<-df$PC2


MapleModel$PC1GC<-MapleModel$PC1GC*-1
plot(MapleModel$PC1GC~MapleModel$PC2GC)

datG<-MapleModel %>% select(Tag,Family,gluc_ConcS,ChlorAS,flav_ConcS,GM_TotalLeaf_AreaS,gh_bench,treatment,RGR1S,GM_Leaf_AreaS,PC1GC,PC2GC) %>%  pivot_longer(c(PC1GC,GM_TotalLeaf_AreaS))

hist(MapleModel$PC1GC)
#This fit fine. 
#Model convergence issue again. 
fit5<-glmmTMB(value ~ name*gh_bench+(-1+name|Family),REML=T,data=datG)
summary(fit5)
vignette('troubleshooting')
datG
```


#Determining if glucosinolate or chlorophyll causes reduction in maple performance. 
```{r}

#Shifting data wide
datG<-MapleModel %>% select(Tag,Family,gluc_ConcS,ChlorAS,GM_TotalLeaf_AreaS,gh_bench,MapleDamageS,PC1TotS,Maple_TotalLeafArea_EndS,Maple_TotalLeafArea_End,PC1GC,PC2GC,MapleLeafAreaResidualS) %>%  pivot_longer(c(MapleLeafAreaResidualS,PC2GC))

plot(MapleLeafAreaResidualS~PC2GC,data=MapleModel)
#try with pc1 and pc2. can not do pc2 if no genetic variation. 

#Genetic variation for all traits #Still no fit using the residuals from the model
fit1<-glmmTMB(value ~ name+(-1+name|Family),REML=T,data=datG)
#Would not converge. Removing damage interaction as it has a small effect. ... why would damage be expected to effect garlic mustard traits? 
summary(fit1)
#Model without total leaf area. 
fit2<-glmmTMB(value ~ gh_bench+(-1+name|Family),REML=T,data=datG)
#Still no fit. 
```




#Visuallization: maple treatments -- initial maple size controlled.. 
```{r}
#Modelling

#Is Damage significant?
fit1<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+treatment+Fern+MapleDamage,data=Maple)
fit2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+treatment+Fern,data=Maple)
anova(fit1,fit2) #Yes
summary(fit1)
#Is Fern significant?
fit1<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+treatment+Fern+MapleDamage,data=Maple)
fit2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+treatment+MapleDamage,data=Maple)
anova(fit1,fit2) #Yes

#Is treatment significant?
fit1<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+Fern+MapleDamage,data=Maple)
fit2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+treatment+Fern+MapleDamage,data=Maple)
anova(fit1,fit2) #Yes

#Is there an interaction?
fit1<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+treatment+Fern+MapleDamage,data=Maple)
fit2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot*treatment+Fern+MapleDamage,data=Maple)
anova(fit1,fit2) #no, not at all when other variables are accounted for.

#Generating coefficients
fit1<-glmmTMB(Standardize(Maple_TotalLeafArea_End)~PC1Tot+treatment+Standardize(Fern)+Standardize(MapleDamage),data=Maple)
summary(fit1)
slope<-function(x,PlusInt){
  y=1261.58*x+6674.52+PlusInt
  return(y)
}
#-1914.29 change in intercept in the competition treatment

#Competition x axis
Comp<-Maple$PC1Tot[Maple$treatment=="m"]
xComp<-seq(min(Comp),max(Comp),length.out = 194)

#Control x axis
Cont<-Maple$PC1Tot[Maple$treatment=="mcnt"]
xCont<-seq(min(Cont),max(Cont),length.out = 194)



source("GGPlot_Themes.R")

tiff("Maple_Figures/Maple_Control.tiff", units="in", width=10, height=6, res=300)
ggplot()+
  geom_point(aes(y=Maple$Maple_TotalLeafArea_End,x=Maple$PC1Tot,colour=Maple$treatment))+
  geom_path(aes(x=xCont,y=slope(xCont,0)),colour="black",size=1)+
  geom_path(aes(x=xComp,y=slope(xComp,-1914.29)),colour="#E69F00",size=1)+
    scale_colour_manual(values=c("black","#E69F00" ),labels=c("Maple Alone","Interspecific"))+
  scale_y_continuous(breaks=seq(0,20000,2500))+
  scale_x_continuous(breaks=seq(-3,5,1))+

  theme_simple()+
  ylab(bquote(bold("Total Leaf Area"~(mm^2))))+
  xlab("Initial Size (PC1)")
dev.off()

#The conclusion is that, not only are maples in the mcnt treatment have higher fitness after controlling for differences in initial size, they also exhibit increased growth at a given body size. 

#Generating coefficients for display
Maple$treatment<-factor(Maple$treatment,levels=c("mcnt","m"))
fitTreat<-glmmTMB(Standardize(Maple_TotalLeafArea_End)~Standardize(PC1Tot)+treatment+Standardize(Fern)+Standardize(MapleDamage),data=Maple)
summary(fitTreat)

confint(fitTreat)
```



#Modelling: what effects maple performance?
```{r}
#Is bench important? 
fit<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+gluc_Conc+(1|gh_bench), data=MapleModel[!is.na(MapleModel$gluc_Conc),])
fit2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+gluc_Conc, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
anova(fit,fit2) #No it is not.

#Modelling fixed effects. 
fit<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+gluc_Conc+MapleDamage+Family+GM_TotalLeaf_Area+Fern, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
summary(fit) 

fit2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+gluc_Conc+MapleDamage+GM_TotalLeaf_Area+Fern, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
anova(fit,fit2) #Family not significant. 
summary(fit2)

fit3<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+gluc_Conc+MapleDamage+Fern, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
anova(fit2,fit3) #Total leaf area not significant. 

#Is family important if I add it mack in? 
fit4<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+gluc_Conc+MapleDamage+Family+Fern, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
anova(fit4,fit3) #No, still not important.

#IS glucosinolate significant?
fit5<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+MapleDamage+Fern, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
anova(fit3,fit5) #Yes it is. 

#IS damage significant?
fit6<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+gluc_Conc+Fern, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
anova(fit3,fit6) #Yes it is. 

#IS Fern significant?
fit7<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+gluc_Conc+MapleDamage, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
anova(fit3,fit7) #No it is not. 

#IS initial size significant?
fit8<-glmmTMB(Maple_TotalLeafArea_End~gluc_Conc+MapleDamage+Fern, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
anova(fit3,fit8) #No it is not. 


#The best model is 
fit3<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+Standardize(gluc_Conc)+Standardize(MapleDamage)+Standardize(Fern), data=MapleModel[!is.na(MapleModel$gluc_Conc),])
summary(fit3)
length(residuals(fit3))

plot(residuals(fit3,type="pearson"),fitted(fit3))

plot(residuals(fit3,type="pearson"))
qqnorm(residuals(fit3,type="pearson"))

#What is the effect with chlorophyll included?
fit0.1<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+gluc_Conc+MapleDamage+ChlorA, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
fit0.2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+MapleDamage+ChlorA, data=MapleModel[!is.na(MapleModel$gluc_Conc),])
anova(fit0.1,fit0.2) #

#What is the effect of chlorophyll?
fit0.1<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+gluc_Conc+MapleDamage+ChlorA, data=MapleModel[!is.na(MapleModel$ChlorA),])
fit0.2<-glmmTMB(Maple_TotalLeafArea_End~PC1Tot+gluc_Conc+MapleDamage, data=MapleModel[!is.na(MapleModel$ChlorA),])
anova(fit0.1,fit0.2) #


```



```{r}
#Generating SD for figure. This model has the standard deviation of the enire maple data set to make it translateable to the model scale. 
fit3<-glmmTMB(Standardize(Maple_TotalLeafArea_End,set.sd = T,3132.683)~Standardize(PC1Tot)+Standardize(GM_TotalLeaf_Area)+Standardize(MapleDamage), data=MapleModel)

summary(fit3)

#The effect of GM size on maple is -0.0354822  SD/SD

GM_SD_OnMap<-Standardize(MapleModel$GM_TotalLeaf_Area)
GM_SD_OnMap
#write.csv(GM_SD_OnMap,"GM_SD_OnMap.csv")

#Ferns did not effect maple.....
```



#Visualizing effect of glucosinolates on maple performance. 
```{r}
source("GGPlot_Themes.R")
fitTw2<-glmmTMB(Maple_TotalLeafArea_End~Standardize(PC1Tot)+gluc_Conc+Standardize(MapleDamage), data=MapleModel[!is.na(MapleModel$gluc_Conc),])
summary(fitTw2)

#ChlorA Slope
fitTw2<-glmmTMB(Maple_TotalLeafArea_End~Standardize(PC1Tot)+ChlorA+Standardize(MapleDamage), data=MapleModel)
summary(fitTw2)

glucSlope<-function(x){
  y=-1338.5  *x+2282.3 #Non significant slope
  return(y)
}
minG<-min(MapleModel$gluc_Conc,na.rm = T)
maxG<-max(MapleModel$gluc_Conc,na.rm = T)

chlorSlope<-function(x){
  y= -1751.0  *x+2307.9  #Non significant slope
  return(y)
}

minC<-min(MapleModel$ChlorA,na.rm = T)
maxC<-max(MapleModel$ChlorA,na.rm = T)



a<-ggplot(MapleModel)+
  geom_point(aes(y=Maple_TotalLeafArea_End,x=gluc_Conc),colour="#E69F00")+
    geom_segment(x=minG,xend=maxG,y=glucSlope(minG),yend=glucSlope(maxG),colour="black",size=1.5)+
  scale_y_continuous(breaks=seq(0,20000,2500))+
   scale_x_continuous(breaks=seq(-3,0,0.25))+
  theme_simple_multiCol_First()+
  ylab(bquote(bold("Total Leaf Area "*(mm^2))))+
  xlab(bquote(bold("[Total Glucosinolate] (log" (mg/ml)*")")))

b<-ggplot(MapleModel)+
  geom_point(aes(y=Maple_TotalLeafArea_End,x=ChlorA),colour="#E69F00")+
  geom_segment(x=minC,xend=maxC,y=chlorSlope(minC),yend=glucSlope(maxC),colour="black",size=1.5)+
  scale_y_continuous(breaks=seq(0,20000,2500))+
 scale_x_continuous(breaks=seq(-3,0,0.5))+
  theme_simple_multiCol()+
  ylab(bquote(bold("Total Leaf Area "~(mm^2))))+
  xlab(bquote(bold("[Chlorophyll A] (log"(μg/ml)*")")))

plots <- align_plots(a, b,align="hv")



tiff("Maple_Figures/Maple_Inhibition_gluc_Chlor.tiff", units="in", width=12, height=6, res=300)
plot_grid(plots[[1]],plots[[2]],ncol=2,rel_widths=c(1,1),rel_heights = c(1,1),labels = c("a","b"),label_fontfamily = "Arial",label_size = 18)
dev.off()

```

#Genetic correlation model to determine if genotype or glucosinolate is responsible 
```{r}
library(tidyr)

MapleModel$Family<-as.character(MapleModel$Family)
#Standardizing variables
MapleModel$gluc_ConcS<-Standardize(MapleModel$gluc_Conc)
MapleModel$ChlorAS<-Standardize(MapleModel$ChlorA)
MapleModel$GM_TotalLeaf_AreaS<-Standardize(MapleModel$GM_TotalLeaf_Area)
MapleModel$PC1TotS<-Standardize(MapleModel$PC1Tot)
MapleModel$MapleDamageS<-Standardize(MapleModel$MapleDamage)
MapleModel$Maple_TotalLeafArea_EndS<-Standardize(MapleModel$Maple_TotalLeafArea_End)

  #Genetic correlation model to determine if genotype or glucosinolate is responsible 


#Shifting data wide
datG<-MapleModel %>% select(Tag,Family,gluc_ConcS,ChlorAS,GM_TotalLeaf_AreaS,gh_bench,MapleDamageS,PC1TotS,Maple_TotalLeafArea_EndS,Maple_TotalLeafArea_End) %>%  pivot_longer(c(Maple_TotalLeafArea_End,gluc_ConcS,ChlorAS,GM_TotalLeaf_AreaS))

#try with pc1 and pc2. can not do pc2 if no genetic variation. 

#Genetic variation for all traits
fit1<-glmmTMB(value ~ name*PC1TotS+name*MapleDamageS+(-1+name|Family),REML=T,data=datG)
#Would not converge. Removing damage interaction as it has a small effect. ... why would damage be expected to effect garlic mustard traits? 
summary(fit1)


fit2<-glmmTMB(value ~ name*PC1TotS+MapleDamageS+(-1+name|Family),REML=T,data=datG) 
#Still no good. ..Removing damage entirely. 

fit3<-glmmTMB(value ~ name*PC1TotS+(-1+name|Family),REML=T,data=datG) 
#Still no convergence.


#Trying model without garlic mustard size, as i found that that was not significant predictor
datG<-MapleModel %>% select(Tag,Family,gluc_ConcS,ChlorAS,GM_TotalLeaf_AreaS,gh_bench,MapleDamageS,PC1TotS,Maple_TotalLeafArea_EndS,Maple_TotalLeafArea_End) %>%  pivot_longer(c(Maple_TotalLeafArea_EndS,gluc_ConcS,ChlorAS))

fit1<-glmmTMB(value ~ name*PC1TotS+name*MapleDamageS+(-1+name|Family),REML=T,data=datG)
#Would not converge. Removing damage interaction 

fit2<-glmmTMB(value ~ name*PC1TotS+MapleDamageS+(-1+name|Family),REML=T,data=datG) 
#Still no good. ..Removing damage entirely. 

fit3<-glmmTMB(value ~ name*PC1TotS+(-1+name|Family),REML=T,data=datG) 
#Still no convergence.
summary(fit3)
fit4<-glmmTMB(value ~-1 +(-1+name|Family),REML=T,data=datG) 



#Removing Chlor A as there is little genetic correlation for it anyways 
datG<-MapleModel %>% select(Tag,Family,gluc_ConcS,ChlorAS,GM_TotalLeaf_AreaS,gh_bench,MapleDamageS,PC1TotS,Maple_TotalLeafArea_EndS,Maple_TotalLeafArea_End) %>%  pivot_longer(c(Maple_TotalLeafArea_End,gluc_ConcS))

fit1<-glmmTMB(value ~ name*PC1TotS+name*MapleDamageS+(-1+name|Family),REML=T,data=datG)
#Would not converge. Removing damage interaction 

fit2<-glmmTMB(value ~ name*PC1TotS+MapleDamageS+(-1+name|Family),REML=T,data=datG) 
#Still no good. ..Removing damage entirely. 

fit3<-glmmTMB(value ~ name*PC1TotS+(-1+name|Family),REML=T,data=datG) 
#Still no convergence.
summary(fit3)


fit4<-glmmTMB(value ~ PC1TotS+(-1+name|Family),REML=T,data=datG) 
summary(fit4)

fit4<-glmmTMB(value ~ -1+(-1+name|Family),REML=T,data=datG) 
summary(fit4)
#Model just wont run. 
```

#Calculating genetic correlation between gluc, chlor and total size. 
```{r}
datG<-MapleModel %>% select(Tag,Family,gluc_ConcS,ChlorAS,GM_TotalLeaf_AreaS,gh_bench,MapleDamageS,PC1TotS,Maple_TotalLeafArea_EndS,Maple_TotalLeafArea_End) %>%  pivot_longer(c(gluc_ConcS,ChlorAS,GM_TotalLeaf_AreaS))

glmmTMB(value ~ -1+name*gh_bench+(-1+name|Family),REML=T,data=datG)
#did not converge... removing bench interaction.

glmmTMB(value ~ -1+name+gh_bench+(-1+name|Family),REML=T,data=datG)
#Did not converge, removing bench. 
glmmTMB(value ~ -1+(-1+name|Family),REML=T,data=datG)
#Still did not converge. 

```



#Effect of maple on GM performance. 
I chose to seperate this model from the last due to the causality inherent in this data. Glucosinolate concentration should affect garlic mustard fitness only through effects on maple and pathogen abundance. Including glucosinolate concentration in a model with both of these variables to determien the effect of glucosinolates on fitness is actually determining how much glucosinolates affect fitness when these terms are controlled for, which should be not at all. Therefore multiple models are needed to test if glucosinolates influence abundance of pathogens and maple performance, after controlling for garlic mustard performance (Using chlorophyll A, because those with high performance might simply be making more glucosinolates). Then i can see how much maple and pathogens influence garlic mustard performance. 
```{r}
#ThripsDam and BlackPathDam represent standardized, logged data which are weighed by leaf size. 
MapleModel$GM_Leaf_Area<-Standardize(MapleModel$GM_Leaf_Area)
MapleModel$Maple_TotalLeafArea_End<-Standardize(MapleModel$Maple_TotalLeafArea_End)

#Modelling random effects 
fit<-glmmTMB(Standardize(GM_TotalLeaf_Area)~Maple_TotalLeafArea_End+Fern+ThripsDam*BlackPathDam*WhiteFungLogis+(1|Family)+(1|gh_bench),data=MapleModel)

fit2<-glmmTMB(Standardize(GM_TotalLeaf_Area)~Maple_TotalLeafArea_End+Fern+ThripsDam*BlackPathDam*WhiteFungLogis+(1|Family),data=MapleModel)

fit3<-glmmTMB(Standardize(GM_TotalLeaf_Area)~Maple_TotalLeafArea_End+Fern+ThripsDam*BlackPathDam*WhiteFungLogis+(1|gh_bench),data=MapleModel)


#Is Bench important? 
anova(fit,fit2) #Yes bench is very important

#Is family important? 
anova(fit,fit3) #Family is on the edge. but i will leave it for now. 

#Modeling fixed effects: 

fit<-glmmTMB(GM_TotalLeaf_Area~Maple_TotalLeafArea_End+Fern+ThripsDam*BlackPathDam*WhiteFungLogis+(1|Family)+(1|gh_bench),data=MapleModel)

fit2<-update(fit,~.-ThripsDam:BlackPathDam:WhiteFungLogis)
anova(fit,fit2) #Not a significant three way interaction.

fit3<-update(fit2,~.-BlackPathDam:WhiteFungLogis)
anova(fit3,fit2) #There is not a significant two way interaction.

fit4<-update(fit3,~.-BlackPathDam:ThripsDam)
anova(fit4,fit3)
#There is no significant interaction between black path dam and thrips dam interaction p=0.06 (very close). 

fit5<-update(fit4,~.-WhiteFungLogis:ThripsDam)
anova(fit5,fit4) #There is not significant white path and thripsdamage interaction.

summary(fit5) #White fungal damage not significant. 


fit6<-glmmTMB(GM_TotalLeaf_Area ~ Maple_TotalLeafArea_End + Fern +  
    ThripsDam + BlackPathDam +(1 | Family)+(1|gh_bench)  ,data= MapleModel)

summary(fit6)

#Thrips is not significant
fit7<-lmer(GM_TotalLeaf_Area ~ Maple_TotalLeafArea_End  +  
    Fern + Standardize(BlackPathDam ) +(1 | Family)+(1|gh_bench)  ,data= MapleModel)

summary(fit7) #Best model. 

#What is the p value of Maple?
fit8<-lmer(GM_TotalLeaf_Area ~    
   +Fern+ Standardize(BlackPathDam ) +(1 | Family)+(1|gh_bench)  ,data= MapleModel)
anova(fit7,fit8)

plot(fit7)
plot(residuals(fit7,type="pearson")~fitted(fit7))
qqnorm(residuals(fit7)) #looks good. 

#Modelling with standardized data to get coefficients.
fit7<-lmer(GM_TotalLeaf_Area ~ Standardize(Maple_TotalLeafArea_End)  +  
    Standardize(Fern) + Standardize(BlackPathDam ) +(1 | Family)+(1|gh_bench)  ,data= MapleModel)
summary(fit7)

#Getting coefficients from standardized data (respective to the whole data set)
fit7<-glmmTMB(Standardize(GM_TotalLeaf_Area,set.sd=T,3549.252) ~  Standardize(Maple_TotalLeafArea_End)  +
    Standardize(Fern) + Standardize(BlackPathDam ) +(1 | Family)+(1|gh_bench)  ,data= MapleModel)
summary(fit7)


 #-0.24305 is the SD/ SD effect of maple on GM. 

MaponGM<-Standardize(MapleModel$Maple_TotalLeafArea_End)
MaponGM
write.csv(MaponGM,"Map_SD_OnGM.csv")


```

#Using the best model of what determines fitness in the presense of competitor and pathogens, is there a cost to glucosinolates after holding these values constant? 
```{r}

#Cost of glucosinolates ?
fit7<-glmmTMB(GM_TotalLeaf_Area ~ Standardize(Maple_TotalLeafArea_End)   +  
    ThripsDam + BlackPathDam + (1 | Family) +  
    (1 | gh_bench) + Standardize(GM_Leaf_Area)+gluc_Conc,data=MapleModel)
summary(fit7) #Gluc conc is significantly positive. 


#Cost of Flavonoids ?
#Cost of glucosinolates ?
fit7<-glmmTMB(GM_TotalLeaf_Area ~ Maple_TotalLeafArea_End   +  
    ThripsDam + BlackPathDam + (1 | Family) +  
    (1 | gh_bench) + GM_Leaf_Area+flav_Conc,data=MapleModel)
summary(fit7) #no there is not.
```
I use the log(black path dam) but i do not have it weighted by leaf size. This is because i need to control for the influence that leaf size has on glucoisnolate concentration to avoid the autocorrelation between leaf size and performace (total leaf area)



#Modelling: Negative Binomial- Fern abundance
```{r}
#Because there are two garlic mustard individuals per pot, and the unit we are looking at is only replicable at the pot level (fern abundance in a pot) duplicates within the same pot in the garlic mustard treatment need to be removed and averaged to remove pseudoreplication. 

#What i will do is make the competition number the tag for those in the GM treatment. This will have the effect of maintaining the leaf variation, but averaging it over each pot. 

# I will need to use dat2, summarized at the individual level, because we have a single observation at the pot level, not at the leaf level. 
datFern<-dat2
datFern$Tag<-as.character(datFern$Tag)
for(i in 1:length(datFern$Tag)){
  if(!is.na(datFern$comp_number[i])){
    datFern$Tag[i]<-datFern$comp_number[i]
  }
}
datFern
#I am excluding flavonoid concentration because there were no detectable flavonoids in the root samples. 

#Modelling random effects 

fit_full<-glmmTMB(Fern~treatment+gluc_Conc+ChlorA+(1|Family)+(1|gh_bench),family=nbinom2,data=datFern)

fit_full_0.1<-glmmTMB(Fern~treatment+gluc_Conc+ChlorA+(1|Family),family=nbinom2,data=datFern)

fit_full_0.2<-glmmTMB(Fern~treatment+gluc_Conc+ChlorA+(1|gh_bench),family=nbinom2,data=datFern)

anova(fit_full,fit_full_0.1)#Bench is an extremenly important predictor. 
anova(fit_full,fit_full_0.2)#Family is not. 



#Testing the effect of glucosinolates without chlorophyll in the model
fit_full<-glmmTMB(Fern~treatment+gluc_Conc+(1|gh_bench),family=nbinom2,data=datFern[!is.na(datFern$gluc_Conc),])
fit_1<-glmmTMB(Fern~treatment+(1|gh_bench),family=nbinom2,data=datFern[!is.na(datFern$gluc_Conc),])

anova(fit_full,fit_1)



fit_full<-glmmTMB(Fern~treatment+gluc_Conc+ChlorA+(1|gh_bench),family=nbinom2,data=datFern[!is.na(datFern$gluc_Conc),])
fit_1<-glmmTMB(Fern~treatment+ChlorA+(1|gh_bench),family=nbinom2,data=datFern[!is.na(datFern$gluc_Conc),])

anova(fit_full,fit_1)#Glucosinolates are not a significant predictor of fern abundance (although the AIC is about the same)



summary(fit_full)
summary(fit_1)
#Using the whole data set...
fit_1<-glmmTMB(Fern~treatment+ChlorA+(1|gh_bench),family=nbinom2,data=datFern)
summary(fit_1)
#those with more ChlorA dont have less ferns. If anything, they have more ferns. It seems ferns are just along for the ride, if the pot is good enough, then ferns will grow.... Interestingly there are more ferns in the competition experiemnet. ...

fit_1<-glmmTMB(Fern~treatment+(1|gh_bench),family=nbinom2,data=datFern)
fit_2<-glmmTMB(Fern~1+(1|gh_bench),family=nbinom2,data=datFern)
anova(fit_2,fit_1)
#Fern abundance is predicted by treatment. 

summary(fit_1)$coef
plot(resid(fit_1))
plot(resid(fit_1)^2)

summary(fit_1)


# #Permutation test
# datPerTest<-datFern
# zStoretreatGM<-c()
# zStoretreatM<-c()
# 
# for(i in 1:500){
#   #Randomize flavonoid concentration.
#   datPerTest$treatment<-sample(datPerTest$treatment,length(datPerTest$treatment),replace = F)
# 
#   #New Model with randomized treatment and flavonoids
#   newMod<-update(fit_1,data=datPerTest)
#   
#   # Extract test statistics for maple (M) and garlic mustard (gm) treatments
#   MtreatZval<-summary(newMod)$coef[[1]][3,3]
#   GMtreatZval<-summary(newMod)$coef[[1]][3,2]
#   
#   #Store z value.
#   zStoretreatGM[i]<-GMtreatZval
#   zStoretreatM[i]<-MtreatZval
# }
# 
# sum(zStoretreatM>=2.316180)/length(zStoretreatM)
# #Estimated p value for the maple treatment is 0.01. This is very close to the actual p value of 0.02
# sum(zStoretreatGM>=2.231574)/length(zStoretreatGM)
# #Estimated p value for the garlic mustard treatment is 0. This is close to the actual p value of 0.02

summary(fit_1)
```

```{r}
ggplot(datFern)+
  geom_col(aes(x=treatment,y=Fern),stat=mean)

tapply(datFern$Fern,datFern$treatment,mean)
tapply(Maple$Fern
,Maple$treatment
,mean,na.rm=T)

dat
Maple
MapleModel$Fern
tapply(datFern$Fern,datFern$treatment,mean)#Wow....
```


If maples took hold at the end, it would explain why there is less glucosnilates in the treatment than expected, but total leaf area is just as high. This is consistent with the growth rate data and the fact that these were transplant maples 





