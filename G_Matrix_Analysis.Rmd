---
title: "GMatrix"
author: "Richard Honor"
date: "02/06/2020"
output: html_document
---

#Read in and prep data
```{r}
library(ggplot2)
library(tidyr)
library(cowplot)
library(grid)
library(gridExtra)
library(dplyr)
library(glmmTMB)
source("GGPlot_Themes.R")

#read in data
rm(list=ls())
dat<-read.csv("DataSynthesis.csv",stringsAsFactors = F)

#Remove maple controls data from the data set.
dat<-dat %>% filter(treatment!="mcnt") %>% droplevels()

#remove those with fertilizer treatment, and extra genotypes that are only in the alone treatment. 
dat<-dat[!grepl("i",dat$Sample,fixed=T),]

#Initializing columns to avoid constant error messages. 
dat$WhiteFungLogis<-NA
dat$BlackFungLogis<-NA
```


#Generating data frames with summarized leaf data (dat2) and summarized genotype data (dat3)
```{r}
hist(dat$gluc_Conc)
hist(dat$flav_Conc)
#Both concentrations are above zero. 
min(dat$gluc_Conc,na.rm=T)
min(dat$flav_Conc,na.rm=T)

  #Function to standardize variables. 
Standardize<-function(x){
  standard<-(x-mean(x,na.rm=T))/sd(x,na.rm=T)
}


#Logging data
dat$Fern<-log(dat$Fern+1)
dat$gluc_Conc<-log(dat$gluc_Conc)
dat$flav_Conc<-log(dat$flav_Conc)
dat$ChlorA<-log(dat$ChlorA)
dat$ThripsDam<-log(dat$ThripsDam+1)
dat$BlackPathDam<-log(dat$BlackPathDam+1)



#Creating leaf area vector 
dat$GM_Leaf_Area<-dat$GM_Leaf_Len*dat$GM_Leaf_Wid



#Summarizing: Taking the mean value of leaves. This tibble contains data at the level of the plant means. 
dat2<-dat %>% group_by(Tag) %>% summarize(ChlorA=mean(ChlorA),ChlorB=mean(ChlorB),gluc_Conc=mean(gluc_Conc),flav_Conc=mean(flav_Conc),Family=first(Family),treatment=first(treatment),gh_row=first(gh_row),gh_bench=first(gh_bench),GM_TotalLeaf_Area=first(GM_TotalLeaf_Area),comp_number=first(comp_number),ThripsDam=mean(ThripsDam),WhiteFungDam=mean(WhiteFungDam),BlackPathDam=mean(BlackPathDam),Fern=mean(Fern),gh_col=first(gh_col),GM_Leaf_Area=mean(GM_Leaf_Area),Latitude=first(Latitude),Longitude=first(Longitude),Altitude=first(Altitude),RGR1=first(RGR1),GM_Leaf_Len_Initial=first(GM_Leaf_Len_Initial),GM_NumberOfLeaves_Initial=first(GM_NumberOfLeaves_Initial))


#All of these genotypes died (15 Genotypes).(We are simply missing a final measurement for e|JBCHY1-1-50|Q|240) That is only 3% Mortality. 
dead<-dat2[is.na(dat2$GM_TotalLeaf_Area),]

#Removing those with dead competitors from the garlic mustard treatment. ("e|JBCHY1-1-50|Q|240") did not die, we are simply missing the final measurement for it.

dead_competitors<-dead %>% filter(treatment=="gm",Tag!="e|JBCHY1-1-50|Q|240") %>% select(comp_number)

#Removing those with dead competitors from the analysis. 
dat2<-dat2 %>% filter(!comp_number %in% dead_competitors$comp_number)
dat<-dat %>% filter(!comp_number %in% dead_competitors$comp_number)


##Summarizing: Taking the mean value of plants. This tibble contains data at the level of the family means within each treatment. 
#dat3<-dat2 %>% drop_na(GM_TotalLeaf_Area) %>% group_by(Family,treatment)  %>% summarize_if(is.numeric,mean)



#Because of how zero inflated white pathogen damage is, i will use a logistic regression to model it.
dat2$WhiteFungLogis<-NA
dat2$WhiteFungLogis[dat2$WhiteFungDam==0]<-0
dat2$WhiteFungLogis[dat2$WhiteFungDam>0]<-1

```



#Gmatrix model without growth rate
```{r}
#Standardizing Variables.
dat2$GM_TotalLeaf_AreaS<-Standardize(dat2$GM_TotalLeaf_Area)
dat2$flav_ConcS<-Standardize(dat2$flav_Conc)
dat2$gluc_ConcS<-Standardize(dat2$gluc_Conc)
dat2$ChlorAS<-Standardize(dat2$ChlorA)
dat2$RGR1S<-Standardize(dat2$RGR1)
dat2$GM_Leaf_AreaS<-Standardize(dat2$GM_Leaf_Area)
dat2$gh_bench<-as.factor(dat2$gh_bench)


#Generating data frame for g matrix.
datG<-dat2 %>% select(Tag,Family,gluc_ConcS,ChlorAS,flav_ConcS,GM_TotalLeaf_AreaS,gh_bench,treatment) %>%  pivot_longer(c(gluc_ConcS,ChlorAS,GM_TotalLeaf_AreaS))


#---- #Genetic correlation between traits and within treatments

#Genetic variation for all traits
fit1<-glmmTMB(value ~ name+(1|Family),REML=T,data=datG)
summary(fit1) #Can run seperately for each trait. 

#Genetic correlations between traits. 
fit2<-glmmTMB(value ~ -1+name+(-1+name|Family),REML=T,data=datG)
summary(fit2)
cov2cor(vcov(fit2)$cond)
anova(fit1,fit2)#Not significantly better fit.

length(dat2$gluc_Conc[!is.na(dat2$gluc_Conc)])
length(dat2$flav_Conc[!is.na(dat2$flav_Conc)])
hist(dat2$gluc_ConcS)
hist(dat2$flav_ConcS)
#Genetic correlations between traits accounting for bench and treatment
fit3<-glmmTMB(value ~ -1+name+gh_bench+treatment +(-1+name|Family),REML=T,data=datG)
summary(fit3) #Took away the effect of treatment on each value (mean effect of treatment). 
anova(fit3,fit1) #This is a much better fit with treatment than both previous models. 

#Genetic correlations between traits accounting for bench and treatment interaction
fit4<-glmmTMB(value ~ -1+name*treatment +gh_bench+(-1+name|Family),REML=T,data=datG)
summary(fit4) #Took away the effect of treatment on each value, respective to each value (mean effect of treatment). 
anova(fit4,fit3) #This is a better model than the previous. 


#Genetic correlations between traits accounting for bench and treatment interaction.
datG
fit5<-glmmTMB(value ~ -1+name*treatment +gh_bench+name:gh_bench+(-1+name|Family),REML=T,data=datG)
summary(fit5) #Took away the effect of treatment on each value, respective to each value (mean effect of treatment). #####This model has interaction with treatment , gh bench and name such that treatment and gh bench have individual effects on each of chlophyll body size, and glucosinolate concentration. Glucosinolate has alot of genetic variation, but it is highly correlated with total leaf area and chlrophyll a. 


datG<-dat2 %>% select(Tag,Family,gluc_ConcS,ChlorAS,flav_ConcS,GM_TotalLeaf_AreaS,gh_bench,treatment,RGR1S,GM_Leaf_AreaS) %>%  pivot_longer(c(gluc_ConcS,GM_TotalLeaf_AreaS,ChlorAS))
hist(dat2$RGR1S)
sum(!is.na(dat2$RGR1S))

fit5<-glmmTMB(value ~ -1+name*treatment +gh_bench+name:gh_bench+(-1+name|Family),REML=T,data=datG,verbose=T)
summary(fit5)

fit5.5<-glmmTMB(value ~ -1+name*treatment +gh_bench+name:gh_bench+(-1+1|Family),REML=T,data=datG,verbose=T)

anova(fit5,fit5.5)

dat2$RGR1S

anova(fit5,fit4)
#This is the best model yet. GXE effects are ellusive, however.
cov2cor(vcov(fit5)$cond)

#Looking for genetic variation within each treatment (GXE)
fit6<-glmmTMB(value ~ -1+name*treatment +gh_bench+name:gh_bench+(-1+name|Family),REML=T,data=datG)
summary(fit6) #Model too complicated to test a GXE for all. 

#Does the G matrix change across treatments?

0.45^2
0.63^2
0.87^2
```


#Genetic correlation with PCA for glucosinolates and chlorA 
```{r}
#Standardizing Variables.
dat2$GM_TotalLeaf_AreaS<-Standardize(dat2$GM_TotalLeaf_Area)
dat2$flav_ConcS<-Standardize(dat2$flav_Conc)
dat2$gluc_ConcS<-Standardize(dat2$gluc_Conc)
dat2$ChlorAS<-Standardize(dat2$ChlorA)
dat2$RGR1S<-Standardize(dat2$RGR1)
dat2$GM_Leaf_AreaS<-Standardize(dat2$GM_Leaf_Area)
dat2$gh_bench<-as.factor(dat2$gh_bench)

pcaGlucCor<-prcomp(~gluc_ConcS+ChlorAS,data=dat2,na.action=na.omit)

prediction<-as.data.frame(predict(pcaGlucCor))

df<-tibble::rownames_to_column(prediction, "rownumber")

dat2[df$rownumber,"PC1GC"]<-df$PC1
dat2[df$rownumber,"PC2GC"]<-df$PC2
summary(pcaGlucCor)
pcaGlucCor
#Greater PC2 = less glucosinolate, more chlorophyll. I.e. more pc2 is lower gluc:flav ratio
datG<-dat2 %>% select(Tag,Family,gluc_ConcS,ChlorAS,flav_ConcS,GM_TotalLeaf_AreaS,gh_bench,treatment,RGR1S,GM_Leaf_AreaS,PC1GC,PC2GC) %>%  pivot_longer(c(GM_TotalLeaf_AreaS,PC2GC))

#This fit fine. 
fit5<-glmmTMB(value ~ -1+name*treatment +gh_bench+name:gh_bench+(-1+name|treatment)+(1|Family),REML=T,data=datG)
summary(fit5)

#Complex model to get at genetic correlations in treatments
fitW<-glmmTMB(value ~ -1+name*treatment +gh_bench+name:gh_bench+(-1+name|Family)+(-1+treatment|Family),REML=T,data=datG)
summary(fitW)

(1|treatment/Family)+(1|Family)

fit6<-glmmTMB(value ~ -1+name*treatment +gh_bench+name:gh_bench+(1|Family),REML=T,data=datG)
anova(fit5,fit6) #Highly significant genetic correlation. 

#Does PC2 have significant genetic variation?
fit7<-glmmTMB(PC2GC ~ treatment +gh_bench
              +(1|Family),REML=T,data=dat2)
summary(fit7)

  fit8<-glmmTMB(PC2GC ~ treatment +gh_bench
             ,REML=T,data=dat2)
anova(fit8,fit7) #Highly significant genetic variation for PC2! This is good news. 

#Does PC1 have significant genetic correlation?
fit7<-glmmTMB(PC1GC ~ treatment +gh_bench
              +(1|Family),REML=T,data=dat2)
summary(fit7)

0.067/(0.067+1.469) #only 4 percent H^2 for PC1 
  fit8<-glmmTMB(PC1GC ~ treatment +gh_bench
             ,REML=T,data=dat2)
anova(fit8,fit7) #Oddly genetic variation for PC1 is only on the edge of significance. I suppose this means that all individuals exhibit a phenotypic correlation between gluc_Conc and ChlorA but the genetic level lies in how the ratio differs between the two. 

pcaGlucCor #If i understand this correctly, this means that a high pc2 exhibits low glucosinolate and high chlorophyll and a low pc2 means high glucosinolate and low chlorophyll. Therefore, those with larger sizes  have a higher glucosinolate:chlorophyll ratio. 

summary(fit5)
```





#Generating genetic correlations for other variables
```{r}
#flav_Conc,ChlorA, Body Size #Genetic correlation with other variables are not possible due to reduced sample size. ... it just wont fit. 
datG<-dat2 %>% select(Tag,Family,gluc_ConcS,ChlorAS,flav_ConcS,GM_TotalLeaf_AreaS,gh_bench,treatment) %>%  pivot_longer(c(flav_ConcS,ChlorAS,GM_TotalLeaf_AreaS))

fit<-glmmTMB(value ~ -1+name*treatment +gh_bench+name:gh_bench+(-1+name|Family),REML=T,data=datG)
summary(fit) #Convergence problem


#RGR1, CHlorA and Body mass
#Creating data frame
datG<-dat2 %>% select(Tag,Family,gluc_ConcS,ChlorAS,flav_ConcS,GM_TotalLeaf_AreaS,gh_bench,treatment,RGR1S) %>%  pivot_longer(c(ChlorAS,GM_TotalLeaf_AreaS,RGR1S))

fit<-glmmTMB(value ~ -1+name*treatment +gh_bench+name:gh_bench+(-1+name|Family),REML=T,data=datG)
summary(fit) #Does not fit. 


#gluc_Conc,Flav_Conc and ChlorA
datG<-dat2 %>% select(Tag,Family,gluc_ConcS,ChlorAS,flav_ConcS,GM_TotalLeaf_AreaS,gh_bench,treatment) %>%  pivot_longer(c(gluc_ConcS,flav_ConcS,ChlorAS))

fit<-glmmTMB(value ~ -1+name*treatment +gh_bench+name:gh_bench+(-1+name|Family),REML=T,data=datG)
summary(fit) #Wont Fit.


#Flav_Conc and ChlorA
datG<-dat2 %>% select(Tag,Family,gluc_ConcS,ChlorAS,flav_ConcS,GM_TotalLeaf_AreaS,gh_bench,treatment) %>%  pivot_longer(c(flav_ConcS,ChlorAS))

fit<-glmmTMB(value ~ -1+name*treatment +gh_bench+name:gh_bench+(-1+name|Family),REML=T,data=datG)
summary(fit) #Wont fit. 
```

#Gnetic variation for individual traits -- 
On the left of the pipe is what the axis are, on the right side of the pipe is what the points are. ... too large. 
```{r}
#-----
####. CHlorophyll A
fit<-glmmTMB(ChlorA ~ gh_bench+treatment+GM_Leaf_AreaS,REML=T,data=dat2[!is.na(dat2$GM_Leaf_AreaS),])
fit0.1<-glmmTMB(ChlorA ~ gh_bench+treatment,REML=T,data=dat2[!is.na(dat2$GM_Leaf_AreaS),])
anova(fit,fit0.1) #Leaf area highly important. 

fit<-glmmTMB(ChlorA ~ gh_bench+treatment+GM_Leaf_AreaS,REML=T,data=dat2)

fit1<-glmmTMB(ChlorA ~ gh_bench+treatment+GM_Leaf_AreaS+(1|Family),REML=T,data=dat2)

anova(fit,fit1) #Genetic Variation for Chlorophyll is not significant.

summary(fit1)
0.003975/(0.159282+0.003975) #2.4 % of the variation in chlorophyll. 

#GXE interaction
fit2<-glmmTMB(ChlorA ~ gh_bench+treatment+GM_Leaf_AreaS+(1|Family:treatment),REML=T,data=dat2)
summary(fit2) 
anova(fit1,fit2)#Interaction is not significant

#---------------
#Glucosinolate
fit<-glmmTMB(gluc_Conc ~ gh_bench+treatment+GM_Leaf_AreaS,REML=T,data=dat2)
fit1<-glmmTMB(gluc_Conc ~ gh_bench+treatment+GM_Leaf_AreaS+(1|Family),REML=T,data=dat2)
anova(fit,fit1)
#Glucosinolate variation highly significant. 
summary(fit1) 
  0.0876/(0.819+0.0876)
0.007448/(0.069621+0.007448)#Same as if it is standardized
#Genotype accounts for 9.6% of glucosinolate variation
confint(fit1)
5.343228e-02/(0.819+0.0876) #95% CI
0.13938976/(0.819+0.0876)
#GXE Interaction
fit2<-glmmTMB(gluc_Conc ~ gh_bench+treatment+GM_Leaf_AreaS+(1|Family/treatment),REML=T,data=dat2)
summary(fit2) 
anova(fit1,fit2)#Interaction is not significant



#---------------
#Flavonoid
fit<-glmmTMB(flav_Conc ~ gh_bench+treatment+GM_Leaf_AreaS,REML=T,data=dat2)
fit1<-glmmTMB(flav_Conc ~ gh_bench+treatment+GM_Leaf_AreaS+(1|Family),REML=T,data=dat2)
anova(fit,fit1)#Family not significant.
summary(fit1) 
9.062e-11/(7.863e-02+9.062e-11)

#GXE Interaction
fit2<-glmmTMB(flav_Conc ~ gh_bench+treatment+GM_Leaf_AreaS+(1|Family:treatment),REML=T,data=dat2)
summary(fit2) 
anova(fit1,fit2)#Interaction is not significant

#---------------
#Total Leaf area (model selection performed elsewhere)
fit<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment+BlackPathDam+WhiteFungLogis+ThripsDam+GM_Leaf_AreaS+gh_bench, data=dat2)

fit1<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment+BlackPathDam+WhiteFungLogis+ThripsDam+GM_Leaf_AreaS+gh_bench+(1|Family), data=dat2)
anova(fit,fit1) #Family highly significant. 
summary(fit1) 
0.02347/(0.4060+0.02347) #5.4% of variation 


#GXE Interaction
fit2<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment+BlackPathDam+WhiteFungLogis+ThripsDam+GM_Leaf_AreaS+gh_bench+(1|Family/treatment), data=dat2)
anova(fit2,fit1) #Must analyze GXE like so, otherwise it is impossible to hypothesis test. 
summary(fit2) 

#Alternate Without leaf area accounted for
fit1<-glmmTMB(Standardize(GM_TotalLeaf_Area)~treatment+BlackPathDam+WhiteFungLogis+Fern+gh_bench+(1|Family), data=dat2)
summary(fit1)
0.009858/(0.547077+0.009858) #1 %




#GXE Interaction
fit2<-lmer(GM_TotalLeaf_AreaS~treatment+BlackPathDam+WhiteFungLogis+ThripsDam+Fern+gh_bench+GM_Leaf_AreaS+(1|Family), data=dat2)

fit3<-lmer(GM_TotalLeaf_AreaS~treatment+BlackPathDam+WhiteFungLogis+ThripsDam+Fern+gh_bench+GM_Leaf_AreaS+(1|Family:treatment), data=dat2)

anova(fit2,fit3) #No treatment interaction 


```


#Special Case: RGR
```{r}
#RGR1 
#This only fits if RGR is standardized. 
fit0<-glmmTMB(RGR1S ~ treatment+GM_NumberOfLeaves_Initial+GM_Leaf_Len_Initial+(1|Family)+(1|gh_bench),REML=T,data=dat2)

fit1<-glmmTMB(RGR1S ~ treatment+GM_Leaf_Len_Initial+(1|Family)+(1|gh_bench),REML=T,data=dat2)
anova(fit0,fit1)#Initial number of leaves is not significant. 

fit2<-glmmTMB(RGR1S ~ GM_Leaf_Len_Initial+(1|Family)+(1|gh_bench),REML=T,data=dat2)
anova(fit2,fit1)#treatment is significant


fit3<-glmmTMB(RGR1S ~ treatment+GM_Leaf_Len_Initial+(1|Family),REML=T,data=dat2)
anova(fit3,fit1)#greenhouse bench not significant
summary(fit3)
0.00288/(0.00288+0.57003)
fit4<-glmmTMB(RGR1S ~ treatment+GM_Leaf_Len_Initial,REML=T,data=dat2)

anova(fit4,fit3) #Family not significant. .....

#GXE Interaction
fit5<-glmmTMB(RGR1S ~ treatment+GM_Leaf_Len_Initial+(1|Family:treatment),REML=T,data=dat2)
anova(fit3,fit5) #GXE is highly significant. 


#Double checking to see if interaction is better than nothing
fit5<-glmmTMB(RGR1S ~ treatment+GM_Leaf_Len_Initial,REML=T,data=dat2)
fit4<-glmmTMB(RGR1S ~ treatment+GM_Leaf_Len_Initial+(1|Family:treatment),REML=T,data=dat2)

anova(fit4,fit5)  #But including the interaction term is not better than nothing at all. 



fit3<-glmmTMB(RGR1S ~ treatment+GM_Leaf_Len_Initial+gh_bench,REML=T,data=dat2)

fit4<-glmmTMB(RGR1S ~ treatment+GM_Leaf_Len_Initial+gh_bench+(1|Family),REML=T,data=dat2)
#Family not significant. 
summary(fit4)
anova(fit3,fit4)

fit5<-glmmTMB(RGR1S ~ treatment+GM_Leaf_Len_Initial+gh_bench+(1|Family/treatment),REML=T,data=dat2)
anova(fit3,fit4)
anova(fit4,fit5) #GXE not significant.

```



